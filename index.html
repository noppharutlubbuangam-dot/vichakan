<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>



    <title>ระบบลงทะเบียนแข่งขัน</title>
<style>
        body {
            font-family: 'Kanit', 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        .app-section { display: none; }
        .app-section.active { display: block; }
        .nav-item.active { color: #0ea5e9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #f59e0b; }
        .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-size:14px; }
        .btn-blue { background:#2563eb; color:#fff; }
        .btn-green { background:#059669; color:#fff; }
        .btn-gray { background:#64748b; color:#fff; }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
            display: block;
            font-size: 24px;
            line-height: 1;
            margin: 0 auto;
        }
        .file-input-style {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #334155;
            padding: 8px 12px;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-style:hover {
            background-color: #e2e8f0;
        }

        /* ขยายตัวอักษรใน Modal รูปทีมให้ชัดขึ้น */
        #team-photo-modal-content {
            font-size: 0.95rem;
        }
        #team-photo-modal-content .text-[9px],
        #team-photo-modal-content .text-[10px],
        #team-photo-modal-content .text-[11px] {
            font-size: 0.8rem !important;
        }
        #team-photo-modal-content .text-xs {
            font-size: 0.8rem;
        }
        #team-photo-modal-content .text-lg {
            font-size: 1.2rem;
        }

        /* ปรับตารางหน้าทีมให้ใช้งานได้ดีบนหน้าจอเล็ก (Mobile Friendly) */
@media (max-width: 768px) {
    #section-teams .overflow-x-auto {
        overflow-x: visible;
    }

    #section-teams table {
        width: 100%;
        border-collapse: collapse;
    }

    #section-teams thead {
        display: none;
    }

    #section-teams tbody {
        display: block;
    }

    /* แปลงเป็นการ์ดเฉพาะแถวทีมจริงๆ
       ไม่รวมหัวหมวด (category-header-row) */
    #section-teams tbody tr:not(.category-header-row) {
        display: block;
        margin-bottom: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.9rem;
        border: 1px solid #e2e8f0;
        background-color: #ffffff;
        box-shadow: 0 1px 2px rgba(15,23,42,0.03);
    }

    /* แถวหัวหมวดบนมือถือ: ให้เป็นหัวข้อเรียบ ๆ */
    #section-teams tbody tr.category-header-row {
        display: block;
        margin: 0.6rem 0 0.2rem;
        padding: 0.35rem 0.4rem 0.2rem;
        border: none;
        border-radius: 0;
        background-color: transparent;
        box-shadow: none;
    }

    #section-teams tbody tr.category-header-row td {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0;
        font-size: 0.8rem;
        font-weight: 600;
        color: #475569;
        border: none !important;
    }

    /* ช่องในแต่ละทีมเป็น block + label */
    #section-teams tbody tr:not(.category-header-row) td {
        display: block;
        padding: 0.15rem 0;
        font-size: 0.78rem;
        border: none !important;
        white-space: normal;
    }

    /* Label ต่าง ๆ (เฉพาะแถวทีม) */
    #section-teams tbody tr:not(.category-header-row) td:nth-child(1)::before {
        content: "รหัสทีม: ";
        font-weight: 600;
        color: #0f172a;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(2)::before {
        content: "กิจกรรม: ";
        font-weight: 600;
        color: #0f172a;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(3)::before {
        content: "รหัสกิจกรรม: ";
        font-weight: 600;
        color: #0f172a;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(4) {
        margin-top: 0.2rem;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(5)::before {
        content: "ครู (ต้อง/มี): ";
        font-weight: 500;
        color: #475569;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(6)::before {
        content: "นร. (ต้อง/มี): ";
        font-weight: 500;
        color: #475569;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(7)::before {
        content: "ระดับ: ";
        font-weight: 500;
        color: #475569;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(8)::before {
        content: "สถานะ: ";
        font-weight: 500;
        color: #475569;
        margin-right: 0.25rem;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(8) span {
        margin-top: 0.15rem;
    }
    #section-teams tbody tr:not(.category-header-row) td:nth-child(9)::before {
        content: "จัดการ: ";
        font-weight: 500;
        color: #475569;
    }
}


/* หัวหมวดบน desktop: เต็มความกว้าง ดูเป็นบล็อกหัวข้อ */
#section-teams tbody tr.category-header-row td {
  background-color: #f1f5f9;
  border-top: 1px solid #e5e7eb;
  border-bottom: 1px solid #e5e7eb;
}
#section-teams tbody tr.category-header-row td .cat-header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}
.activity-header-row--active {
  background-image: linear-gradient(90deg, rgba(14,165,233,0.1), rgba(236,253,245,0.8));
  box-shadow: inset 0 0 0 1px rgba(14,165,233,0.25);
}
.activity-header-row--active td {
  border-color: rgba(14,165,233,0.2);
}
.activity-header-row--active .material-symbols-outlined {
  color: #0ea5e9;
}


/* ให้ .hidden ใช้กับ accordion ได้แน่นอน (เผื่อยังไม่มี Tailwind) */
.hidden {
    display: none !important;
}

        /* แสดงสีบ่งบอกสิทธิ์ในตารางผู้ใช้ */
        .user-role-row {
            position: relative;
            --role-accent: #cbd5f5;
            background-color: #ffffff;
        }
        .user-role-row::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 6px;
            bottom: 6px;
            width: 4px;
            border-radius: 999px;
            background-color: var(--role-accent);
            opacity: 0.85;
        }
        .user-role-row > td:first-child {
            padding-left: 1.75rem !important;
        }
        .user-role-row--admin {
            --role-accent: #e11d48;
            background-color: #fff1f2;
        }
        .user-role-row--area {
            --role-accent: #4c1d95;
            background-color: #eef2ff;
        }
        .user-role-row--group {
            --role-accent: #d97706;
            background-color: #fffbeb;
        }
        .user-role-row--school {
            --role-accent: #059669;
            background-color: #ecfdf5;
        }
        .user-role-row--score {
            --role-accent: #0284c7;
            background-color: #f0f9ff;
        }
        .user-role-row--user {
            --role-accent: #94a3b8;
            background-color: #f8fafc;
        }
        .user-role-row--default {
            --role-accent: #cbd5f5;
            background-color: #ffffff;
        }
        #user-management-content table thead th:first-child {
            padding-left: 1.75rem;
        }
        .competition-medal {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
        }
        .competition-medal.gold { background: #fef3c7; color: #b45309; }
        .competition-medal.silver { background: #e2e8f0; color: #475569; }
        .competition-medal.bronze { background: #fef2f2; color: #9a3412; }
        .competition-medal.merit { background: #ecfccb; color: #3f6212; }
        .competition-medal.participant { background: #e0f2fe; color: #0369a1; }
        .competition-entry {
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            background-color: #ffffff;
        }
        .competition-area-entry {
            border: 1px solid #e2e8f0;
            border-radius: 0.9rem;
            padding: 0.75rem 1rem;
            background-color: #f8fafc;
        }
        .competition-entry + .competition-entry {
            margin-top: 0.75rem;
        }
        .competition-representative-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            background: #dbeafe;
            color: #1d4ed8;
        }
        .team-row--representative {
            background-color: #eff6ff;
        }
        .team-row--representative td {
            border-top-color: rgba(59, 130, 246, 0.12);
        }
        .competition-results-scroll {
            max-height: 640px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }
        .user-management-table {
            table-layout: fixed;
            min-width: 720px;
        }
        .user-management-table th,
        .user-management-table td {
            white-space: nowrap;
        }
        .select2-container .select2-selection--single {
            height: 42px;
            border: 1px solid #cbd5f5;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #0f172a;
            line-height: 42px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
            right: 0.5rem;
        }
        .select2-dropdown {
            border-radius: 0.75rem;
            border-color: #cbd5e1;
            box-shadow: 0 10px 35px rgba(15,23,42,0.08);
        }
        #signup-loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(248, 250, 252, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #0f172a;
        }
        #signup-loading-overlay.hidden {
            display: none;
        }
        .report-stage-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background-color: #e2e8f0;
            color: #334155;
            white-space: nowrap;
        }
        .stage-chip-cluster {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        .stage-chip-area {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .report-cluster-toggle,
        .report-category-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .report-cluster-toggle {
            padding: 1rem 1.25rem 0.75rem;
        }
        .report-category-toggle {
            padding: 0.75rem 1rem;
        }
        .report-cluster-toggle:focus-visible,
        .report-category-toggle:focus-visible {
            outline: 2px solid #0ea5e9;
            outline-offset: 2px;
        }
        .report-cluster-body {
            padding: 0 1.25rem 1.25rem;
        }
        .report-category-body {
            padding: 0 1rem 1rem;
        }
        .school-cluster-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.25rem 0.75rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
        }
        .school-cluster-toggle:focus-visible {
            outline: 2px solid #0ea5e9;
            outline-offset: 2px;
        }
        .school-cluster-body {
            padding: 0 1.25rem 1.25rem;
        }
        .report-activity-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem 0;
        }
        .report-activity-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #475569;
        }
        #score-duty-summary {
            position: relative;
        }
        #score-duty-summary.score-duty-blocked::after {
            content: attr(data-block-message);
            position: absolute;
            inset: 0;
            background-color: rgba(248, 250, 252, 0.92);
            border-radius: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: #0f172a;
            z-index: 10;
            pointer-events: auto;
        }
        #score-duty-summary.score-duty-blocked > * {
            filter: blur(0.4px);
            opacity: 0.65;
        }
        .score-duty-activity-card {
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }
        .score-duty-activity--highlight {
            border-color: #0ea5e9 !important;
            box-shadow: 0 15px 30px rgba(14, 165, 233, 0.25);
            transform: translateY(-1px);
            animation: scoreDutyPulse 1.6s ease-out;
        }
        @keyframes scoreDutyPulse {
            0% {
                box-shadow: 0 10px 24px rgba(14, 165, 233, 0.2);
            }
            50% {
                box-shadow: 0 20px 34px rgba(14, 165, 233, 0.32);
            }
            100% {
                box-shadow: 0 12px 28px rgba(14, 165, 233, 0.22);
            }
        }
        .cluster-leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .cluster-leaderboard-table th,
        .cluster-leaderboard-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }
        .cluster-leaderboard-table thead {
            background-color: #f8fafc;
        }
        #report-table-body tr.bg-slate-50 td {
            width: 100%;
            min-width: 100%;
        }
        #report-table-body tr[data-report-panel] .divide-y {
            width: 100%;
        }
        .cluster-leaderboard-table td[data-label] {
            position: relative;
        }
        @media (max-width: 768px) {
            .cluster-leaderboard-table thead {
                display: none;
            }
            .cluster-leaderboard-table tbody {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            .cluster-leaderboard-table tbody tr {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.25rem;
                border: 1px solid #e2e8f0;
                border-radius: 1rem;
                padding: 0.9rem;
                background-color: #fff;
            }
            .cluster-leaderboard-table tbody tr td {
                display: flex;
                justify-content: space-between;
                border: none;
                padding: 0.1rem 0;
            }
            .cluster-leaderboard-table tbody tr td::before {
                content: attr(data-label);
                font-size: 0.65rem;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                color: #475569;
                margin-right: 0.45rem;
                flex: 0 0 auto;
            }
        }
        .school-award-printable {
            width: 100%;
        }

    
        /* PDF Export (Kanit) */
        .pdf-kanit, .pdf-kanit * {
            font-family: 'Kanit', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif !important;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .pdf-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        .pdf-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .pdf-subtitle {
            font-size: 12px;
            color: #475569;
            margin-bottom: 8px;
        }


        .personal-pass-card.personal-pass-anim {
          animation: personal-pass-fade-in 0.25s ease-out;
        }

        @keyframes personal-pass-fade-in {
          from {
            opacity: 0;
            transform: translateX(10px) scale(0.97);
          }
          to {
            opacity: 1;
            transform: translateX(0) scale(1);
          }
        }


/* ===== ใบลงคะแนน (Score Sheet) — Base ===== */
.score-sheet-wrap{ background:#fff; border-radius:12px; padding:12px; }
.score-sheet-title{ font-weight:600; font-size:14px; text-align:center; }
.score-sheet-subtitle{ font-size:12px; color:#64748b; text-align:center; }

/* ตารางหลัก */
.score-sheet-table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
  font-size:10px;               /* อ่านง่าย ประหยัดพื้นที่ */
}
.score-sheet-table th,
.score-sheet-table td{
  border:1px solid #e5e7eb;
  padding:6px 8px;
  vertical-align:top;
  text-align:center;
}
.score-sheet-table thead th{
  background:#f1f5f9;
  font-weight:600;
}
.score-sheet-table .text-left{ text-align:left; }

/* คอลัมน์พื้นฐาน (ใช้ร่วมกับโค้ดที่กำหนด width ผ่าน HTML ได้) */
.score-sheet-table .col-order{ width:42px; }
.score-sheet-table .col-sum{ width:56px; font-weight:600; }
.score-sheet-table .col-result{ width:170px; }
.score-sheet-table .col-note{ width:150px; }

/* เซลล์ข้อมูลทีม */
.team-name-cell .sub{ font-size:10px; color:#64748b; }

/* ===== ใบลงเวลาของกรรมการ (Timesheet) ===== */
.judge-timesheet-table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
  font-size:11px;
}
.judge-timesheet-table th,
.judge-timesheet-table td{
  border:1px solid #e2e8f0;
  padding:6px 8px;
  text-align:left;
  vertical-align:middle;
}
.judge-timesheet-table thead th{
  background:#f8fafc;
  font-size:12px;
  font-weight:600;
  text-align:center;
}
.judge-timesheet-role-heading{
  background:#f1f5f9;
  font-weight:600;
  font-size:12px;
  color:#0f172a;
}
.judge-timesheet-role-heading td{
  border-top-width:2px;
}
.judge-timesheet-note{
  font-size:10px;
  color:#475569;
}


/* ===== ปรับหน้าตา Swal ตั้งค่าใบลงคะแนน ===== */
.score-swal-popup{
  border-radius:24px !important;
  padding:26px 28px 30px !important;
  background:#fff !important;
  box-shadow:0 35px 80px rgba(15,23,42,0.2) !important;
}
.score-swal-container{
  margin-top:6px !important;
}
.score-swal-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:18px 22px;
  margin-top:14px;
}
.score-swal-field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.score-swal-field label{
  font-size:14px;
  font-weight:600;
  color:#0f172a;
}
.score-swal-input{
  margin:0 !important;
  width:100% !important;
  text-align:center;
  font-size:18px;
  font-weight:600;
  border-radius:16px !important;
  border:1px solid #cbd5ff !important;
  padding:0.6rem 0.75rem !important;
  color:#0f172a !important;
}
.score-swal-hint{
  font-size:12px;
  color:#64748b;
}
.score-swal-note{
  margin-top:10px;
  font-size:12px;
  color:#475569;
  text-align:center;
}

/* ช่องคะแนนอนาคต (เผื่อกรอกในหน้าเว็บ/พิมพ์เขียน) */
.score-cell{ min-width:32px; height:24px; }
.sum-cell{ font-weight:600; }
.result-cell{ }
.note-cell{ }

/* ===== กล่องลายเซ็นกรรมการ ===== */
.sig-grid{
  display:grid;
  gap:14px;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  margin-top:16px;
}
@media (min-width:1024px){
  .sig-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}
.sig-box{
  text-align:center;
  border:1px dashed #cbd5e1;
  border-radius:10px;
  padding:10px 12px;
}
.sig-box .role{
  font-weight:700; color:#0f172a; margin-bottom:6px;
}
  .sig-box .name{
    font-size:12px;
    color:#0f172a;
    font-weight:600;
    min-height:1.4rem;
  }
  .sig-box .sig-meta{
    font-size:10px;
    color:#475569;
    margin-bottom:4px;
  }
  .sig-box .line{
    width:100%; max-width:260px; height:1px; background:#94a3b8;
    margin:6px auto 6px;
  }
  .sig-box .hint{ color:#475569; font-size:10px; }
.sig-box .hint.under{ margin-top:4px; }

/* ===== พิมพ์ (Print) — แนวตั้ง + หัวตารางซ้ำทุกหน้า ===== */
@media print{
  @page{
    size: A4 portrait;
    margin: 8mm 12mm 12mm 12mm;   /* ชิดบนเล็กน้อยตามที่ขอ */
  }

  body *{ visibility: hidden !important; }
  body.score-sheet-printing #score-sheet-print-wrapper,
  body.score-sheet-printing #score-sheet-print-wrapper *{
    visibility: visible !important;
  }
  body.judge-timesheet-printing #judge-timesheet-print-wrapper,
  body.judge-timesheet-printing #judge-timesheet-print-wrapper *{
    visibility: visible !important;
  }
  body.school-award-printing #school-award-modal,
  body.school-award-printing #school-award-modal *{
    visibility: visible !important;
  }

  body.score-sheet-printing #score-sheet-print-wrapper{
    position:absolute; top:0; left:0; right:0;
    background:#fff;
    width:100%;
    max-width:210mm;
    margin:0 auto;
    padding:12px 16px;
    transform-origin: top center;
  }
  body.judge-timesheet-printing #judge-timesheet-modal{
    position:absolute; top:0; left:0; right:0;
    background:#fff;
    width:100%;
    max-width:210mm;
    margin:0 auto;
    padding:0;
    display:block !important;
    align-items:flex-start !important;
    justify-content:flex-start !important;
  }
  body.judge-timesheet-printing #judge-timesheet-modal > div{
    max-height:none;
    border:none;
    box-shadow:none;
    margin:0 auto;
    width:100%;
  }
  body.judge-timesheet-printing #judge-timesheet-print-wrapper{
    background:#fff;
    width:100%;
    padding:12px 16px;
  }
  body.school-award-printing #school-award-modal{
    position:static;
    inset:auto;
    background:#fff;
    width:100%;
    max-width:none;
    margin:0;
    box-shadow:none;
    border-radius:0;
    display:block !important;
    min-height:auto;
    align-items:flex-start !important;
    justify-content:flex-start !important;
    padding:0;
  }
  body.school-award-printing #school-award-modal > div{
    max-height:none;
    border:none;
    box-shadow:none;
    margin:0 auto;
  }
  body.school-award-printing #school-award-modal .school-award-printable{
    width:100% !important;
  }
  body.school-award-printing #school-award-modal .school-award-printable table thead{
    display: table-header-group;
  }

  body.score-sheet-printing #school-award-modal{
    display:none;
  }
  body.school-award-printing #score-sheet-print-wrapper{
    display:none;
  }
  body.judge-timesheet-printing #school-award-modal{
    display:none;
  }
  body.judge-timesheet-printing #score-sheet-print-wrapper{
    display:none;
  }
  body.score-sheet-printing #judge-timesheet-modal,
  body.school-award-printing #judge-timesheet-modal{
    display:none;
  }

  /* ทำให้หัวตารางซ้ำทุกหน้าอัตโนมัติ */
  body.score-sheet-printing .score-sheet-table thead { display: table-header-group; }
  body.score-sheet-printing .score-sheet-table tfoot { display: table-footer-group; }
  body.judge-timesheet-printing .judge-timesheet-table thead { display: table-header-group; }

  body.score-sheet-printing .score-sheet-table{
    font-size:9px;
  }
  body.score-sheet-printing .score-sheet-table th,
  body.score-sheet-printing .score-sheet-table td{
    padding:4px 5px;
  }
  body.score-sheet-printing .team-name-cell .font-semibold{
    font-size:11px;
  }
  body.score-sheet-printing .team-name-cell .sub{
    font-size:10px;
  }
  body.score-sheet-printing .sig-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  /* อนุญาตให้แถวแตกหน้าได้ตามธรรมชาติ (ห้ามใส่ page-break-inside: avoid; กับ tr ทั้งตาราง) */
  body.score-sheet-printing .score-sheet-table{ page-break-inside:auto; }
  body.score-sheet-printing .score-sheet-table tr{ page-break-inside:auto; page-break-after:auto; }

  body.score-sheet-printing #score-sheet-print-wrapper button,
  body.score-sheet-printing #score-sheet-print-wrapper .no-print{
    display:none !important;
  }
  body.judge-timesheet-printing #judge-timesheet-print-wrapper button,
  body.judge-timesheet-printing #judge-timesheet-print-wrapper .no-print{
    display:none !important;
  }
  body.school-award-printing #school-award-print-button{
    display:none !important;
  }
}

/* ===== จอเล็ก (ถ้าต้องเลื่อนแนวนอน) ===== */
@media (max-width:768px){
  .score-sheet-wrap{ padding:10px; }
  .score-sheet-table{ font-size:9.5px; }
}

body.score-sheet-printing #score-sheet-print-wrapper{
  max-width:900px;
  margin:0 auto;
}
body.judge-timesheet-printing #judge-timesheet-print-wrapper{
  max-width:900px;
  margin:0 auto;
}

#team-manage-panel .managed-member-grid input{
  width:100%;
}
@media (min-width:768px){
  #team-manage-panel .managed-member-grid--teacher{
    grid-template-columns:140px minmax(0,1.4fr) minmax(0,1fr);
  }
  #team-manage-panel .managed-member-grid--student{
    grid-template-columns:140px minmax(0,1.6fr) minmax(0,0.9fr);
  }
}
@media (min-width:1024px){
  #team-manage-panel label{
    font-size:0.95rem !important;
  }
  #team-manage-panel input,
  #team-manage-panel select,
  #team-manage-panel textarea{
    font-size:1rem !important;
    padding:0.85rem 1rem !important;
  }
  #team-manage-panel .text-xs{
    font-size:0.875rem;
  }
  #team-manage-panel .text-[11px]{
    font-size:0.82rem;
  }
  #team-manage-panel .text-sm{
    font-size:1rem;
  }
  #team-manage-panel .text-base{
    font-size:1.05rem;
  }
  #team-manage-panel .text-lg{
    font-size:1.35rem;
  }
}

</style>
</head>
<body class="text-slate-800">

<div class="container mx-auto max-w-5xl pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex-col items-center justify-center" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
        <p class="mt-4 text-lg font-semibold text-sky-600">กำลังโหลด...</p>
    </div>

    <div id="global-stage-indicator" class="flex items-center gap-3 px-4 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm mb-4">
        <div class="h-10 w-10 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center">
            <span class="material-symbols-outlined text-xl">flag</span>
        </div>
        <div>
            <p class="text-xs text-slate-500">สถานะการแข่งขัน</p>
            <p id="global-stage-text" class="text-sm font-semibold text-slate-800">กำลังโหลด...</p>
        </div>
        <span id="global-stage-chip" class="ml-auto inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold bg-slate-100 text-slate-600">
            <span class="material-symbols-outlined text-base">schedule</span>
            <span>กำลังโหลด</span>
        </span>
    </div>

    <!-- 1. Hero Section -->
    <section id="section-hero" class="app-section active p-6 text-center bg-slate-50 rounded-b-lg">
        <ion-icon name="trophy-outline" class="text-6xl text-sky-500 mx-auto"></ion-icon>
        <h1 class="text-3xl font-bold text-slate-900 mt-4">ลงทะเบียนแข่งขันระดับสถานศึกษา</h1>
        <p class="text-lg text-slate-600 mt-2">ระบบจัดการการแข่งขันวิชาการและกิจกรรม</p>
        <button type="button" class="mt-6 inline-flex items-center justify-center bg-sky-500 text-white font-semibold px-8 py-3 rounded-lg shadow-md hover:bg-sky-600 transition-colors"
                onclick="handleStartRegistration(event)">
            เริ่มลงทะเบียน
        </button>
        <div class="mt-6 p-3 bg-sky-100 border border-sky-200 text-sky-800 rounded-lg text-sm text-left">
            <strong>คำแนะนำ:</strong> คลิก "เริ่มลงทะเบียน" เพื่อเลื่อนไปยังแบบฟอร์ม หรือเลื่อนลงเพื่อสำรวจกิจกรรมที่เปิดรับสมัคร
        </div>
        <div class="mt-10 text-left space-y-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-end">
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-slate-900">กิจกรรมที่เปิดรับสมัคร</h2>
                    <p class="text-sm text-slate-500 mt-1">ค้นหากิจกรรมที่ยังเปิดให้สมัครและกดสมัครได้ทันที</p>
                </div>
                <div class="w-full md:w-80 relative">
                    <span class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none">search</span>
                    <input id="home-activity-search" type="search" class="w-full pl-11 pr-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหาจากชื่อกิจกรรม หมวดหมู่ หรือระดับ" autocomplete="off">
                </div>
            </div>
            <div id="home-category-filter" class="flex flex-wrap gap-2"></div>
            <p id="home-activity-meta" class="text-sm text-slate-500">กำลังโหลดข้อมูลกิจกรรม...</p>
            <div id="home-activity-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="home-activity-empty" class="hidden text-center text-slate-500">
                <span class="material-symbols-outlined text-4xl mb-2 text-slate-400">info</span>
                <p>ไม่พบกิจกรรมที่ตรงกับคำค้นหา</p>
            </div>
            <div class="flex justify-center">
                <button id="home-activity-load-more" class="hidden px-5 py-2 rounded-lg border border-sky-500 text-sky-600 font-semibold hover:bg-sky-50 transition-colors">
                    ดูเพิ่มเติม
                </button>
            </div>
        </div>
        </section>

        <!-- Member/Auth Section -->
        <section id="section-auth" class="app-section p-4">
            <h2 class="text-2xl font-bold mb-2 px-2">สมัครสมาชิก / เข้าระบบ</h2>
            <p class="text-sm text-slate-500 mb-6 px-2">เลือกวิธีสมัครสมาชิกและเข้าสู่ระบบอย่างสะดวก ระบบจะดึงข้อมูลโรงเรียนจากฐานข้อมูล Schools ให้โดยอัตโนมัติ</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Login Card -->
                <div id="login-card" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
                    <h3 class="text-xl font-semibold text-slate-900 mb-4">เข้าสู่ระบบ</h3>
                    <div id="login-form-wrapper" class="space-y-4">
                        <form id="auth-login-form" class="space-y-4">
                            <div>
                                <label for="login-username" class="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้</label>
                                <input type="text" id="login-username" name="username" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="username" placeholder="ชื่อผู้ใช้ที่ลงทะเบียนไว้">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                <input type="password" id="login-password" name="password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="current-password" placeholder="รหัสผ่านเข้าสู่ระบบ">
                            </div>
                            <button type="submit" id="login-submit-button" class="w-full bg-slate-900 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-slate-800 transition-colors">เข้าสู่ระบบ</button>
                        </form>
                        <div id="login-progress-indicator" class="hidden mt-3 text-sm text-sky-600 flex items-center gap-2">
                            <span class="h-4 w-4 border-2 border-sky-500 border-t-transparent rounded-full animate-spin"></span>
                            <span>กำลังตรวจสอบข้อมูล...</span>
                        </div>
                        <div id="login-status" class="text-sm text-slate-500"></div>
                    </div>
                    <div id="auth-user-panel" class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg hidden">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border border-slate-200 bg-white flex items-center justify-center overflow-hidden">
                                <img id="auth-user-avatar" alt="Avatar" class="hidden w-full h-full object-cover">
                                <span id="auth-user-avatar-placeholder" class="material-symbols-outlined text-slate-400">person</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-slate-800">เข้าสู่ระบบแล้ว</p>
                                <p class="text-sm text-slate-600 mt-1" id="auth-user-summary">-</p>
                                <p class="text-xs text-slate-500 mt-1" id="auth-user-school">-</p>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 hidden" id="auth-user-email"></p>
                        <button id="logout-button" type="button" class="mt-3 w-full bg-white text-slate-700 font-semibold px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 transition-colors">ออกจากระบบ</button>
                    </div>
                </div>

                <!-- Signup Card -->
                <div id="signup-card" class="relative bg-white p-6 rounded-lg shadow-md border border-slate-200 overflow-hidden">
                    <div id="signup-loading-overlay" class="hidden">
                        <span class="h-8 w-8 border-4 border-sky-500 border-t-transparent rounded-full animate-spin"></span>
                        <span>กำลังดำเนินการ...</span>
                    </div>
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                        <h3 class="text-xl font-semibold text-slate-900">สมัครสมาชิกใหม่</h3>
                        <button id="toggle-signup-form" type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition-colors" aria-expanded="false">
                            <span class="material-symbols-outlined text-base" id="toggle-signup-form-icon">expand_more</span>
                            <span id="toggle-signup-form-text">เปิดฟอร์มสมัครสมาชิก</span>
                        </button>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">
                        ระบบจะซ่อนแบบฟอร์มไว้ก่อนเพื่อป้องกันการกรอกโดยไม่ตั้งใจ กดปุ่ม “เปิดฟอร์มสมัครสมาชิก” หากต้องการลงทะเบียนใหม่
                    </div>
                    <div id="signup-form-container" class="hidden mt-4 space-y-4">
                        <form id="auth-signup-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="signup-name" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ</label>
                                    <input type="text" id="signup-name" name="name" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required placeholder="ชื่อจริง เช่น สมชาย">
                                    <p class="text-xs text-slate-500 mt-1">ระบุชื่อจริงตามเอกสารทางราชการ</p>
                                </div>
                                <div>
                                    <label for="signup-surname" class="block text-sm font-medium text-slate-700 mb-1">นามสกุล</label>
                                    <input type="text" id="signup-surname" name="surname" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required placeholder="นามสกุล เช่น ใจดี">
                                    <p class="text-xs text-slate-500 mt-1">ใช้ให้ตรงกับทะเบียนบ้าน</p>
                                </div>
                            </div>
                            <div>
                                <label for="signup-tel" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์</label>
                                <input type="tel" id="signup-tel" name="tel" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required placeholder="เช่น 0891234567">
                                <p class="text-xs text-slate-500 mt-1">ใช้สำหรับติดต่อยืนยันผลการแข่งขัน</p>
                            </div>
                            <div>
                                <label for="signup-email" class="block text-sm font-medium text-slate-700 mb-1">อีเมล</label>
                                <input type="email" id="signup-email" name="email" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="email" placeholder="เช่น teacher@school.ac.th">
                                <p id="signup-email-hint" class="text-xs text-slate-500 mt-1" data-default-text="ใช้อีเมลที่ติดต่อได้จริง ระบบจะตรวจสอบว่าไม่ซ้ำ">ใช้อีเมลที่ติดต่อได้จริง ระบบจะตรวจสอบว่าไม่ซ้ำ</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">รูปประจำตัว (ไม่บังคับ)</label>
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-full border border-slate-200 bg-white flex items-center justify-center overflow-hidden">
                                        <img id="signup-avatar-preview" alt="รูปประจำตัว" class="hidden w-full h-full object-cover">
                                        <span id="signup-avatar-placeholder" class="material-symbols-outlined text-slate-400">person</span>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <input type="file" id="signup-avatar" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200" accept="image/png, image/jpeg">
                                        <p id="signup-avatar-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg ขนาดไม่เกิน 2MB">รองรับ .png, .jpg ขนาดไม่เกิน 2MB</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="auth-school-select" class="block text-sm font-medium text-slate-700 mb-1">เลือกโรงเรียน (จากฐานข้อมูล)</label>
                                <div class="select2-parent">
                                    <select id="auth-school-select" name="schoolId" class="w-full border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" data-placeholder="ค้นหาและเลือกโรงเรียนของคุณ" required>
                                        <option value="">-- กำลังโหลดรายชื่อโรงเรียน --</option>
                                    </select>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">พิมพ์ชื่อโรงเรียนเพื่อค้นหาได้ทันที</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="signup-username" class="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้</label>
                                    <input type="text" id="signup-username" name="username" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-username" placeholder="4-20 ตัวอักษร เช่น somchai78">
                                    <p id="signup-username-hint" class="text-xs text-slate-500 mt-1" data-default-text="ใช้ตัวอักษรภาษาอังกฤษหรือตัวเลข ระบบจะตรวจสอบความซ้ำอัตโนมัติ">ใช้ตัวอักษรภาษาอังกฤษหรือตัวเลข ระบบจะตรวจสอบความซ้ำอัตโนมัติ</p>
                                </div>
                                <div>
                                    <label for="signup-password" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                    <input type="password" id="signup-password" name="password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-password" placeholder="อย่างน้อย 6 ตัวอักษรพร้อมตัวเลข">
                                    <p class="text-xs text-slate-500 mt-1">เพื่อความปลอดภัยแนะนำให้ผสมตัวเลขและอักษรพิมพ์ใหญ่</p>
                                </div>
                            </div>
                            <div>
                                <label for="signup-confirm-password" class="block text-sm font-medium text-slate-700 mb-1">ยืนยันรหัสผ่าน</label>
                                <input type="password" id="signup-confirm-password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-password" placeholder="พิมพ์ซ้ำให้ตรงกัน">
                            </div>
                            <button type="submit" id="signup-submit-button" class="w-full bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-sky-600 transition-colors">สมัครสมาชิก</button>
                        </form>
                        <div id="signup-status" class="text-sm text-slate-500"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Activities Filter & Cards -->
    <section id="section-activities" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">รายการกิจกรรม</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 px-2">
            <select id="filter-category" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <option value="">-- เลือกหมวดหมู่กิจกรรม --</option>
            </select>
            <select id="filter-activity-name" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <option value="">-- เลือกกิจกรรม --</option>
            </select>
        </div>
        <div id="activity-container" class="space-y-6">
            <p id="activity-loading" class="text-slate-500">กำลังโหลดรายการกิจกรรม...</p>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> เลือก "หมวดหมู่" เพื่อกรองรายการกิจกรรมที่สนใจ จากนั้นคลิก "สมัครทีม" บนการ์ดที่ต้องการ
        </div>
    </section>

    <!-- 4. Form สมัครทีม -->
    <section id="section-form" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">กรอกข้อมูลการสมัคร</h2>
        
        <!-- Stepper UI -->
        <div class="flex justify-between items-center mb-6 px-2">
            <div id="step-indicator-1" class="step-indicator active text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-sky-500 text-white rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <p class="text-sm font-semibold text-sky-600 mt-1">ข้อมูลทีม</p>
            </div>
            <div class="flex-1 h-1 bg-slate-200"></div>
            <div id="step-indicator-2" class="step-indicator text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-slate-300 text-slate-600 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <p class="text-sm font-semibold text-slate-500 mt-1">ผู้ติดต่อ</p>
            </div>
            <div class="flex-1 h-1 bg-slate-200"></div>
            <div id="step-indicator-3" class="step-indicator text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-slate-300 text-slate-600 rounded-full flex items-center justify-center font-bold text-lg">3</div>
                <p class="text-sm font-semibold text-slate-500 mt-1">สมาชิก</p>
            </div>
        </div>

        <form id="registration-form" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-6">
            <div id="registration-lock-notice" class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-700 text-sm">
                กรุณาเข้าสู่ระบบก่อนจึงจะสามารถกรอกแบบฟอร์มสมัครได้
            </div>
            <fieldset id="registration-fieldset" disabled class="space-y-6">

            <!-- Step 1: Team Info -->
            <div id="form-step-1" class="form-step active">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 1: ข้อมูลทีม</h3>
                <div class="space-y-4">
                    <div>
                        <label for="form-activity-category" class="block text-sm font-medium text-slate-700 mb-1">หมวดหมู่กิจกรรม</label>
                        <select id="form-activity-category" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">-- เลือกหมวดหมู่ --</option>
                        </select>
                    </div>
                    <div>
                        <label for="form-activity" class="block text-sm font-medium text-slate-700 mb-1">กิจกรรม*</label>
                        <select id="form-activity" name="activity" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            <option value="">-- เลือกกิจกรรม --</option>
                        </select>
                        <div id="registration-assignment-message" class="hidden mt-2 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800"></div>
                    </div>
                    <div>
                        <label for="form-level" class="block text-sm font-medium text-slate-700 mb-1">ระดับ*</label>
                        <select id="form-level" name="level" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            <option value="">-- เลือกระดับ --</option>
                        </select>
                    </div>
                    <div>
                        <label for="form-school" class="block text-sm font-medium text-slate-700 mb-1">โรงเรียน*</label>
                        <input type="text" id="form-school" name="school" list="school-options" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="พิมพ์ชื่อโรงเรียนเพื่อค้นหา" autocomplete="off" required>
                        <datalist id="school-options"></datalist>
                    </div>
                    <div>
                        <label for="form-teamName" class="block text-sm font-medium text-slate-700 mb-1">ชื่อทีม (ถ้ามี)</label>
                        <input type="text" id="form-teamName" name="teamName" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>

                    <!-- Upload Logo -->
                    <div>
                        <label for="form-logo" class="block text-sm font-medium text-slate-700 mb-1">โลโก้ทีม (ถ้ามี)</label>
                        <div class="flex items-center gap-4">
                            <div class="w-20 h-20 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="form-logo-preview" alt="โลโก้ทีม" class="hidden w-full h-full object-cover">
                                <span id="form-logo-placeholder" class="material-symbols-outlined text-3xl text-slate-400">image</span>
                            </div>
                            <div class="flex-1 space-y-1">
                                <input type="file" id="form-logo" name="logo" class="w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-100 file:text-sky-700
                                    hover:file:bg-sky-200"
                                    accept="image/png, image/jpeg">
                                <p id="logo-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg (ไม่เกิน 2MB)">รองรับ .png, .jpg (ไม่เกิน 2MB)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Team Photo -->
                    <div>
                        <label for="form-team-photo" class="block text-sm font-medium text-slate-700 mb-1">รูปภาพทีม (รวมสมาชิก)</label>
                        <div class="flex items-center gap-4">
                            <div class="w-24 h-24 rounded-xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="team-photo-preview" alt="Team preview" class="hidden w-full h-full object-cover">
                                <span id="team-photo-placeholder" class="material-symbols-outlined text-4xl text-slate-400">group</span>
                            </div>
                            <div class="flex-1 space-y-2">
                                <input type="file" id="form-team-photo" name="teamPhoto" class="w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-100 file:text-sky-700
                                    hover:file:bg-sky-200"
                                    accept="image/png, image/jpeg">
                                <p id="team-photo-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 3MB">รองรับ .png, .jpg ไม่เกิน 3MB</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="mt-6 text-right">
                    <button type="button" onclick="nextStep(2)" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-sky-600 transition-colors">ถัดไป &gt;</button>
                </div>
            </div>

            <!-- Step 2: Contact Person -->
            <div id="form-step-2" class="form-step">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 2: ผู้ติดต่อหลัก (ครู/ผู้ประสานงาน)</h3>
                <div class="space-y-4">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ-สกุล*</label>
                        <input type="text" id="contact-name" name="contactName" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    </div>
                    <div>
                        <label for="contact-phone" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์*</label>
                        <input type="tel" id="contact-phone" name="contactPhone" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-slate-700 mb-1">อีเมล*</label>
                        <input type="email" id="contact-email" name="contactEmail" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="prevStep(1)" class="bg-slate-200 text-slate-700 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition-colors">&lt; ย้อนกลับ</button>
                    <button type="button" onclick="nextStep(3)" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-sky-600 transition-colors">ถัดไป &gt;</button>
                </div>
            </div>

            <!-- Step 3: Members -->
            <div id="form-step-3" class="form-step">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 3: รายชื่อสมาชิก</h3>
                <div id="member-requirements" class="p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-lg mb-4">
                    กรุณาเลือกกิจกรรมก่อน...
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-slate-800 mb-2">ครูผู้ควบคุม</h4>
                    <div id="teacher-fields" class="space-y-3"></div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-slate-800 mb-2">นักเรียน</h4>
                    <div id="student-fields" class="space-y-3"></div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="prevStep(2)" class="bg-slate-200 text-slate-700 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition-colors">&lt; ย้อนกลับ</button>
                    <button id="form-submit-button" type="submit" class="bg-green-500 text-white font-bold px-6 py-2 rounded-lg shadow-md hover:bg-green-600 transition-colors">ส่งใบสมัคร</button>
                </div>
            </div>
            </fieldset>
        </form>
        <datalist id="teacher-prefix-options">
            <option value="นาย">
            <option value="นางสาว">
            <option value="นาง">
            <option value="ผศ.">
            <option value="ดร.">
            <option value="ผศ.ดร.">
        </datalist>
        <datalist id="student-prefix-options">
            <option value="เด็กชาย">
            <option value="เด็กหญิง">
            <option value="นาย">
            <option value="นางสาว">
        </datalist>

        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> กรอกข้อมูลให้ครบถ้วน 3 ขั้นตอน จำนวนสมาชิกและครูที่ต้องกรอก จะขึ้นอยู่กับกิจกรรมที่เลือก
        </div>
    </section>

    <!-- 5. Upload Files -->
    <section id="section-upload" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">อัปโหลดเอกสาร (เพิ่มเติม)</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
            <div>
                <label for="upload-team-id" class="block text-sm font-medium text-slate-700 mb-1">เลือกทีม (ที่สมัครแล้ว)</label>
                <select id="upload-team-id" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">-- กรุณาเลือกรหัสทีม --</option>
                </select>
            </div>
            <div>
                <label for="upload-file-type" class="block text-sm font-medium text-slate-700 mb-1">ประเภทไฟล์</label>
                <select id="upload-file-type" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">-- เลือกประเภทไฟล์ --</option>
                    <option value="Consent">ใบยินยอมผู้ปกครอง</option>
                    <option value="Slip">สลิปโอนเงิน (ถ้ามี)</option>
                    <option value="Portfolio">แฟ้มผลงาน (ถ้ามี)</option>
                    <option value="Other">อื่นๆ</option>
                </select>
            </div>
            <div>
                <label for="file-input" class="block text-sm font-medium text-slate-700 mb-1">เลือกไฟล์ (PDF, JPG, PNG ไม่เกิน 5MB)</label>
                <input id="file-input" type="file" class="w-full text-sm text-slate-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-sky-100 file:text-sky-700
                    hover:file:bg-sky-200"
                    accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <button id="upload-button" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-sky-600 transition-colors">
                อัปโหลดไฟล์
            </button>
            <div id="upload-status" class="mt-4 space-y-2"></div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> ใช้ส่วนนี้เพื่ออัปโหลดเอกสารอื่นๆ ที่จำเป็นหลังจากการสมัครทีมเสร็จสิ้น
        </div>
    </section>

    <!-- 6. Team List -->
    <section id="section-teams" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-2 px-2">ตรวจสอบสถานะทีม</h2>
        <div id="team-scope-banner" class="hidden mb-4 mx-2 flex items-center gap-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
            <span class="material-symbols-outlined text-base text-slate-400">info</span>
            <span id="team-scope-text" class="font-medium"></span>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">


            <div id="team-insights" class="grid grid-cols-1 gap-3 md:grid-cols-2 mb-4">
                <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">ทีมตัวแทน</p>
                        <p id="team-insight-representatives" class="text-3xl font-bold text-slate-900 mt-1">--</p>
                        <p class="text-[11px] text-slate-500">รวมเฉพาะทีมที่ได้สิทธิ์เป็นตัวแทน</p>
                    </div>
                    <span class="material-symbols-outlined text-4xl text-sky-500">diversity_3</span>
                </div>
                <div class="rounded-2xl border border-slate-100 bg-white p-4 flex items-center justify-between shadow-sm">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">เหรียญรางวัล</p>
                        <p id="team-insight-medals" class="text-3xl font-bold text-amber-600 mt-1">--</p>
                        <p id="team-insight-medals-breakdown" class="text-[11px] text-slate-500">รอข้อมูล...</p>
                    </div>
                    <span class="material-symbols-outlined text-4xl text-amber-500">workspace_premium</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input type="search" id="team-search" placeholder="ค้นหาจากชื่อทีม, โรงเรียน..." class="flex-grow p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <button id="export-csv-button" type="button" class="bg-slate-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-slate-700 opacity-50 cursor-not-allowed" disabled>Export CSV</button>
                <button id="export-pdf-button" type="button" class="bg-slate-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-slate-700 opacity-50 cursor-not-allowed" disabled>Export PDF</button>
                <button id="area-transfer-button" type="button" class="inline-flex items-center gap-2 bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-sky-700 transition hidden opacity-50 cursor-not-allowed" disabled>
                    <span class="material-symbols-outlined text-base">sync_alt</span>
                    <span>โอนข้อมูลตัวแทนไปเขต</span>
                </button>
                <button id="export-attendance-pdf-button" class="btn btn-green">ใบลงเวลา PDF (กิจกรรม)</button>
            </div>

            <div class="overflow-x-auto no-scrollbar">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">รหัสทีม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">กิจกรรม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">รหัสกิจกรรม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ชื่อทีม / โลโก้</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ครู (ต้อง/มี)</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">นร. (ต้อง/มี)</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ระดับ</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">สถานะ</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="team-table-body" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="9" class="p-4 text-center text-slate-500">กำลังโหลดข้อมูลทีม...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> "Pending" = รอตรวจสอบ, "Approved" = สมัครสำเร็จ, "Rejected" = ข้อมูลไม่ครบ/ไม่ถูกต้อง
        </div>
    </section>

    <!-- 7. Edit Team (คำอธิบาย) -->
    <section id="section-edit" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">การจัดการข้อมูลทีม (สำหรับผู้สมัคร)</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
            <p class="text-slate-700">ส่วนนี้คือหน้าสำหรับผู้สมัครเพื่อแก้ไขข้อมูลทีมและสมาชิกหลังจากสมัครไปแล้ว (โดยปกติจะเข้าผ่านลิงก์พิเศษที่ส่งให้ทางอีเมล หรือหลังจากล็อกอิน)</p>
            <h3 class="text-lg font-semibold">การทำงานของ UI:</h3>
            <ul class="list-decimal list-inside space-y-2 text-slate-600">
                <li>ผู้ใช้จะเห็นฟอร์มที่กรอกข้อมูลเดิมของทีมไว้</li>
                <li>มีปุ่ม <strong>"แก้ไขข้อมูลทีม"</strong> (เช่น ชื่อทีม, ผู้ติดต่อ, โลโก้)</li>
                <li>ในส่วนรายชื่อสมาชิก แต่ละคนจะมีปุ่ม <strong>[ แก้ไข ]</strong> และ <strong>[ ลบสมาชิก ]</strong></li>
                <li>มีปุ่ม <strong>[ + เพิ่มสมาชิก ]</strong> (หากกิจกรรมอนุญาต หรือใช้แทนที่คนเดิม)</li>
                <li>เมื่อแก้ไขเสร็จ กดปุ่ม <strong>"บันทึกการเปลี่ยนแปลง"</strong></li>
            </ul>
        </div>
    </section>

    <!-- 8. Profile -->
    <section id="section-profile" class="app-section p-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4 px-2">
            <div>
                <h2 class="text-2xl font-bold">โปรไฟล์ผู้สมัคร</h2>
                <p class="text-sm text-slate-500">ตรวจสอบข้อมูลติดต่อ สถิติโรงเรียน และแก้ไขรายละเอียดของคุณ</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button type="button" class="inline-flex items-center gap-2 text-sm font-semibold text-sky-600 hover:text-sky-800 transition-colors" onclick="navigateTo('section-form', this)">
                    <span class="material-symbols-outlined text-base">assignment_add</span>
                    <span>ไปยังแบบฟอร์มสมัคร</span>
                </button>
                <button id="profile-logout-btn" type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="handleProfileSectionLogout(event)">
                    <span class="material-symbols-outlined text-base">logout</span>
                    <span>ออกจากระบบ</span>
                </button>
            </div>
        </div>

        <div id="competition-stage-card" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                    <p class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-sky-600">flag</span>
                        <span>สถานะรอบการแข่งขัน</span>
                    </p>
                    <p id="competition-stage-status" class="text-sm text-slate-500 mt-1" data-loading-text="กำลังโหลดสถานะรอบการแข่งขัน...">กำลังโหลดสถานะรอบการแข่งขัน...</p>
                </div>
                <div id="competition-stage-controls" class="flex flex-col gap-2 text-sm md:flex-row md:items-center hidden">
                    <select id="competition-stage-select" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <option value="cluster">รอบกลุ่มเครือข่าย</option>
                        <option value="area">รอบระดับเขต</option>
                    </select>
                    <button type="button" id="competition-stage-save" class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white hover:bg-slate-800">
                        <span class="material-symbols-outlined text-base">save</span>
                        <span>บันทึก</span>
                    </button>
                </div>
            </div>
            <p id="competition-stage-note" class="text-xs text-slate-500 mt-3">ระบบจะแสดงผลคะแนนทุกทีมเมื่ออยู่ในรอบกลุ่มเครือข่าย</p>
        </div>

        <div id="profile-guest-notice" class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-lg font-semibold text-slate-900">เข้าสู่ระบบเพื่อดูโปรไฟล์ของคุณ</p>
                    <p class="text-sm text-slate-500 mt-1">ระบบจะแสดงข้อมูลติดต่อและสถิติโรงเรียนเมื่อคุณเข้าสู่ระบบ</p>
                </div>
                <button type="button" class="inline-flex items-center gap-2 bg-sky-500 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-sky-600 transition-colors" onclick="navigateTo('section-auth', this)">
                    <span class="material-symbols-outlined text-base">login</span>
                    <span>เข้าสู่ระบบ</span>
                </button>
            </div>
        </div>

        <div id="profile-content" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row md:items-center md:gap-6">
                <div class="flex items-center gap-4 flex-1">
                    <div class="w-20 h-20 rounded-full border-2 border-slate-200 bg-slate-50 flex items-center justify-center overflow-hidden">
                        <img id="profile-avatar" alt="รูปโปรไฟล์" class="hidden w-full h-full object-cover">
                        <span id="profile-avatar-fallback" class="material-symbols-outlined text-slate-400 text-4xl">person</span>
                    </div>
                    <div class="space-y-1">
                        <p id="profile-name" class="text-xl font-semibold text-slate-900">-</p>
                        <p id="profile-username" class="text-sm text-slate-500">-</p>
                        <p id="profile-email" class="text-sm text-slate-500">-</p>
                        <p id="profile-phone" class="text-sm text-slate-500">-</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0">
                    <p class="text-sm text-slate-500">โรงเรียน</p>
                    <p id="profile-school" class="text-lg font-semibold text-slate-900">-</p>
                    <p id="profile-cluster" class="text-sm text-slate-500">-</p>
                </div>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">กิจกรรมที่ลงสมัคร</p>
                    <p id="profile-stats-activities" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">จำนวนทีม</p>
                    <p id="profile-stats-teams" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">นักเรียนทั้งหมด</p>
                    <p id="profile-stats-students" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">ครูผู้ควบคุม</p>
                    <p id="profile-stats-teachers" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">รายละเอียดบัญชี</h3>
                        <p class="text-sm text-slate-500">ตรวจสอบข้อมูลผู้ใช้งานและสิทธิ์ปัจจุบัน</p>
                    </div>
                    <span id="profile-role-badge" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-50">
                        <span class="material-symbols-outlined text-base">shield_person</span>
                        <span id="profile-role-label">-</span>
                    </span>
                </div>
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm text-slate-600">
                    <div>
                        <dt class="font-medium text-slate-500">ชื่อผู้ใช้</dt>
                        <dd id="profile-detail-username" class="text-slate-900 break-all">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">สิทธิ์การใช้งาน</dt>
                        <dd id="profile-detail-level" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">อีเมล</dt>
                        <dd id="profile-detail-email" class="text-slate-900 break-all">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">เบอร์ติดต่อ</dt>
                        <dd id="profile-detail-tel" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">โรงเรียน</dt>
                        <dd id="profile-detail-school" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">เครือข่าย</dt>
                        <dd id="profile-detail-cluster" class="text-slate-900">-</dd>
                    </div>
                </dl>
                <p id="profile-permission-note" class="mt-4 text-xs text-slate-500"></p>
            </div>

            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">ทีมของคุณ</h3>
                        <p class="text-sm text-slate-500">ดูสถานะทีมและจัดการสมาชิก</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50" onclick="loadRegisteredTeams(true)">
                            <span class="material-symbols-outlined text-base">refresh</span>
                            <span>รีเฟรช</span>
                        </button>
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50" onclick="navigateTo('section-teams')">
                            <span class="material-symbols-outlined text-base">table</span>
                            <span>เปิดตารางทีม</span>
                        </button>
                    </div>
                </div>
                <div id="profile-team-list" class="space-y-3 text-sm text-slate-600">
                    <p class="text-slate-500">ยังไม่มีข้อมูลทีม</p>
                </div>
            </div>

            <div class="grid gap-6 lg:grid-cols-2">
                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm space-y-4">
                    <h3 class="text-lg font-semibold text-slate-900">ข้อมูลโรงเรียน</h3>
                    <dl class="text-sm text-slate-600 space-y-3">
                        <div class="flex items-center justify-between">
                            <dt class="font-medium text-slate-500">รหัสโรงเรียน</dt>
                            <dd id="profile-school-id" class="text-slate-900">-</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt class="font-medium text-slate-500">เครือข่าย/ภูมิภาค</dt>
                            <dd id="profile-school-cluster" class="text-slate-900">-</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-slate-500">หมายเหตุ</dt>
                            <dd class="text-slate-400 text-sm">หากต้องการแก้ไขข้อมูลโรงเรียนเพิ่มเติม กรุณาติดต่อผู้ดูแลระบบ</dd>
                        </div>
                    </dl>
                </div>
                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900">แก้ไขข้อมูลติดต่อ</h3>
                            <p class="text-sm text-slate-500">ข้อมูลนี้ใช้ในการติดต่อและออกหนังสือราชการ</p>
                        </div>
                        <span id="profile-form-status" class="text-sm text-slate-500"></span>
                    </div>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-name-input" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ</label>
                                <input type="text" id="profile-name-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                            <div>
                                <label for="profile-surname-input" class="block text-sm font-medium text-slate-700 mb-1">นามสกุล</label>
                                <input type="text" id="profile-surname-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-email-input" class="block text-sm font-medium text-slate-700 mb-1">อีเมล</label>
                                <input type="email" id="profile-email-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                            <div>
                                <label for="profile-phone-input" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์</label>
                                <input type="tel" id="profile-phone-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-password-input" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่านใหม่</label>
                                <input type="password" id="profile-password-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="เว้นว่างหากไม่เปลี่ยน">
                            </div>
                            <div>
                                <label for="profile-password-confirm-input" class="block text-sm font-medium text-slate-700 mb-1">ยืนยันรหัสผ่านใหม่</label>
                                <input type="password" id="profile-password-confirm-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="พิมพ์ซ้ำเพื่อยืนยัน">
                            </div>
                        </div>
                        <div>
                            <label for="profile-school-select" class="block text-sm font-medium text-slate-700 mb-1">โรงเรียน</label>
                            <select id="profile-school-select" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="">-- เลือกโรงเรียน --</option>
                            </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" id="profile-form-submit" class="inline-flex items-center gap-2 bg-slate-900 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-base">save</span>
                                <span>บันทึกการเปลี่ยนแปลง</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm space-y-4">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">การจัดการผู้ใช้</h3>
                        <p class="text-sm text-slate-500">ดูรายชื่อผู้ใช้ตามสิทธิ์ของคุณและจัดการได้จากหน้านี้</p>
                    </div>
                    <button type="button" id="user-management-refresh" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        <span>รีเฟรช</span>
                    </button>
                </div>
                <div class="relative">
                    <label for="user-management-search" class="sr-only">ค้นหาผู้ใช้</label>
                    <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-base text-slate-400">search</span>
                    <input id="user-management-search" type="search" class="w-full rounded-lg border border-slate-200 pl-10 pr-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหาจากชื่อผู้ใช้ ชื่อ-สกุล หรือโรงเรียน" autocomplete="off">
                </div>
                <p id="user-management-status" class="text-xs text-slate-500">เฉพาะผู้ใช้ที่มีสิทธิ์</p>
                <p id="user-management-cluster-note" class="text-xs text-slate-500 hidden">คุณกำลังดูข้อมูลเฉพาะเครือข่ายของตนเอง</p>
                <div class="mt-2 flex flex-wrap gap-2 hidden" id="user-management-actions">
                    <button type="button" id="user-management-add" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">person_add</span>
                        <span>เพิ่มผู้ใช้</span>
                    </button>
                </div>
                <div id="user-management-content" class="mt-4 space-y-3 text-sm text-slate-600"></div>
                <form id="user-management-form" class="hidden mt-4 border border-slate-200 rounded-xl p-4 bg-slate-50 space-y-3">
                    <div class="flex items-center justify-between">
                        <p id="user-form-title" class="text-sm font-semibold text-slate-800">เพิ่มผู้ใช้ใหม่</p>
                        <button type="button" id="user-management-cancel" class="text-xs text-slate-500 hover:text-slate-700">ยกเลิก</button>
                    </div>
                    <input type="hidden" id="user-form-userid">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ชื่อผู้ใช้</label>
                            <input type="text" id="user-form-username" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ระดับสิทธิ์</label>
                            <select id="user-form-level" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="User">User</option>
                                <option value="School_Admin">School Admin</option>
                                <option value="Group_Admin">Group Admin</option>
                                <option value="Area">Area</option>
                                <option value="Admin">Admin</option>
                                <option value="Score">Score</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ชื่อ</label>
                            <input type="text" id="user-form-name" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">นามสกุล</label>
                            <input type="text" id="user-form-surname" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">อีเมล</label>
                            <input type="email" id="user-form-email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">เบอร์ติดต่อ</label>
                            <input type="tel" id="user-form-tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">รหัสผ่าน (เฉพาะตอนสร้างหรือเปลี่ยน)</label>
                            <input type="password" id="user-form-password" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ปล่อยว่างหากไม่เปลี่ยน">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ยืนยันรหัสผ่าน</label>
                            <input type="password" id="user-form-password-confirm" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ปล่อยว่างหากไม่เปลี่ยน">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 mb-1 block">โรงเรียน</label>
                        <select id="user-form-school" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">-- เลือกโรงเรียน --</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100" id="user-form-cancel-btn">ยกเลิก</button>
                        <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" id="user-form-submit-btn">
                            <span class="material-symbols-outlined text-base">save</span>
                            <span>บันทึกผู้ใช้</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- 9. Report -->
    <section id="section-report" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">รายงานสรุปผล</h2>
        <div id="report-user-summary" class="mb-6 hidden">
            <div class="flex flex-col gap-2 px-2 mb-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-xl text-sky-500">badge</span>
                    <div>
                        <p class="text-sm font-semibold text-slate-700">ข้อมูลทีมของคุณ</p>
                        <p id="report-user-summary-hint" class="text-xs text-slate-500">กำลังโหลดข้อมูลทีม...</p>
                    </div>
                </div>
                <span id="report-user-summary-stage" class="report-stage-chip">-</span>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-sky-50 p-4 rounded-lg border border-sky-100 text-center shadow-sm">
                    <div class="text-2xl font-bold text-sky-700" id="report-user-total-teams">0</div>
                    <div class="text-xs font-medium text-slate-600" id="report-user-teams-label">ทีมของคุณ</div>
                </div>
                <div class="bg-sky-50 p-4 rounded-lg border border-sky-100 text-center shadow-sm">
                    <div class="text-2xl font-bold text-sky-700" id="report-user-total-teachers">0</div>
                    <div class="text-xs font-medium text-slate-600" id="report-user-teachers-label">ครูผู้ควบคุม</div>
                </div>
                <div class="bg-sky-50 p-4 rounded-lg border border-sky-100 text-center shadow-sm">
                    <div class="text-2xl font-bold text-sky-700" id="report-user-total-students">0</div>
                    <div class="text-xs font-medium text-slate-600" id="report-user-students-label">นักเรียน</div>
                </div>
                <div class="bg-sky-50 p-4 rounded-lg border border-sky-100 text-center shadow-sm">
                    <div class="text-2xl font-bold text-sky-700" id="report-user-total-all">0</div>
                    <div class="text-xs font-medium text-slate-600" id="report-user-all-label">รวมทั้งหมด</div>
                </div>
            </div>
        </div>
        <div id="score-duty-summary" class="mb-6 hidden">
            <div class="flex items-center gap-3 px-2 mb-2">
                <span class="material-symbols-outlined text-xl text-purple-500">workspace_premium</span>
                <div>
                    <p class="text-sm font-semibold text-slate-700">กิจกรรมที่ต้องให้คะแนน</p>
                    <p id="score-duty-hint" class="text-xs text-slate-500">ระบบกำลังเตรียมข้อมูล...</p>
                </div>
            </div>
            <div id="score-duty-search-wrapper" class="px-2 mb-3 hidden">
                <label for="score-duty-search" class="sr-only">ค้นหากิจกรรมให้คะแนน</label>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-base">search</span>
                    <input id="score-duty-search" type="search" class="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหากิจกรรมหรือโรงเรียนในกลุ่มที่ต้องให้คะแนน">
                </div>
            </div>
            <ul id="score-duty-list" class="bg-white border border-slate-200 rounded-lg divide-y divide-slate-100"></ul>
        </div>
        <div id="area-score-card" class="mb-6 hidden">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 space-y-3">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">บันทึกคะแนนระดับเขต</h3>
                        <p class="text-sm text-slate-500">ใช้เมื่อต้องบันทึกคะแนนในรอบระดับเขต</p>
                    </div>
                    <span class="text-xs text-slate-500" id="area-score-stage-label"></span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1fr)_auto] gap-3">
                    <div>
                        <label class="text-xs font-semibold text-slate-600 mb-1 block">กิจกรรมระดับเขต</label>
                        <select id="area-score-activity" class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">กำลังโหลดกิจกรรม...</option>
                        </select>
                        <p id="area-score-helper" class="text-[11px] text-slate-500 mt-1">ระบบจะอัปเดตกิจกรรมที่อยู่ในรอบระดับเขตเมื่อมีข้อมูล</p>
                    </div>
                    <div class="flex items-center justify-end">
                        <button id="area-score-start" type="button" class="inline-flex items-center gap-2 rounded-full bg-sky-500 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-600 transition-colors" disabled>
                            <span class="material-symbols-outlined text-base">score</span>
                            <span>บันทึกคะแนนระดับเขต</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="report-totals-grid" class="bg-white p-6 rounded-lg shadow border border-slate-200 mb-6">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
                <div>
                    <h3 class="text-xl font-semibold text-slate-900">ภาพรวมทั้งหมด</h3>
                    <p id="report-totals-hint" class="text-sm text-slate-500">กำลังโหลดข้อมูลภาพรวม...</p>
                </div>
                <span id="report-totals-stage" class="report-stage-chip">-</span>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center shadow-sm">
                    <div class="text-3xl font-bold text-sky-600" id="report-total-teams">...</div>
                    <div class="text-sm font-medium text-slate-600" id="report-totals-teams-label">ทีมทั้งหมด</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center shadow-sm">
                    <div class="text-3xl font-bold text-sky-600" id="report-total-teachers">...</div>
                    <div class="text-sm font-medium text-slate-600" id="report-totals-teachers-label">ครูทั้งหมด</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center shadow-sm">
                    <div class="text-3xl font-bold text-sky-600" id="report-total-students">...</div>
                    <div class="text-sm font-medium text-slate-600" id="report-totals-students-label">นักเรียนทั้งหมด</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center shadow-sm">
                    <div class="text-3xl font-bold text-sky-600" id="report-total-all">...</div>
                    <div class="text-sm font-medium text-slate-600" id="report-totals-all-label">รวมสมาชิก</div>
                </div>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
                <h3 class="text-xl font-semibold">สรุปตามกิจกรรม</h3>
                <p class="text-sm text-slate-500">แสดงผลแยกตามกลุ่มเครือข่าย สามารถกดเพื่อซ่อน/แสดงได้</p>
            </div>
            <div id="report-table-body" class="space-y-4">
                <div class="p-4 text-center text-slate-500 border border-dashed border-slate-200 rounded-xl">กำลังโหลดข้อมูลรายงาน...</div>
            </div>
        </div>
        <div id="cluster-leaderboard-wrapper" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-6 hidden">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">อันดับเหรียญรางวัลรายโรงเรียน</h3>
                    <p class="text-sm text-slate-500" id="leaderboard-description">กำลังโหลดข้อมูลอันดับเหรียญ...</p>
                </div>
                <span id="leaderboard-stage-chip" class="report-stage-chip">-</span>
            </div>
            <div id="cluster-leaderboard-content" class="mt-4 space-y-4"></div>
        </div>
        <div id="competition-representative-wrapper" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-6 hidden">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">ตัวแทนระดับกลุ่มเครือข่าย</h3>
                    <p class="text-sm text-slate-500">สรุปรายชื่อผู้แทนในแต่ละหมวดหมู่ของกลุ่มเครือข่าย</p>
                </div>
            </div>
            <div id="competition-representative-body" class="mt-4 space-y-4 text-sm text-slate-700">
                <p class="text-center text-slate-500">ยังไม่มีข้อมูลตัวแทน</p>
            </div>
        </div>
        <div id="competition-area-wrapper" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-6 hidden">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">ผลการแข่งขันรอบระดับเขต</h3>
                    <p class="text-sm text-slate-500">จัดอันดับตัวแทนจากทุกกลุ่มเครือข่ายเพื่อหาผู้ชนะระดับเขต</p>
                </div>
            </div>
            <div id="competition-area-body" class="mt-4 space-y-4 text-sm text-slate-700">
                <p class="text-center text-slate-500">ยังไม่มีข้อมูลรอบระดับเขต</p>
            </div>
        </div>
        <div id="report-management-wrapper" class="hidden space-y-6 mt-8">
            <div id="score-assignment-card" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 hidden">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">มอบหมายผู้ตรวจคะแนน (Score)</h3>
                        <p class="text-sm text-slate-500">กำหนดกิจกรรมที่ผู้ใช้ระดับ Score รับผิดชอบ (Admin / Area / Group Admin จัดการได้)</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" id="score-assignment-refresh" class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                            <span class="material-symbols-outlined text-[16px] leading-none">refresh</span>
                            <span>รีเฟรช</span>
                        </button>
                    </div>
                </div>
                <div class="text-xs text-slate-500">สามารถเลือกได้หลายกิจกรรม (กด Ctrl/Cmd เพื่อเลือกหลายรายการ)</div>
                <div id="score-assignment-content" class="mt-4 space-y-4 text-sm text-slate-600">
                    <p class="text-xs text-slate-500">กำลังโหลดข้อมูลผู้ใช้ Score...</p>
                </div>
                <div class="mt-4 border-t border-slate-200 pt-4">
                    <h4 class="text-sm font-semibold text-slate-800 mb-2">ภาพรวมการมอบหมายต่อกิจกรรม</h4>
                    <div id="score-assignment-activity-summary" class="text-xs text-slate-600 space-y-2">
                        <p>ยังไม่มีข้อมูลการมอบหมาย</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">การจัดการโรงเรียน</h3>
                        <p class="text-sm text-slate-500">ตรวจสอบรายชื่อโรงเรียนในเครือข่ายของคุณ</p>
                    </div>
                    <button type="button" id="school-management-refresh" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        <span>รีเฟรช</span>
                    </button>
                </div>
                <div class="relative mt-4">
                    <label for="school-management-search" class="sr-only">ค้นหาโรงเรียน</label>
                    <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-base text-slate-400">search</span>
                    <input id="school-management-search" type="search" class="w-full rounded-lg border border-slate-200 pl-10 pr-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหาจากชื่อโรงเรียน รหัส หรือกลุ่มเครือข่าย" autocomplete="off">
                </div>
                <p id="school-management-status" class="text-xs text-slate-500 mt-3">เฉพาะผู้ใช้ที่มีสิทธิ์</p>
                <div id="school-management-content" class="mt-4 space-y-3 text-sm text-slate-600"></div>
            </div>
        </div>
    </section>

    <!-- 10. Admin Section -->
    <section id="section-admin" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">สำหรับผู้ดูแลระบบ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
            <h3 class="text-xl font-semibold mb-4">รายการไฟล์ที่รอตรวจสอบ</h3>
            <div id="admin-file-review-list" class="space-y-4">
                <p id="admin-loading" class="text-slate-500">กำลังโหลดรายการ...</p>
            </div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ (Admin):</strong> ตรวจสอบไฟล์ที่อัปโหลดล่าสุด หากกด "ไม่ผ่าน" กรุณาระบุเหตุผลให้ชัดเจนในช่องหมายเหตุ
        </div>
    </section>

</div>

<!-- Bottom Navbar -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-10">
    <div class="flex flex-nowrap items-stretch gap-1 max-w-5xl mx-auto px-2 overflow-x-auto no-scrollbar">
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50 active" onclick="navigateTo('section-hero', this)">
            <span class="material-symbols-outlined text-2xl">home</span>
            <span class="text-xs block">หน้าหลัก</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-form', this)">
            <span class="material-symbols-outlined text-2xl">assignment</span>
            <span class="text-xs block">ลงทะเบียน</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-teams', this)">
            <span class="material-symbols-outlined text-2xl">groups</span>
            <span class="text-xs block">ทีมทั้งหมด</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-report', this)">
            <span class="material-symbols-outlined text-2xl">monitoring</span>
            <span class="text-xs block">รายงาน</span>
        </button>
        <div id="nav-profile-wrapper" class="relative flex-none md:flex-1 min-w-[4.5rem]">
            <button id="nav-profile-button" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="nav-profile-menu" class="nav-item w-full p-3 text-center text-slate-600 hover:bg-sky-50" onclick="handleNavProfileButton(event)">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-9 h-9 rounded-full border border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        <img id="nav-profile-avatar" alt="โปรไฟล์" class="hidden w-full h-full object-cover">
                        <span id="nav-profile-avatar-fallback" class="material-symbols-outlined text-2xl text-slate-400">account_circle</span>
                    </div>
                    <span id="nav-profile-label" class="text-xs block">โปรไฟล์</span>
                </div>
            </button>
            <div id="nav-profile-menu" class="hidden absolute bottom-full left-1/2 z-20 mb-3 w-72 max-w-xs -translate-x-1/2 md:w-80">
                <div class="rounded-2xl border border-slate-200 bg-white/95 shadow-2xl backdrop-blur p-4 space-y-4">
                    <div id="nav-profile-menu-guest" class="space-y-4">
                        <div class="rounded-2xl border border-slate-200 bg-slate-50/70 p-3">
                            <p class="text-sm font-semibold text-slate-700 mb-2">เข้าสู่ระบบอย่างรวดเร็ว</p>
                            <form id="nav-login-form" class="space-y-2" onsubmit="handleNavLoginSubmit(event)">
                                <div>
                                    <label for="nav-login-username" class="sr-only">ชื่อผู้ใช้</label>
                                    <input id="nav-login-username" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อผู้ใช้" autocomplete="username" required>
                                </div>
                                <div>
                                    <label for="nav-login-password" class="sr-only">รหัสผ่าน</label>
                                    <input id="nav-login-password" type="password" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="รหัสผ่าน" autocomplete="current-password" required>
                                </div>
                                <button type="submit" id="nav-login-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                                    <span class="material-symbols-outlined text-base">login</span>
                                    <span>เข้าสู่ระบบ</span>
                                </button>
                                <p id="nav-login-status" class="text-xs text-slate-500 min-h-[1.25rem]"></p>
                            </form>
                        </div>
                        <div class="rounded-2xl border border-dashed border-slate-300 p-3 space-y-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-slate-700">ยังไม่มีบัญชี?</p>
                                    <p class="text-xs text-slate-500">สมัครใช้งานเพื่อสร้างทีมได้ทันที</p>
                                </div>
                                <button type="button" id="nav-signup-toggle" class="inline-flex items-center gap-1 text-xs font-semibold text-sky-600 hover:text-sky-800" onclick="toggleNavSignupForm()">
                                    <span class="material-symbols-outlined text-base" id="nav-signup-toggle-icon">expand_more</span>
                                    <span id="nav-signup-toggle-label">เปิดฟอร์มสมัคร</span>
                                </button>
                            </div>
                            <form id="nav-signup-form" class="hidden space-y-2" onsubmit="handleNavSignupSubmit(event)">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="nav-signup-name" type="text" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อ" required>
                                    <input id="nav-signup-surname" type="text" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="นามสกุล" required>
                                </div>
                                <div>
                                    <input id="nav-signup-username" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อผู้ใช้" required>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="nav-signup-password" type="password" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="รหัสผ่าน" required>
                                    <input id="nav-signup-confirm" type="password" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ยืนยันรหัสผ่าน" required>
                                </div>
                                <div>
                                    <input id="nav-signup-email" type="email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="อีเมล" required>
                                </div>
                                <div>
                                    <input id="nav-signup-tel" type="tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="เบอร์ติดต่อ" required>
                                </div>
                                <div>
                                    <select id="nav-signup-school" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        <option value="">-- เลือกโรงเรียน --</option>
                                    </select>
                                </div>
                                <button type="submit" id="nav-signup-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-3 py-2 text-xs font-semibold text-white hover:bg-sky-600">
                                    <span class="material-symbols-outlined text-base">person_add</span>
                                    <span>สมัครสมาชิก</span>
                                </button>
                                <p id="nav-signup-status" class="text-xs text-slate-500 min-h-[1.25rem]"></p>
                            </form>
                            <button type="button" class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="openAuthFromProfile('signup')">
                                <span class="material-symbols-outlined text-base">open_in_new</span>
                                <span>เปิดฟอร์มเต็มหน้าจอ</span>
                            </button>
                        </div>
                    </div>
                    <div id="nav-profile-menu-user" class="hidden space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border border-slate-200 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="nav-profile-menu-avatar" alt="เมนูโปรไฟล์" class="hidden w-full h-full object-cover">
                                <span id="nav-profile-menu-avatar-fallback" class="material-symbols-outlined text-3xl text-slate-400">person</span>
                            </div>
                            <div class="text-sm">
                                <p id="nav-profile-menu-name" class="font-semibold text-slate-900">-</p>
                                <p id="nav-profile-menu-role" class="text-xs uppercase tracking-wide text-slate-500">USER</p>
                                <p id="nav-profile-menu-school" class="text-xs text-slate-500">โรงเรียน: -</p>
                            </div>
                        </div>
                        <div id="nav-profile-avatar-editor" class="hidden space-y-2 rounded-xl border border-dashed border-slate-200 bg-slate-50 p-3 text-sm">
                            <div class="text-xs font-medium text-slate-600">รูปโปรไฟล์</div>
                            <label for="nav-profile-avatar-input" class="inline-flex w-full cursor-pointer items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:border-slate-400">
                                <span class="material-symbols-outlined text-base">upload</span>
                                <span>เลือกไฟล์ใหม่</span>
                            </label>
                            <input type="file" id="nav-profile-avatar-input" class="hidden" accept="image/png,image/jpeg">
                            <p id="nav-profile-avatar-status" class="text-xs text-slate-500" data-default-status="รองรับ .jpg, .png ไม่เกิน 2MB">รองรับ .jpg, .png ไม่เกิน 2MB</p>
                            <p id="nav-profile-approval-hint" class="text-[11px] text-amber-600">รูปใหม่จะใช้งานหลังจากโรงเรียนได้รับการอนุมัติจาก Admin</p>
                            <button type="button" id="nav-profile-avatar-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-3 py-2 text-sm font-semibold text-white hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50">
                                <span class="material-symbols-outlined text-base">check_circle</span>
                                <span>ส่งคำขอเปลี่ยนรูป</span>
                            </button>
                        </div>
                        <div class="space-y-2">
                            <button type="button" class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="goToProfileSection()">
                                <span class="material-symbols-outlined text-base">account_circle</span>
                                <span>เปิดหน้าโปรไฟล์</span>
                            </button>
                            <button type="button" id="nav-profile-admin-link" class="hidden w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="goToAdminSection()">
                                <span class="material-symbols-outlined text-base">admin_panel_settings</span>
                                <span>แดชบอร์ดผู้ดูแล</span>
                            </button>
                            <button type="button" id="nav-profile-logout" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                                <span class="material-symbols-outlined text-base">logout</span>
                                <span>ออกจากระบบ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<div id="team-manage-panel" class="fixed inset-0 bg-black/40 z-40 hidden items-end md:items-center justify-center p-4">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl border border-slate-200
              flex flex-col max-h-[90vh] overflow-hidden relative">

        <div id="team-manage-loading" class="hidden absolute inset-0 bg-white/85 z-20 flex flex-col items-center justify-center gap-3">
            <div class="h-10 w-10 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin"></div>
            <p class="text-sm font-medium text-slate-600">กำลังบันทึกข้อมูลทีม...</p>
        </div>
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">จัดการทีม</p>
                <h3 id="team-manage-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="team-manage-cluster" class="text-[11px] text-amber-600">เครือข่าย: -</p>
                <p id="team-manage-stage" class="text-[11px] text-sky-600">ระดับการแข่งขัน: -</p>
                <div id="team-manage-stage-switch" class="mt-2 flex gap-2 hidden">
                    <button type="button" data-stage-scope="cluster" class="flex-1 rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-100">
                        รอบกลุ่มเครือข่าย
                    </button>
                    <button type="button" data-stage-scope="area" class="flex-1 rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-100">
                        รอบระดับเขต
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="team-manage-status-pill" class="px-2 py-1 text-xs font-semibold rounded-full border border-slate-200 text-slate-600">-</span>
                <button type="button" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="closeTeamManager()">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
        </div>
        <div class="overflow-y-auto p-4 space-y-4">
            <div id="team-manage-lock" class="hidden rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 flex items-start gap-2">
                <span class="material-symbols-outlined text-base">info</span>
                <p>สถานะทีมกำลัง <strong>Print</strong> ไม่สามารถแก้ไขข้อมูลได้</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <label class="text-xs font-semibold text-slate-500">ชื่อทีม</label>
                    <input id="team-manage-name" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
            <div class="space-y-3">
                <label class="text-xs font-semibold text-slate-500">สถานะ</label>
                <select id="team-manage-status" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Print">Print</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <p id="team-manage-status-hint" class="text-[11px] text-slate-500">ระบบจะแสดงสิทธิ์การแก้สถานะตามบทบาท (Admin/Area และ Group Admin รอบกลุ่มเครือข่าย)</p>
                <div id="team-manage-reason-wrapper" class="space-y-2 hidden">
                    <label class="text-xs font-semibold text-slate-500">เหตุผลการไม่อนุมัติ</label>
                    <textarea id="team-manage-status-reason" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="กรุณาระบุเหตุผลเมื่อเปลี่ยนสถานะเป็น Rejected"></textarea>
                    <p class="text-[11px] text-slate-500">จะแสดงให้เจ้าของทีมเห็นในหน้าโปรไฟล์</p>
                </div>
            </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">ผู้ประสานงาน</label>
                    <input id="team-manage-contact-name" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อ-นามสกุล">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">เบอร์ติดต่อ</label>
                    <input id="team-manage-contact-phone" type="tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="08x-xxx-xxxx" data-only-digits="true" inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">อีเมล</label>
                    <input id="team-manage-contact-email" type="email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="example@mail.com">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">โลโก้ทีม</p>
                            <p class="text-xs text-slate-500">อัปเดตโลโก้สำหรับบัตร/รายงาน</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                            <img id="team-manage-logo-preview" alt="Team logo preview" class="hidden w-full h-full object-cover">
                            <span id="team-manage-logo-placeholder" class="material-symbols-outlined text-slate-400 text-3xl">image</span>
                        </div>
                        <div class="flex-1 text-xs space-y-2">
                            <p id="team-manage-logo-status" class="text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 2MB (School Admin / Group Admin / Area / Admin)">รองรับ .png, .jpg ไม่เกิน 2MB (School Admin / Group Admin / Area / Admin)</p>
                            <input id="team-manage-logo-input" type="file" class="w-full text-xs text-slate-500 file:mr-3 file:rounded-lg file:border-0 file:bg-sky-100 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-sky-700 hover:file:bg-sky-200" accept="image/png,image/jpeg" disabled>
                        </div>
                    </div>
                </div>
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">รูปทีม</p>
                            <p class="text-xs text-slate-500">รูปถ่ายรวมทีม ใช้ในแสดงผล/รายงาน</p>
                        </div>
                        <button type="button" id="team-manage-photo-open" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-50" disabled>
                            <span class="material-symbols-outlined text-base">open_in_new</span>
                            ดูรูป
                        </button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-24 h-16 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                            <img id="team-manage-photo-preview" alt="Team photo preview" class="hidden w-full h-full object-cover">
                            <span id="team-manage-photo-placeholder" class="material-symbols-outlined text-slate-400 text-3xl">group</span>
                        </div>
                        <div class="flex-1 text-xs space-y-2">
                            <p id="team-manage-photo-status" class="text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 3MB (School Admin / Group Admin / Area / Admin)">รองรับ .png, .jpg ไม่เกิน 3MB (School Admin / Group Admin / Area / Admin)</p>
                            <input id="team-manage-photo-input" type="file" class="w-full text-xs text-slate-500 file:mr-3 file:rounded-lg file:border-0 file:bg-sky-100 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-sky-700 hover:file:bg-sky-200" accept="image/png,image/jpeg" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">ครูผู้ควบคุมทีม</p>
                            <p class="text-xs text-slate-500">เพิ่มหรือลบครูได้ตามสิทธิ์</p>
                        </div>
                        <button type="button" class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50" onclick="addManagedMember('teacher')" id="team-add-teacher-btn">
                            <span class="material-symbols-outlined text-base">add</span>
                        </button>
                    </div>
                    <div id="team-manage-teachers" class="space-y-2 text-sm text-slate-600"></div>
                </div>
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">นักเรียนในทีม</p>
                            <p class="text-xs text-slate-500">ระบุชื่อและระดับชั้น</p>
                        </div>
                        <button type="button" class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50" onclick="addManagedMember('student')" id="team-add-student-btn">
                            <span class="material-symbols-outlined text-base">add</span>
                        </button>
                    </div>
                    <div id="team-manage-students" class="space-y-2 text-sm text-slate-600"></div>
                </div>
            </div>
        </div>
        <div class="border-t border-slate-200 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <p id="team-manage-feedback" class="text-xs text-slate-500">ปรับปรุงข้อมูลให้ถูกต้องก่อนบันทึก</p>
            <div class="flex flex-wrap justify-end gap-2">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="closeTeamManager()">ปิด</button>
                <button type="button" id="team-manage-delete" class="inline-flex items-center gap-2 rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-100" onclick="deleteActiveTeam()">ลบทีม</button>
                <button type="button" id="team-manage-save" class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-600" onclick="saveManagedTeam()">บันทึกการเปลี่ยนแปลง</button>
            </div>
        </div>
    </div>
</div>

<div id="score-entry-modal" class="fixed inset-0 bg-black/50 z-40 hidden items-end md:items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col max-h-[90vh] overflow-hidden relative">
        <div id="score-entry-loading-overlay" class="hidden absolute inset-0 bg-white/80 z-10 flex flex-col items-center justify-center gap-2">
            <div class="h-10 w-10 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
            <p class="text-sm font-semibold text-sky-600">กำลังบันทึกคะแนน...</p>
        </div>
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">บันทึกคะแนน</p>
                <h3 id="score-entry-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="score-entry-subtitle" class="text-[11px] text-slate-500">เลือกกิจกรรมและกรอกคะแนนให้ครบทุกทีม</p>
            </div>
            <button type="button" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="closeScoreEntryModal()">
                <span class="material-symbols-outlined text-base">close</span>
            </button>
        </div>
        <div id="score-entry-body" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm text-slate-600">
            <p class="text-slate-500 text-center">กำลังเตรียมข้อมูลทีม...</p>
        </div>
        <div class="border-t border-slate-200 px-4 py-3 flex items-center justify-between gap-3 bg-slate-50">
            <p class="text-[11px] text-slate-500">ระบบจะจัดอันดับโดยอัตโนมัติ และเลือกตัวแทนจากทีมที่ได้คะแนนสูงสุด</p>
            <button type="button" id="score-entry-submit" class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-700" onclick="submitScoreEntries()">
                <span class="material-symbols-outlined text-base">save</span>
                <span>บันทึกคะแนน</span>
            </button>
        </div>
    </div>
</div>

<div id="school-award-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">กิจกรรมที่ได้รับรางวัล</p>
                <h3 id="school-award-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="school-award-subtitle" class="text-[11px] text-slate-500">เลือกโรงเรียนเพื่อดูรายละเอียด</p>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" id="school-award-print-button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-100">
                    <span class="material-symbols-outlined text-base">print</span>
                    <span>พิมพ์ตารางนี้</span>
                </button>
                <button type="button" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="closeSchoolAwardModal()">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
        </div>
        <div id="school-award-body" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm text-slate-600">
            <p class="text-center text-slate-500">เลือกชื่อโรงเรียนด้านบนเพื่อดูรายละเอียดกิจกรรมที่ได้รับรางวัล</p>
        </div>
    </div>
</div>

<div id="school-assignment-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">กำหนดกิจกรรมให้โรงเรียน</p>
                <h3 id="school-assignment-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="school-assignment-subtitle" class="text-[11px] text-slate-500">เลือกกิจกรรมที่ต้องการมอบหมาย</p>
            </div>
            <button type="button" id="school-assignment-close" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                <span class="material-symbols-outlined text-base">close</span>
            </button>
        </div>
        <div class="border-b border-slate-200 p-4 space-y-2">
            <input id="school-assignment-search" type="search" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหาตามชื่อกิจกรรมหรือหมวดหมู่...">
            <p class="text-[11px] text-slate-500">สามารถเลือกได้หลายกิจกรรม ระบบจะจำแนกเฉพาะรายการที่กำหนดไว้</p>
        </div>
        <div id="school-assignment-list" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm text-slate-700">
            <p class="text-center text-slate-500">กำลังเตรียมรายการกิจกรรม...</p>
        </div>
        <div class="border-t border-slate-200 px-4 py-3 flex items-center justify-between gap-3 bg-slate-50">
            <button type="button" id="school-assignment-cancel" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">ยกเลิก</button>
            <button type="button" id="school-assignment-save" class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-700">
                <span class="material-symbols-outlined text-base">save</span>
                <span>บันทึกกิจกรรม</span>
            </button>
        </div>
    </div>
</div>

<div id="judge-manual-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col max-h-[90vh]">
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">เพิ่มกรรมการ</p>
                <h3 id="judge-manual-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="judge-manual-subtitle" class="text-[11px] text-slate-500">-</p>
            </div>
            <button type="button" id="judge-manual-close" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                <span class="material-symbols-outlined text-base">close</span>
            </button>
        </div>
        <form id="judge-manual-form" class="space-y-4 p-4 overflow-y-auto">
            <div>
                <label class="text-xs font-semibold text-slate-600 mb-1 block">ชื่อกรรมการ</label>
                <input type="text" id="judge-manual-name" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
            </div>
            <div id="judge-manual-copy-wrapper" class="hidden">
                <label class="text-xs font-semibold text-slate-600 mb-1 block">คัดลอกจากกรรมการรอบกลุ่มเครือข่าย</label>
                <select id="judge-manual-copy" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">-- เลือกกรรมการ --</option>
                </select>
                <p class="text-[11px] text-slate-500 mt-1">ระบบจะกรอกข้อมูลให้ตามกรรมการที่เลือก</p>
            </div>
            <div>
                <label class="text-xs font-semibold text-slate-600 mb-1 block">โรงเรียน (SchoolID)</label>
                <select id="judge-manual-school" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <option value="">-- กำลังโหลดรายชื่อโรงเรียน --</option>
                </select>
                <p class="text-[11px] text-slate-500 mt-1">หากไม่มีในรายการให้เลือก “กรรมการภายนอก”</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="text-xs font-semibold text-slate-600 mb-1 block">บทบาท</label>
                    <select id="judge-manual-role" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <option value="">-- เลือกบทบาท --</option>
                        <option value="ประธานกรรมการ">ประธานกรรมการ</option>
                        <option value="กรรมการ">กรรมการ</option>
                        <option value="กรรมการและเลขา">กรรมการและเลขา</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-600 mb-1 block">เบอร์โทร</label>
                    <input type="text" id="judge-manual-phone" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="08x-xxx-xxxx">
                </div>
            </div>
            <div>
                <label class="text-xs font-semibold text-slate-600 mb-1 block">อีเมล</label>
                <input type="email" id="judge-manual-email" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="example@mail.com">
            </div>
            <p id="judge-manual-status" class="text-xs text-slate-500">กรอกข้อมูลให้ครบแล้วกด “บันทึกกรรมการ”</p>
            <div class="flex items-center justify-end gap-2 border-t border-slate-200 pt-3">
                <button type="button" id="judge-manual-cancel" class="inline-flex items-center gap-1 rounded-full border border-slate-300 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100">ยกเลิก</button>
                <button type="submit" id="judge-manual-submit" class="inline-flex items-center gap-1 rounded-full bg-sky-500 px-4 py-1.5 text-xs font-semibold text-white hover:bg-sky-600">
                    <span id="judge-manual-spinner" class="hidden h-4 w-4 border-2 border-white/70 border-t-transparent rounded-full animate-spin"></span>
                    <span id="judge-manual-submit-icon" class="material-symbols-outlined text-base">save</span>
                    <span data-judge-submit-label>บันทึกกรรมการ</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Team Members & Digital ID (กรรมการดูภาพรวม) -->
<div id="team-photo-modal"
     class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-2 md:p-4">
  <div class="bg-white w-full h-full md:h-auto md:max-h-[96vh] max-w-6xl mx-auto
              rounded-none md:rounded-2xl shadow-2xl overflow-hidden flex flex-col relative">

    <!-- Header -->
    <div class="flex items-center justify-between px-5 pt-4 pb-3 border-b border-slate-200">
      <div class="flex flex-col flex-1 items-center gap-1">
        <div class="text-[11px] font-semibold text-slate-900 tracking-[0.16em] uppercase">
          แบบลงทะเบียนรายงานตัว
        </div>
        <div id="team-photo-modal-title"
             class="text-sm font-semibold text-slate-900">
          บัตรประจำตัวเข้าแข่งขันดิจิทัล
        </div>
        <div id="team-photo-modal-subtitle"
             class="text-[10px] text-slate-500 text-center">
          <!-- ใส่ด้วย JS -->
        </div>
      </div>

      <!-- ปุ่มปิด -->
      <button type="button"
              onclick="closeTeamPhotoModal()"
              class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full
                     bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-300">
        ✕
      </button>
    </div>

    <!-- Content -->
    <div id="team-photo-modal-content"
         class="flex-1 p-4 md:p-5 overflow-hidden">
      <!-- เติมด้วย openTeamPhotoModal -->
    </div>
  </div>
</div>



<!-- Personal Digital Pass: สำหรับผู้เข้าแข่งขัน / ครู -->
<div id="personal-pass-modal"
     class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-0 md:p-4">
  <div class="bg-slate-900 w-full h-full md:h-auto md:max-h-[100vh] md:max-w-xs mx-auto
              rounded-none md:rounded-2xl shadow-2xl overflow-hidden flex flex-col relative">

    <!-- Header -->
    <div class="flex items-center justify-between px-4 pt-3 pb-2 border-b border-slate-800">
      <div class="flex flex-col gap-0 leading-tight">
        <div class="text-[9px] text-sky-300 tracking-[0.16em] uppercase">
          DIGITAL ENTRY PASS
        </div>
        <div id="personal-pass-title"
             class="text-[12px] font-semibold text-slate-50">
          บัตรประจำตัวเข้าแข่งขันของฉัน
        </div>
        <div id="personal-pass-subtitle"
             class="text-[9px] text-slate-400">
          <!-- ใส่ด้วย JS -->
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button type="button"
                onclick="toggleAddToHomeGuide()"
                class="hidden md:inline-flex items-center gap-1 px-2.5 py-1 rounded-full
                       text-[9px] bg-sky-500/10 text-sky-300 border border-sky-500/40">
          <span class="material-symbols-outlined text-[14px] leading-none">smartphone</span>
          <span>เพิ่มบนหน้าจอหลัก</span>
        </button>
        <button type="button"
                onclick="closePersonalPassModal()"
                class="w-7 h-7 flex items-center justify-center rounded-full
                       bg-slate-800 hover:bg-slate-700 text-slate-300 text-[14px]">
          ✕
        </button>
      </div>
    </div>

    <!-- คู่มือเพิ่มบนหน้าจอหลัก -->
    <div id="add-to-home-guide"
         class="hidden px-4 pt-2 pb-2 bg-slate-900 text-[8.5px] text-slate-300 border-b border-slate-800 space-y-1">
      <div class="font-semibold text-sky-300">คำแนะนำการปักบัตรบนหน้าจอหลัก</div>
      <div>- Android (Chrome): เมนู ⋮ → "เพิ่มลงในหน้าจอหลัก"</div>
      <div>- iPhone (Safari): ปุ่มแชร์ ⬆️ → "Add to Home Screen"</div>
    </div>

    <!-- บัตรแนวตั้ง -->
    <div class="flex-1 flex items-center justify-center p-4">
      <div id="personal-pass-card"
           class="w-full max-w-xs aspect-[3/5]">
        <!-- เติมด้วย renderPersonalIdCard -->
      </div>
    </div>
  </div>
</div>


<div id="score-sheet-modal"
     class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white w-full max-w-6xl max-h-[95vh] mx-4 rounded-2xl shadow-2xl
              flex flex-col overflow-hidden">
    <div class="flex items-center justify-between px-5 py-3 border-b border-slate-200">
      <div>
        <div class="text-xs text-slate-500">แบบฟอร์มใบลงคะแนน</div>
        <div id="score-sheet-title" class="text-base font-semibold text-slate-800">
          -
        </div>
        <div id="score-sheet-subtitle" class="text-[11px] text-slate-500">
          -
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button"
                onclick="printScoreSheet()"
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full
                       bg-emerald-500 text-white text-xs font-semibold shadow-sm
                       hover:bg-emerald-600">
          <span class="material-symbols-outlined text-[16px] leading-none">print</span>
          <span>พิมพ์ใบลงคะแนน</span>
        </button>
        <button type="button"
                onclick="closeScoreSheetModal()"
                class="w-8 h-8 flex items-center justify-center rounded-full
                       bg-slate-100 hover:bg-slate-200 text-slate-600">
          <span class="material-symbols-outlined text-[18px] leading-none">close</span>
        </button>
      </div>
    </div>

    <div id="score-sheet-body"
         class="px-5 py-3 overflow-auto bg-slate-50">
      <!-- สร้างด้วย JS -->
    </div>
  </div>
</div>

<div id="judge-timesheet-modal"
     class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white w-full max-w-4xl max-h-[95vh] mx-4 rounded-2xl shadow-2xl
              flex flex-col overflow-hidden">
    <div class="flex items-center justify-between px-5 py-3 border-b border-slate-200">
      <div>
        <div class="text-xs text-slate-500">ใบลงเวลาของกรรมการ</div>
        <div id="judge-timesheet-title" class="text-base font-semibold text-slate-800">-</div>
        <div id="judge-timesheet-subtitle" class="text-[11px] text-slate-500">-</div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button"
                onclick="printJudgeTimesheet()"
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full
                       bg-amber-500 text-white text-xs font-semibold shadow-sm
                       hover:bg-amber-600">
          <span class="material-symbols-outlined text-[16px] leading-none">print</span>
          <span>พิมพ์ใบลงเวลา</span>
        </button>
        <button type="button"
                onclick="closeJudgeTimesheetModal()"
                class="w-8 h-8 flex items-center justify-center rounded-full
                       bg-slate-100 hover:bg-slate-200 text-slate-600">
          <span class="material-symbols-outlined text-[18px] leading-none">close</span>
        </button>
      </div>
    </div>
    <div id="judge-timesheet-body"
         class="px-5 py-3 overflow-auto bg-slate-50">
      <!-- render by JS -->
    </div>
  </div>
</div>


<script>
    // --- Global State ---
    let ALL_ACTIVITIES = [];
    let ALL_TEAMS = [];
    let CURRENTLY_VISIBLE_TEAMS = []; 
    let CURRENT_STEP = 1;
    let LOGO_FILE_DATA = null;
    let TEAM_PHOTO_FILE_DATA = null;
    let USER_AVATAR_FILE_DATA = null;
    let PROFILE_AVATAR_FILE_DATA = null;
    let signupAvailabilityState = {
        username: { status: 'idle', value: '', available: false },
        email: { status: 'idle', value: '', available: false }
    };
    let signupAvailabilityTimer = null;
    let isSignupBusy = false;
    const SIGNUP_HINT_DEFAULTS = {
        username: 'ใช้ตัวอักษรภาษาอังกฤษหรือตัวเลข ระบบจะตรวจสอบความซ้ำอัตโนมัติ',
        email: 'ใช้อีเมลที่ติดต่อได้จริง ระบบจะตรวจสอบว่าไม่ซ้ำ'
    };
    const STAGE_COPY = {
        cluster: {
            chipLabel: 'รอบกลุ่มเครือข่าย',
        summaryLabels: {
            teams: 'ทีมของคุณ',
            teachers: 'ครูผู้ควบคุม',
            students: 'นักเรียน',
            all: 'รวมทั้งหมด'
        },
        totalsLabels: {
            teams: 'ทีมทั้งหมด',
            teachers: 'ครูทั้งหมด',
            students: 'นักเรียนทั้งหมด',
            all: 'รวมสมาชิก'
        },
        totalsHint: 'สะสมจากทุกโรงเรียนในรอบกลุ่มเครือข่าย',
        leaderboardHint: 'ผลการแข่งขันรอบกลุ่มเครือข่าย เรียงตามเหรียญรวม'
    },
    area: {
        chipLabel: 'รอบระดับเขต',
        summaryLabels: {
            teams: 'ทีมตัวแทนของคุณ',
            teachers: 'ครูตัวแทน',
            students: 'นักเรียนตัวแทน',
            all: 'ผู้แทนรวมทั้งหมด'
        },
        totalsLabels: {
            teams: 'ทีมตัวแทนทั้งหมด',
            teachers: 'ครูตัวแทน',
            students: 'นักเรียนตัวแทน',
            all: 'ผู้แทนในรอบระดับเขต'
        },
        totalsHint: 'แสดงจำนวนตัวแทนที่ผ่านเข้าสู่รอบระดับเขต',
        leaderboardHint: 'สรุปผลการแข่งขันรอบระดับเขต เรียงตามเหรียญรวม'
    }
};
    const assignmentModalState = {
        school: null,
        selectedMap: new Map(),
        filter: ''
    };
    const schoolManagementState = {
        search: ''
    };
    let PERSONAL_PASS_CTX = null; 
    const MEMBER_PHOTO_DATA = {};
    const homeActivityState = {
        search: '',
        category: '',
        visibleCount: 9,
        pageSize: 9
    };
    // ตั้งค่าเริ่มต้นสำหรับใบลงคะแนน
    const SCORE_SHEET_CONFIG = {
      defaultScoreCols: 10,  // จำนวนช่องคะแนนเริ่มต้น
      defaultJudges: 3       // จำนวนกรรมการเริ่มต้น
    };
    const SCORE_SHEET_PROMPT_STATE = {
      judges: SCORE_SHEET_CONFIG.defaultJudges || 3,
      scoreCols: SCORE_SHEET_CONFIG.defaultScoreCols || 10,
      showJudgeNames: true,
      judgeSelections: {}
    };
    const AREA_TRANSFER_ALLOWED_ROLES = ['admin', 'area', 'group_admin'];
    const AREA_TRANSFER_BATCH_SIZE = 10;

    const JUDGE_SAMPLE_FILES = {
        csv: {
            name: 'judge-import-sample.csv',
            mime: 'text/csv;charset=utf-8',
            base64: 'dUZFRkZBY3Rpdml0eUlELENsdXN0ZXJLZXksQ2x1c3RlckxhYmVsLFNjaG9vbElELFNjaG9vbE5hbWUsSnVkZ2VOYW1lLFJvbGUsUGhvbmUsRW1haWwNCkFDVDAwMSxDTDAwMSzguKDguLLguITguYDguKvguJnguLfguK0sU0NIMDAxLOC5guC4o+C4h+C5gOC4o+C4teC4ouC4meC4quC4suC4mOC4tOC4leC4oeC4q+C4suC4p+C4tOC4l+C4ouC4suC4peC4seC4ouC5gOC4iuC4teC4ouC4h+C5g+C4q+C4oeC5iCzguITguKPguLnguKrguLjguYDguKHguJgs4Lib4Lij4Liw4LiY4Liy4LiZ4LiB4Lij4Lij4Lih4LiB4Liy4LijLDA4MTIzNDU2NzgsY2hhaXJAZXhhbXBsZS5jb20NCkFDVDAwMSxDTDAwMSzguKDguLLguITguYDguKvguJnguLfguK0sU0NIMDA1LOC5guC4o+C4h+C5gOC4o+C4teC4ouC4meC4nuC4tOC4qeC4k+C4uOC5guC4peC4geC4nuC4tOC4l+C4ouC4suC4hOC4oSzguITguKPguLnguKfguKPguLHguI3guI3guLIs4LiB4Lij4Lij4Lih4LiB4Liy4LijLDA4OTk5OTExMTEsanVkZ2UxQGV4YW1wbGUuY29tDQpBQ1QwMDIsQ0wwMDEs4Lig4Liy4LiE4LmA4Lir4LiZ4Li34LitLFNDSDAxMCzguYLguKPguIfguYDguKPguLXguKLguJnguKvguKPguLTguKDguLjguI3guIrguLHguKLguKfguLTguJfguKLguLLguITguKEs4LiE4Lij4Li54Lit4Lij4LiX4Lix4LiiLOC5gOC4peC4guC4suC4meC4uOC4geC4suC4oywwODIzNDU2Nzg5LGp1ZGdlMkBleGFtcGxlLmNvbQ0KQUNUMDAzLENMMDAyLOC4oOC4suC4hOC4leC4sOC4p+C4seC4meC4reC4reC4gSxTQ0gxMDEs4LmC4Lij4LiH4LmA4Lij4Li14Lii4LiZ4LiK4Lil4Lia4Li44Lij4Li14Liq4Li44LiC4Lio4Li24LiB4Lip4LiyLOC4hOC4o+C4ueC4reC4tOC4quC4o+C4tOC4ouC4sizguIHguKPguKPguKHguIHguLLguKPguIHguKXguLLguIcsMDg5ODg4MzMzMyxqdWRnZTNAZXhhbXBsZS5jb20NCkFDVDAwMyxDTDAwMizguKDguLLguITguJXguLDguKfguLHguJnguK3guK3guIEsU0NIMTA5LOC5guC4o+C4h+C5gOC4o+C4teC4ouC4meC4muC5ieC4suC4meC4muC4tuC4hyzguITguKPguLnguJTguJnguLHguKIs4LiB4Lij4Lij4Lih4LiB4Liy4LijLDA4Njk4NzY1NDMsanVkZ2U0QGV4YW1wbGUuY29tDQo='
        },
        xlsx: {
            name: 'judge-import-sample.xlsx',
            mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            base64: 'UEsDBBQAAAAIABW5dFt80ApjxAAAADoBAAAQAAAAZG9jUHJvcHNcYXBwLnhtbJ2PMW7DMAxFd59C0J7I7VAEgeqgQNutQIekuyDRsQCbFEQ2cM7WoUfKFcJ0SDKXG/8DHvlPP79+M0+jOUDlTPhs7cOytdYARkoZ9xrstu+LlUYsAVMYCUHDI7C1m67xn5UKVMnARj3IygaRsnaO4wBT4KVyVNRTnYLoWveO+j5HeKX4PQGKe2zbJwezACZIi3I1WtuYu/nzrw/y7xOJ4uVd/toey8Xeqd6/lDLmGETbdx85VmLqxbzNEUbv7mHj3a1sdwZQSwMEFAAAAAgAFbl0W3eTRy8WAQAAIwIAABEAAABkb2NQcm9wc1xjb3JlLnhtbIWRTU7DMBCF9zmF5X3iBCSEopCKDRIIJERBYmvZQ2rhn5E9Je3ZWHAkroAbaLtoVbzzvPe+keZ9f351s5Wz7ANiMsFfcd5UNecMvAra+CEPXp5vyss8SiS9ljZ4yMM1JM5nfdEpbFWI8BgDQiQDiWWcT63C7FoQYStEUgtwMlXZ4rP6FqKTlL9xECjVuxxAnNX1hXBAUkuSYkMscYfkvGCH73ePVvs9uIx2omolwIIDT0k0VSNOAwiiS8cpk/RP3BlaIxzPb9WTiFUy+/Q4jtV4PuXzTRrx+nA/n85XGr9pQAHnfWZ1WrVkyEJ/t9QDsFuHIRKbS4cWOrFT/6wqgqQQ+ycYTKIoKZfNrhEn51YsOnFQZ/8DUEsDBBQAAAAIABW5dFvDV6yy0wAAAEUBAAAPAAAAeGxcd29ya2Jvb2sueG1sjZAxbsMwDEX3nELQnsjNUBSG6yxFgGRuD6BatC3EIg1SSdqzdeiReoXSCtK5nPg/gUd+/nx9N7uPNJkLsETCZ2sfNpW1BrCjEHFQ4+11v35SS7LH4CdCUPMTxNpdu2quxKd3opNRCopOxpzn2jnpRkheNjQD6qgnTj6r5MHJzOCDjAA5TW5bVY8u+YjWrsxfFVrN/+JR38cOXqg7J8B8AzJMPmsgGeOsl7aKbspGacuWmzDo05LmeA7DEsgU9xCWN6jiOi4tH4IqVxjuDmncPXn7C1BLAwQUAAAACAAVuXRbsOy2D2QCAAANCQAAGAAAAHhsXHdvcmtzaGVldHNcc2hlZXQxLnhtbKWWYWvTQBjH3+9ThLy3SVo36zgzZ9q56Rhi5wc402sTTXIluW7rOzsHDsFXIm4IYi0yVAQdild84Ve5b+BX8OkzVmXTp0WPvrg8yf93zx2/0Pz49p0t7aSJtSXyIpbZFdv2Sq5tWyILZTPO2lC4s7lyoQqlQvGsyROZCSj2RGHbS/4c25b5/SISQlmAyQq4FSnVWXScIoxEyouS7IgMbrVknnIFl3nbKTq54E1MpYlTdt0FJ+VxZttz1q+BuMV8JqBsteJQ1GTYTUWmToi5SLiCLRVR3IFefWAzXLLGFfdxJZbLbWu8gndyH2shVpahZCmYxFkSZ6KhcniExYXPlL8cqngrVr21GnOUz5xx1QnPAK4RgCDpFkrkN0WPAATTAev8rkgIRI1ANMJIyoTcQn1qfIOnggCsEIAb3WZbTMlfJ/K3ZUJFV4norQgcJrJrRLYOov7hyJkDKp2RqnxeqjIhVbDpuh4lFBEO1ulsQGSNfmX0sdF7ZvTA6PdGHxr91egPlFcErhGs0r3UqV5Gu0YPjX6EvcDki9GvsaN32OOB0Z+Nfmb0ADuFyhFWnuNjcPnG6E/j+Tj++DQOtIf4/MCM9ildyVPaw4ZG2IrGBaCJA8peEvcCcR9xT9D4IeUyAXKrXrlycX7hUpUSmgCEEY/zq2KHp51ElEKZziZ35bzclf+RmwhPlZvI/ovcBA7lnqfkpnr5q9wvUeK3Rj9FtXbR4/5pfSI3GDig9CXPYaLvEU7gLXmCv2PKYJLYR9AQ34M+NjikJCZYbvUyDA8GJTEBuDf+M/FmtJg5v30GMGfyAeP/BFBLAwQUAAAACAAVuXRbQb3dOcMAAAA+AQAAGgAAAHhsXF9yZWxzXHdvcmtib29rLnhtbC5yZWxzjY89DsIwDIV3ThF5p24ZEEJQFoTEisoBotT9EW0SxeGnZ2PgSFwBw4BAYmCy/J78Pb/79bZYXfpOnShw6+wSIEtSAEXWuLK1tQj7YjOeicRR21J3zpKIAzHAKh8tdtTpKJfctJ6VoCyL3cTo54hsGuo1J86TFatyoddR1lCj1+aga8JJmk4xfEIA8pFSX2C1LQUatmUmfxSDp78iXFW1htbOHHuy8UcSnl04cEMUn1gdaooCfouMr5ElwgVAKYtfbfMHUEsDBBQAAAAIABW5dFsnExIpwAAAAD0BAAALAAAAX3JlbHNcLnJlbHONjz0OwjAMhXdOEXmnaRkQQtAuCIkVwQFC6v6oaRwlAdqzMXAkroDZADEw+j37e36P231VDL0RF/ShJbsGyJIUQKDVVLa2ZuF42E4XLIWobKkMWWRxxABQ5JPVHo2KfBma1gXBKBvYbmJ0SymDbrBXISGHlq2KfK8ij76WTulO1ShnaTqX/h0CkE+E+ACLXclQvysz/uMwOvwrgqqq1bghfe7Rxh9JXxsvtvI1RqYPRl7JdyeiLmEsgOSu8qNs/gRQSwMEFAAAAAgAFbl0WzMStwomAQAAPwMAABMAAABbQ29udGVudF9UeXBlc10ueG1srVM7TsMwGN57CstrFbtlQAiFdOAxQodyAGP/Saz4Jdst4WwMHIkr8CcUhFBLK9TJsr+nX++vb+Wit4ZsICbt3RWlczajlICTXmnX4MLj6q64oHRRTcrVS4BEkO8SAm3O4ZLzJFuwIjEfwCFU+2hFxmlseBCyEw3ws9nsnEvvMrhc5MGE0mpCSHkDtVibTG57hLYFIhiEyfUnfYjERRGC0VJkpPCNU7/Cim0QQ+3ISa0OaYoESvneoBH+I+eH/AHPJ2oFZClivhd2oPLe8GcfuyfvO3bIa0dnX9dagvJybVHDUoggVGoBsjVsHJkV2k2PrDEqEh+H+cn7fCccrIMGy+hDwvuO8J8eX3c56IuAVhCzhnR8MPqfYP8wvBQFaleFko8/ofoAUEsBAhQAFAAAAAgAFbl0W3zQCmPEAAAAOgEAABAAAAAAAAAAAAAAAAAAAAAAAGRvY1Byb3BzXGFwcC54bWxQSwECFAAUAAAACAAVuXRbd5NHLxYBAAAjAgAAEQAAAAAAAAAAAAAAAADyAAAAZG9jUHJvcHNcY29yZS54bWxQSwECFAAUAAAACAAVuXRbw1esstMAAABFAQAADwAAAAAAAAAAAAAAAAA3AgAAeGxcd29ya2Jvb2sueG1sUEsBAhQAFAAAAAgAFbl0W7Dstg9kAgAADQkAABgAAAAAAAAAAAAAAAAANwMAAHhsXHdvcmtzaGVldHNcc2hlZXQxLnhtbFBLAQIUABQAAAAIABW5dFtBvd05wwAAAD4BAAAaAAAAAAAAAAAAAAAAANEFAAB4bFxfcmVsc1x3b3JrYm9vay54bWwucmVsc1BLAQIUABQAAAAIABW5dFsnExIpwAAAAD0BAAALAAAAAAAAAAAAAAAAAMwGAABfcmVsc1wucmVsc1BLAQIUABQAAAAIABW5dFszErcKJgEAAD8DAAATAAAAAAAAAAAAAAAAALUHAABbQ29udGVudF9UeXBlc10ueG1sUEsFBgAAAAAHAAcAwgEAAAwJAAAAAA=='
        }
    };

    let JUDGE_ASSIGNMENTS = [];
    let hasLoadedJudgeAssignments = false;
    let isLoadingJudgeAssignments = false;
    let lastJudgeFetch = 0;
    const JUDGE_FETCH_COOLDOWN_MS = 30000;
    const judgeManualState = {
        activityId: '',
        clusterKey: '',
        clusterLabel: '',
        panel: null,
        mode: 'create',
        rowNumber: null,
        stageScope: 'cluster'
    };
    const judgeTimesheetState = {
        activityId: '',
        isOpen: false
    };
    const EXTERNAL_JUDGE_SCHOOL_ID = '__EXTERNAL__';
    const EXTERNAL_JUDGE_SCHOOL_LABEL = 'กรรมการภายนอก';
    const EXTERNAL_JUDGE_SCHOOL_SELECT_LABEL = 'กรรมการภายนอก (ไม่สังกัดโรงเรียน)';
    const expandedActivityIds = new Set();
    let pendingActivityScrollId = '';
    let judgeActionLoadingActive = false;
    let pendingScoreDutyFocusId = '';
    let isScoreDutyBlocked = false;
    let scoreDutyFocusPending = false;
    let scoreDutyFocusReady = false;
    let scoreDutyBlockReleasePending = false;
    
    let homeSearchDebounce = null;
    let teamSearchTerm = '';
    let teamSearchDebounce = null;
    let isLoadingActivities = false;
    let isLoadingTeams = false;
    let isLoadingReport = false;
    let suppressCategorySync = false;
    const FETCH_COOLDOWN_MS = 30000;
    let lastActivitiesFetch = 0;
    let lastTeamsFetch = 0;
    let lastReportFetch = 0;
    let cachedReport = null;
    let latestReportData = null;
    let SCHOOL_OPTIONS = [];
    let SCHOOL_LOOKUP_BY_NAME = new Map();
    let SCHOOL_LOOKUP_BY_ID = new Map();
    let isLoadingSchools = false;
    let lastSchoolFetch = 0;
    const SCHOOL_FETCH_COOLDOWN_MS = 60000;
    let SCHOOL_CLUSTER_LOOKUP = new Map();
    let currentUser = null;
    let isAppAdmin = false;
    const AUTH_STORAGE_KEY = 'registration-app-user';
    let isProfileMenuOpen = false;
    let navSignupFormVisible = false;
    let navAuthBusyState = { login: false, signup: false };
    let activeManagedTeam = null;
    let managedTeamMembers = { teachers: [], students: [] };
    let teamManageEditable = false;
    let teamManageStatusEditable = false;
    let teamManageImageEditable = false;
    let teamManageLogoFileData = null;
    let teamManagePhotoFileData = null;
    let MANAGED_USERS = [];
    let managedUsersLoadAttempted = false;
    let hasLoadedManagedUsers = false;
    let userManagementSearchTerm = '';
    let MANAGED_SCHOOLS = [];
    let isLoadingManagedUsers = false;
    let isLoadingManagedSchools = false;
    let userFormMode = 'create';
    let isSavingManagedUser = false;
    let isUpdatingSchoolMode = false;
    let isUpdatingSchoolCluster = false;
    const TEAM_MANAGE_MEMBER_PHOTO_DATA = {};
    const SCORE_ASSIGNMENT_SAVING = new Set();
    let homeCountdownInterval = null;
    let homeCountdownElements = [];
    const DEADLINE_WARNING_HOURS = 72;
    let scoreAssignmentActivityCache = { options: [], categories: [] };
    let teamManageStatusMode = 'none';
    let teamManageStageScope = 'cluster';
    let teamManageStageAvailable = false;
    let teamManageData = { cluster: null, area: null };
    let competitionResultsCache = null;
    let schoolRepresentativeStats = new Map();
    const competitionFilterState = {
        activity: '',
        school: '',
        medal: '',
        onlyRepresentative: false
    };
    let competitionStage = 'cluster';
    let hasCompetitionStageInfo = false;
    let isSavingCompetitionStage = false;
    let isAreaTransferInProgress = false;
    let scoreEntryState = {
        activityId: null,
        teams: [],
        initialScores: new Map(),
        initialRepresentative: '',
        selectedRepresentative: '',
        dirty: false
    };
    let SCORE_ASSIGNED_ACTIVITIES = [];
    let scoreDutySearchTerm = '';
    let scoreDutySearchDebounce = null;
    let isSavingScoreEntries = false;
    const CLASS_LEVEL_OPTIONS = [
        'อนุบาล 1', 'อนุบาล 2', 'อนุบาล 3',
        'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6',
        'ม.1', 'ม.2', 'ม.3', 'ม.4', 'ม.5', 'ม.6',
        'ปวช.1', 'ปวช.2', 'ปวช.3'
    ];

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const globalStageIndicator = document.getElementById('global-stage-indicator');
    const globalStageText = document.getElementById('global-stage-text');
    const globalStageChip = document.getElementById('global-stage-chip');
    const sections = document.querySelectorAll('.app-section');
    const navItems = document.querySelectorAll('.nav-item');
    const navProfileWrapper = document.getElementById('nav-profile-wrapper');
    const navProfileButton = document.getElementById('nav-profile-button');
    const navProfileAvatar = document.getElementById('nav-profile-avatar');
    const navProfileAvatarFallback = document.getElementById('nav-profile-avatar-fallback');
    const navProfileLabel = document.getElementById('nav-profile-label');
    const navProfileMenu = document.getElementById('nav-profile-menu');
    const navProfileMenuGuest = document.getElementById('nav-profile-menu-guest');
    const navProfileMenuUser = document.getElementById('nav-profile-menu-user');
    const navProfileMenuAvatar = document.getElementById('nav-profile-menu-avatar');
    const navProfileMenuAvatarFallback = document.getElementById('nav-profile-menu-avatar-fallback');
    const navProfileMenuName = document.getElementById('nav-profile-menu-name');
    const navProfileMenuRole = document.getElementById('nav-profile-menu-role');
    const navProfileMenuSchool = document.getElementById('nav-profile-menu-school');
    const navProfileAvatarEditor = document.getElementById('nav-profile-avatar-editor');
    const navProfileAvatarInput = document.getElementById('nav-profile-avatar-input');
    const navProfileAvatarStatus = document.getElementById('nav-profile-avatar-status');
    const navProfileAvatarSubmit = document.getElementById('nav-profile-avatar-submit');
    const navProfileApprovalHint = document.getElementById('nav-profile-approval-hint');
    const navProfileAdminLink = document.getElementById('nav-profile-admin-link');
    const navProfileLogoutButton = document.getElementById('nav-profile-logout');
    const navLoginForm = document.getElementById('nav-login-form');
    const navLoginUsernameInput = document.getElementById('nav-login-username');
    const navLoginPasswordInput = document.getElementById('nav-login-password');
    const navLoginStatus = document.getElementById('nav-login-status');
    const navLoginSubmitButton = document.getElementById('nav-login-submit');
    const navSignupToggle = document.getElementById('nav-signup-toggle');
    const navSignupToggleIcon = document.getElementById('nav-signup-toggle-icon');
    const navSignupToggleLabel = document.getElementById('nav-signup-toggle-label');
    const navSignupForm = document.getElementById('nav-signup-form');
    const navSignupStatus = document.getElementById('nav-signup-status');
    const navSignupSubmitButton = document.getElementById('nav-signup-submit');
    const navSignupNameInput = document.getElementById('nav-signup-name');
    const navSignupSurnameInput = document.getElementById('nav-signup-surname');
    const navSignupUsernameInput = document.getElementById('nav-signup-username');
    const navSignupPasswordInput = document.getElementById('nav-signup-password');
    const navSignupConfirmInput = document.getElementById('nav-signup-confirm');
    const navSignupEmailInput = document.getElementById('nav-signup-email');
    const navSignupTelInput = document.getElementById('nav-signup-tel');
    const navSignupSchoolSelect = document.getElementById('nav-signup-school');
    const homeActivitySearchInput = document.getElementById('home-activity-search');
    const homeActivityContainer = document.getElementById('home-activity-container');
    const homeActivityMeta = document.getElementById('home-activity-meta');
    const homeActivityLoadMoreBtn = document.getElementById('home-activity-load-more');
    const homeActivityEmpty = document.getElementById('home-activity-empty');
    const homeCategoryFilter = document.getElementById('home-category-filter');
    const activityContainer = document.getElementById('activity-container');
    const activityLoading = document.getElementById('activity-loading');
    const teamTableBody = document.getElementById('team-table-body');
    const areaTransferButton = document.getElementById('area-transfer-button');
    const teamScopeBanner = document.getElementById('team-scope-banner');
    const teamScopeText = document.getElementById('team-scope-text');
    const teamInsightsWrapper = document.getElementById('team-insights');
    const teamRepresentativeCountEl = document.getElementById('team-insight-representatives');
    const teamMedalCountEl = document.getElementById('team-insight-medals');
    const teamMedalBreakdownEl = document.getElementById('team-insight-medals-breakdown');
    const reportTableBody = document.getElementById('report-table-body');
    const reportUserSummary = document.getElementById('report-user-summary');
    const reportUserSummaryHint = document.getElementById('report-user-summary-hint');
    const reportUserTotals = {
        teams: document.getElementById('report-user-total-teams'),
        teachers: document.getElementById('report-user-total-teachers'),
        students: document.getElementById('report-user-total-students'),
        all: document.getElementById('report-user-total-all')
    };
    const reportUserSummaryStage = document.getElementById('report-user-summary-stage');
    const reportUserSummaryLabels = {
        teams: document.getElementById('report-user-teams-label'),
        teachers: document.getElementById('report-user-teachers-label'),
        students: document.getElementById('report-user-students-label'),
        all: document.getElementById('report-user-all-label')
    };
    const scoreDutySummary = document.getElementById('score-duty-summary');
    const scoreDutyHint = document.getElementById('score-duty-hint');
    const scoreDutyList = document.getElementById('score-duty-list');
    const scoreDutySearchWrapper = document.getElementById('score-duty-search-wrapper');
    const scoreDutySearchInput = document.getElementById('score-duty-search');
    const reportTotalsGrid = document.getElementById('report-totals-grid');
    const reportTotalsStage = document.getElementById('report-totals-stage');
    const reportTotalsHint = document.getElementById('report-totals-hint');
    const reportTotalsLabels = {
        teams: document.getElementById('report-totals-teams-label'),
        teachers: document.getElementById('report-totals-teachers-label'),
        students: document.getElementById('report-totals-students-label'),
        all: document.getElementById('report-totals-all-label')
    };
    const areaScoreCard = document.getElementById('area-score-card');
    const areaScoreActivitySelect = document.getElementById('area-score-activity');
    const areaScoreStartButton = document.getElementById('area-score-start');
    const areaScoreHelper = document.getElementById('area-score-helper');
    const areaScoreStageLabel = document.getElementById('area-score-stage-label');
    const competitionResultsWrapper = document.getElementById('competition-results-wrapper');
    const competitionStatsGrid = document.getElementById('competition-stats-grid');
    const competitionResultsBody = document.getElementById('competition-results-body');
    const competitionRepresentativeWrapper = document.getElementById('competition-representative-wrapper');
    const competitionRepresentativeBody = document.getElementById('competition-representative-body');
    const competitionAreaWrapper = document.getElementById('competition-area-wrapper');
    const competitionAreaBody = document.getElementById('competition-area-body');
    const competitionStageCard = document.getElementById('competition-stage-card');
    const competitionStageStatus = document.getElementById('competition-stage-status');
    const competitionStageControls = document.getElementById('competition-stage-controls');
    const competitionStageSelect = document.getElementById('competition-stage-select');
    const competitionStageSaveBtn = document.getElementById('competition-stage-save');
    const competitionStageNote = document.getElementById('competition-stage-note');
    const competitionStageSaveDefault = competitionStageSaveBtn ? competitionStageSaveBtn.innerHTML : '';
    const competitionFilterActivity = document.getElementById('competition-filter-activity');
    const competitionFilterSchool = document.getElementById('competition-filter-school');
    const competitionFilterMedal = document.getElementById('competition-filter-medal');
    const competitionFilterRepresentative = document.getElementById('competition-filter-representative');
    const competitionFilterResetBtn = document.getElementById('competition-filter-reset');
    const clusterLeaderboardWrapper = document.getElementById('cluster-leaderboard-wrapper');
    const clusterLeaderboardContent = document.getElementById('cluster-leaderboard-content');
    const leaderboardStageChip = document.getElementById('leaderboard-stage-chip');
    const leaderboardDescription = document.getElementById('leaderboard-description');
    const scoreEntryModal = document.getElementById('score-entry-modal');
    const scoreEntryTitle = document.getElementById('score-entry-title');
    const scoreEntrySubtitle = document.getElementById('score-entry-subtitle');
    const scoreEntryBody = document.getElementById('score-entry-body');
    const scoreEntrySubmit = document.getElementById('score-entry-submit');
    const scoreEntryLoadingOverlay = document.getElementById('score-entry-loading-overlay');
    const schoolAwardModal = document.getElementById('school-award-modal');
    const schoolAwardTitle = document.getElementById('school-award-title');
    const schoolAwardSubtitle = document.getElementById('school-award-subtitle');
    const schoolAwardBody = document.getElementById('school-award-body');
    const schoolAwardPrintButton = document.getElementById('school-award-print-button');
    const registrationAssignmentMessage = document.getElementById('registration-assignment-message');
    const schoolAssignmentModal = document.getElementById('school-assignment-modal');
    const schoolAssignmentTitle = document.getElementById('school-assignment-title');
    const schoolAssignmentSubtitle = document.getElementById('school-assignment-subtitle');
    const schoolAssignmentSearch = document.getElementById('school-assignment-search');
    const schoolAssignmentList = document.getElementById('school-assignment-list');
    const schoolAssignmentClose = document.getElementById('school-assignment-close');
    const schoolAssignmentCancel = document.getElementById('school-assignment-cancel');
    const schoolAssignmentSave = document.getElementById('school-assignment-save');
    const schoolAssignmentSaveDefault = schoolAssignmentSave ? schoolAssignmentSave.innerHTML : '';
    const adminReviewList = document.getElementById('admin-file-review-list');
    const judgeManualModal = document.getElementById('judge-manual-modal');
    const judgeManualForm = document.getElementById('judge-manual-form');
    const judgeManualTitle = document.getElementById('judge-manual-title');
    const judgeManualSubtitle = document.getElementById('judge-manual-subtitle');
    const judgeManualCopyWrapper = document.getElementById('judge-manual-copy-wrapper');
    const judgeManualCopySelect = document.getElementById('judge-manual-copy');
    const judgeManualSchoolSelect = document.getElementById('judge-manual-school');
    const judgeManualNameInput = document.getElementById('judge-manual-name');
    const judgeManualRoleInput = document.getElementById('judge-manual-role');
    const judgeManualPhoneInput = document.getElementById('judge-manual-phone');
    const judgeManualEmailInput = document.getElementById('judge-manual-email');
    const judgeManualSubmit = document.getElementById('judge-manual-submit');
    const judgeManualSubmitIcon = document.getElementById('judge-manual-submit-icon');
    const judgeManualSubmitLabel = document.querySelector('#judge-manual-submit [data-judge-submit-label]');
    const judgeManualSpinner = document.getElementById('judge-manual-spinner');
    const judgeManualStatus = document.getElementById('judge-manual-status');
    const judgeManualCancel = document.getElementById('judge-manual-cancel');
    const judgeManualClose = document.getElementById('judge-manual-close');
    const judgeTimesheetModal = document.getElementById('judge-timesheet-modal');
    const judgeTimesheetBody = document.getElementById('judge-timesheet-body');
    const judgeTimesheetTitle = document.getElementById('judge-timesheet-title');
    const judgeTimesheetSubtitle = document.getElementById('judge-timesheet-subtitle');
    updateCompetitionStageUI();
    if (clusterLeaderboardContent) {
        clusterLeaderboardContent.addEventListener('click', handleClusterLeaderboardAction);
    }
    const adminLoading = document.getElementById('admin-loading');
    const reportManagementWrapper = document.getElementById('report-management-wrapper');
    const userManagementContent = document.getElementById('user-management-content');
    const userManagementStatus = document.getElementById('user-management-status');
    const userManagementClusterNote = document.getElementById('user-management-cluster-note');
    const userManagementRefreshBtn = document.getElementById('user-management-refresh');
    const userManagementActions = document.getElementById('user-management-actions');
    const userManagementAddButton = document.getElementById('user-management-add');
    const userManagementForm = document.getElementById('user-management-form');
    const userManagementCancelLink = document.getElementById('user-management-cancel');
    const userManagementSearchInput = document.getElementById('user-management-search');
    const userFormTitle = document.getElementById('user-form-title');
    const userFormUserId = document.getElementById('user-form-userid');
    const userFormUsername = document.getElementById('user-form-username');
    const userFormLevel = document.getElementById('user-form-level');
    const userFormName = document.getElementById('user-form-name');
    const userFormSurname = document.getElementById('user-form-surname');
    const userFormEmail = document.getElementById('user-form-email');
    const userFormTel = document.getElementById('user-form-tel');
    const userFormPassword = document.getElementById('user-form-password');
    const userFormPasswordConfirm = document.getElementById('user-form-password-confirm');
    const userFormSchoolSelect = document.getElementById('user-form-school');
    const userFormSubmitBtn = document.getElementById('user-form-submit-btn');
    const userFormSubmitLabel = userFormSubmitBtn ? userFormSubmitBtn.querySelector('span:last-child') : null;
    const userFormCancelBtn = document.getElementById('user-form-cancel-btn');
    const schoolManagementContent = document.getElementById('school-management-content');
    const schoolManagementStatus = document.getElementById('school-management-status');
    const schoolManagementSearchInput = document.getElementById('school-management-search');
    const schoolManagementRefreshBtn = document.getElementById('school-management-refresh');
    const scoreAssignmentCard = document.getElementById('score-assignment-card');
    const scoreAssignmentContent = document.getElementById('score-assignment-content');
    const scoreAssignmentSummary = document.getElementById('score-assignment-activity-summary');
    const scoreAssignmentRefreshBtn = document.getElementById('score-assignment-refresh');

    const TEAM_MEDAL_CONFIG = [
        { key: 'gold', label: 'เหรียญทอง', min: 80 },
        { key: 'silver', label: 'เหรียญเงิน', min: 70 },
        { key: 'bronze', label: 'เหรียญทองแดง', min: 60 },
        { key: 'merit', label: 'ชมเชย', min: 50 }
    ];
    const TEAM_MEDAL_CONFIG_MAP = TEAM_MEDAL_CONFIG.reduce((acc, item) => {
        acc[item.key] = item;
        return acc;
    }, {});
    const TEAM_MEDAL_KEYS = TEAM_MEDAL_CONFIG.map(item => item.key);

    // Form elements
    const form = document.getElementById('registration-form');
    const formSteps = document.querySelectorAll('.form-step');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    const activityCategorySelect = document.getElementById('form-activity-category');
    const activitySelect = document.getElementById('form-activity');
    const levelSelect = document.getElementById('form-level');
    const schoolInput = document.getElementById('form-school');
    const schoolOptionsList = document.getElementById('school-options');
    const logoInput = document.getElementById('form-logo');
    const logoStatus = document.getElementById('logo-status');
    const formLogoPreview = document.getElementById('form-logo-preview');
    const formLogoPlaceholder = document.getElementById('form-logo-placeholder');
    const teamPhotoInput = document.getElementById('form-team-photo');
    const teamPhotoPreview = document.getElementById('team-photo-preview');
    const teamPhotoPlaceholder = document.getElementById('team-photo-placeholder');
    const teamPhotoStatus = document.getElementById('team-photo-status');
    const memberReqText = document.getElementById('member-requirements');
    const teacherFields = document.getElementById('teacher-fields');
    const studentFields = document.getElementById('student-fields');
    const submitButton = document.getElementById('form-submit-button');

    // Upload elements
    const uploadButton = document.getElementById('upload-button');
    const fileInput = document.getElementById('file-input');
    const uploadTeamIdSelect = document.getElementById('upload-team-id');
    const uploadFileTypeSelect = document.getElementById('upload-file-type');
    const uploadStatusDiv = document.getElementById('upload-status');
    const teamSearchInput = document.getElementById('team-search');
    const authSignupForm = document.getElementById('auth-signup-form');
    const authLoginForm = document.getElementById('auth-login-form');
    const authSchoolSelect = document.getElementById('auth-school-select');
    const signupStatus = document.getElementById('signup-status');
    const loginStatus = document.getElementById('login-status');
    const signupNameInput = document.getElementById('signup-name');
    const signupSurnameInput = document.getElementById('signup-surname');
    const signupTelInput = document.getElementById('signup-tel');
    const signupEmailInput = document.getElementById('signup-email');
    const signupAvatarInput = document.getElementById('signup-avatar');
    const signupAvatarPreview = document.getElementById('signup-avatar-preview');
    const signupAvatarPlaceholder = document.getElementById('signup-avatar-placeholder');
    const signupAvatarStatus = document.getElementById('signup-avatar-status');
    const signupUsernameInput = document.getElementById('signup-username');
    const signupPasswordInput = document.getElementById('signup-password');
    const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
    const signupUsernameHint = document.getElementById('signup-username-hint');
    const signupEmailHint = document.getElementById('signup-email-hint');
    const signupSubmitButton = document.getElementById('signup-submit-button');
    const signupLoadingOverlay = document.getElementById('signup-loading-overlay');
    const loginUsernameInput = document.getElementById('login-username');
    const loginPasswordInput = document.getElementById('login-password');
    const loginFormWrapper = document.getElementById('login-form-wrapper');
    const loginSubmitButton = document.getElementById('login-submit-button');
    const loginProgressIndicator = document.getElementById('login-progress-indicator');
    const signupFormContainer = document.getElementById('signup-form-container');
    const toggleSignupFormBtn = document.getElementById('toggle-signup-form');
    const toggleSignupFormText = document.getElementById('toggle-signup-form-text');
    const toggleSignupFormIcon = document.getElementById('toggle-signup-form-icon');
    const signupCard = document.getElementById('signup-card');
    const authUserPanel = document.getElementById('auth-user-panel');
    const authUserSummary = document.getElementById('auth-user-summary');
    const authUserSchool = document.getElementById('auth-user-school');
    const authUserEmail = document.getElementById('auth-user-email');
    const authUserAvatar = document.getElementById('auth-user-avatar');
    const authUserAvatarPlaceholder = document.getElementById('auth-user-avatar-placeholder');
    const logoutButton = document.getElementById('logout-button');
    const registrationFieldset = document.getElementById('registration-fieldset');
    const registrationLockNotice = document.getElementById('registration-lock-notice');
    const contactNameInput = document.getElementById('contact-name');
    const contactPhoneInput = document.getElementById('contact-phone');
    const contactEmailInput = document.getElementById('contact-email');
    const profileGuestNotice = document.getElementById('profile-guest-notice');
    const profileContent = document.getElementById('profile-content');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileAvatarFallback = document.getElementById('profile-avatar-fallback');
    const profileNameDisplay = document.getElementById('profile-name');
    const profileUsernameDisplay = document.getElementById('profile-username');
    const profileEmailDisplay = document.getElementById('profile-email');
    const profilePhoneDisplay = document.getElementById('profile-phone');
    const profileSchoolDisplay = document.getElementById('profile-school');
    const profileClusterDisplay = document.getElementById('profile-cluster');
    const profileSchoolIdDisplay = document.getElementById('profile-school-id');
    const profileSchoolClusterDisplay = document.getElementById('profile-school-cluster');
    const profileStatsActivities = document.getElementById('profile-stats-activities');
    const profileStatsTeams = document.getElementById('profile-stats-teams');
    const profileStatsStudents = document.getElementById('profile-stats-students');
    const profileStatsTeachers = document.getElementById('profile-stats-teachers');
    const profileLogoutButton = document.getElementById('profile-logout-btn');
    const profileRoleBadge = document.getElementById('profile-role-badge');
    const profileRoleLabel = document.getElementById('profile-role-label');
    const profileDetailUsername = document.getElementById('profile-detail-username');
    const profileDetailLevel = document.getElementById('profile-detail-level');
    const profileDetailEmail = document.getElementById('profile-detail-email');
    const profileDetailTel = document.getElementById('profile-detail-tel');
    const profileDetailSchool = document.getElementById('profile-detail-school');
    const profileDetailCluster = document.getElementById('profile-detail-cluster');
    const profilePermissionNote = document.getElementById('profile-permission-note');
    const profileTeamList = document.getElementById('profile-team-list');
    const profileForm = document.getElementById('profile-form');
    const profileFormStatus = document.getElementById('profile-form-status');
    const profileNameInput = document.getElementById('profile-name-input');
    const profileSurnameInput = document.getElementById('profile-surname-input');
    const profileEmailInput = document.getElementById('profile-email-input');
    const profilePhoneInput = document.getElementById('profile-phone-input');
    const profilePasswordInput = document.getElementById('profile-password-input');
    const profilePasswordConfirmInput = document.getElementById('profile-password-confirm-input');
    const profileSchoolSelect = document.getElementById('profile-school-select');
    const profileFormSubmitButton = document.getElementById('profile-form-submit');
    const teamManagePanel = document.getElementById('team-manage-panel');
    const teamManageTitle = document.getElementById('team-manage-title');
    const teamManageStatusPill = document.getElementById('team-manage-status-pill');
    const teamManageStatusHint = document.getElementById('team-manage-status-hint');
    const teamManageClusterLabel = document.getElementById('team-manage-cluster');
    const teamManageStageLabel = document.getElementById('team-manage-stage');
    const teamManageStageSwitch = document.getElementById('team-manage-stage-switch');
    const teamManageLockNotice = document.getElementById('team-manage-lock');
    const teamManageNameInput = document.getElementById('team-manage-name');
    const teamManageStatusSelect = document.getElementById('team-manage-status');
    const teamManageReasonWrapper = document.getElementById('team-manage-reason-wrapper');
    const teamManageStatusReasonInput = document.getElementById('team-manage-status-reason');
    const teamManageContactNameInput = document.getElementById('team-manage-contact-name');
    const teamManageContactPhoneInput = document.getElementById('team-manage-contact-phone');
    const teamManageContactEmailInput = document.getElementById('team-manage-contact-email');
    const teamManageTeachersContainer = document.getElementById('team-manage-teachers');
    const teamManageStudentsContainer = document.getElementById('team-manage-students');
    const teamManageFeedback = document.getElementById('team-manage-feedback');
    const teamManageSaveButton = document.getElementById('team-manage-save');
    const teamManageDeleteButton = document.getElementById('team-manage-delete');
    const teamAddTeacherBtn = document.getElementById('team-add-teacher-btn');
    const teamAddStudentBtn = document.getElementById('team-add-student-btn');
    const teamManageLoadingOverlay = document.getElementById('team-manage-loading');
    const teamManageLogoPreview = document.getElementById('team-manage-logo-preview');
    const teamManageLogoPlaceholder = document.getElementById('team-manage-logo-placeholder');
    const teamManageLogoStatus = document.getElementById('team-manage-logo-status');
    const teamManageLogoInput = document.getElementById('team-manage-logo-input');
    const teamManagePhotoPreview = document.getElementById('team-manage-photo-preview');
    const teamManagePhotoPlaceholder = document.getElementById('team-manage-photo-placeholder');
    const teamManagePhotoStatus = document.getElementById('team-manage-photo-status');
    const teamManagePhotoInput = document.getElementById('team-manage-photo-input');
    const teamManagePhotoOpen = document.getElementById('team-manage-photo-open');

    // --- Utility functions ---
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }
    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }
    function handleError(error) {
        hideLoading();
        const message = error && error.message ? error.message : 'ไม่ทราบสาเหตุ';
        console.error(error);
        Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด',
            text: message
        });
    }
    function formatDeadline(deadlineIso, fallbackText = 'ไม่ระบุ') {
        if (!deadlineIso) return fallbackText;
        const parsed = new Date(deadlineIso);
        if (Number.isNaN(parsed.getTime())) return fallbackText;
        const options = { dateStyle: 'long', timeStyle: 'short', hour12: false };
        return parsed.toLocaleString('th-TH', options);
    }
    function calculateRemainingTeams(activity) {
        if (!activity) return null;
        const maxTeams = typeof activity.maxTeams === 'number' && activity.maxTeams > 0 ? activity.maxTeams : null;
        if (maxTeams === null) return null;
        const currentTeams = Number(activity.currentTeams || 0);
        const remaining = activity.remainingTeams ?? (maxTeams - currentTeams);
        return Math.max(remaining, 0);
    }
    function safeJsonParse(value, fallback = {}) {
        if (value === null || value === undefined || value === '') return fallback;
        if (typeof value === 'object') return value;
        try { return JSON.parse(value); } catch { return fallback; }
    }

    function showAuthStatus(target, message = '', type = 'info') {
        if (!target) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500',
            warning: 'text-amber-600'
        };
        target.textContent = message || '';
        target.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500', 'text-amber-600');
        target.classList.add(classMap[type] || classMap.info);
    }

    function setSignupFormVisibility(show) {
        if (!signupFormContainer || !toggleSignupFormBtn) return;
        signupFormContainer.classList.toggle('hidden', !show);
        toggleSignupFormBtn.setAttribute('aria-expanded', show ? 'true' : 'false');
        if (toggleSignupFormText) {
            toggleSignupFormText.textContent = show ? 'ซ่อนฟอร์มสมัครสมาชิก' : 'เปิดฟอร์มสมัครสมาชิก';
        }
        if (toggleSignupFormIcon) {
            toggleSignupFormIcon.textContent = show ? 'expand_less' : 'expand_more';
        }
    }

    function toggleSignupFormVisibility(event) {
        if (event) event.preventDefault();
        if (!signupFormContainer) return;
        const willShow = signupFormContainer.classList.contains('hidden');
        setSignupFormVisibility(willShow);
    }

    function setCurrentUser(user, { persist = true } = {}) {
        currentUser = user ? { ...user } : null;
        if (!currentUser) {
            resetJudgeAssignmentState();
        }
        if (persist) {
            try {
                if (currentUser) {
                    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(currentUser));
                } else {
                    localStorage.removeItem(AUTH_STORAGE_KEY);
                }
            } catch (error) {
                console.warn('Persist user session failed', error);
            }
        }
        if (!currentUser) {
            MANAGED_USERS = [];
            hasLoadedManagedUsers = false;
            managedUsersLoadAttempted = false;
        }
        updateAuthUI();
        updateRegistrationAccess();
        applyUserSchoolToForm();
        if (currentUser) {
            applyUserContactToForm();
        } else {
            applyUserContactToForm({ force: true });
        }
        if (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            populateUploadTeamSelect(ALL_TEAMS);
        }
        if (currentUser && (!Array.isArray(ALL_TEAMS) || ALL_TEAMS.length === 0)) {
            loadRegisteredTeams();
        }
        updateProfileSection();
        updateReportManagementVisibility();
        updateAreaTransferButtonState();
        if (currentUser) {
            loadJudgeAssignments(true);
        }
    }

    function restoreUserSession() {
        try {
            const raw = localStorage.getItem(AUTH_STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed && parsed.username) {
                setCurrentUser(parsed, { persist: false });
            }
        } catch (error) {
            console.warn('Restore user session failed', error);
        }
    }

    function clearUserSession() {
        setCurrentUser(null);
    }

    function setLoginFormDisabled(disabled) {
        if (!authLoginForm) return;
        const elements = authLoginForm.querySelectorAll('input, button');
        elements.forEach(el => {
            el.disabled = disabled;
            if (disabled) {
                el.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                el.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        });
    }

    function setLoginBusyState(isBusy) {
        if (loginProgressIndicator) {
            loginProgressIndicator.classList.toggle('hidden', !isBusy);
        }
        if (!loginSubmitButton) return;
        if (!loginSubmitButton.dataset.defaultLabel) {
            loginSubmitButton.dataset.defaultLabel = loginSubmitButton.innerHTML;
        }
        if (isBusy) {
            loginSubmitButton.innerHTML = `
                <span class="inline-flex items-center justify-center gap-2 w-full">
                    <span class="h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                    กำลังเข้าสู่ระบบ...
                </span>
            `;
        } else {
            loginSubmitButton.innerHTML = loginSubmitButton.dataset.defaultLabel || 'เข้าสู่ระบบ';
        }
    }

    function getSchoolDisplayNameById(schoolId) {
        const info = getSchoolInfoById(schoolId);
        return info ? info.name : '';
    }

    function getSchoolInfoById(schoolId) {
        if (!schoolId) return null;
        const normalized = normalizeText(schoolId);
        if (SCHOOL_LOOKUP_BY_ID instanceof Map && SCHOOL_LOOKUP_BY_ID.size > 0) {
            const match = SCHOOL_LOOKUP_BY_ID.get(normalized);
            if (match) return match;
        }
        if (!Array.isArray(SCHOOL_OPTIONS) || SCHOOL_OPTIONS.length === 0) return null;
        return SCHOOL_OPTIONS.find(school => {
            if (!school) return false;
            const idMatch = school.id && normalizeText(school.id) === normalized;
            const nameMatch = school.name && normalizeText(school.name) === normalized;
            return idMatch || nameMatch;
        }) || null;
    }

    function getSchoolClusterName(info) {
        if (!info) return '';
        const directName = info.clusterName || info.cluster || '';
        if (directName) return directName;
        const clusterId = info.clusterId || info.schoolClusterId || info.SchoolClusterID || '';
        if (!clusterId) return '';
        const normalized = normalizeText(clusterId);
        return SCHOOL_CLUSTER_LOOKUP.get(normalized) || clusterId;
    }

    function getSchoolClusterId(info) {
        if (!info) return '';
        return info.clusterId || info.cluster || '';
    }

    function updateSchoolClusterLookup(schools) {
        SCHOOL_CLUSTER_LOOKUP.clear();
        if (!Array.isArray(schools)) return;
        schools.forEach(school => {
            if (!school) return;
            const clusterIdRaw = (school.clusterId || school.schoolClusterId || school.SchoolClusterID || '').toString();
            const normalized = normalizeText(clusterIdRaw);
            if (!normalized) return;
            const label = school.clusterName || school.cluster || '';
            if (label) {
                SCHOOL_CLUSTER_LOOKUP.set(normalized, label);
            }
        });
    }

    function getSchoolInfoByName(name) {
        if (!name || !(SCHOOL_LOOKUP_BY_NAME instanceof Map)) return null;
        const normalized = normalizeText(name);
        if (!normalized) return null;
        return SCHOOL_LOOKUP_BY_NAME.get(normalized) || null;
    }

    function applyUserSchoolToForm() {
        if (!schoolInput) return;
        const level = getCurrentUserLevel();
        const enforceReadonly = Boolean(currentUser && currentUser.schoolId) && !['admin', 'area', 'group_admin'].includes(level);
        if (enforceReadonly) {
            const schoolName = getSchoolDisplayNameById(currentUser.schoolId) || currentUser.schoolId;
            schoolInput.value = schoolName;
        }
        schoolInput.readOnly = enforceReadonly;
        schoolInput.classList.toggle('bg-slate-100', enforceReadonly);
        schoolInput.classList.toggle('cursor-not-allowed', enforceReadonly);
        if (!enforceReadonly && !currentUser) {
            schoolInput.value = '';
        }
    }

    function applyUserContactToForm({ force = false } = {}) {
        if (!contactNameInput || !contactPhoneInput || !contactEmailInput) return;
        if (!currentUser) {
            if (force) {
                [contactNameInput, contactPhoneInput, contactEmailInput].forEach(input => {
                    if (!input) return;
                    input.value = '';
                    input.dataset.autofilled = 'false';
                });
            }
            return;
        }
        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '';
        const mappings = [
            { input: contactNameInput, value: fullName },
            { input: contactPhoneInput, value: currentUser.tel || currentUser.phone || '' },
            { input: contactEmailInput, value: currentUser.email || '' }
        ];
        mappings.forEach(({ input, value }) => {
            if (!input || !value) return;
            const isEmpty = !(input.value || '').trim();
            const autofillState = input.dataset.autofilled;
            const wasAutofilled = autofillState === 'true';
            const neverAutofilled = autofillState === undefined;
            if (force || wasAutofilled || (neverAutofilled && isEmpty)) {
                input.value = value;
                input.dataset.autofilled = 'true';
            }
        });
    }

    function markContactFieldManual(event) {
        if (event && event.target) {
            event.target.dataset.autofilled = 'false';
        }
    }

    function handleStartRegistration(event) {
        if (event) event.preventDefault();
        if (currentUser) {
            navigateTo('section-form');
            return;
        }
        navigateTo('section-auth');
        setSignupFormVisibility(false);
        loginUsernameInput?.focus();
        showAuthStatus(loginStatus, 'กรุณาเข้าสู่ระบบก่อนลงทะเบียน', 'info');
    }

    function showNavAuthStatus(target, message = '', type = 'info') {
        if (!target) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        target.textContent = message;
        target.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        target.classList.add(classMap[type] || classMap.info);
    }

    function toggleNavSignupForm() {
        if (!navSignupForm) {
            openAuthFromProfile('signup');
            return;
        }
        navSignupFormVisible = !navSignupFormVisible;
        navSignupForm.classList.toggle('hidden', !navSignupFormVisible);
        if (navSignupToggleIcon) navSignupToggleIcon.textContent = navSignupFormVisible ? 'expand_less' : 'expand_more';
        if (navSignupToggleLabel) navSignupToggleLabel.textContent = navSignupFormVisible ? 'ปิดฟอร์มสมัคร' : 'เปิดฟอร์มสมัคร';
    }

    function setNavLoginBusyState(isBusy) {
        navAuthBusyState.login = isBusy;
        if (navLoginSubmitButton) {
            navLoginSubmitButton.disabled = isBusy;
            navLoginSubmitButton.classList.toggle('opacity-60', isBusy);
        }
        if (navLoginUsernameInput) navLoginUsernameInput.disabled = isBusy;
        if (navLoginPasswordInput) navLoginPasswordInput.disabled = isBusy;
    }

    function resetNavLoginForm() {
        if (navLoginForm) navLoginForm.reset();
        showNavAuthStatus(navLoginStatus, '');
    }

    function handleNavLoginSubmit(event) {
        if (event) event.preventDefault();
        if (navAuthBusyState.login) return;
        const username = (navLoginUsernameInput?.value || '').trim();
        const password = (navLoginPasswordInput?.value || '').trim();
        if (!username || !password) {
            showNavAuthStatus(navLoginStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'error');
            return;
        }
        setNavLoginBusyState(true);
        showNavAuthStatus(navLoginStatus, 'กำลังตรวจสอบ...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavLoginBusyState(false);
                if (response && response.success && response.user) {
                    showNavAuthStatus(navLoginStatus, 'เข้าสู่ระบบสำเร็จ', 'success');
                    resetNavLoginForm();
                    setCurrentUser(response.user);
                    closeProfileMenu();
                    navigateTo('section-form');
                } else {
                    showNavAuthStatus(navLoginStatus, (response && response.error) || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavLoginBusyState(false);
                showNavAuthStatus(navLoginStatus, error.message || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
            })
            .loginUser({ username, password });
    }

    function setNavSignupBusyState(isBusy) {
        navAuthBusyState.signup = isBusy;
        if (navSignupSubmitButton) {
            navSignupSubmitButton.disabled = isBusy;
            navSignupSubmitButton.classList.toggle('opacity-60', isBusy);
        }
        [
            navSignupNameInput,
            navSignupSurnameInput,
            navSignupUsernameInput,
            navSignupPasswordInput,
            navSignupConfirmInput,
            navSignupEmailInput,
            navSignupTelInput,
            navSignupSchoolSelect
        ].forEach(input => {
            if (input) input.disabled = isBusy;
        });
    }

    function resetNavSignupForm() {
        if (navSignupForm) navSignupForm.reset();
        showNavAuthStatus(navSignupStatus, '');
    }

    function handleNavSignupSubmit(event) {
        if (event) event.preventDefault();
        if (navAuthBusyState.signup) return;
        const username = (navSignupUsernameInput?.value || '').trim();
        const password = navSignupPasswordInput?.value || '';
        const confirmPassword = navSignupConfirmInput?.value || '';
        const schoolId = navSignupSchoolSelect ? navSignupSchoolSelect.value : '';
        const email = (navSignupEmailInput?.value || '').trim();
        if (!username || !password) {
            showNavAuthStatus(navSignupStatus, 'กรุณากรอกข้อมูลให้ครบ', 'error');
            return;
        }
        if (password !== confirmPassword) {
            showNavAuthStatus(navSignupStatus, 'รหัสผ่านไม่ตรงกัน', 'error');
            return;
        }
        if (!schoolId) {
            showNavAuthStatus(navSignupStatus, 'กรุณาเลือกโรงเรียน', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNavAuthStatus(navSignupStatus, 'รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        const payload = {
            username,
            password,
            name: (navSignupNameInput?.value || '').trim(),
            surname: (navSignupSurnameInput?.value || '').trim(),
            tel: (navSignupTelInput?.value || '').trim(),
            schoolId,
            email
        };
        setNavSignupBusyState(true);
        showNavAuthStatus(navSignupStatus, 'กำลังสมัครสมาชิก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavSignupBusyState(false);
                if (response && response.success && response.user) {
                    showNavAuthStatus(navSignupStatus, 'สมัครเรียบร้อย กำลังเข้าสู่ระบบ...', 'success');
                    resetNavSignupForm();
                    setCurrentUser(response.user);
                    closeProfileMenu();
                    navigateTo('section-form');
                } else {
                    showNavAuthStatus(navSignupStatus, (response && response.error) || 'สมัครไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavSignupBusyState(false);
                showNavAuthStatus(navSignupStatus, error.message || 'สมัครไม่สำเร็จ', 'error');
            })
            .registerNormalUser(payload);
    }

    function normalizeText(value) {
        return (value || '').toString().trim().toLowerCase();
    }

    function normalizeBooleanFlagClient(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'number') return value !== 0;
        const normalized = (value || '').toString().trim().toLowerCase();
        if (!normalized) return null;
        if (['true', '1', 'yes', 'y', 't'].includes(normalized)) return true;
        if (['false', '0', 'no', 'n', 'f'].includes(normalized)) return false;
        return null;
    }

    function normalizeCompetitionStageClient(value) {
        const normalized = (value || '').toString().trim().toLowerCase();
        return normalized === 'area' ? 'area' : 'cluster';
    }

    function getCompetitionStageLabel(stage) {
        return stage === 'area' ? 'รอบระดับเขต' : 'รอบกลุ่มเครือข่าย';
    }

    function getCompetitionStageNote(stage) {
        return stage === 'area'
            ? 'จะแสดงเฉพาะทีมที่ผ่านรอบเครือข่ายและมีสถานะตัวแทนเพื่อแข่งขันระดับเขต'
            : 'จะแสดงผลคะแนนทุกทีมในเครือข่าย';
    }

    function getStageCopy() {
        return STAGE_COPY[competitionStage] || STAGE_COPY.cluster;
    }

    function updateStageChip(element, label, stage, { withIcon = false } = {}) {
        if (!element) return;
        element.classList.remove('stage-chip-cluster', 'stage-chip-area');
        if (!label) {
            element.textContent = '-';
            return;
        }
        element.classList.add(stage === 'area' ? 'stage-chip-area' : 'stage-chip-cluster');
        if (withIcon) {
            element.innerHTML = `<span class="material-symbols-outlined text-base">flag</span><span>${label}</span>`;
        } else {
            element.textContent = label;
        }
    }

    function refreshStageAwareUI() {
        if (!hasCompetitionStageInfo) {
            if (globalStageText) globalStageText.textContent = 'กำลังโหลดสถานะรอบการแข่งขัน...';
            if (globalStageChip) {
                globalStageChip.classList.remove('stage-chip-cluster', 'stage-chip-area');
                globalStageChip.innerHTML = '<span class="material-symbols-outlined text-base">schedule</span><span>กำลังโหลด</span>';
            }
            if (reportUserSummaryStage) {
                reportUserSummaryStage.classList.remove('stage-chip-cluster', 'stage-chip-area');
                reportUserSummaryStage.textContent = '-';
            }
            if (reportTotalsStage) {
                reportTotalsStage.classList.remove('stage-chip-cluster', 'stage-chip-area');
                reportTotalsStage.textContent = '-';
            }
            if (reportTotalsHint) {
                reportTotalsHint.textContent = 'กำลังโหลดข้อมูลภาพรวม...';
            }
            if (leaderboardStageChip) {
                leaderboardStageChip.classList.remove('stage-chip-cluster', 'stage-chip-area');
                leaderboardStageChip.textContent = '-';
            }
            if (leaderboardDescription) {
                leaderboardDescription.textContent = 'กำลังโหลดข้อมูลอันดับเหรียญ...';
            }
            return;
        }
        const copy = getStageCopy();
        if (globalStageText) {
            globalStageText.textContent = `ขณะนี้ระบบอยู่ใน${copy.chipLabel}`;
        }
        if (globalStageChip) {
            updateStageChip(globalStageChip, copy.chipLabel, competitionStage, { withIcon: true });
        }
        if (reportUserSummaryStage) {
            updateStageChip(reportUserSummaryStage, copy.chipLabel, competitionStage);
        }
        if (reportTotalsStage) {
            updateStageChip(reportTotalsStage, copy.chipLabel, competitionStage);
        }
        if (reportTotalsHint) {
            reportTotalsHint.textContent = copy.totalsHint;
        }
        if (leaderboardStageChip) {
            updateStageChip(leaderboardStageChip, copy.chipLabel, competitionStage);
        }
        if (leaderboardDescription) {
            leaderboardDescription.textContent = copy.leaderboardHint;
        }
        Object.entries(reportUserSummaryLabels).forEach(([key, el]) => {
            if (el && copy.summaryLabels[key]) {
                el.textContent = copy.summaryLabels[key];
            }
        });
        Object.entries(reportTotalsLabels).forEach(([key, el]) => {
            if (el && copy.totalsLabels[key]) {
                el.textContent = copy.totalsLabels[key];
            }
        });
        updateAreaTransferButtonState();
    }

    function canManageCompetitionStage() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function getCurrentUserLevel() {
        return normalizeText(currentUser?.level || '');
    }

    function getRoleDisplayName(level) {
        const normalized = normalizeText(level);
        const map = {
            admin: 'Admin',
            school_admin: 'School Admin',
            group_admin: 'Group Admin',
            area: 'Area',
            score: 'Score',
            user: 'ผู้ใช้ทั่วไป'
        };
        return map[normalized] || (level || 'User');
    }

    function canEditAvatarFromNav() {
        return getCurrentUserLevel() === 'user';
    }

    function setNavProfileAvatarStatus(message = '', type = 'info') {
        if (!navProfileAvatarStatus) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        navProfileAvatarStatus.textContent = message || navProfileAvatarStatus.dataset.defaultStatus || '';
        navProfileAvatarStatus.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        navProfileAvatarStatus.classList.add(classMap[type] || classMap.info);
    }

    function resetNavProfileAvatarUI() {
        PROFILE_AVATAR_FILE_DATA = null;
        if (navProfileAvatarInput) {
            navProfileAvatarInput.value = '';
            navProfileAvatarInput.disabled = !canEditAvatarFromNav();
        }
        if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = true;
            navProfileAvatarSubmit.classList.remove('opacity-60');
        }
        setNavProfileAvatarStatus(navProfileAvatarStatus?.dataset.defaultStatus || '', 'info');
    }

    function setNavProfileAvatarBusy(isBusy) {
        if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = isBusy || !PROFILE_AVATAR_FILE_DATA;
            navProfileAvatarSubmit.classList.toggle('opacity-60', isBusy);
        }
        if (navProfileAvatarInput) {
            navProfileAvatarInput.disabled = isBusy || !canEditAvatarFromNav();
        }
    }

    function closeProfileMenu() {
        if (!navProfileMenu) return;
        navProfileMenu.classList.add('hidden');
        navProfileButton?.setAttribute('aria-expanded', 'false');
        isProfileMenuOpen = false;
    }

    function openProfileMenu() {
        if (!navProfileMenu) {
            navigateTo('section-profile', navProfileButton);
            return;
        }
        refreshProfileMenuState();
        navProfileMenu.classList.remove('hidden');
        navProfileButton?.setAttribute('aria-expanded', 'true');
        isProfileMenuOpen = true;
    }

    function handleNavProfileButton(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (currentUser) {
            goToProfileSection();
            return;
        }
        closeProfileMenu();
        navigateTo('section-auth', navProfileButton);
        setSignupFormVisibility(false);
        loginUsernameInput?.focus();
        showAuthStatus(loginStatus, 'กรุณาเข้าสู่ระบบเพื่อดำเนินการต่อ', 'info');
    }

    function toggleProfileMenu(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (isProfileMenuOpen) {
            closeProfileMenu();
        } else {
            openProfileMenu();
        }
    }

    function goToProfileSection() {
        closeProfileMenu();
        if (!currentUser) {
            openAuthFromProfile('login');
            return;
        }
        navigateTo('section-profile', navProfileButton);
    }

    function goToAdminSection() {
        closeProfileMenu();
        if (!isAppAdmin) return;
        navigateTo('section-admin');
    }

    function openAuthFromProfile(mode = 'login') {
        closeProfileMenu();
        navigateTo('section-auth');
        if (mode === 'signup') {
            setSignupFormVisibility(true);
            signupNameInput?.focus();
        } else {
            setSignupFormVisibility(false);
            loginUsernameInput?.focus();
        }
    }

    function handleNavProfileLogout(event) {
        if (event) event.preventDefault();
        closeProfileMenu();
        handleLogout();
    }

    function handleProfileSectionLogout(event) {
        if (event) event.preventDefault();
        handleLogout();
    }

    function refreshProfileMenuState() {
        if (!navProfileMenu) return;
        const isLoggedIn = Boolean(currentUser);
        navProfileMenuGuest?.classList.toggle('hidden', isLoggedIn);
        navProfileMenuUser?.classList.toggle('hidden', !isLoggedIn);
        if (!isLoggedIn) {
            resetNavProfileAvatarUI();
            closeProfileMenu();
            return;
        }
        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '-';
        if (navProfileMenuName) navProfileMenuName.textContent = fullName;
        if (navProfileMenuRole) navProfileMenuRole.textContent = getRoleDisplayName(currentUser.level);
        const schoolName = getSchoolDisplayNameById(currentUser.schoolId || currentUser.SchoolID || '') || currentUser.schoolName || '-';
        if (navProfileMenuSchool) navProfileMenuSchool.textContent = '\u0e42\u0e23\u0e07\u0e40\u0e23\u0e35\u0e22\u0e19: ' + (schoolName || '-');
        const avatarUrl = getUserAvatarUrl(currentUser, 96);
        if (navProfileMenuAvatar && navProfileMenuAvatarFallback) {
            if (avatarUrl) {
                navProfileMenuAvatar.src = avatarUrl;
                navProfileMenuAvatar.classList.remove('hidden');
                navProfileMenuAvatarFallback.classList.add('hidden');
            } else {
                navProfileMenuAvatar.src = '';
                navProfileMenuAvatar.classList.add('hidden');
                navProfileMenuAvatarFallback.classList.remove('hidden');
            }
        }
        const canEdit = canEditAvatarFromNav();
        if (navProfileAvatarEditor) navProfileAvatarEditor.classList.toggle('hidden', !canEdit);
        if (navProfileApprovalHint) navProfileApprovalHint.classList.toggle('hidden', !canEdit);
        if (navProfileAvatarInput) navProfileAvatarInput.disabled = !canEdit;
        if (!canEdit) {
            resetNavProfileAvatarUI();
        } else if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = !PROFILE_AVATAR_FILE_DATA;
        }
        if (navProfileAdminLink) {
            navProfileAdminLink.classList.toggle('hidden', !isAppAdmin);
        }
    }

    function handleGlobalProfileMenuClick(event) {
        if (!isProfileMenuOpen) return;
        if (!navProfileWrapper) {
            closeProfileMenu();
            return;
        }
        if (!navProfileWrapper.contains(event.target)) {
            closeProfileMenu();
        }
    }

    function handleProfileMenuKeydown(event) {
        if (event.key === 'Escape') {
            closeProfileMenu();
            if (teamManagePanel && !teamManagePanel.classList.contains('hidden')) {
                closeTeamManager();
            }
        }
    }

    function handleNavProfileAvatarSelect(event) {
        if (!canEditAvatarFromNav()) {
            setNavProfileAvatarStatus('สิทธิ์ของคุณไม่สามารถแก้ไขรูปได้', 'error');
            resetNavProfileAvatarUI();
            return;
        }
        const file = event.target?.files?.[0];
        if (!file) {
            resetNavProfileAvatarUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            setNavProfileAvatarStatus(`ไฟล์ใหญ่กว่า ${MAX}MB`, 'error');
            resetNavProfileAvatarUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            setNavProfileAvatarStatus('รองรับเฉพาะไฟล์ .jpg หรือ .png', 'error');
            resetNavProfileAvatarUI();
            return;
        }
        setNavProfileAvatarStatus(`กำลังประมวลผล: ${file.name}`, 'info');
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            PROFILE_AVATAR_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            setNavProfileAvatarStatus(`อัปโหลดแล้ว: ${file.name}`, 'success');
            if (navProfileAvatarSubmit) {
                navProfileAvatarSubmit.disabled = false;
            }
        };
        reader.onerror = () => {
            setNavProfileAvatarStatus('ไม่สามารถอ่านไฟล์ได้', 'error');
            resetNavProfileAvatarUI();
        };
        reader.readAsDataURL(file);
    }

    function handleNavProfileAvatarSubmit(event) {
        if (event) event.preventDefault();
        if (!currentUser) {
            setNavProfileAvatarStatus('กรุณาเข้าสู่ระบบก่อน', 'error');
            return;
        }
        if (!canEditAvatarFromNav()) {
            setNavProfileAvatarStatus('สิทธิ์ของคุณไม่สามารถแก้ไขรูปได้', 'error');
            return;
        }
        if (!PROFILE_AVATAR_FILE_DATA) {
            setNavProfileAvatarStatus('กรุณาเลือกรูปก่อนส่งคำขอ', 'error');
            return;
        }
        const payload = {
            userid: getCurrentUserId(),
            name: (currentUser.name || '').trim(),
            surname: (currentUser.surname || '').trim(),
            email: (currentUser.email || '').trim(),
            tel: (currentUser.tel || currentUser.phone || '').trim(),
            schoolId: (currentUser.schoolId || currentUser.SchoolID || '').toString().trim(),
            avatarFileData: PROFILE_AVATAR_FILE_DATA
        };
        if (!payload.userid) {
            setNavProfileAvatarStatus('ไม่พบรหัสผู้ใช้', 'error');
            return;
        }
        if (!payload.name || !payload.surname || !payload.email || !payload.tel) {
            setNavProfileAvatarStatus('กรุณากรอกข้อมูลโปรไฟล์ให้ครบก่อน', 'error');
            return;
        }
        setNavProfileAvatarBusy(true);
        setNavProfileAvatarStatus('กำลังส่งคำขอ...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavProfileAvatarBusy(false);
                if (response && response.success && response.user) {
                    setCurrentUser(response.user);
                    resetNavProfileAvatarUI();
                    setNavProfileAvatarStatus('ส่งคำขอแล้ว กรุณารอการอนุมัติ', 'success');
                } else {
                    setNavProfileAvatarStatus((response && response.error) || 'ไม่สามารถอัปเดตรูปได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavProfileAvatarBusy(false);
                setNavProfileAvatarStatus(error.message || 'ไม่สามารถอัปเดตรูปได้', 'error');
            })
            .updateUserProfile(payload);
    }

    function updateNavProfile() {
        if (!navProfileButton) return;
        const avatarUrl = getUserAvatarUrl(currentUser, 72);
        if (navProfileAvatar) {
            if (avatarUrl) {
                navProfileAvatar.src = avatarUrl;
                navProfileAvatar.classList.remove('hidden');
                navProfileAvatarFallback?.classList.add('hidden');
            } else {
                navProfileAvatar.src = '';
                navProfileAvatar.classList.add('hidden');
                navProfileAvatarFallback?.classList.remove('hidden');
            }
        }
        if (navProfileLabel) {
            navProfileLabel.textContent = currentUser ? 'โปรไฟล์' : 'เข้าสู่ระบบ';
        }
        refreshProfileMenuState();
    }

    function updateAuthUI() {
        const isLoggedIn = Boolean(currentUser);
        if (authUserPanel) {
            authUserPanel.classList.toggle('hidden', !isLoggedIn);
        }
        if (authUserSummary) {
            const fullName = currentUser
                ? `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || ''
                : '';
            authUserSummary.textContent = isLoggedIn ? `ยินดีต้อนรับ ${fullName}` : '';
        }
        if (authUserSchool) {
            const schoolText = currentUser
                ? (getSchoolDisplayNameById(currentUser.schoolId) || currentUser.schoolId || '')
                : '';
            authUserSchool.textContent = schoolText ? `โรงเรียน: ${schoolText}` : '';
        }
        if (authUserEmail) {
            const emailText = currentUser?.email || '';
            authUserEmail.textContent = emailText ? `อีเมล: ${emailText}` : '';
            authUserEmail.classList.toggle('hidden', !emailText);
        }
        if (authUserAvatar && authUserAvatarPlaceholder) {
            const avatarUrl = getUserAvatarUrl(currentUser, 96);
            if (avatarUrl) {
                authUserAvatar.src = avatarUrl;
                authUserAvatar.classList.remove('hidden');
                authUserAvatarPlaceholder.classList.add('hidden');
            } else {
                authUserAvatar.src = '';
                authUserAvatar.classList.add('hidden');
                authUserAvatarPlaceholder.classList.remove('hidden');
            }
        }
        if (loginFormWrapper) {
            loginFormWrapper.classList.toggle('hidden', isLoggedIn);
        }
        if (signupCard) {
            signupCard.classList.toggle('hidden', isLoggedIn);
        }
        setLoginFormDisabled(isLoggedIn);
        if (!isLoggedIn) {
            setLoginBusyState(false);
        }
        updateNavProfile();
        updateProfileSection();
        refreshReportUserSummary();
        updateScoreDutySummary(latestReportData);
        if (logoutButton) {
            logoutButton.disabled = !isLoggedIn;
        }
    }

    function updateRegistrationAccess() {
        const locked = !currentUser;
        if (registrationFieldset) {
            registrationFieldset.disabled = locked;
        }
        if (registrationLockNotice) {
            registrationLockNotice.classList.toggle('hidden', !locked);
        }
        if (locked) {
            setSubmitButtonState(true);
        } else {
            updateFormBasedOnActivity(activitySelect.value || '');
        }
        updateRegistrationAssignmentNotice();
        updateHomeActivities({ resetVisibleCount: true });
    }

    function updateRegistrationAssignmentNotice() {
        if (!registrationAssignmentMessage) return;
        if (!currentUser) {
            registrationAssignmentMessage.classList.add('hidden');
            registrationAssignmentMessage.textContent = '';
            return;
        }
        const level = getCurrentUserLevel();
        if (['admin', 'area', 'group_admin', 'score'].includes(level)) {
            registrationAssignmentMessage.classList.add('hidden');
            registrationAssignmentMessage.textContent = '';
            return;
        }
        const schoolInfo = getCurrentUserSchoolInfo();
        if (!schoolInfo) {
            registrationAssignmentMessage.classList.add('hidden');
            registrationAssignmentMessage.textContent = '';
            return;
        }
        const mode = normalizeRegistrationModeClient(schoolInfo.registrationMode);
        if (mode !== 'group_assigned') {
            registrationAssignmentMessage.classList.add('hidden');
            registrationAssignmentMessage.textContent = '';
            return;
        }
        const assigned = Array.isArray(schoolInfo.assignedActivities) ? schoolInfo.assignedActivities : [];
        if (!assigned.length) {
            registrationAssignmentMessage.textContent = 'โรงเรียนของคุณอยู่ในโหมดให้ Group Admin กำหนดกิจกรรม กรุณารอการมอบหมาย';
            registrationAssignmentMessage.classList.remove('hidden');
            setSubmitButtonState(true);
        } else {
            const names = getAssignedActivityNames(assigned);
            if (!names.length) {
                registrationAssignmentMessage.textContent = 'โรงเรียนของคุณลงทะเบียนได้เฉพาะกิจกรรมที่ได้รับมอบหมาย';
            } else {
                const preview = names.slice(0, 4).join(', ');
                const extra = names.length - Math.min(names.length, 4);
                const suffix = extra > 0 ? ` และอีก ${extra} กิจกรรม` : '';
                registrationAssignmentMessage.textContent = `โรงเรียนของคุณลงทะเบียนได้เฉพาะกิจกรรมที่ได้รับมอบหมาย ได้แก่ ${preview}${suffix}`;
            }
            registrationAssignmentMessage.classList.remove('hidden');
        }
        if (activitySelect) {
            const activities = getFormActivities();
            populateFormActivitySelect(activities);
            if (!activities.some(act => act.id === activitySelect.value)) {
                activitySelect.value = '';
                updateFormBasedOnActivity('');
            }
        }
    }


    function updateProfileSection() {
        if (!profileContent || !profileGuestNotice) return;
        const isLoggedIn = Boolean(currentUser);
        profileContent.classList.toggle('hidden', !isLoggedIn);
        profileGuestNotice.classList.toggle('hidden', isLoggedIn);
        if (profileLogoutButton) {
            profileLogoutButton.disabled = !isLoggedIn;
            profileLogoutButton.classList.toggle('opacity-60', !isLoggedIn);
        }
        updateTeamScopeBanner();
        if (!isLoggedIn) {
            showProfileFormStatus('');
            if (profilePermissionNote) profilePermissionNote.textContent = '';
            return;
        }

        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '-';
        if (profileNameDisplay) profileNameDisplay.textContent = fullName;
        if (profileUsernameDisplay) profileUsernameDisplay.textContent = currentUser.username ? `ชื่อผู้ใช้: ${currentUser.username}` : '';
        if (profileEmailDisplay) profileEmailDisplay.textContent = currentUser.email ? `อีเมล: ${currentUser.email}` : 'อีเมล: -';
        if (profilePhoneDisplay) {
            const formattedPhone = formatDisplayPhone(currentUser.tel || currentUser.phone || '');
            profilePhoneDisplay.textContent = formattedPhone ? `โทร: ${formattedPhone}` : 'โทร: -';
        }
        if (profileRoleLabel) profileRoleLabel.textContent = getRoleDisplayName(currentUser.level);
        if (profileDetailUsername) profileDetailUsername.textContent = currentUser.username || '-';
        if (profileDetailLevel) profileDetailLevel.textContent = getRoleDisplayName(currentUser.level);
        if (profileDetailEmail) profileDetailEmail.textContent = currentUser.email || '-';
        if (profileDetailTel) {
            const detailPhone = formatDisplayPhone(currentUser.tel || currentUser.phone || '');
            profileDetailTel.textContent = detailPhone || '-';
        }

        const avatarUrl = getUserAvatarUrl(currentUser, 160);
        if (profileAvatar && profileAvatarFallback) {
            if (avatarUrl) {
                profileAvatar.src = avatarUrl;
                profileAvatar.classList.remove('hidden');
                profileAvatarFallback.classList.add('hidden');
            } else {
                profileAvatar.src = '';
                profileAvatar.classList.add('hidden');
                profileAvatarFallback.classList.remove('hidden');
            }
        }

        const schoolInfo = getSchoolInfoById(currentUser.schoolId || currentUser.SchoolID || '');
        const schoolName = getSchoolDisplayNameById(currentUser.schoolId || currentUser.SchoolID || '') || currentUser.schoolId || currentUser.SchoolID || '-';
        currentUser.schoolName = schoolName === '-' ? '' : schoolName;
        currentUser.schoolCluster = schoolInfo?.cluster || currentUser.schoolCluster || '';
        if (profileSchoolDisplay) profileSchoolDisplay.textContent = schoolName;
        if (profileClusterDisplay) profileClusterDisplay.textContent = schoolInfo?.cluster ? `สังกัด: ${schoolInfo.cluster}` : 'สังกัด: -';
        if (profileSchoolIdDisplay) profileSchoolIdDisplay.textContent = schoolInfo?.id || currentUser.schoolId || currentUser.SchoolID || '-';
        if (profileSchoolClusterDisplay) profileSchoolClusterDisplay.textContent = schoolInfo?.cluster || '-';
        if (profileDetailSchool) profileDetailSchool.textContent = schoolName;
        if (profileDetailCluster) profileDetailCluster.textContent = schoolInfo?.cluster || '-';

        fillProfileFormFromUser();
        applyProfileEditPermissions();

        const hasTeamData = lastTeamsFetch > 0 || (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0);
        if (!hasTeamData) {
            if (profileStatsActivities) profileStatsActivities.textContent = '...';
            if (profileStatsTeams) profileStatsTeams.textContent = '...';
            if (profileStatsStudents) profileStatsStudents.textContent = '...';
            if (profileStatsTeachers) profileStatsTeachers.textContent = '...';
        } else {
            const stats = getUserTeamStats();
            if (profileStatsActivities) profileStatsActivities.textContent = stats.activities.toString();
            if (profileStatsTeams) profileStatsTeams.textContent = stats.teams.toString();
            if (profileStatsStudents) profileStatsStudents.textContent = stats.students.toString();
            if (profileStatsTeachers) profileStatsTeachers.textContent = stats.teachers.toString();
        }
        renderProfileTeams();
        refreshProfileMenuState();
        updateReportManagementVisibility();
    }


    function fillProfileFormFromUser() {
        if (!currentUser) return;
        if (profileNameInput) profileNameInput.value = currentUser.name || '';
        if (profileSurnameInput) profileSurnameInput.value = currentUser.surname || '';
        if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
        if (profilePhoneInput) profilePhoneInput.value = currentUser.tel || currentUser.phone || '';
        if (profileSchoolSelect) profileSchoolSelect.value = currentUser.schoolId || currentUser.SchoolID || '';
    }

    function applyProfileEditPermissions() {
        if (!profileForm) return;
        const isLoggedIn = Boolean(currentUser);
        const level = getCurrentUserLevel();
        const canEditSchool = level === 'admin' || level === 'area';
        const generalFields = [
            profileNameInput,
            profileSurnameInput,
            profileEmailInput,
            profilePhoneInput,
            profilePasswordInput,
            profilePasswordConfirmInput
        ];
        generalFields.forEach(field => {
            if (!field) return;
            field.disabled = !isLoggedIn;
            field.classList.toggle('opacity-60', !isLoggedIn);
        });
        if (profileSchoolSelect) {
            profileSchoolSelect.disabled = !canEditSchool;
            profileSchoolSelect.classList.toggle('opacity-60', !canEditSchool);
            profileSchoolSelect.classList.toggle('cursor-not-allowed', !canEditSchool);
        }
        if (profileFormSubmitButton) {
            profileFormSubmitButton.disabled = !isLoggedIn;
            profileFormSubmitButton.classList.toggle('opacity-60', !isLoggedIn);
        }
        if (profilePermissionNote) {
            let note = '';
            if (isLoggedIn) {
                note = canEditSchool
                    ? 'คุณสามารถแก้ไขข้อมูลทั้งหมด รวมถึงโรงเรียนได้'
                    : 'คุณสามารถแก้ไขข้อมูลทั้งหมด ยกเว้นโรงเรียน (เฉพาะ Admin/Area ที่เปลี่ยนโรงเรียนได้)';
            }
            profilePermissionNote.textContent = note;
        }
    }

    function setProfileFormBusy(isBusy) {
        if (!profileForm) return;
        const elements = profileForm.querySelectorAll('input, select, button');
        elements.forEach(el => {
            el.disabled = isBusy;
        });
        if (profileFormSubmitButton) {
            profileFormSubmitButton.classList.toggle('opacity-60', isBusy);
        }
    }

    function showProfileFormStatus(message = '', type = 'info') {
        if (!profileFormStatus) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        profileFormStatus.textContent = message || '';
        profileFormStatus.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        profileFormStatus.classList.add(classMap[type] || classMap.info);
    }

    function handleProfileFormSubmit(event) {
        event.preventDefault();
        if (!currentUser) {
            showProfileFormStatus('กรุณาเข้าสู่ระบบก่อน', 'error');
            return;
        }
        const payload = {
            userid: getCurrentUserId(),
            name: (profileNameInput?.value || '').trim(),
            surname: (profileSurnameInput?.value || '').trim(),
            email: (profileEmailInput?.value || '').trim(),
            tel: (profilePhoneInput?.value || '').trim(),
            schoolId: (profileSchoolSelect?.value || '').trim()
        };
        const newPassword = (profilePasswordInput?.value || '').trim();
        const confirmPassword = (profilePasswordConfirmInput?.value || '').trim();
        if (!payload.name || !payload.surname) {
            showProfileFormStatus('กรุณากรอกชื่อและนามสกุล', 'error');
            return;
        }
        if (!payload.email) {
            showProfileFormStatus('กรุณากรอกอีเมล', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(payload.email)) {
            showProfileFormStatus('รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        if (!payload.tel) {
            showProfileFormStatus('กรุณากรอกเบอร์โทรศัพท์', 'error');
            return;
        }
        if (newPassword || confirmPassword) {
            if (newPassword.length < 6) {
                showProfileFormStatus('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showProfileFormStatus('รหัสผ่านใหม่และยืนยันไม่ตรงกัน', 'error');
                return;
            }
            payload.newPassword = newPassword;
        }

        setProfileFormBusy(true);
        showProfileFormStatus('กำลังบันทึก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setProfileFormBusy(false);
                if (response && response.success) {
                    if (response.user) {
                        setCurrentUser(response.user);
                    }
                    if (profilePasswordInput) profilePasswordInput.value = '';
                    if (profilePasswordConfirmInput) profilePasswordConfirmInput.value = '';
                    showProfileFormStatus('อัปเดตข้อมูลเรียบร้อย', 'success');
                } else {
                    showProfileFormStatus((response && response.error) || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setProfileFormBusy(false);
                showProfileFormStatus(error.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
            })
            .updateUserProfile(payload);
    }    function requireLoginForRegistration() {
        if (currentUser) return true;
        Swal.fire({
            icon: 'info',
            title: 'ต้องเข้าสู่ระบบ',
            text: 'กรุณาเข้าสู่ระบบก่อนสมัครกิจกรรม'
        }).then(() => navigateTo('section-auth'));
        return false;
    }

    function getCurrentUserId() {
        if (!currentUser) return '';
        return currentUser.userid || currentUser.userId || currentUser.id || '';
    }

    function getUserSchoolNameForFilter() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        const display = getSchoolDisplayNameById(schoolId) || currentUser.schoolName || schoolId || '';
        return normalizeText(display);
    }

    function getUserClusterForFilter() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        if (schoolId) {
            const schoolInfo = getSchoolInfoById(schoolId);
            const clusterId = getSchoolClusterId(schoolInfo);
            if (clusterId) return normalizeText(clusterId);
        }
        if (currentUser.schoolCluster) return normalizeText(currentUser.schoolCluster);
        const schoolInfoByName = getSchoolInfoByName(currentUser.schoolName || '');
        const clusterId = getSchoolClusterId(schoolInfoByName);
        return normalizeText(clusterId);
    }
    function getCurrentUserClusterLabel() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        const schoolInfo = getSchoolInfoById(schoolId) || getSchoolInfoByName(currentUser.schoolName || '');
        return getSchoolClusterName(schoolInfo);
    }
    function resetJudgeAssignmentState() {
        JUDGE_ASSIGNMENTS = [];
        hasLoadedJudgeAssignments = false;
        isLoadingJudgeAssignments = false;
        lastJudgeFetch = 0;
    }

    function buildActorPayload() {
        if (!currentUser) return null;
        return {
            userId: currentUser.userid || currentUser.userId || currentUser.id || '',
            username: currentUser.username || '',
            level: currentUser.level || '',
            schoolId: currentUser.schoolId || currentUser.SchoolID || '',
            schoolName: currentUser.schoolName || '',
            cluster: currentUser.schoolCluster || '',
            clusterId: currentUser.schoolClusterId || ''
        };
    }
    function escapeSelectorAttribute(value) {
        return (value || '').toString().replace(/["\\]/g, '\\$&');
    }
    function requestActivityFocus(activityId) {
        const normalized = (activityId || '').toString().trim();
        if (!normalized) return;
        expandedActivityIds.add(normalized);
        pendingActivityScrollId = normalized;
    }
    function scrollActivityIntoView(activityId) {
        const normalized = (activityId || '').toString().trim();
        if (!normalized) return;
        const safeId = escapeSelectorAttribute(normalized);
        const header = document.querySelector(`.activity-header-row[data-activity-id="${safeId}"]`);
        if (header) {
            header.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    function applyPendingActivityScroll() {
        if (!pendingActivityScrollId) return;
        scrollActivityIntoView(pendingActivityScrollId);
        pendingActivityScrollId = '';
    }
    function showJudgeActionLoading(message = 'กำลังประมวลผลกรรมการ...') {
        if (judgeActionLoadingActive) return;
        judgeActionLoadingActive = true;
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'info',
            title: message,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });
    }
    function stopJudgeActionLoading() {
        if (!judgeActionLoadingActive) return;
        judgeActionLoadingActive = false;
        Swal.close();
    }
    function notifyJudgeAction(message, type = 'success') {
        if (!message) return;
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: type,
            title: message,
            showConfirmButton: false,
            timer: 2200,
            timerProgressBar: true
        });
    }

    function filterTeamsForCurrentUser(teams) {
        if (!Array.isArray(teams) || !teams.length || !currentUser) return [];
        const dataset = [...teams];
        const role = getCurrentUserLevel();
        const userId = getCurrentUserId();
        if (role === 'school_admin') {
            const schoolName = getUserSchoolNameForFilter();
            if (!schoolName) return [];
            return dataset.filter(team => normalizeText(team.school) === schoolName);
        }
        if (role === 'group_admin') {
            const cluster = getUserClusterForFilter();
            if (cluster) {
                const clusterTeams = dataset.filter(team => normalizeText(getTeamCluster(team)) === cluster);
                if (clusterTeams.length) {
                    return clusterTeams;
                }
            }
            const schoolName = getUserSchoolNameForFilter();
            if (!schoolName) return [];
            return dataset.filter(team => normalizeText(team.school) === schoolName);
        }
        if (role === 'admin' || role === 'area') {
            return dataset;
        }
        if (!userId) return [];
        return dataset.filter(team => (team.createdByUserId || '') === userId);
    }

    function summarizeMemberCounts(teams) {
        const result = { teachers: 0, students: 0, allMembers: 0 };
        if (!Array.isArray(teams)) return result;
        teams.forEach(team => {
            const members = safeJsonParse(team.members, { teachers: [], students: [] });
            if (Array.isArray(members.teachers)) {
                result.teachers += members.teachers.length;
            }
            if (Array.isArray(members.students)) {
                result.students += members.students.length;
            }
        });
        result.allMembers = result.teachers + result.students;
        return result;
    }

    function getUserReportTotalsFromTeams() {
        if (!currentUser || !Array.isArray(ALL_TEAMS) || !lastTeamsFetch) {
            return null;
        }
        const scopedTeams = filterTeamsForCurrentUser(ALL_TEAMS);
        const relevantTeams = isAreaStageActive()
            ? scopedTeams.filter(team => isTeamRepresentative(team))
            : scopedTeams;
        const memberCounts = summarizeMemberCounts(relevantTeams);
        return {
            teams: relevantTeams.length,
            teachers: memberCounts.teachers,
            students: memberCounts.students,
            allMembers: memberCounts.allMembers,
            hasLocalData: true
        };
    }

    function refreshReportUserSummary(fallbackTotals = null) {
        if (!reportUserSummary) return;
        if (!shouldShowReportUserSummary()) {
            reportUserSummary.classList.add('hidden');
            return;
        }
        const stageCopy = getStageCopy();
        const clientTotals = getUserReportTotalsFromTeams();
        const totals = clientTotals || fallbackTotals || { teams: 0, teachers: 0, students: 0, allMembers: 0 };
        reportUserSummary.classList.remove('hidden');
        if (reportUserTotals.teams) reportUserTotals.teams.textContent = totals.teams ?? 0;
        if (reportUserTotals.teachers) reportUserTotals.teachers.textContent = totals.teachers ?? 0;
        if (reportUserTotals.students) reportUserTotals.students.textContent = totals.students ?? 0;
        if (reportUserTotals.all) reportUserTotals.all.textContent = totals.allMembers ?? (totals.teachers + totals.students);

        if (!reportUserSummaryHint) return;
        const stageSuffix = hasCompetitionStageInfo ? ` • ${stageCopy.chipLabel}` : '';
        if (clientTotals) {
            reportUserSummaryHint.textContent = clientTotals.teams > 0
                ? `อัปเดตจากข้อมูลทีมล่าสุดของคุณ${stageSuffix}`
                : `คุณยังไม่มีทีมในสิทธิ์ของคุณ${stageSuffix}`;
        } else if (fallbackTotals) {
            reportUserSummaryHint.textContent = totals.teams > 0
                ? `สรุปจากฐานข้อมูลล่าสุด${stageSuffix}`
                : `ยังไม่มีข้อมูลทีมในสิทธิ์ของคุณ${stageSuffix}`;
        } else {
            reportUserSummaryHint.textContent = `กำลังเตรียมข้อมูลทีมของคุณ${stageSuffix || '...'}`;
        }
    }

    function updateScoreDutySearchState() {
        if (!scoreDutySearchInput) return;
        const wrapperHidden = scoreDutySearchWrapper && scoreDutySearchWrapper.classList.contains('hidden');
        scoreDutySearchInput.disabled = isScoreDutyBlocked || wrapperHidden;
    }

    function setScoreDutyBlocked(blocked, message = 'กำลังอัปเดตผลคะแนน...') {
        isScoreDutyBlocked = blocked;
        if (!scoreDutySummary) return;
        if (blocked) {
            scoreDutySummary.classList.add('score-duty-blocked');
            scoreDutySummary.setAttribute('data-block-message', message || 'กำลังอัปเดตผลคะแนน...');
        } else {
            scoreDutySummary.classList.remove('score-duty-blocked');
            scoreDutySummary.removeAttribute('data-block-message');
        }
        updateScoreDutySearchState();
    }

    function releaseScoreDutyBlockIfPending() {
        if (!scoreDutyBlockReleasePending) return false;
        scoreDutyBlockReleasePending = false;
        setScoreDutyBlocked(false);
        return true;
    }

    function resetScoreDutyFocusIntent() {
        pendingScoreDutyFocusId = '';
        scoreDutyFocusPending = false;
        scoreDutyFocusReady = false;
    }

    function handlePendingScoreDutyFocus() {
        if (!scoreDutyFocusPending || !scoreDutyFocusReady || !pendingScoreDutyFocusId || !scoreDutyList) return;
        const target = Array.from(scoreDutyList.querySelectorAll('[data-score-duty-activity]'))
            .find(el => (el.dataset.scoreDutyActivity || '') === pendingScoreDutyFocusId);
        if (!target) return;
        let ancestor = target.closest('details');
        while (ancestor) {
            ancestor.open = true;
            ancestor = ancestor.parentElement ? ancestor.parentElement.closest('details') : null;
        }
        requestAnimationFrame(() => target.scrollIntoView({ behavior: 'smooth', block: 'center' }));
        target.classList.add('score-duty-activity--highlight');
        setTimeout(() => target.classList.remove('score-duty-activity--highlight'), 2400);
        pendingScoreDutyFocusId = '';
        scoreDutyFocusPending = false;
        scoreDutyFocusReady = false;
    }

    function updateScoreDutySummary(report) {
        if (!scoreDutySummary || !scoreDutyList) {
            releaseScoreDutyBlockIfPending();
            return;
        }
        const level = getCurrentUserLevel();
        const isScoreUser = currentUser && level === 'score';
        const isGroupAdmin = currentUser && level === 'group_admin';
        const isAreaStageUser = currentUser && ['admin', 'area'].includes(level) && isAreaStageActive();
        const canViewScoreDuty = isScoreUser || isGroupAdmin || isAreaStageUser;
        if (!canViewScoreDuty) {
            scoreDutySummary.classList.add('hidden');
            scoreDutyList.innerHTML = '';
            SCORE_ASSIGNED_ACTIVITIES = [];
            if (scoreDutySearchWrapper) scoreDutySearchWrapper.classList.add('hidden');
            updateScoreDutySearchState();
            if (!releaseScoreDutyBlockIfPending()) {
                setScoreDutyBlocked(false);
            }
            return;
        }
        if (Array.isArray(ALL_TEAMS) && !ALL_TEAMS.length) {
            scoreDutySummary.classList.remove('hidden');
            if (scoreDutyHint) scoreDutyHint.textContent = 'กำลังเตรียมข้อมูลทีม...';
            scoreDutyList.innerHTML = '<li class="px-3 py-2 text-sm text-slate-500">กำลังโหลดข้อมูลทีมสำหรับการให้คะแนน</li>';
            SCORE_ASSIGNED_ACTIVITIES = [];
            if (scoreDutySearchWrapper) scoreDutySearchWrapper.classList.add('hidden');
            updateScoreDutySearchState();
            scoreDutySearchTerm = '';
            if (scoreDutySearchInput) scoreDutySearchInput.value = '';
            if (!releaseScoreDutyBlockIfPending()) {
                setScoreDutyBlocked(false);
            }
            return;
        }

        let activities = [];
        if (isScoreUser) {
            const assignedIds = Array.isArray(report?.actorScoreActivities) ? [...report.actorScoreActivities] : [];
            SCORE_ASSIGNED_ACTIVITIES = assignedIds.slice();
            if (!assignedIds.length) {
                scoreDutySummary.classList.remove('hidden');
                if (scoreDutyHint) scoreDutyHint.textContent = 'ยังไม่มีการมอบหมายกิจกรรม รอติดต่อจากทีมงาน';
                scoreDutyList.innerHTML = '<li class="px-3 py-2 text-sm text-slate-500">ยังไม่มีการมอบหมายให้คะแนนกิจกรรม</li>';
                if (scoreDutySearchWrapper) scoreDutySearchWrapper.classList.add('hidden');
                updateScoreDutySearchState();
                scoreDutySearchTerm = '';
                if (scoreDutySearchInput) scoreDutySearchInput.value = '';
                if (!releaseScoreDutyBlockIfPending()) {
                    setScoreDutyBlocked(false);
                }
                return;
            }
            const teamsByActivity = new Map();
            const scopedTeams = getTeamsWithinClusterScope(getClusterFilterForDisplay());
            scopedTeams.forEach(team => {
                const key = (team.activity || '').toString();
                if (!key) return;
                if (!teamsByActivity.has(key)) teamsByActivity.set(key, []);
                teamsByActivity.get(key).push(team);
            });
            activities = assignedIds.map(id => {
                const info = getActivityInfoById(id);
                return {
                    id: info?.id || id,
                    label: info ? info.name || info.id : id,
                    category: info?.category || 'หมวดหมู่ทั่วไป',
                    teams: teamsByActivity.get((info?.id || id).toString()) || []
                };
            });
        } else {
            const clusterKey = getClusterFilterForDisplay();
            const clusterTeams = getTeamsWithinClusterScope(clusterKey);
            const grouped = new Map();
            clusterTeams.forEach(team => {
                const actId = (team.activity || '').toString();
                if (!actId) return;
                if (!grouped.has(actId)) grouped.set(actId, []);
                grouped.get(actId).push(team);
            });
            SCORE_ASSIGNED_ACTIVITIES = Array.from(grouped.keys());
            activities = Array.from(grouped.entries()).map(([id, teams]) => {
                const info = getActivityInfoById(id);
                return {
                    id,
                    label: info ? info.name || info.id : id,
                    category: info?.category || 'หมวดหมู่ทั่วไป',
                    teams
                };
            });
        }

        const clusterLabel = getCurrentUserClusterLabel();
        if (scoreDutyHint) {
            if (competitionStage === 'area') {
                scoreDutyHint.textContent = 'กิจกรรมระดับเขตที่อยู่ในการดูแลของคุณ';
            } else if (isScoreUser) {
                scoreDutyHint.textContent = clusterLabel
                    ? `กิจกรรมที่คุณต้องให้คะแนน (เครือข่าย: ${clusterLabel})`
                    : 'กิจกรรมที่คุณต้องให้คะแนน (แสดงเฉพาะเครือข่ายของคุณ)';
            } else {
                scoreDutyHint.textContent = clusterLabel
                    ? `กิจกรรมทั้งหมดในเครือข่าย ${clusterLabel}`
                    : 'กิจกรรมในเครือข่ายของคุณ';
            }
        }

        scoreDutySummary.classList.remove('hidden');
        if (scoreDutySearchInput && scoreDutySearchInput.value !== scoreDutySearchTerm) {
            scoreDutySearchInput.value = scoreDutySearchTerm;
        }
        if (scoreDutySearchWrapper) scoreDutySearchWrapper.classList.toggle('hidden', !activities.length);
        updateScoreDutySearchState();
        if (!activities.length) {
            scoreDutySearchTerm = '';
            if (scoreDutySearchInput) scoreDutySearchInput.value = '';
            scoreDutyList.innerHTML = '<li class="px-3 py-2 text-sm text-slate-500">ยังไม่มีข้อมูลให้คะแนนในเครือข่ายของคุณ</li>';
            releaseScoreDutyBlockIfPending();
            setScoreDutyBlocked(false);
            return;
        }

        activities.sort((a, b) => (a.label || '').localeCompare(b.label || '', 'th'));
        const query = (scoreDutySearchTerm || '').trim().toLowerCase();
        const filteredActivities = query
            ? activities.filter(activity => {
                const teamBlob = (activity.teams || []).map(team => `${team.teamName || ''} ${team.school || ''}`).join(' ');
                const haystack = `${activity.label} ${activity.category} ${teamBlob}`.toLowerCase();
                return haystack.includes(query);
            })
            : activities;

        if (!filteredActivities.length) {
            scoreDutyList.innerHTML = '<li class="px-3 py-2 text-sm text-slate-500">ไม่พบกิจกรรมที่ตรงกับคำค้นหา</li>';
            releaseScoreDutyBlockIfPending();
            setScoreDutyBlocked(false);
            return;
        }

        const categoryMap = new Map();
        filteredActivities.forEach(activity => {
            const key = activity.category || 'หมวดหมู่ทั่วไป';
            if (!categoryMap.has(key)) categoryMap.set(key, []);
            categoryMap.get(key).push(activity);
        });
        const categoryBlocks = Array.from(categoryMap.entries())
            .sort((a, b) => a[0].localeCompare(b[0], 'th'))
            .map(([categoryName, list], index) => renderScoreDutyCategory(categoryName, list, index === 0));
        scoreDutyList.innerHTML = categoryBlocks.join('');
        handlePendingScoreDutyFocus();
        if (releaseScoreDutyBlockIfPending()) {
            return;
        }
        if (isScoreDutyBlocked) {
            const blockMessage = scoreDutySummary ? scoreDutySummary.getAttribute('data-block-message') : '';
            setScoreDutyBlocked(true, blockMessage || 'กำลังอัปเดตผลคะแนน...');
        } else {
            setScoreDutyBlocked(false);
        }
    }

    function renderScoreDutyCategory(categoryName, activities, openByDefault) {
        const useAreaMetrics = competitionStage === 'area';
        const sortedActivities = Array.isArray(activities) ? [...activities].sort((a, b) => {
            return (a.label || '').localeCompare(b.label || '', 'th');
        }) : [];
        const allTeams = sortedActivities.reduce((acc, activity) => {
            if (Array.isArray(activity.teams)) {
                return acc.concat(activity.teams);
            }
            return acc;
        }, []);
        const totalTeams = allTeams.length;
        const scoredTeams = allTeams.filter(team => hasRecordedStageScore(team, useAreaMetrics)).length;
        const pendingTeams = Math.max(0, totalTeams - scoredTeams);
        const isComplete = totalTeams > 0 && pendingTeams === 0;
        const borderClass = isComplete ? 'border-emerald-200' : 'border-amber-200';
        const bgClass = isComplete ? 'bg-emerald-50' : 'bg-amber-50';
        const statusColorClass = isComplete ? 'text-emerald-700' : 'text-amber-700';
        const statusDotClass = isComplete ? 'bg-emerald-600' : 'bg-amber-600';
        const statusMessage = totalTeams
            ? (isComplete
                ? (useAreaMetrics ? 'บันทึกคะแนนระดับเขตครบแล้ว' : 'บันทึกครบแล้ว')
                : `เหลือ ${pendingTeams} ทีมยังไม่บันทึก${useAreaMetrics ? 'คะแนนระดับเขต' : ''}`)
            : 'ยังไม่มีทีม';
        const activityBlocks = sortedActivities.map(activity => renderScoreDutyActivity(activity)).join('');
        return `
            <li class="list-none">
                <details class="rounded-xl border ${borderClass} ${bgClass}" ${openByDefault ? 'open' : ''}>
                    <summary class="cursor-pointer list-none px-3 py-2 text-sm font-semibold text-slate-800 flex flex-wrap items-center justify-between gap-2">
                        <span>${escapeHtmlClient(categoryName || 'หมวดหมู่ทั่วไป')}</span>
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-xs text-slate-500">${sortedActivities.length} กิจกรรม • ${totalTeams} ทีม</span>
                            <span class="inline-flex items-center gap-1 text-[11px] font-semibold ${statusColorClass}">
                                <span class="h-2 w-2 rounded-full ${statusDotClass}"></span>
                                <span>${statusMessage}</span>
                            </span>
                        </div>
                    </summary>
                    <div class="mt-2 space-y-3 px-1 pb-3">
                        ${activityBlocks || '<p class="text-xs text-slate-500 px-2">ยังไม่มีทีมในหมวดหมู่นี้</p>'}
                    </div>
                </details>
            </li>
        `;
    }

    function renderScoreDutyActivity(activity) {
        const baseButtonClass = 'inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold transition-colors';
        const scoredButtonClass = `${baseButtonClass} border border-emerald-200 bg-emerald-50 text-emerald-600 hover:bg-emerald-100`;
        const pendingButtonClass = `${baseButtonClass} border border-amber-200 bg-amber-50 text-amber-600 hover:bg-amber-100`;
        const useAreaMetrics = competitionStage === 'area';
        const teams = Array.isArray(activity.teams) ? [...activity.teams].sort((a, b) => {
            const schoolCompare = (a.school || '').localeCompare(b.school || '', 'th');
            if (schoolCompare !== 0) return schoolCompare;
            return (a.teamName || '').localeCompare(b.teamName || '', 'th');
        }) : [];
        const teamList = teams.length
            ? teams.map(team => {
                const rawScore = useAreaMetrics ? team.areaScore : team.scoreTotal;
                const normalizedScore = normalizeScoreValue(rawScore);
                const hasScore = normalizedScore !== '';
                const numericScore = hasScore ? Number(normalizedScore) : null;
                const scoreLabel = hasScore
                    ? formatScoreDisplay(numericScore)
                    : (useAreaMetrics ? 'ยังไม่บันทึกคะแนนระดับเขต' : 'ยังไม่บันทึก');
                const scoreClass = hasScore ? 'text-slate-600' : 'text-amber-600';
                const areaRankValue = team && team.areaRank !== undefined && team.areaRank !== null && team.areaRank !== ''
                    ? team.areaRank
                    : 'ยังไม่จัดอันดับ';
                const rawRankOverride = team && team.rankOverride !== undefined && team.rankOverride !== null
                    ? team.rankOverride.toString().trim()
                    : '';
                const rankOverrideValue = rawRankOverride || 'ยังไม่กำหนด';
                const rankNote = useAreaMetrics
                    ? `<span class="text-[11px] text-slate-500">AreaRank: ${escapeHtmlClient(areaRankValue)}</span>`
                    : `<span class="text-[11px] text-slate-500">RankOverride: ${escapeHtmlClient(rankOverrideValue)}</span>`;
                const scorePrefix = useAreaMetrics ? 'AreaScore' : 'คะแนน';
                const scoreBlock = `<div class="flex flex-col items-end text-right">
                            <span class="text-[11px] font-semibold ${scoreClass}">${scorePrefix}: ${scoreLabel}</span>
                            ${rankNote}
                       </div>`;
                return `
                    <li class="flex items-center justify-between gap-3 flex-wrap">
                        <div>
                            <p class="text-slate-700 font-medium">${escapeHtmlClient(team.teamName || '-')}</p>
                            <p class="text-[11px] text-slate-500">${escapeHtmlClient(team.school || '-')}</p>
                        </div>
                        ${scoreBlock}
                    </li>
                `;
            }).join('')
            : '<li class="text-[11px] text-slate-500">ยังไม่มีทีมในเครือข่ายของคุณ</li>';
        const activityHasScore = teams.some(team => hasRecordedStageScore(team, useAreaMetrics));
        const buttonClass = activityHasScore ? scoredButtonClass : pendingButtonClass;
        const activityId = activity.id || '';
        return `
            <div class="score-duty-activity-card rounded-lg border border-slate-200 p-3 space-y-2" data-score-duty-activity="${escapeHtmlClient(activityId)}">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(activity.label || '-')}</p>
                        <p class="text-[11px] text-slate-500">${teams.length} ทีม</p>
                    </div>
                    <button type="button" class="${buttonClass}" data-score-open="${escapeHtmlClient(activityId)}">
                        <span class="material-symbols-outlined text-[14px]">edit_note</span>
                        <span>บันทึกคะแนน</span>
                    </button>
                </div>
                <ul class="text-xs text-slate-600 space-y-1">
                    ${teamList}
                </ul>
            </div>
        `;
    }

    function hasRecordedStageScore(team, useAreaMetrics) {
        const value = useAreaMetrics ? team.areaScore : team.scoreTotal;
        const normalizedScore = normalizeScoreValue(value);
        if (normalizedScore === '') return false;
        const numericScore = Number(normalizedScore);
        return Number.isFinite(numericScore);
    }

    function handleScoreDutySearchInput(event) {
        const value = (event.target?.value || '').trim();
        if (scoreDutySearchDebounce) {
            clearTimeout(scoreDutySearchDebounce);
        }
        scoreDutySearchDebounce = setTimeout(() => {
            scoreDutySearchTerm = value;
            updateScoreDutySummary(latestReportData);
        }, 200);
    }

    function shouldHideReportTotals() {
        return false;
    }

    function updateReportTotalsVisibility() {
        if (!reportTotalsGrid) return;
        reportTotalsGrid.classList.toggle('hidden', shouldHideReportTotals());
    }

    function resetCompetitionResultsUI() {
        competitionResultsCache = null;
        if (competitionResultsWrapper) {
            competitionResultsWrapper.classList.add('hidden');
        }
        if (competitionResultsBody) {
            competitionResultsBody.innerHTML = '';
        }
        if (competitionStatsGrid) {
            competitionStatsGrid.innerHTML = '';
        }
        if (competitionRepresentativeWrapper) {
            competitionRepresentativeWrapper.classList.add('hidden');
        }
        if (competitionRepresentativeBody) {
            competitionRepresentativeBody.innerHTML = '<p class="text-center text-slate-500 text-sm">ยังไม่มีข้อมูลตัวแทน</p>';
        }
        if (competitionAreaWrapper) {
            competitionAreaWrapper.classList.add('hidden');
        }
        if (competitionAreaBody) {
            competitionAreaBody.innerHTML = '<p class="text-center text-slate-500 text-sm">ยังไม่มีข้อมูลรอบระดับเขต</p>';
        }
        if (competitionFilterActivity) competitionFilterActivity.value = '';
        if (competitionFilterSchool) competitionFilterSchool.value = '';
        if (competitionFilterMedal) competitionFilterMedal.value = '';
        if (competitionFilterRepresentative) competitionFilterRepresentative.checked = false;
        competitionFilterState.activity = '';
        competitionFilterState.school = '';
        competitionFilterState.medal = '';
        competitionFilterState.onlyRepresentative = false;
    }

    function getCompetitionResultsSource(report) {
        if (!report || !report.competitionResults) return null;
        const useScoped = shouldUseScopedReportSummary();
        if (useScoped && report.competitionResults.scoped && Array.isArray(report.competitionResults.scoped.activities) && report.competitionResults.scoped.activities.length) {
            return report.competitionResults.scoped;
        }
        return report.competitionResults.global || null;
    }

    function updateCompetitionResultsUI(report) {
        const source = getCompetitionResultsSource(report);
        competitionResultsCache = source;
        refreshSchoolRepresentativeStats();
        if (!source || !Array.isArray(source.activities) || !source.activities.length) {
            resetCompetitionResultsUI();
            return;
        }
        setCompetitionFilterOptions(source);
        renderCompetitionStats(source);
        refreshCompetitionViews();
        if (competitionResultsWrapper) {
            competitionResultsWrapper.classList.remove('hidden');
        }
    }

    function setCompetitionFilterOptions(data) {
        if (!data || !Array.isArray(data.activities)) return;
        const activityOptions = data.activities
            .map(act => ({ value: act.id || '', label: act.name || act.id || '-' }))
            .filter(opt => opt.value)
            .sort((a, b) => a.label.localeCompare(b.label, 'th'));
        updateFilterSelect(competitionFilterActivity, activityOptions, '-- ทุกกิจกรรม --', 'activity');

        const schoolSet = new Set();
        data.activities.forEach(act => {
            act.entries.forEach(entry => {
                if (entry.school) {
                    schoolSet.add(entry.school);
                }
            });
        });
        const schoolOptions = Array.from(schoolSet)
            .sort((a, b) => a.localeCompare(b, 'th'))
            .map(name => ({ value: name, label: name }));
        updateFilterSelect(competitionFilterSchool, schoolOptions, '-- ทุกโรงเรียน --', 'school');

        const medalOptions = [
            { value: 'gold', label: 'เหรียญทอง' },
            { value: 'silver', label: 'เหรียญเงิน' },
            { value: 'bronze', label: 'เหรียญทองแดง' },
            { value: 'merit', label: 'ชมเชย' },
            { value: 'participant', label: 'เข้าร่วม' }
        ];
        updateFilterSelect(competitionFilterMedal, medalOptions, '-- ทุกเหรียญ --', 'medal');

        if (competitionFilterRepresentative) {
            competitionFilterRepresentative.checked = competitionFilterState.onlyRepresentative;
        }
    }

    function updateFilterSelect(selectEl, options, placeholderLabel, stateKey) {
        if (!selectEl) return;
        const currentValue = competitionFilterState[stateKey] || '';
        let html = '';
        if (placeholderLabel) {
            html += `<option value="">${placeholderLabel}</option>`;
        }
        let hasValue = false;
        options.forEach(opt => {
            const selected = opt.value === currentValue && opt.value !== '';
            if (selected) hasValue = true;
            html += `<option value="${opt.value}">${escapeHtmlClient(opt.label)}</option>`;
        });
        selectEl.innerHTML = html;
        if (currentValue && !hasValue) {
            competitionFilterState[stateKey] = '';
        }
        selectEl.value = competitionFilterState[stateKey];
    }

    function renderCompetitionStats(data) {
        if (!competitionStatsGrid) return;
        const summary = data.summary || {};
        const medals = summary.medals || {};
        const representativeCount = typeof summary.clusterRepresentatives === 'number'
            ? summary.clusterRepresentatives
            : (summary.representatives || 0);
        const cards = [
            { label: 'จำนวนกิจกรรม', value: summary.totalActivities || 0 },
            { label: 'ผู้เข้าแข่งขันรวม', value: summary.totalParticipants || 0 },
            { label: 'เหรียญทอง', value: medals.gold || 0 },
            { label: 'เหรียญเงิน', value: medals.silver || 0 },
            { label: 'เหรียญทองแดง', value: medals.bronze || 0 },
            { label: 'ชมเชย', value: medals.merit || 0 },
            { label: 'ตัวแทนเครือข่าย', value: representativeCount }
        ];
        if (typeof summary.areaFinalActivities === 'number') {
            cards.push({ label: 'กิจกรรมรอบระดับเขต', value: summary.areaFinalActivities || 0 });
        }
        competitionStatsGrid.innerHTML = cards.map(card => `
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                <p class="text-2xl font-bold text-slate-900">${card.value}</p>
                <p class="text-xs text-slate-500 mt-1">${card.label}</p>
            </div>
        `).join('');
    }

    function getFilteredCompetitionActivities() {
        if (!competitionResultsCache || !Array.isArray(competitionResultsCache.activities)) return [];
        const activityFilter = competitionFilterState.activity || '';
        const schoolFilter = normalizeText(competitionFilterState.school || '');
        const medalFilter = (competitionFilterState.medal || '').toLowerCase();
        const onlyRep = competitionFilterState.onlyRepresentative;
        const clusterFilter = getClusterFilterForDisplay();
        return competitionResultsCache.activities.map(activity => {
            if (activityFilter && activity.id !== activityFilter) return null;
            const entries = activity.entries.filter(entry => {
                if (clusterFilter && !matchesClusterKey(entry.clusterKey || '', entry.clusterLabel || '', clusterFilter)) return false;
                if (schoolFilter && normalizeText(entry.school) !== schoolFilter) return false;
                if (medalFilter && entry.medalKey !== medalFilter) return false;
                if (onlyRep && !entry.isRepresentative) return false;
                return true;
            });
            if (!entries.length) return null;
            return { ...activity, entries };
        }).filter(Boolean);
    }

    function buildClusteredCompetitionDataset(filteredActivities) {
        if (!Array.isArray(filteredActivities)) return [];
        const clusterMap = new Map();
        filteredActivities.forEach(activity => {
            const entries = Array.isArray(activity.entries) ? activity.entries : [];
            const bucket = new Map();
            entries.forEach(entry => {
                const key = entry.clusterKey || normalizeText(entry.clusterLabel || '');
                const clusterKey = key || 'unassigned';
                if (!bucket.has(clusterKey)) {
                    bucket.set(clusterKey, []);
                }
                bucket.get(clusterKey).push(entry);
            });
            bucket.forEach((clusterEntries, clusterKey) => {
                if (!clusterEntries.length) return;
                if (!clusterMap.has(clusterKey)) {
                    clusterMap.set(clusterKey, {
                        clusterKey,
                        clusterLabel: clusterEntries[0]?.clusterLabel || 'ไม่ระบุเครือข่าย',
                        activities: []
                    });
                }
                clusterMap.get(clusterKey).activities.push({
                    id: activity.id,
                    name: activity.name,
                    category: activity.category,
                    entries: clusterEntries
                });
            });
        });
        return Array.from(clusterMap.values())
            .map(cluster => ({
                ...cluster,
                activities: (cluster.activities || []).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'th'))
            }))
            .sort((a, b) => (a.clusterLabel || '').localeCompare(b.clusterLabel || '', 'th'));
    }

    function refreshCompetitionViews() {
        const filteredActivities = getFilteredCompetitionActivities();
        const clusterGroups = buildClusteredCompetitionDataset(filteredActivities);
        renderCompetitionResultsSection(clusterGroups);
        renderCompetitionRepresentatives(clusterGroups);
        renderCompetitionAreaFinals(competitionResultsCache);
        updateAreaScoreCard();
    }

    function renderCompetitionResultsSection(clusterGroups) {
        if (!competitionResultsBody) return;
        if (!Array.isArray(clusterGroups) || !clusterGroups.length) {
            competitionResultsBody.innerHTML = '<p class="text-center text-slate-500">ไม่พบผลการแข่งขันตามตัวกรอง</p>';
            return;
        }
        competitionResultsBody.innerHTML = clusterGroups.map(renderClusterCompetitionBlock).join('');
    }

    function renderClusterCompetitionBlock(cluster) {
        const activities = Array.isArray(cluster.activities) ? cluster.activities : [];
        if (!activities.length) {
            return `
                <div class="rounded-2xl border border-slate-200 p-4">
                    <p class="text-sm font-semibold text-slate-900">กลุ่มเครือข่าย: ${escapeHtmlClient(cluster.clusterLabel || 'ไม่ระบุเครือข่าย')}</p>
                    <p class="text-xs text-slate-500 mt-2">ยังไม่มีข้อมูลการแข่งขัน</p>
                </div>
            `;
        }
        return `
            <div class="rounded-2xl border border-slate-200 p-4 space-y-4">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">กลุ่มเครือข่าย: ${escapeHtmlClient(cluster.clusterLabel || 'ไม่ระบุเครือข่าย')}</p>
                        <p class="text-[11px] text-slate-500">${activities.length} กิจกรรม</p>
                    </div>
                </div>
                <div class="space-y-4">
                    ${activities.map(renderCompetitionActivityBlock).join('')}
                </div>
            </div>
        `;
    }

    function buildRepresentativeDataset(clusterGroups) {
        if (!Array.isArray(clusterGroups)) return [];
        return clusterGroups.map(cluster => {
            const categories = new Map();
            (cluster.activities || []).forEach(activity => {
                const representative = (activity.entries || []).find(entry => entry.isRepresentative);
                const hasScore = representative && typeof representative.score === 'number' && !Number.isNaN(representative.score);
                if (!representative || !hasScore) return;
                const categoryName = activity.category || 'หมวดหมู่ทั่วไป';
                if (!categories.has(categoryName)) {
                    categories.set(categoryName, []);
                }
                categories.get(categoryName).push({
                    activityName: activity.name,
                    teamName: representative.teamName,
                    school: representative.school,
                    score: representative.score,
                    medalLabel: representative.medalLabel,
                    medalKey: representative.medalKey
                });
            });
            const categoryList = Array.from(categories.entries())
                .map(([name, entries]) => ({ name, entries }))
                .sort((a, b) => a.name.localeCompare(b.name, 'th'));
            return {
                clusterLabel: cluster.clusterLabel || 'ไม่ระบุเครือข่าย',
                categories: categoryList
            };
        }).filter(cluster => Array.isArray(cluster.categories) && cluster.categories.length);
    }

    function renderCompetitionRepresentatives(clusterGroups) {
        if (!competitionRepresentativeWrapper || !competitionRepresentativeBody) return;
        if (competitionStage === 'area') {
            competitionRepresentativeWrapper.classList.add('hidden');
            competitionRepresentativeBody.innerHTML = '';
            return;
        }
        const representativeClusters = buildRepresentativeDataset(clusterGroups);
        if (!representativeClusters.length) {
            competitionRepresentativeWrapper.classList.add('hidden');
            competitionRepresentativeBody.innerHTML = '<p class="text-center text-slate-500 text-sm">ยังไม่มีข้อมูลตัวแทน</p>';
            return;
        }
        competitionRepresentativeWrapper.classList.remove('hidden');
        competitionRepresentativeBody.innerHTML = representativeClusters
            .map((cluster, index) => renderRepresentativeClusterBlock(cluster, index === 0))
            .join('');
    }

    function canUseAreaScoreBlock() {
        if (!currentUser) return false;
        const level = getCurrentUserLevel();
        return ['admin', 'area', 'group_admin', 'score'].includes(level);
    }

    function updateAreaScoreCard() {
        if (!areaScoreCard) return;
        const shouldShow = competitionStage === 'area' && canUseAreaScoreBlock();
        areaScoreCard.classList.toggle('hidden', !shouldShow);
        if (!shouldShow) return;
        const activities = (competitionResultsCache?.activities || []).filter(act => act && act.id);
        if (!activities.length) {
            if (areaScoreActivitySelect) {
                areaScoreActivitySelect.innerHTML = '<option value="">ไม่มีกิจกรรมระดับเขต</option>';
            }
            if (areaScoreStartButton) {
                areaScoreStartButton.disabled = true;
            }
            if (areaScoreHelper) {
                areaScoreHelper.textContent = 'ยังไม่มีข้อมูลกิจกรรมในรอบระดับเขต';
            }
        } else {
            const options = activities
                .map(act => `<option value="${escapeHtmlClient(act.id)}">${escapeHtmlClient(act.name || act.id)}</option>`)
                .join('');
            if (areaScoreActivitySelect) {
                areaScoreActivitySelect.innerHTML = `<option value="">เลือกกิจกรรมระดับเขต</option>${options}`;
            }
            if (areaScoreStartButton) {
                areaScoreStartButton.disabled = false;
            }
            if (areaScoreHelper) {
                areaScoreHelper.textContent = `มี ${activities.length} กิจกรรมในรอบระดับเขต`;
            }
        }
        if (areaScoreStageLabel) {
            areaScoreStageLabel.textContent = getCompetitionStageLabel(competitionStage);
        }
    }

    function renderCompetitionAreaFinals(source) {
        if (!competitionAreaWrapper || !competitionAreaBody) return;
        if (competitionStage !== 'area') {
            competitionAreaWrapper.classList.add('hidden');
            competitionAreaBody.innerHTML = '<p class="text-center text-slate-500 text-sm">ผลการแข่งขันระดับเขตจะปรากฏเมื่อระบบอยู่ในรอบระดับเขต</p>';
            return;
        }
        const base = source && Array.isArray(source.areaFinals) ? source.areaFinals : [];
        const activityFilter = competitionFilterState.activity || '';
        const filtered = activityFilter ? base.filter(item => item.activityId === activityFilter) : base;
        if (!filtered.length) {
            competitionAreaWrapper.classList.add('hidden');
            competitionAreaBody.innerHTML = '<p class="text-center text-slate-500 text-sm">ยังไม่มีข้อมูลรอบระดับเขต</p>';
            return;
        }
        competitionAreaWrapper.classList.remove('hidden');
        competitionAreaBody.innerHTML = filtered.map(renderAreaFinalActivityBlock).join('');
    }

    function renderAreaFinalActivityBlock(final) {
        const finalists = Array.isArray(final.finalists) ? final.finalists : [];
        const entries = finalists.length
            ? finalists.map(renderAreaFinalEntry).join('')
            : '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลรอบนี้</p>';
        return `
            <div class="rounded-2xl border border-slate-200 p-4 space-y-3">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(final.activityName || '-')}</p>
                        <p class="text-[11px] text-slate-500">หมวดหมู่: ${escapeHtmlClient(final.category || 'ไม่ระบุหมวดหมู่')}</p>
                    </div>
                    <p class="text-xs text-slate-500">${finalists.length} ตัวแทน</p>
                </div>
                <div class="space-y-2">
                    ${entries}
                </div>
            </div>
        `;
    }

    function renderAreaFinalEntry(entry) {
        return `
            <div class="competition-area-entry">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(entry.areaRank || '-')} . ${escapeHtmlClient(entry.teamName || '-')}</p>
                        <p class="text-xs text-slate-500">${escapeHtmlClient(entry.school || '-')} • เครือข่าย: ${escapeHtmlClient(entry.clusterLabel || '-')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="competition-medal ${entry.medalKey || 'participant'}">${escapeHtmlClient(entry.medalLabel || '-')}</span>
                        <span class="text-sm font-semibold text-slate-900">${formatScoreDisplay(entry.score)}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function renderRepresentativeClusterBlock(cluster, openByDefault) {
        const categories = Array.isArray(cluster.categories) ? cluster.categories : [];
        const categoryHtml = categories
            .map((category, index) => renderRepresentativeCategoryBlock(category, index === 0))
            .join('');
        return `
            <details class="rounded-2xl border border-slate-200 bg-white" ${openByDefault ? 'open' : ''}>
                <summary class="cursor-pointer list-none px-3 py-2 text-sm font-semibold text-slate-800 flex items-center justify-between gap-2">
                    <span>กลุ่มเครือข่าย: ${escapeHtmlClient(cluster.clusterLabel || 'ไม่ระบุเครือข่าย')}</span>
                    <span class="text-xs text-slate-500">${categories.length} หมวดหมู่</span>
                </summary>
                <div class="mt-3 space-y-3">
                    ${categoryHtml || '<p class="text-xs text-slate-500 px-3 pb-3">ยังไม่มีตัวแทนในกลุ่มนี้</p>'}
                </div>
            </details>
        `;
    }

    function renderRepresentativeCategoryBlock(category, openByDefault) {
        const entries = Array.isArray(category.entries) ? category.entries : [];
        const entriesHtml = entries.map(entry => `
            <div class="flex flex-col gap-1 border-t border-slate-100 px-3 py-2 first:border-t-0">
                <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(entry.activityName)}</p>
                <p class="text-xs text-slate-600">${escapeHtmlClient(entry.teamName)} • ${escapeHtmlClient(entry.school)}</p>
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <span>คะแนน ${escapeHtmlClient(formatScoreDisplay(entry.score))}</span>
                    <span class="competition-medal ${entry.medalKey}">${escapeHtmlClient(entry.medalLabel)}</span>
                </div>
            </div>
        `).join('');
        return `
            <details class="rounded-xl border border-slate-200 bg-slate-50" ${openByDefault ? 'open' : ''}>
                <summary class="cursor-pointer list-none px-3 py-2 text-xs font-semibold text-slate-700 flex items-center justify-between gap-2">
                    <span>${escapeHtmlClient(category.name || 'หมวดหมู่ทั่วไป')}</span>
                    <span class="text-[11px] text-slate-500">${entries.length} ตัวแทน</span>
                </summary>
                <div class="mt-1">
                    ${entriesHtml || '<p class="text-[11px] text-slate-500 px-3 py-2">ยังไม่มีตัวแทน</p>'}
                </div>
            </details>
        `;
    }

    function renderCompetitionActivityBlock(activity) {
        const entriesHtml = activity.entries.map(entry => {
            const teachers = (entry.teachers || []).length ? entry.teachers.join(', ') : '-';
            const students = (entry.students || []).length ? entry.students.join(', ') : '-';
            const representativeBadge = entry.isRepresentative ? '<span class="competition-representative-badge mt-2">ตัวแทน</span>' : '';
            return `
                <div class="competition-entry">
                    <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">#${entry.rank} ${escapeHtmlClient(entry.teamName)}</p>
                            <p class="text-xs text-slate-500">${escapeHtmlClient(entry.school)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-slate-900">${escapeHtmlClient(formatScoreDisplay(entry.score))}</p>
                            <p class="text-[11px] text-slate-500">คะแนน (เต็ม 100)</p>
                            <span class="competition-medal ${entry.medalKey}">${escapeHtmlClient(entry.medalLabel)}</span>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-slate-500">
                        <p>ระดับ: ${escapeHtmlClient(entry.level || '-')}</p>
                        <p>ครูผู้ควบคุม: ${escapeHtmlClient(teachers)}</p>
                        <p class="md:col-span-2">นักเรียน: ${escapeHtmlClient(students)}</p>
                    </div>
                    ${representativeBadge}
                </div>
            `;
        }).join('');
        return `
            <div class="rounded-2xl border border-slate-200 p-4">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(activity.name || '-')}</p>
                        <p class="text-[11px] text-slate-500">หมวดหมู่: ${escapeHtmlClient(activity.category || 'ไม่ระบุหมวดหมู่')}</p>
                    </div>
                    <p class="text-xs text-slate-500">ทีมที่มีคะแนน: ${activity.entries.length}</p>
                </div>
                <div class="mt-3">
                    ${entriesHtml}
                </div>
            </div>
        `;
    }

    function formatScoreDisplay(score) {
        if (score === null || score === undefined || isNaN(score)) return '-';
        return Number.isInteger(score) ? score.toString() : Number(score).toFixed(2);
    }

    function getClusterLeaderboardDataset(report) {
        if (!report || !report.clusterLeaderboard) return null;
        const useScoped = shouldUseScopedReportSummary();
        const data = report.clusterLeaderboard;
        if (!currentUser) {
            return data.global || [];
        }
        if (useScoped && Array.isArray(data.scoped) && data.scoped.length) {
            return data.scoped;
        }
        const globalData = Array.isArray(data.global) ? data.global : [];
        const userCluster = getUserClusterForFilter();
        if (userCluster) {
            const filtered = globalData.filter(cluster => {
                const byKey = normalizeText(cluster.key || '') === userCluster;
                const byLabel = normalizeText(cluster.label || '') === userCluster;
                return byKey || byLabel;
            });
            if (filtered.length) return filtered;
        }
        return globalData;
    }

    function compareLeaderboardSchools(a, b) {
        if (isAreaStageActive()) {
            const statsA = a?.areaStats || {};
            const statsB = b?.areaStats || {};
            const bestRankA = typeof statsA.bestRank === 'number' ? statsA.bestRank : Number.POSITIVE_INFINITY;
            const bestRankB = typeof statsB.bestRank === 'number' ? statsB.bestRank : Number.POSITIVE_INFINITY;
            if (bestRankA !== bestRankB) return bestRankA - bestRankB;
            const repA = statsA.representativeCount || 0;
            const repB = statsB.representativeCount || 0;
            if (repB !== repA) return repB - repA;
            const bestScoreA = typeof statsA.bestScore === 'number' ? statsA.bestScore : -Infinity;
            const bestScoreB = typeof statsB.bestScore === 'number' ? statsB.bestScore : -Infinity;
            if (bestScoreB !== bestScoreA) return bestScoreB - bestScoreA;
            return (a?.name || '').localeCompare(b?.name || '', 'th');
        }
        const medalKeys = ['gold', 'silver', 'bronze', 'merit'];
        const medalsA = a?.medals || {};
        const medalsB = b?.medals || {};
        for (const key of medalKeys) {
            const diff = (medalsB[key] || 0) - (medalsA[key] || 0);
            if (diff !== 0) return diff;
        }
        return (b?.totalScore || 0) - (a?.totalScore || 0);
    }

    function getAreaLeaderboardDataset(report) {
        const dataset = getClusterLeaderboardDataset(report);
        if (!dataset || !dataset.length) return [];
        const flattened = [];
        dataset.forEach(cluster => {
            const schools = Array.isArray(cluster.schools) ? cluster.schools : [];
            schools.forEach(school => {
                flattened.push({
                    ...school,
                    clusterLabel: cluster.label || 'ไม่ระบุเครือข่าย'
                });
            });
        });
        return flattened.slice().sort(compareLeaderboardSchools);
    }

    function getRepresentativeActivitiesForSchool(schoolName) {
        if (!schoolName || !Array.isArray(ALL_TEAMS) || !ALL_TEAMS.length) return [];
        const normalizedSchool = normalizeText(schoolName);
        const clusterFilter = getClusterFilterForDisplay();
        const seen = new Set();
        const activities = [];
        ALL_TEAMS.forEach(team => {
            if (normalizeText(team.school || '') !== normalizedSchool) return;
            if (!isTeamRepresentative(team)) return;
            if (clusterFilter) {
                const teamClusterId = normalizeText(getTeamCluster(team));
                const teamClusterLabel = normalizeText(getTeamClusterLabel(team));
                if (teamClusterId !== clusterFilter && teamClusterLabel !== clusterFilter) {
                    return;
                }
            }
            const label = getActivityLabel(team.activity) || team.activity || '-';
            const key = normalizeText(label);
            if (seen.has(key)) return;
            seen.add(key);
            activities.push(label);
        });
        return activities;
    }

    function formatRepresentativeActivityListHtml(schoolName) {
        if (!schoolName) return '';
        if (!Array.isArray(ALL_TEAMS) || !ALL_TEAMS.length) {
            return '<p class="text-[10px] text-slate-400 mt-0.5">กำลังโหลดข้อมูลตัวแทน...</p>';
        }
        const activities = getRepresentativeActivitiesForSchool(schoolName);
        if (!activities.length) {
            return '<p class="text-[10px] text-rose-500 mt-0.5">ยังไม่มีทีมตัวแทน</p>';
        }
        const LIMIT = 3;
        const visible = activities.slice(0, LIMIT).map(name => escapeHtmlClient(name));
        const remaining = activities.length - visible.length;
        const suffix = remaining > 0 ? ` +${remaining} กิจกรรม` : '';
        return `<p class="text-[10px] text-slate-500 mt-0.5">กิจกรรมตัวแทน: ${visible.join(', ')}${suffix}</p>`;
    }

    function formatAreaRepresentativeCell(school) {
        const repCount = typeof school?.areaStats?.representativeCount === 'number'
            ? school.areaStats.representativeCount
            : 0;
        const bestRank = typeof school?.areaStats?.bestRank === 'number' ? school.areaStats.bestRank : null;
        if (!repCount && !bestRank) return 'ยังไม่มีข้อมูล';
        if (!repCount) return bestRank ? `อันดับ ${bestRank}` : 'ยังไม่มีข้อมูล';
        const rankText = bestRank ? ` • อันดับ ${bestRank}` : '';
        return `${repCount} ทีม${rankText}`;
    }

    function renderAreaLeaderboardBlock(schools) {
        const LIMIT = 10;
        const visible = schools.slice(0, LIMIT);
        const hasMore = schools.length > LIMIT;
        const summaryNote = hasMore ? `<p class="text-[11px] text-slate-500 mt-2">แสดงอันดับ ${visible.length} จาก ${schools.length} โรงเรียน</p>` : '';
        const showClusterActivityList = isAreaStageActive() && getCurrentUserLevel() === 'group_admin';
        const rows = visible.map((school, idx) => {
            const safeSchool = escapeHtmlClient(school.name || '-');
            const safeClusterLabel = escapeHtmlClient(school.clusterLabel || 'ไม่ระบุเครือข่าย');
            const medals = school.medals || {};
            const totalMedals = (medals.gold || 0) + (medals.silver || 0) + (medals.bronze || 0) + (medals.merit || 0);
            const repDisplay = isAreaStageActive()
                ? formatAreaRepresentativeCell(school)
                : formatRepresentativeRatio(getSchoolRepresentativeStats(school.name));
            const repNote = showClusterActivityList
                ? `${formatRepresentativeActivityListHtml(school.name)}<p class="text-[11px] text-slate-500 mt-0.5">เครือข่าย: ${safeClusterLabel}</p>`
                : `<p class="text-[11px] text-slate-500 mt-0.5">เครือข่าย: ${safeClusterLabel}</p>`;
            return `
                <tr>
                    <td class="p-2 text-center font-semibold text-slate-700" data-label="อันดับ">${idx + 1}</td>
                    <td class="p-2 text-slate-700" data-label="โรงเรียน">
                        <button type="button"
                            class="w-full text-left font-semibold text-slate-800 hover:text-sky-600 transition-colors"
                            data-school-award="${safeSchool}"
                            data-cluster-label="${safeClusterLabel}">
                            ${safeSchool}
                            ${repNote}
                        </button>
                    </td>
                    <td class="p-2 text-center text-slate-700 font-semibold" data-label="ตัวแทน">${escapeHtmlClient(repDisplay)}</td>
                    <td class="p-2 text-center text-amber-600" data-label="ทอง">${medals.gold || 0}</td>
                    <td class="p-2 text-center text-slate-600" data-label="เงิน">${medals.silver || 0}</td>
                    <td class="p-2 text-center text-orange-600" data-label="ทองแดง">${medals.bronze || 0}</td>
                    <td class="p-2 text-center text-emerald-600" data-label="ชมเชย">${medals.merit || 0}</td>
                    <td class="p-2 text-center font-semibold text-slate-900" data-label="รวมเหรียญ">${totalMedals}</td>
                </tr>
            `;
        }).join('');
        const emptyRow = '<tr><td colspan="8" class="p-3 text-center text-slate-500">ยังไม่มีข้อมูลเหรียญ</td></tr>';
        return `
            <div class="rounded-2xl border border-slate-200 bg-white">
                <div class="mt-3 overflow-x-auto">
                    <table class="cluster-leaderboard-table">
                        <thead>
                            <tr>
                                <th class="w-16 text-center">อันดับ</th>
                                <th>โรงเรียน</th>
                                <th class="w-24 text-center">ตัวแทน</th>
                                <th class="w-20 text-center">ทอง</th>
                                <th class="w-20 text-center">เงิน</th>
                                <th class="w-24 text-center">ทองแดง</th>
                                <th class="w-24 text-center">ชมเชย</th>
                                <th class="w-20 text-center">รวมเหรียญ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows || emptyRow}
                        </tbody>
                    </table>
                </div>
                ${summaryNote}
            </div>
        `;
    }

    function resetClusterLeaderboard() {
        if (!clusterLeaderboardWrapper || !clusterLeaderboardContent) return;
        clusterLeaderboardWrapper.classList.add('hidden');
        clusterLeaderboardContent.innerHTML = '';
    }

    function renderClusterLeaderboard(report) {
        if (!clusterLeaderboardWrapper || !clusterLeaderboardContent) return;
        const isAreaStage = competitionStage === 'area';
        if (isAreaStage) {
            const areaDataset = getAreaLeaderboardDataset(report);
            if (!areaDataset || !areaDataset.length) {
                clusterLeaderboardWrapper.classList.remove('hidden');
                clusterLeaderboardContent.innerHTML = '<p class="text-xs text-slate-500 text-center">ยังไม่มีข้อมูลรอบระดับเขต</p>';
                if (leaderboardDescription) {
                    leaderboardDescription.textContent = 'ยังไม่มีข้อมูลรอบระดับเขต';
                }
                if (leaderboardStageChip) {
                    updateStageChip(leaderboardStageChip, 'รอบระดับเขต', 'area');
                }
                return;
            }
            clusterLeaderboardWrapper.classList.remove('hidden');
            clusterLeaderboardContent.innerHTML = renderAreaLeaderboardBlock(areaDataset);
            if (leaderboardDescription) {
                leaderboardDescription.textContent = 'ผลการแข่งขันรอบระดับเขต เรียงตามเหรียญรวม';
            }
            if (leaderboardStageChip) {
                updateStageChip(leaderboardStageChip, 'รอบระดับเขต', 'area');
            }
            return;
        }

        const clusterDataset = getClusterLeaderboardDataset(report);
        if (!clusterDataset || !clusterDataset.length) {
            clusterLeaderboardWrapper.classList.remove('hidden');
            clusterLeaderboardContent.innerHTML = '<p class="text-xs text-slate-500 text-center">ยังไม่มีข้อมูลเหรียญในรอบกลุ่มเครือข่าย</p>';
            if (leaderboardDescription) {
                leaderboardDescription.textContent = 'ยังไม่มีข้อมูลเหรียญในรอบกลุ่มเครือข่าย';
            }
            if (leaderboardStageChip) {
                updateStageChip(leaderboardStageChip, 'รอบกลุ่มเครือข่าย', 'cluster');
            }
            return;
        }

        clusterLeaderboardWrapper.classList.remove('hidden');
        clusterLeaderboardContent.innerHTML = clusterDataset
            .map((cluster, index) => renderClusterLeaderboardBlock(cluster, index === 0))
            .join('');
        if (leaderboardDescription) {
            leaderboardDescription.textContent = 'ผลการแข่งขันรอบกลุ่มเครือข่าย เรียงตามเหรียญรวม';
        }
        if (leaderboardStageChip) {
            updateStageChip(leaderboardStageChip, 'รอบกลุ่มเครือข่าย', 'cluster');
        }
    }

    function renderClusterLeaderboardBlock(cluster, openByDefault) {
        const LIMIT = 10;
        const schools = Array.isArray(cluster.schools) ? [...cluster.schools] : [];
        const sortedSchools = schools.sort(compareLeaderboardSchools);
        const visible = sortedSchools.slice(0, LIMIT);
        const hasMore = sortedSchools.length > LIMIT;
        const medalCell = medalKey => (school) => school.medals?.[medalKey] || 0;
        const totals = school => (school.medals?.gold || 0) + (school.medals?.silver || 0) + (school.medals?.bronze || 0) + (school.medals?.merit || 0);
        const summaryNote = hasMore ? `<p class="text-[11px] text-slate-500 mt-2">แสดงอันดับ ${visible.length} จาก ${sortedSchools.length} โรงเรียน</p>` : '';
        const clusterLabelAttr = escapeHtmlClient(cluster.label || '');
        const rows = visible.map((school, idx) => {
            const repStats = getSchoolRepresentativeStats(school.name);
            const repDisplay = formatRepresentativeRatio(repStats);
            const safeSchool = escapeHtmlClient(school.name || '-');
            return `
                <tr>
                    <td class="p-2 text-center font-semibold text-slate-700" data-label="อันดับ">${idx + 1}</td>
                    <td class="p-2 text-slate-700" data-label="โรงเรียน">
                        <button type="button"
                            class="w-full text-left font-semibold text-slate-800 hover:text-sky-600 transition-colors"
                            data-school-award="${safeSchool}"
                            data-cluster-label="${clusterLabelAttr}">
                            ${safeSchool}
                        </button>
                    </td>
                    <td class="p-2 text-center text-slate-700 font-semibold" data-label="ตัวแทน">${escapeHtmlClient(repDisplay)}</td>
                    <td class="p-2 text-center text-amber-600" data-label="ทอง">${medalCell('gold')(school)}</td>
                    <td class="p-2 text-center text-slate-600" data-label="เงิน">${medalCell('silver')(school)}</td>
                    <td class="p-2 text-center text-orange-600" data-label="ทองแดง">${medalCell('bronze')(school)}</td>
                    <td class="p-2 text-center text-emerald-600" data-label="ชมเชย">${medalCell('merit')(school)}</td>
                    <td class="p-2 text-center font-semibold text-slate-900" data-label="รวมเหรียญ">${totals(school)}</td>
                </tr>
            `;
        }).join('');
        return `
            <details class="rounded-2xl border border-slate-200 bg-white" ${openByDefault ? 'open' : ''}>
                <summary class="cursor-pointer list-none px-3 py-2 text-sm font-semibold text-slate-800 flex items-center justify-between gap-2">
                    <span>เครือข่าย: ${escapeHtmlClient(cluster.label || 'ไม่ระบุ')}</span>
                    <span class="text-xs text-slate-500">${schools.length} โรงเรียน</span>
                </summary>
                <div class="mt-3 overflow-x-auto">
                    <table class="cluster-leaderboard-table">
                        <thead>
                            <tr>
                                <th class="w-16 text-center">อันดับ</th>
                                <th>โรงเรียน</th>
                                <th class="w-24 text-center">ตัวแทน</th>
                                <th class="w-20 text-center">ทอง</th>
                                <th class="w-20 text-center">เงิน</th>
                                <th class="w-24 text-center">ทองแดง</th>
                                <th class="w-24 text-center">ชมเชย</th>
                                <th class="w-20 text-center">รวมเหรียญ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows || '<tr><td colspan="8" class="p-3 text-center text-slate-500">ยังไม่มีข้อมูลเหรียญ</td></tr>'}
                        </tbody>
                    </table>
                    ${summaryNote}
                </div>
            </details>
        `;
    }

    function refreshSchoolRepresentativeStats() {
        schoolRepresentativeStats = new Map();
        const teams = Array.isArray(ALL_TEAMS) ? ALL_TEAMS : [];
        if (!teams.length) return;
        teams.forEach(team => {
            const schoolName = (team.school || '').toString().trim();
            if (!schoolName) return;
            const key = normalizeText(schoolName);
            if (!schoolRepresentativeStats.has(key)) {
                schoolRepresentativeStats.set(key, {
                    school: schoolName,
                    activities: new Set(),
                    representatives: new Set()
                });
            }
            const stats = schoolRepresentativeStats.get(key);
            const activityKey = (team.activity || '').toString();
            if (activityKey) {
                stats.activities.add(activityKey);
            }
            const repOverride = isTeamRepresentative(team);
            if (repOverride && activityKey) {
                stats.representatives.add(activityKey);
            }
        });
    }

    function getSchoolRepresentativeStats(schoolName) {
        if (!schoolName) return null;
        return schoolRepresentativeStats.get(normalizeText(schoolName)) || null;
    }

    function formatRepresentativeRatio(stats) {
        if (!stats) return '0 (0%)';
        const total = stats.activities?.size || 0;
        const reps = stats.representatives?.size || 0;
        const percent = total ? Math.round((reps / total) * 100) : 0;
        return `${reps} (${percent}%)`;
    }

    function handleClusterLeaderboardAction(event) {
        const target = event.target.closest('[data-school-award]');
        if (!target) return;
        const name = target.dataset.schoolAward;
        if (!name) return;
        openSchoolAwardModal(name, target.dataset.clusterLabel || '');
    }

    function openSchoolAwardModal(schoolName, clusterLabel) {
        if (!schoolAwardModal) return;
        const entries = getSchoolAwardEntries(schoolName);
        if (schoolAwardTitle) schoolAwardTitle.textContent = schoolName || '-';
        if (schoolAwardSubtitle) {
            const clusterText = clusterLabel ? `เครือข่าย: ${clusterLabel}` : 'เครือข่าย: -';
            const summary = entries.length ? `${entries.length} กิจกรรม` : 'ยังไม่มีข้อมูลรางวัล';
            schoolAwardSubtitle.textContent = `${clusterText} • ${summary}`;
        }
        if (schoolAwardBody) {
            schoolAwardBody.innerHTML = entries.length
                ? renderSchoolAwardEntries(entries)
                : '<p class="text-center text-slate-500">ยังไม่พบกิจกรรมที่ได้รับรางวัลจากโรงเรียนนี้</p>';
        }
        schoolAwardModal.classList.remove('hidden');
        schoolAwardModal.classList.add('flex');
    }

    function closeSchoolAwardModal() {
        if (!schoolAwardModal) return;
        schoolAwardModal.classList.add('hidden');
        schoolAwardModal.classList.remove('flex');
    }

    function getSchoolAwardEntries(schoolName) {
        if (!schoolName || !competitionResultsCache || !Array.isArray(competitionResultsCache.activities)) return [];
        const normalizedSchool = normalizeText(schoolName);
        const entries = [];
        competitionResultsCache.activities.forEach(activity => {
            const activityEntries = Array.isArray(activity.entries) ? activity.entries : [];
            const category = activity.category || 'หมวดหมู่ทั่วไป';
            const activityName = activity.name || activity.id || '-';
            activityEntries.forEach(entry => {
                if (normalizeText(entry.school || '') !== normalizedSchool) return;
                if (!entry.medalKey || entry.medalKey === 'participant') return;
                entries.push({
                    activityName,
                    category,
                    score: entry.score,
                    medalKey: entry.medalKey,
                    medalLabel: entry.medalLabel,
                    isRepresentative: Boolean(entry.isRepresentative),
                    rank: entry.rank
                });
            });
        });
        return entries.sort((a, b) => {
            const repCompare = (Number(b.isRepresentative) || 0) - (Number(a.isRepresentative) || 0);
            if (repCompare !== 0) return repCompare;
            const categoryCompare = (a.category || '').localeCompare(b.category || '', 'th');
            if (categoryCompare !== 0) return categoryCompare;
            if ((b.score ?? 0) !== (a.score ?? 0)) return (b.score ?? 0) - (a.score ?? 0);
            return (a.activityName || '').localeCompare(b.activityName || '', 'th');
        });
    }

    function renderSchoolAwardEntries(entries) {
        const medalStyles = {
            gold: 'bg-amber-100 text-amber-700 border border-amber-200',
            silver: 'bg-slate-100 text-slate-600 border border-slate-200',
            bronze: 'bg-orange-100 text-orange-700 border border-orange-200',
            merit: 'bg-emerald-100 text-emerald-700 border border-emerald-200'
        };
        const rows = entries.map(entry => {
            const badgeClass = medalStyles[entry.medalKey] || 'bg-slate-100 text-slate-600 border border-slate-200';
            const repBadge = entry.isRepresentative
                ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-[11px] font-semibold">ตัวแทน</span>'
                : '-';
            return `
                <tr class="border-b last:border-0">
                    <td class="p-2 font-semibold text-slate-900">${escapeHtmlClient(entry.activityName)}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(entry.category)}</td>
                    <td class="p-2 text-center font-semibold text-slate-900">${formatScoreDisplay(entry.score)}</td>
                    <td class="p-2 text-center">
                        <span class="inline-flex rounded-full px-3 py-1 text-[11px] font-semibold ${badgeClass}">
                            ${escapeHtmlClient(entry.medalLabel || entry.medalKey || '-')}
                        </span>
                    </td>
                    <td class="p-2 text-center">${repBadge}</td>
                </tr>
            `;
        }).join('');
        return `
            <div class="school-award-printable overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 text-left">กิจกรรม</th>
                            <th class="p-2 text-left">หมวดหมู่</th>
                            <th class="p-2 text-center w-24">คะแนน</th>
                            <th class="p-2 text-center w-28">เหรียญ</th>
                            <th class="p-2 text-center w-24">ตัวแทน</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-100">
                        ${rows}
                    </tbody>
                </table>
            </div>
        `;
    }

    function buildClusterCategoryBlocks(cluster) {
        const categories = new Map();
        const activities = Array.isArray(cluster?.activities) ? cluster.activities : [];
        activities.forEach(activity => {
            const categoryName = activity?.category || 'หมวดหมู่ทั่วไป';
            if (!categories.has(categoryName)) {
                categories.set(categoryName, []);
            }
            categories.get(categoryName).push(activity);
        });
        return Array.from(categories.entries()).map(([name, items]) => ({ name, items }));
    }

function bindReportClusterSummary(container) {
    if (!container) return;
    container.querySelectorAll('[data-report-cluster]').forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.dataset.reportCluster;
            const panel = container.querySelector(`[data-report-cluster-panel="${key}"]`);
            const icon = btn.querySelector('.material-symbols-outlined');
            if (panel) panel.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-180');
        });
    });
    container.querySelectorAll('[data-report-category]').forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.dataset.reportCategory;
            const panel = container.querySelector(`[data-report-category-panel="${key}"]`);
            const icon = btn.querySelector('.material-symbols-outlined');
            if (panel) panel.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-180');
        });
    });
}

function renderReportCategoryBlock(category, key) {
    const totals = category.items.reduce((acc, item) => {
        acc.teams += item.teams || 0;
        acc.teachers += item.teachers || 0;
        acc.students += item.students || 0;
        return acc;
    }, { teams: 0, teachers: 0, students: 0 });
    const itemsHtml = category.items.map(item => {
        const totalMembers = (item.teachers || 0) + (item.students || 0);
        return `
            <div class="report-activity-row">
                <div>
                    <p class="text-sm font-semibold text-slate-800">${escapeHtmlClient(item.activityName || '-')}</p>
                    <p class="text-xs text-slate-500">ทีม ${item.teams || 0}</p>
                </div>
                <div class="report-activity-meta">
                    <span>ครู ${item.teachers || 0}</span>
                    <span>นร. ${item.students || 0}</span>
                    <span>รวม ${totalMembers}</span>
                </div>
            </div>
        `;
    }).join('');
    return `
        <div class="report-category-card bg-slate-50 border border-slate-100 rounded-2xl">
            <button type="button" class="report-category-toggle" data-report-category="${key}">
                <div>
                    <p class="text-sm font-semibold text-slate-700">${escapeHtmlClient(category.name)}</p>
                    <p class="text-[11px] text-slate-500">ทีม ${totals.teams} • สมาชิก ${totals.teachers + totals.students}</p>
                </div>
                <span class="material-symbols-outlined transition-transform duration-200 text-base">expand_more</span>
            </button>
            <div class="report-category-body hidden" data-report-category-panel="${key}">
                ${itemsHtml}
            </div>
        </div>
    `;
}

function renderClusterActivitySummary(report) {
    if (!reportTableBody) return;
    const dataset = filterClustersForDisplay(getClusterActivitySummaryDataset(report));
    if (!dataset.length) {
        reportTableBody.innerHTML = '<div class="p-4 text-center text-slate-500 border border-dashed border-slate-200 rounded-xl">ยังไม่มีข้อมูลรายงานในกลุ่มเครือข่ายนี้</div>';
        return;
    }
    const html = dataset.map((cluster, clusterIndex) => {
        const totals = cluster?.totals || {};
        const clusterId = `report-cluster-${clusterIndex}`;
        const categories = buildClusterCategoryBlocks(cluster).sort((a, b) => a.name.localeCompare(b.name, 'th'));
        const categoryHtml = categories.length
            ? categories.map((category, index) => renderReportCategoryBlock(category, `${clusterId}-${index}`)).join('')
            : '<div class="p-4 text-sm text-slate-500">ยังไม่มีข้อมูลกิจกรรมในกลุ่มนี้</div>';
        return `
            <div class="report-cluster-card border border-slate-200 rounded-2xl bg-white">
                <button type="button" class="report-cluster-toggle" data-report-cluster="${clusterId}">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">กลุ่มเครือข่าย: ${escapeHtmlClient(cluster.clusterLabel || 'ไม่ระบุเครือข่าย')}</p>
                        <p class="text-[11px] text-slate-500">ทีม ${totals.teams || 0} • สมาชิก ${totals.allMembers || ((totals.teachers || 0) + (totals.students || 0))}</p>
                    </div>
                    <span class="material-symbols-outlined transition-transform duration-200 text-base">expand_more</span>
                </button>
                <div class="report-cluster-body ${clusterIndex === 0 ? '' : 'hidden'}" data-report-cluster-panel="${clusterId}">
                    ${categoryHtml}
                </div>
            </div>
        `;
    }).join('');
    reportTableBody.innerHTML = html;
    bindReportClusterSummary(reportTableBody);
}

    function handleScoreDutyAction(event) {
        const button = event.target.closest('[data-score-open]');
        if (!button) return;
        const activityId = button.dataset.scoreOpen;
        openScoreEntryModal(activityId);
    }

    function openScoreEntryModal(activityId) {
        if (!scoreEntryModal) return;
        const level = getCurrentUserLevel();
        const allowedForArea = isAreaStageActive() && ['admin', 'area'].includes(level);
        if (!currentUser || (!['score', 'group_admin'].includes(level) && !allowedForArea)) {
            Swal.fire({ icon: 'info', title: 'จำกัดสิทธิ์', text: 'กรุณาเข้าสู่ระบบด้วยสิทธิ์ Score / Group Admin หรือ Admin/Area เมื่อเป็นรอบระดับเขต' });
            return;
        }
        const targetId = (activityId || '').toString().trim();
        if (!targetId) {
            Swal.fire({ icon: 'warning', title: 'ไม่สามารถเปิดกิจกรรมนี้', text: 'ไม่พบบันทึกกิจกรรมที่เลือก' });
            return;
        }
        if (!canCurrentUserScoreActivity(targetId)) {
            Swal.fire({ icon: 'warning', title: 'ไม่สามารถเปิดกิจกรรมนี้', text: 'กิจกรรมนี้ไม่ได้อยู่ในสิทธิ์ของคุณ' });
            return;
        }
        if (!Array.isArray(ALL_TEAMS) || !ALL_TEAMS.length) {
            Swal.fire({ icon: 'info', title: 'กำลังโหลดทีม', text: 'โปรดลองอีกครั้งหลังจากโหลดข้อมูลทีมเสร็จสิ้น' });
            loadRegisteredTeams(true);
            return;
        }
        const teams = getTeamsForActivityWithinScope(targetId);
        if (!teams.length) {
            Swal.fire({ icon: 'info', title: 'ยังไม่มีทีม', text: 'ยังไม่มีทีมในเครือข่ายของคุณสำหรับกิจกรรมนี้' });
            return;
        }
        const meta = getActivityInfoById(targetId);
        if (scoreEntryTitle) {
            scoreEntryTitle.textContent = `กิจกรรม: ${meta?.name || meta?.id || targetId}`;
        }
        if (scoreEntrySubtitle) {
            const parts = [];
            if (meta?.category) parts.push(`หมวดหมู่: ${meta.category}`);
            parts.push(`ทีมทั้งหมด: ${teams.length}`);
            parts.push('หากคะแนนอันดับ 1 เท่ากันให้เลือกตัวแทน');
            scoreEntrySubtitle.textContent = parts.join(' • ');
        }
        prepareScoreEntryState(targetId, teams);
        renderScoreEntryRows(teams);
        updateScoreEntryDirtyState(false);
        scoreEntryModal.classList.remove('hidden');
        scoreEntryModal.classList.add('flex');
    }

    function normalizeScoreValue(value) {
        if (value === null || value === undefined || value === '') return '';
        const num = parseFloat(value);
        return Number.isNaN(num) ? '' : String(num);
    }

    function prepareScoreEntryState(activityId, teams) {
        const isAreaStageOpen = competitionStage === 'area';
        scoreEntryState = {
            activityId,
            teams: Array.isArray(teams) ? [...teams] : [],
            initialScores: new Map(),
            initialRepresentative: '',
            selectedRepresentative: '',
            dirty: false
        };
        scoreEntryState.teams.forEach(team => {
            const displayScore = isAreaStageOpen && team.areaScore !== undefined ? team.areaScore : team.scoreTotal;
            scoreEntryState.initialScores.set(team.teamId, normalizeScoreValue(displayScore));
            const areaRankNum = Number.parseInt(team.areaRank || '', 10);
            const hasAreaChampion = isAreaStageOpen && Number.isFinite(areaRankNum) && areaRankNum === 1;
            const isRepresentative = hasAreaChampion || isTeamRepresentative(team);
            if (!scoreEntryState.initialRepresentative && isRepresentative) {
                scoreEntryState.initialRepresentative = team.teamId;
            }
        });
        scoreEntryState.selectedRepresentative = scoreEntryState.initialRepresentative || '';
    }

    function renderScoreEntryRows(teams) {
        if (!scoreEntryBody) return;
        if (!Array.isArray(teams) || !teams.length) {
            scoreEntryBody.innerHTML = '<p class="text-center text-slate-500">ไม่พบทีมในกิจกรรมนี้</p>';
            return;
        }
        const selectedRep = scoreEntryState.selectedRepresentative || scoreEntryState.initialRepresentative || '';
        const isAreaStageOpen = competitionStage === 'area';
        const rows = [...teams].sort((a, b) => {
            const bySchool = (a.school || '').localeCompare(b.school || '', 'th');
            if (bySchool !== 0) return bySchool;
            return getTeamDisplayName(a).localeCompare(getTeamDisplayName(b), 'th');
        });
        const htmlRows = rows.map((team, idx) => {
            const rawScore = isAreaStageOpen ? team.areaScore : team.scoreTotal;
            const normalizedValue = normalizeScoreValue(rawScore);
            const hasScore = normalizedValue !== '';
            const numericScore = hasScore ? Number(normalizedValue) : null;
            const value = hasScore ? normalizedValue : '';
            const latestClass = hasScore ? 'text-slate-600' : 'text-amber-600';
            const latestLabel = hasScore
                ? formatScoreDisplay(numericScore)
                : (isAreaStageOpen ? 'ยังไม่มีคะแนนระดับเขตตามข้อมูลล่าสุด' : 'ยังไม่บันทึกคะแนน');
            const rankNote = isAreaStageOpen && team.areaRank
                ? `<span class="text-[11px] text-slate-500">อันดับ ${escapeHtmlClient(team.areaRank)}</span>`
                : '';
            const radioChecked = selectedRep && selectedRep === team.teamId ? 'checked' : '';
            return `
                <tr class="border-b last:border-0">
                    <td class="p-2 text-xs text-slate-500">${idx + 1}</td>
                    <td class="p-2 text-sm text-slate-800">
                        <div class="font-semibold">${escapeHtmlClient(getTeamDisplayName(team))}</div>
                        <div class="text-[11px] text-slate-500">รหัสทีม: ${escapeHtmlClient(team.teamId || '-')}</div>
                    </td>
                    <td class="p-2 text-sm text-slate-600">${escapeHtmlClient(team.school || '-')}</td>
                    <td class="p-2 w-32">
                        <input type="number" min="0" max="100" step="0.1"
                            value="${value === '' ? '' : escapeHtmlClient(value)}"
                            data-score-input="${escapeHtmlClient(team.teamId || '')}"
                            class="w-full rounded-lg border border-slate-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </td>
                    <td class="p-2 text-sm">
                        <span data-latest-score="true" data-team-id="${escapeHtmlClient(team.teamId || '')}" class="${latestClass} font-semibold">${latestLabel}</span>
                        ${rankNote}
                    </td>
                    <td class="p-2 text-center">
                        <label class="inline-flex items-center justify-center gap-1 text-xs text-slate-600">
                            <input type="radio"
                                name="score-representative"
                                value="${escapeHtmlClient(team.teamId || '')}"
                                data-representative-radio="true"
                                ${radioChecked}>
                            <span>เลือก</span>
                        </label>
                    </td>
                </tr>
            `;
        }).join('');
        scoreEntryBody.innerHTML = `
            <div class="text-xs text-slate-500 mb-2 text-center">
                กรอกคะแนน 0-100 ให้ครบ หากคะแนนอันดับ 1 เท่ากันโปรดเลือกตัวแทนด้วยปุ่มด้านขวา
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 text-left w-12">#</th>
                            <th class="p-2 text-left">ทีม</th>
                            <th class="p-2 text-left">โรงเรียน</th>
                            <th class="p-2 text-left w-32">คะแนน (0-100)</th>
                            <th class="p-2 text-left w-32">คะแนนล่าสุด</th>
                            <th class="p-2 text-center w-28">ตัวแทน</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlRows}
                    </tbody>
                </table>
            </div>
        `;
    }

    function updateLatestScoreDisplay(teamId, value) {
        if (!scoreEntryBody) return;
        const targets = scoreEntryBody.querySelectorAll('[data-latest-score="true"]');
        const target = Array.from(targets).find(el => (el.dataset.teamId || '') === teamId);
        if (!target) return;
        let numericScore = typeof value === 'number' ? value : Number(value);
        if (!Number.isFinite(numericScore)) numericScore = NaN;
        const hasScore = Number.isFinite(numericScore);
        target.textContent = hasScore ? formatScoreDisplay(numericScore) : 'ยังไม่บันทึก';
        target.classList.toggle('text-amber-600', !hasScore);
        target.classList.toggle('text-slate-600', hasScore);
    }

    function getSelectedRepresentativeId() {
        if (!scoreEntryBody) return '';
        const radio = scoreEntryBody.querySelector('input[name="score-representative"]:checked');
        return radio ? radio.value : '';
    }

    function updateScoreEntryDirtyState(forceValue) {
        if (typeof forceValue === 'boolean') {
            scoreEntryState.dirty = forceValue;
            refreshScoreEntrySubmitState();
            return;
        }
        if (!scoreEntryBody) return;
        const inputs = scoreEntryBody.querySelectorAll('[data-score-input]');
        let dirty = false;
        inputs.forEach(input => {
            const teamId = input.dataset.scoreInput;
            if (!teamId || dirty) return;
            const currentValue = (input.value || '').trim();
            let normalizedCurrent = '';
            if (currentValue !== '') {
                const num = parseFloat(currentValue);
                normalizedCurrent = Number.isNaN(num) ? currentValue : String(num);
            }
            const initial = scoreEntryState.initialScores.get(teamId) ?? '';
            if (normalizedCurrent !== initial) {
                dirty = true;
            }
        });
        const selectedRep = getSelectedRepresentativeId();
        const initialRep = scoreEntryState.initialRepresentative || '';
        if (!dirty && (selectedRep || '') !== (initialRep || '')) {
            dirty = true;
        }
        scoreEntryState.dirty = dirty;
        refreshScoreEntrySubmitState();
    }

    function refreshScoreEntrySubmitState() {
        if (!scoreEntrySubmit) return;
        scoreEntrySubmit.classList.remove('bg-emerald-600', 'hover:bg-emerald-700', 'bg-sky-600', 'hover:bg-sky-700', 'opacity-60');
        if (isSavingScoreEntries) {
            scoreEntrySubmit.disabled = true;
            scoreEntrySubmit.classList.add('bg-sky-600', 'hover:bg-sky-600', 'opacity-60');
            scoreEntrySubmit.innerHTML = `
                <span class="inline-flex items-center gap-2">
                    <span class="h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                    <span>กำลังบันทึก...</span>
                </span>`;
            return;
        }
        if (!scoreEntryState.dirty) {
            scoreEntrySubmit.disabled = true;
            scoreEntrySubmit.classList.add('bg-emerald-600', 'hover:bg-emerald-600', 'opacity-60');
            scoreEntrySubmit.innerHTML = `
                <span class="inline-flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">check_circle</span>
                    <span>บันทึกแล้ว</span>
                </span>`;
            return;
        }
        scoreEntrySubmit.disabled = false;
        scoreEntrySubmit.classList.add('bg-sky-600', 'hover:bg-sky-700');
        scoreEntrySubmit.innerHTML = `
            <span class="inline-flex items-center gap-2">
                <span class="material-symbols-outlined text-base">save</span>
                <span>บันทึกคะแนน</span>
            </span>`;
    }

    function handleScoreEntryBodyInput(event) {
        if (!event.target || !event.target.matches('[data-score-input]')) return;
        event.target.classList.remove('border-red-500');
        updateScoreEntryDirtyState();
    }

    function handleScoreEntryBodyChange(event) {
        if (!event.target) return;
        if (event.target.matches('[data-representative-radio]')) {
            scoreEntryState.selectedRepresentative = event.target.checked ? event.target.value : scoreEntryState.selectedRepresentative;
            updateScoreEntryDirtyState();
        }
    }

    function closeScoreEntryModal() {
        if (!scoreEntryModal) return;
        scoreEntryModal.classList.add('hidden');
        scoreEntryModal.classList.remove('flex');
        scoreEntryState = {
            activityId: null,
            teams: [],
            initialScores: new Map(),
            initialRepresentative: '',
            selectedRepresentative: '',
            dirty: false
        };
        isSavingScoreEntries = false;
        setScoreEntrySavingState(false, { skipScoreDutyBlockUpdate: true });
        if (scoreEntryBody) {
            scoreEntryBody.innerHTML = '<p class="text-center text-slate-500">เลือกรายการจากหน้ารายงานเพื่อเริ่มให้คะแนน</p>';
        }
    }

    function setScoreEntrySavingState(isSaving, options = {}) {
        const {
            skipScoreDutyBlockUpdate = false,
            deferScoreDutyRelease = false
        } = options;
        isSavingScoreEntries = isSaving;
        if (scoreEntryLoadingOverlay) {
            scoreEntryLoadingOverlay.classList.toggle('hidden', !isSaving);
        }
        if (!skipScoreDutyBlockUpdate) {
            if (isSaving) {
                scoreDutyBlockReleasePending = false;
                setScoreDutyBlocked(true, 'กำลังอัปเดตผลคะแนน...');
            } else if (deferScoreDutyRelease) {
                scoreDutyBlockReleasePending = true;
            } else {
                scoreDutyBlockReleasePending = false;
                setScoreDutyBlocked(false);
            }
        }
        refreshScoreEntrySubmitState();
    }

    function buildScoreEntryReviewHtml(entries, representativeId) {
        if (!Array.isArray(entries) || !entries.length) {
            return '<p class="text-sm text-slate-600">ยังไม่มีคะแนนใหม่ให้ตรวจสอบ</p>';
        }
        const teamLookup = new Map((scoreEntryState.teams || []).map(team => [team.teamId, team]));
        const sortedEntries = [...entries].sort((a, b) => b.score - a.score);
        const highestScore = sortedEntries.length ? sortedEntries[0].score : null;
        const topScoreIds = new Set(sortedEntries.filter(item => item.score === highestScore).map(item => item.teamId));
        const rowsHtml = sortedEntries.map(entry => {
            const team = teamLookup.get(entry.teamId) || {};
            const name = escapeHtmlClient(getTeamDisplayName(team) || entry.teamId || '-');
            const school = escapeHtmlClient(team.school || '-');
            const previousRaw = scoreEntryState.initialScores.get(entry.teamId);
            const previousNumeric = previousRaw !== undefined && previousRaw !== '' ? Number(previousRaw) : null;
            const hasPrevious = typeof previousNumeric === 'number' && !Number.isNaN(previousNumeric);
            const previousLabel = hasPrevious ? formatScoreDisplay(previousNumeric) : 'ยังไม่บันทึก';
            const diffValue = hasPrevious ? Math.round((entry.score - previousNumeric) * 100) / 100 : null;
            const diffLabel = diffValue === null ? '-' : `${diffValue > 0 ? '+' : ''}${formatScoreDisplay(diffValue)}`;
            const diffColor = diffValue === null
                ? '#94a3b8'
                : (diffValue > 0 ? '#059669' : diffValue < 0 ? '#dc2626' : '#0f172a');
            const repBadge = representativeId && representativeId === entry.teamId
                ? '<span style="display:inline-flex;align-items:center;height:1.5rem;padding:0 .5rem;border-radius:999px;background-color:#0ea5e9;color:#fff;font-size:11px;margin-left:.25rem;">ตัวแทน</span>'
                : '';
            const topBadge = topScoreIds.has(entry.teamId)
                ? '<span style="display:inline-flex;align-items:center;height:1.5rem;padding:0 .5rem;border-radius:999px;background-color:#10b981;color:#fff;font-size:11px;margin-left:.25rem;">คะแนนสูงสุด</span>'
                : '';
            return `
                <tr>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;white-space:nowrap;font-weight:600;color:#0f172a;">${name}</td>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;color:#475569;">${school}</td>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;text-align:center;font-weight:600;color:#0f172a;">${formatScoreDisplay(entry.score)}</td>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;text-align:center;color:#475569;">${previousLabel}</td>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;text-align:center;color:${diffColor};">${diffLabel}</td>
                    <td style="padding:.35rem .5rem;border-bottom:1px solid #e2e8f0;white-space:nowrap;">${repBadge}${topBadge}</td>
                </tr>
            `;
        }).join('');
        const repTeam = representativeId ? teamLookup.get(representativeId) : null;
        const repInfo = repTeam
            ? `ทีมตัวแทน: <strong>${escapeHtmlClient(getTeamDisplayName(repTeam) || '-')}</strong>${repTeam.school ? ` • ${escapeHtmlClient(repTeam.school)}` : ''}`
            : 'ยังไม่ได้เลือกทีมตัวแทน';
        const highestLabel = highestScore !== null && highestScore !== undefined
            ? formatScoreDisplay(highestScore)
            : '-';
        const tieLabel = topScoreIds.size > 1
            ? `มี ${topScoreIds.size} ทีมที่ได้คะแนนสูงสุดเท่ากัน`
            : 'ไม่มีคะแนนสูงสุดเท่ากัน';
        return `
            <div style="text-align:left;font-size:13px;color:#475569;">
                <p style="margin:0 0 .5rem 0;">โปรดตรวจสอบคะแนนทั้งหมดก่อนยืนยัน ระบบจะแสดงคะแนนใหม่เทียบกับข้อมูลล่าสุด</p>
                <div style="margin-bottom:.75rem;line-height:1.4;">
                    <p style="margin:0;">คะแนนสูงสุด: <strong>${highestLabel}</strong> • ${tieLabel}</p>
                    <p style="margin:.15rem 0 0 0;">${repInfo}</p>
                </div>
                <div style="max-height:320px;overflow:auto;border:1px solid #e2e8f0;border-radius:.75rem;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background-color:#f8fafc;color:#0f172a;">
                                <th style="padding:.4rem .5rem;text-align:left;">ทีม</th>
                                <th style="padding:.4rem .5rem;text-align:left;">โรงเรียน</th>
                                <th style="padding:.4rem .5rem;text-align:center;">คะแนนใหม่</th>
                                <th style="padding:.4rem .5rem;text-align:center;">คะแนนล่าสุด</th>
                                <th style="padding:.4rem .5rem;text-align:center;">ส่วนต่าง</th>
                                <th style="padding:.4rem .5rem;text-align:left;">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function requestScoreEntryConfirmation(entries, representativeId) {
        if (!window.Swal || typeof Swal.fire !== 'function') {
            return Promise.resolve(true);
        }
        const reviewHtml = buildScoreEntryReviewHtml(entries, representativeId);
        return Swal.fire({
            title: 'ตรวจสอบคะแนนก่อนบันทึก',
            html: reviewHtml,
            icon: 'info',
            width: '48rem',
            showCancelButton: true,
            confirmButtonText: 'ยืนยันบันทึกคะแนน',
            cancelButtonText: 'ตรวจสอบเพิ่ม',
            focusConfirm: false,
            customClass: { htmlContainer: 'text-left' }
        }).then(result => result.isConfirmed);
    }

    function performScoreEntrySave(payload, representativeId, actor) {
        if (!scoreEntryState.activityId || !actor) return;
        const focusActivityId = scoreEntryState.activityId;
        setScoreEntrySavingState(true);
        google.script.run
            .withSuccessHandler(res => {
                setScoreEntrySavingState(false, { deferScoreDutyRelease: true });
                if (!res || !res.success) {
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: (res && res.error) || 'ไม่สามารถบันทึกคะแนนได้' });
                    return;
                }
                Swal.fire({ icon: 'success', title: 'บันทึกคะแนนสำเร็จ', timer: 1600, showConfirmButton: false });
                const isAreaStageOpen = competitionStage === 'area';
                payload.forEach(entry => {
                    scoreEntryState.initialScores.set(entry.teamId, normalizeScoreValue(entry.score));
                    scoreEntryState.teams = scoreEntryState.teams.map(team =>
                        team.teamId === entry.teamId
                            ? isAreaStageOpen
                                ? { ...team, areaScore: entry.score }
                                : { ...team, scoreTotal: entry.score }
                            : team
                    );
                    updateLatestScoreDisplay(entry.teamId, entry.score);
                });
                scoreEntryState.initialRepresentative = representativeId || '';
                scoreEntryState.selectedRepresentative = representativeId || '';
                if (!representativeId && scoreEntryBody) {
                    const checked = scoreEntryBody.querySelector('input[name="score-representative"]:checked');
                    if (checked) checked.checked = false;
                }
                updateScoreEntryDirtyState();
                if (focusActivityId) {
                    pendingScoreDutyFocusId = focusActivityId;
                    scoreDutyFocusPending = true;
                    scoreDutyFocusReady = false;
                } else {
                    resetScoreDutyFocusIntent();
                }
                closeScoreEntryModal();
                loadReportData(true);
                loadRegisteredTeams(true);
            })
            .withFailureHandler(error => {
                setScoreEntrySavingState(false);
                resetScoreDutyFocusIntent();
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: error.message || 'เกิดข้อผิดพลาด' });
            })
            .saveActivityScores({
                activityId: scoreEntryState.activityId,
                scores: payload,
                representativeTeamId: representativeId,
                actor
            });
    }

    function submitScoreEntries() {
        if (!scoreEntryState.activityId || !scoreEntryBody) {
            Swal.fire({ icon: 'info', title: 'ไม่พบกิจกรรม', text: 'กรุณาเลือกกิจกรรมก่อนบันทึกคะแนน' });
            return;
        }
        if (isSavingScoreEntries) return;
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'warning', title: 'ต้องเข้าสู่ระบบ', text: 'กรุณาเข้าสู่ระบบก่อนบันทึกคะแนน' });
            return;
        }
        const inputs = scoreEntryBody.querySelectorAll('[data-score-input]');
        const payload = [];
        let hasError = false;
        inputs.forEach(input => {
            const teamId = input.dataset.scoreInput;
            const rawValue = (input.value || '').trim();
            if (!teamId) return;
            if (rawValue === '') {
                hasError = true;
                input.classList.add('border-red-500');
                return;
            }
            const numeric = parseFloat(rawValue);
            if (Number.isNaN(numeric) || numeric < 0 || numeric > 100) {
                hasError = true;
                input.classList.add('border-red-500');
                return;
            }
            input.classList.remove('border-red-500');
            payload.push({ teamId, score: Math.round(numeric * 100) / 100 });
        });
        if (hasError) {
            Swal.fire({ icon: 'warning', title: 'กรอกคะแนนไม่ถูกต้อง', text: 'กรุณากรอกคะแนน 0-100 ให้ครบทุกทีม' });
            return;
        }
        if (!payload.length) {
            Swal.fire({ icon: 'info', title: 'ยังไม่มีข้อมูล', text: 'กรุณากรอกคะแนนอย่างน้อย 1 ทีม' });
            return;
        }
        const representativeId = getSelectedRepresentativeId();
        const payloadIds = payload.map(item => item.teamId);
        const validRepresentative = representativeId && payloadIds.includes(representativeId) ? representativeId : '';
        const highestScore = Math.max(...payload.map(item => item.score));
        const tiedCount = payload.filter(item => item.score === highestScore).length;
        if (tiedCount > 1 && !validRepresentative) {
            Swal.fire({ icon: 'warning', title: 'ต้องเลือกทีมตัวแทน', text: 'เมื่อคะแนนสูงสุดเท่ากัน ต้องเลือกทีมตัวแทนก่อนบันทึก' });
            return;
        }
        requestScoreEntryConfirmation(payload, validRepresentative)
            .then(confirmed => {
                if (!confirmed) return;
                performScoreEntrySave(payload, validRepresentative, actor);
            });
    }
    function handleCompetitionFilterChange(event) {
        const target = event.target;
        if (!target) return;
        if (target === competitionFilterActivity) {
            competitionFilterState.activity = target.value || '';
        } else if (target === competitionFilterSchool) {
            competitionFilterState.school = target.value || '';
        } else if (target === competitionFilterMedal) {
            competitionFilterState.medal = target.value || '';
        } else if (target === competitionFilterRepresentative) {
            competitionFilterState.onlyRepresentative = !!target.checked;
        }
        refreshCompetitionViews();
    }

    function resetCompetitionFilters() {
        competitionFilterState.activity = '';
        competitionFilterState.school = '';
        competitionFilterState.medal = '';
        competitionFilterState.onlyRepresentative = false;
        if (competitionFilterActivity) competitionFilterActivity.value = '';
        if (competitionFilterSchool) competitionFilterSchool.value = '';
        if (competitionFilterMedal) competitionFilterMedal.value = '';
        if (competitionFilterRepresentative) competitionFilterRepresentative.checked = false;
        refreshCompetitionViews();
    }

    function getTeamClusterId(team) {
        if (!team) return '';
        const schoolInfo = getSchoolInfoByName(team.school) || getSchoolInfoById(team.schoolId || '');
        if (schoolInfo) {
            const clusterId = getSchoolClusterId(schoolInfo);
            if (clusterId) return normalizeText(clusterId);
        }
        if (team.schoolClusterId) return normalizeText(team.schoolClusterId);
        if (team.schoolCluster) return normalizeText(team.schoolCluster);
        return '';
    }

    function getTeamClusterLabel(team) {
        if (!team) return '';
        const schoolInfo = getSchoolInfoByName(team.school) || getSchoolInfoById(team.schoolId || '');
        if (schoolInfo) {
            const clusterName = getSchoolClusterName(schoolInfo);
            if (clusterName) return clusterName;
        }
        return team.schoolClusterName || team.schoolCluster || '';
    }

    function getTeamCluster(team) {
        return getTeamClusterId(team);
    }

    function decodeDataValue(value) {
        if (!value) return '';
        try {
            return decodeURIComponent(value);
        } catch (error) {
            return value;
        }
    }

    function getPanelClusterInfo(panel) {
        if (!panel) return { key: '', label: '' };
        return {
            key: decodeDataValue(panel.dataset?.clusterKey || ''),
            label: decodeDataValue(panel.dataset?.clusterLabel || '')
        };
    }

    function getEffectiveClusterKey(rawKey) {
        const normalized = normalizeText(rawKey || '');
        if (normalized) return normalized;
        if (getCurrentUserLevel() === 'group_admin') {
            return getUserClusterForFilter();
        }
        return '';
    }

    function getEffectiveClusterLabel(rawLabel) {
        const label = (rawLabel || '').trim();
        if (label) return label;
        if (getCurrentUserLevel() === 'group_admin') {
            return getCurrentUserClusterLabel() || '';
        }
        return '';
    }

    function buildActivityClusterBuckets(teams) {
        if (!Array.isArray(teams) || !teams.length) return [];
        const buckets = new Map();
        teams.forEach(team => {
            const key = getTeamCluster(team) || '';
            const label = getTeamClusterLabel(team) || 'ไม่ระบุเครือข่าย';
            if (!buckets.has(key)) {
                buckets.set(key, { key, label, count: 0 });
            }
            buckets.get(key).count += 1;
        });
        return Array.from(buckets.values()).sort((a, b) => a.label.localeCompare(b.label, 'th'));
    }

    function getTeamStageValue(team) {
        if (!team) return 'cluster';
        const stageRaw = team.stage || '';
        const normalizedStage = normalizeCompetitionStageClient(stageRaw);
        if (normalizedStage === 'area') return 'area';
        if (normalizedStage === 'cluster') return 'cluster';
        const repFlag = isTeamRepresentative(team);
        return repFlag ? 'area' : 'cluster';
    }

    function getTeamStageLabel(team) {
        const stageValue = getTeamStageValue(team);
        return stageValue === 'area' ? 'ระดับเขต (ตัวแทน)' : 'กลุ่มเครือข่าย';
    }

    function getTeamDisplayName(team) {
        if (!team) return '-';
        const stageValue = getTeamStageValue(team);
        if (stageValue === 'area' && (team.teamNameArea || team.areaTeamName)) {
            return team.teamNameArea || team.areaTeamName || '-';
        }
        return team.teamNameCluster || team.teamName || '-';
    }

    function getTeamMembersForStage(team) {
        if (!team) return { teachers: [], students: [] };
        const stageValue = getTeamStageValue(team);
        if (stageValue === 'area' && team.membersArea) {
            return safeJsonParse(team.membersArea, { teachers: [], students: [] });
        }
        return safeJsonParse(team.members, { teachers: [], students: [] });
    }

    function getTeamsWithinClusterScope(clusterKey) {
        const dataset = getStageFilteredTeams();
        if (!clusterKey) return dataset;
        return dataset.filter(team =>
            matchesClusterKey(getTeamCluster(team), getTeamClusterLabel(team), clusterKey)
        );
    }

    function getTeamsForActivityWithinScope(activityId) {
        const target = (activityId || '').toString().trim();
        if (!target) return [];
        const dataset = getStageFilteredTeams();
        const level = getCurrentUserLevel();
        const clusterKey = getClusterFilterForDisplay();
        const userId = getCurrentUserId();
        return dataset.filter(team => {
            if ((team.activity || '').toString().trim() !== target) return false;
            if (!currentUser) return false;
            if (['admin', 'area'].includes(level)) return true;
            if (level === 'group_admin' || level === 'score') {
                if (clusterKey) {
                    return matchesClusterKey(getTeamCluster(team), getTeamClusterLabel(team), clusterKey);
                }
            }
            if (level === 'school_admin') {
                const schoolName = getUserSchoolNameForFilter();
                return schoolName && normalizeText(team.school) === schoolName;
            }
            return Boolean(userId) && (team.createdByUserId || '') === userId;
        });
    }

    function getScoreAssignableActivities() {
        if (Array.isArray(SCORE_ASSIGNED_ACTIVITIES) && SCORE_ASSIGNED_ACTIVITIES.length) {
            return SCORE_ASSIGNED_ACTIVITIES;
        }
        if (latestReportData && Array.isArray(latestReportData.actorScoreActivities)) {
            return latestReportData.actorScoreActivities;
        }
        return [];
    }

    function canCurrentUserScoreActivity(activityId, team = null) {
        if (!currentUser || !activityId) return false;
        const level = getCurrentUserLevel();
        if (level === 'score') {
            const list = getScoreAssignableActivities();
            return list.some(id => (id || '').toString().trim() === (activityId || '').toString().trim());
        }
        if (level === 'group_admin') {
            const clusterKey = getClusterFilterForDisplay();
            if (!clusterKey) return false;
            if (team) {
                return matchesClusterKey(getTeamCluster(team), getTeamClusterLabel(team), clusterKey);
            }
            return true;
        }
        if (isAreaStageActive() && ['admin', 'area'].includes(level)) {
            return true;
        }
        return false;
    }

    function isTeamLockedForEdit(team) {
        const status = (team?.status || '').toString().trim().toLowerCase();
        if (status !== 'print') return false;
        const level = getCurrentUserLevel();
        return !['admin', 'area'].includes(level);
    }

    function canManageTeam(team) {
        if (!currentUser || !team) return false;
        const level = getCurrentUserLevel();
        if (!level) return false;
        if (['admin', 'area'].includes(level)) return true;
        const userId = getCurrentUserId();
        if (team.createdByUserId && userId && (team.createdByUserId === userId)) return true;
        const userSchool = getUserSchoolNameForFilter();
        if (level === 'school_admin' && userSchool && normalizeText(team.school) === userSchool) return true;
        const userCluster = getUserClusterForFilter();
        if (level === 'group_admin' && userCluster && normalizeText(getTeamCluster(team)) === userCluster) return true;
        return false;
    }

    function canEditTeamStatusClient() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function canEditTeamImagesClient() {
        return Boolean(currentUser);
    }

    function getTeamScopeDescription() {
        const role = getCurrentUserLevel();
        if (role === 'school_admin') {
            const schoolName = getSchoolDisplayNameById(currentUser?.schoolId || currentUser?.SchoolID) || currentUser?.schoolName || '';
            return schoolName
                ? `School Admin: แสดงทุกทีมในโรงเรียน ${schoolName}`
                : 'School Admin: แสดงทุกทีมในโรงเรียนของคุณ';
        }
        if (role === 'group_admin') {
            const clusterLabel = getCurrentUserClusterLabel();
            return clusterLabel
                ? `Group Admin: แสดงทุกทีมในเครือข่าย ${clusterLabel}`
                : 'Group Admin: แสดงทุกทีมในเครือข่ายของคุณ';
        }
        if (role === 'admin' || role === 'area') {
            return 'ผู้ดูแลระบบ: แสดงทุกทีมในระบบ';
        }
        return 'ผู้ใช้ทั่วไป: เห็นเฉพาะทีมที่คุณสร้าง';
    }

    function updateTeamScopeBanner() {
        if (!teamScopeBanner || !teamScopeText) return;
        if (!currentUser) {
            teamScopeBanner.classList.add('hidden');
            teamScopeText.textContent = '';
            return;
        }
        teamScopeBanner.classList.remove('hidden');
        teamScopeText.textContent = getTeamScopeDescription();
    }

    function getUserTeamStats() {
        const teams = filterTeamsForCurrentUser(ALL_TEAMS);
        if (!teams.length) {
            return { activities: 0, teams: 0, students: 0, teachers: 0 };
        }
        const uniqueActivities = new Set();
        let students = 0;
        let teachers = 0;
        teams.forEach(team => {
            if (team.activity) uniqueActivities.add(team.activity);
            const members = safeJsonParse(team.members, { teachers: [], students: [] });
            teachers += Array.isArray(members.teachers) ? members.teachers.length : 0;
            students += Array.isArray(members.students) ? members.students.length : 0;
        });
        return {
            activities: uniqueActivities.size,
            teams: teams.length,
            students,
            teachers
        };
    }

    function renderActivityJudgesPanel(activityId, clusterBuckets) {
        if (!currentUser || !Array.isArray(clusterBuckets) || !clusterBuckets.length) {
            return '';
        }
        const judgesReady = hasLoadedJudgeAssignments && Array.isArray(JUDGE_ASSIGNMENTS);
        const manageEnabled = canManageJudgesClient();
        const sections = clusterBuckets.map(bucket => {
            const judges = judgesReady ? getJudgesForActivityCluster(activityId, bucket.key) : [];
            const listHtml = renderJudgeListHtml(judges, judgesReady);
            const encodedClusterKey = encodeURIComponent(bucket.key || '');
            const encodedClusterLabel = encodeURIComponent(bucket.label || '');
            const uploadControls = manageEnabled
                ? `
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                            class="inline-flex items-center gap-1 rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-100"
                            data-judge-file-trigger>
                            <span class="material-symbols-outlined text-base">upload_file</span>
                            <span>เลือกไฟล์</span>
                        </button>
                        <button type="button"
                            class="inline-flex items-center gap-1 rounded-full bg-sky-500 px-3 py-1 text-xs font-semibold text-white hover:bg-sky-600"
                            data-judge-upload>
                            <span class="material-symbols-outlined text-base">cloud_upload</span>
                            <span>นำเข้า</span>
                        </button>
                        <button type="button"
                            class="inline-flex items-center gap-1 rounded-full border border-emerald-200 px-3 py-1 text-xs font-semibold text-emerald-700 hover:bg-emerald-50"
                            data-judge-manual>
                            <span class="material-symbols-outlined text-base">person_add</span>
                            <span>เพิ่มกรรมการ</span>
                        </button>
                    </div>
                    <input type="file" class="hidden" data-judge-file accept=".csv,.xlsx,.xls">
                    <p class="text-[11px] text-slate-500" data-judge-status>รองรับไฟล์ .csv (UTF-8) และสามารถมีหลายกิจกรรมได้ (ต้องมีคอลัม ActivityID และ SchoolID)</p>
                `
                : '<p class="text-[11px] text-slate-500">รายชื่อกรรมการจะถูกอัปเดตโดยผู้ดูแลระบบ</p>';
            return `
                <div class="rounded-xl border border-slate-200 bg-white p-3 space-y-2"
                    data-judge-panel
                    data-activity-id="${escapeHtmlClient(activityId)}"
                    data-cluster-key="${encodedClusterKey}"
                    data-cluster-label="${encodedClusterLabel}">
                    <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">เครือข่าย: ${escapeHtmlClient(bucket.label)}</p>
                            <p class="text-[11px] text-slate-500">${bucket.count} ทีม</p>
                        </div>
                        ${uploadControls}
                    </div>
                    <div class="text-xs text-slate-600" data-judge-list>
                        ${listHtml}
                    </div>
                </div>
            `;
        }).join('');
        return `
            <div class="space-y-3">
                <div>
                    <p class="text-sm font-semibold text-slate-900">กรรมการประจำกิจกรรมนี้</p>
                    <p class="text-[11px] text-slate-500">
                        ${isAreaStageActive()
                            ? 'แสดงเฉพาะรายชื่อกรรมการระดับเขต สามารถอัปเดตได้จากไฟล์ Excel หรือ CSV'
                            : 'เลือกไฟล์ Excel หรือ CSV เพื่ออัปเดตรายชื่อกรรมการแต่ละเครือข่าย'}
                    </p>
                    <div class="mt-2 flex flex-wrap gap-2">
                        <button type="button"
                            class="inline-flex items-center gap-1 rounded-full border border-slate-300 px-3 py-1 text-[11px] font-semibold text-slate-600 hover:bg-slate-100"
                            data-judge-sample="csv">
                            <span class="material-symbols-outlined text-base">download</span>
                            <span>ไฟล์ตัวอย่าง CSV</span>
                        </button>
                    </div>
                </div>
                <div class="grid gap-3">
                    ${sections}
                </div>
            </div>
        `;
    }

        function renderJudgeListHtml(list, ready) {
        if (!currentUser) {
            return '<p class="text-xs text-slate-500">กรุณาเข้าสู่ระบบเพื่อดูรายชื่อกรรมการ</p>';
        }
        if (!ready) {
            return '<p class="text-xs text-slate-500">กำลังโหลดข้อมูลกรรมการ...</p>';
        }
        const filteredList = Array.isArray(list)
            ? list.filter(judge => !isAreaStageActive() || normalizeJudgeStageScope(judge.stageScope) === 'area')
            : [];
        if (!filteredList.length) {
            const emptyMessage = isAreaStageActive()
                ? 'ยังไม่มีรายชื่อกรรมการระดับเขตสำหรับเครือข่ายนี้'
                : 'ยังไม่มีรายชื่อกรรมการสำหรับเครือข่ายนี้';
            return `<p class="text-xs text-slate-500">${emptyMessage}</p>`;
        }
        const manageEnabled = canManageJudgesClient();
        return `
            <ul class="divide-y divide-slate-100">
                ${filteredList.map(judge => {
                    const stageScope = normalizeJudgeStageScope(judge.stageScope);
                    const stageBadge = stageScope === 'area'
                        ? '<span class="ml-1 inline-flex items-center px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 text-[10px] font-semibold">ระดับเขต</span>'
                        : '';
                    return `
                    <li class="py-1 flex flex-col gap-0.5 text-[11px]" data-judge-row="${escapeHtmlClient(judge.rowNumber || '')}">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <span class="font-semibold text-slate-800 flex items-center gap-1">
                                    ${escapeHtmlClient(judge.judgeName || '-')}
                                    ${stageBadge}
                                </span>
                                <div class="text-slate-500">${escapeHtmlClient(judge.schoolName || judge.schoolId || '-')}</div>
                            </div>
                            ${manageEnabled && judge.rowNumber ? `
                                <div class="flex items-center gap-1 text-[10px] whitespace-nowrap">
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-2 py-0.5 text-sky-600 hover:bg-slate-50"
                                        data-judge-edit
                                        data-judge-row="${escapeHtmlClient(judge.rowNumber)}">
                                        <span class="material-symbols-outlined text-[12px] leading-none">edit</span>
                                        <span>แก้ไข</span>
                                    </button>
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-full border border-red-200 px-2 py-0.5 text-red-600 hover:bg-red-50"
                                        data-judge-delete
                                        data-judge-row="${escapeHtmlClient(judge.rowNumber)}">
                                        <span class="material-symbols-outlined text-[12px] leading-none">delete</span>
                                        <span>ลบ</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <span class="text-slate-400">${escapeHtmlClient(judge.role || '')}${formatDisplayPhone(judge.phone) ? ' • ' + escapeHtmlClient(formatDisplayPhone(judge.phone)) : ''}${judge.email ? ` | ${escapeHtmlClient(judge.email)}` : ''}</span>
                    </li>
                `}).join('')}
            </ul>
        `;
    }

    function getJudgesForActivityCluster(activityId, clusterKey) {
        if (!hasLoadedJudgeAssignments || !Array.isArray(JUDGE_ASSIGNMENTS)) return [];
        const normalizedActivity = (activityId || '').toString().trim();
        const normalizedCluster = normalizeText(clusterKey || '');
        return JUDGE_ASSIGNMENTS.filter(record => {
            const recordActivity = (record.activityId || '').toString().trim();
            const recordCluster = normalizeText(record.clusterKey || '');
            return recordActivity === normalizedActivity
                && recordCluster === normalizedCluster
                && normalizeJudgeStageScope(record.stageScope) !== 'area';
        });
    }

    function getJudgesForActivity(activityId) {
        if (!hasLoadedJudgeAssignments || !Array.isArray(JUDGE_ASSIGNMENTS)) return [];
        const normalizedActivity = (activityId || '').toString().trim();
        return JUDGE_ASSIGNMENTS
            .filter(record => (record.activityId || '').toString().trim() === normalizedActivity)
            .sort((a, b) => {
                const clusterCompare = (a.clusterLabel || '').localeCompare(b.clusterLabel || '', 'th');
                if (clusterCompare !== 0) return clusterCompare;
                return (a.judgeName || '').localeCompare(b.judgeName || '', 'th');
            });
    }

    function buildJudgeSelectionKey(judge) {
        if (!judge) return '';
        if (judge.rowNumber !== undefined && judge.rowNumber !== null && judge.rowNumber !== '') {
            return `row:${judge.rowNumber}`;
        }
        const cluster = normalizeText(judge.clusterKey || judge.clusterId || judge.clusterLabel || '');
        const school = normalizeText(judge.schoolId || judge.schoolName || '');
        const name = normalizeText(judge.judgeName || judge.name || '');
        return `fallback:${cluster}|${school}|${name}`;
    }

    function normalizeJudgeStageScope(value) {
        const normalized = (value || '').toString().trim().toLowerCase();
        return normalized === 'area' ? 'area' : 'cluster';
    }

    function getJudgeRecordByRow(rowNumber) {
        if (!Array.isArray(JUDGE_ASSIGNMENTS) || !JUDGE_ASSIGNMENTS.length) return null;
        const target = parseInt(rowNumber, 10);
        if (!target) return null;
        return JUDGE_ASSIGNMENTS.find(record => parseInt(record.rowNumber, 10) === target) || null;
    }

    function setJudgePanelStatus(panel, message, type = 'info') {
        if (!panel) return;
        const activityId = panel.dataset.activityId || '';
        requestActivityFocus(activityId);
        const statusEl = panel.querySelector('[data-judge-status]');
        if (!statusEl) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        statusEl.textContent = message || '';
        statusEl.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        statusEl.classList.add(classMap[type] || classMap.info);
        if (type === 'info') {
            showJudgeActionLoading(message || 'กำลังประมวลผลกรรมการ...');
        } else {
            stopJudgeActionLoading();
            if (type === 'success') {
                notifyJudgeAction(message || 'ดำเนินการกรรมการเสร็จสิ้น', 'success');
            } else if (type === 'error') {
                notifyJudgeAction(message || 'เกิดข้อผิดพลาดในกรรมการ', 'error');
            }
        }
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = event => {
                const result = event.target?.result || '';
                const base64 = result.includes(',') ? result.split(',')[1] : result;
                resolve(base64);
            };
            reader.onerror = () => reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
            reader.readAsDataURL(file);
        });
    }

    function downloadJudgeSample(type) {
        const key = (type || '').toLowerCase();
        const sample = JUDGE_SAMPLE_FILES[key];
        if (!sample || !sample.base64) {
            Swal.fire({ icon: 'info', title: 'ยังไม่มีไฟล์ตัวอย่าง', text: 'ไม่พบไฟล์สำหรับดาวน์โหลด' });
            return;
        }
        try {
            const byteCharacters = atob(sample.base64);
            const bytes = new Uint8Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                bytes[i] = byteCharacters.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: sample.mime });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = sample.name;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                link.remove();
            }, 0);
        } catch (error) {
            console.error('ดาวน์โหลดไฟล์ตัวอย่างไม่สำเร็จ', error);
            Swal.fire({ icon: 'error', title: 'ดาวน์โหลดไม่สำเร็จ', text: 'ไม่สามารถดาวน์โหลดไฟล์ตัวอย่างได้' });
        }
    }

    function loadJudgeAssignments(force = false) {
        if (!currentUser) return;
        const now = Date.now();
        if (
            !force &&
            hasLoadedJudgeAssignments &&
            (now - lastJudgeFetch) < JUDGE_FETCH_COOLDOWN_MS
        ) {
            return;
        }
        if (isLoadingJudgeAssignments) return;
        isLoadingJudgeAssignments = true;
        google.script.run
            .withSuccessHandler(res => {
                isLoadingJudgeAssignments = false;
                if (res && !res.error && Array.isArray(res)) {
                    JUDGE_ASSIGNMENTS = res;
                    hasLoadedJudgeAssignments = true;
                    lastJudgeFetch = Date.now();
                    renderTeamTable(ALL_TEAMS);
                    if (judgeTimesheetState.isOpen && judgeTimesheetState.activityId) {
                        renderJudgeTimesheet(judgeTimesheetState.activityId);
                    }

                } else {
                    console.error('ไม่สามารถโหลดข้อมูลกรรมการได้', res?.error);
                }
            })
            .withFailureHandler(error => {
                isLoadingJudgeAssignments = false;
                console.error('ไม่สามารถโหลดข้อมูลกรรมการได้', error);
            })
            .getJudgeAssignments({ actor: buildActorPayload() });
    }

    function handleJudgePanelClick(event) {
        const sampleTrigger = event.target.closest('[data-judge-sample]');
        if (sampleTrigger) {
            event.preventDefault();
            downloadJudgeSample(sampleTrigger.dataset.judgeSample || '');
            return;
        }
        const editTrigger = event.target.closest('[data-judge-edit]');
        if (editTrigger) {
            event.preventDefault();
            if (!currentUser) {
                Swal.fire({ icon: 'info', title: 'กรุณาเข้าสู่ระบบ', text: 'ต้องเข้าสู่ระบบก่อนแก้ไขรายชื่อกรรมการ' });
                return;
            }
            if (!canManageJudgesClient()) {
                Swal.fire({ icon: 'info', title: 'ไม่มีสิทธิ์', text: 'บัญชีของคุณไม่สามารถแก้ไขกรรมการได้' });
                return;
            }
            const panel = editTrigger.closest('[data-judge-panel]');
            const rowNumber = editTrigger.dataset.judgeRow;
            const record = getJudgeRecordByRow(rowNumber);
            if (!record) {
                if (panel) {
                    setJudgePanelStatus(panel, 'ไม่พบข้อมูลกรรมการสำหรับแก้ไข', 'error');
                }
                return;
            }
            const clusterInfo = panel ? getPanelClusterInfo(panel) : { key: record.clusterKey, label: record.clusterLabel };
            openJudgeManualModal(
                record.activityId || panel?.dataset.activityId || '',
                clusterInfo.key || record.clusterKey || '',
                clusterInfo.label || record.clusterLabel || '',
                panel,
                record
            );
            return;
        }
        const deleteTrigger = event.target.closest('[data-judge-delete]');
        if (deleteTrigger) {
            event.preventDefault();
            if (!currentUser) {
                Swal.fire({ icon: 'info', title: 'กรุณาเข้าสู่ระบบ', text: 'ต้องเข้าสู่ระบบก่อนลบกรรมการ' });
                return;
            }
            if (!canManageJudgesClient()) {
                Swal.fire({ icon: 'info', title: 'ไม่มีสิทธิ์', text: 'บัญชีของคุณไม่สามารถลบกรรมการได้' });
                return;
            }
            const panel = deleteTrigger.closest('[data-judge-panel]');
            const rowNumber = deleteTrigger.dataset.judgeRow;
            promptJudgeDeletion(rowNumber, panel);
            return;
        }
        const manualTrigger = event.target.closest('[data-judge-manual]');
        if (manualTrigger) {
            const panel = manualTrigger.closest('[data-judge-panel]');
            if (panel) {
                const clusterInfo = getPanelClusterInfo(panel);
                requestActivityFocus(panel.dataset.activityId || '');
                openJudgeManualModal(
                    panel.dataset.activityId || '',
                    clusterInfo.key,
                    clusterInfo.label,
                    panel
                );
            }
            return;
        }
        const trigger = event.target.closest('[data-judge-file-trigger]');
        if (trigger) {
            const panel = trigger.closest('[data-judge-panel]');
            const input = panel?.querySelector('input[data-judge-file]');
            input?.click();
            return;
        }
        const uploadBtn = event.target.closest('[data-judge-upload]');
        if (!uploadBtn) return;
        const panel = uploadBtn.closest('[data-judge-panel]');
        if (!panel) return;
        if (!currentUser) {
            Swal.fire({ icon: 'info', title: 'กรุณาเข้าสู่ระบบ', text: 'ต้องเข้าสู่ระบบก่อนนำเข้ารายชื่อกรรมการ' });
            return;
        }
        if (!canManageJudgesClient()) {
            Swal.fire({ icon: 'info', title: 'ไม่มีสิทธิ์', text: 'บัญชีของคุณไม่สามารถนำเข้ารายชื่อกรรมการได้' });
            return;
        }
        const fileInput = panel.querySelector('input[data-judge-file]');
        const file = fileInput?.files?.[0];
        if (!file) {
            setJudgePanelStatus(panel, 'กรุณาเลือกไฟล์ .csv หรือ .xlsx ก่อนนำเข้า', 'error');
            return;
        }
        setJudgePanelStatus(panel, 'กำลังอัปโหลด...', 'info');
        const clusterInfo = getPanelClusterInfo(panel);
        const effectiveKey = getEffectiveClusterKey(clusterInfo.key);
        const effectiveLabel = getEffectiveClusterLabel(clusterInfo.label);
        readFileAsBase64(file)
            .then(base64 => new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .importJudges({
                        actor: buildActorPayload(),
                        activityId: panel.dataset.activityId || '',
                        clusterKey: effectiveKey,
                        clusterLabel: effectiveLabel,
                        fileData: {
                            base64Data: base64,
                            mimeType: file.type,
                            fileName: file.name
                        }
                    });
            }))
            .then(res => {
                if (res && res.success) {
                    setJudgePanelStatus(panel, `นำเข้าสำเร็จ (${res.count || 0} รายชื่อ)`, 'success');
                    if (fileInput) fileInput.value = '';
                    loadJudgeAssignments(true);
                } else {
                    throw new Error(res && res.error ? res.error : 'ไม่สามารถนำเข้ารายชื่อกรรมการได้');
                }
            })
            .catch(error => {
                setJudgePanelStatus(panel, error.message || 'ไม่สามารถนำเข้ารายชื่อกรรมการได้', 'error');
            });
    }

    function handleJudgeFileChange(event) {
        const input = event.target.closest('[data-judge-file]');
        if (!input) return;
        const panel = input.closest('[data-judge-panel]');
        if (!panel) return;
        if (input.files && input.files[0]) {
            setJudgePanelStatus(panel, `เลือกไฟล์: ${input.files[0].name}`, 'info');
        } else {
            setJudgePanelStatus(panel, 'รองรับไฟล์ .csv หรือ .xlsx (ต้องมีคอลัม SchoolID)', 'info');
        }
    }

        function openJudgeManualModal(activityId, clusterKey, clusterLabel, panel, record = null) {
        if (!judgeManualModal) return;
        const info = getActivityInfoById(activityId);
        const effectiveKey = getEffectiveClusterKey(clusterKey);
        const effectiveLabel = getEffectiveClusterLabel(clusterLabel);
        const isEditing = Boolean(record && record.rowNumber);
        judgeManualState.activityId = activityId;
        judgeManualState.clusterKey = effectiveKey;
        judgeManualState.clusterLabel = effectiveLabel;
        judgeManualState.panel = panel || null;
        judgeManualState.mode = isEditing ? 'edit' : 'create';
        judgeManualState.rowNumber = isEditing ? record.rowNumber : null;
        judgeManualState.stageScope = isEditing
            ? normalizeJudgeStageScope(record?.stageScope)
            : (shouldUseAreaJudgeManagement() ? 'area' : 'cluster');
        updateJudgeModalActionUi();
        if (judgeManualTitle) {
            judgeManualTitle.textContent = `กิจกรรม: ${info?.name || activityId}`;
        }
        if (judgeManualSubtitle) {
            const stageNote = judgeManualState.stageScope === 'area' ? ' • ระดับเขต' : '';
            judgeManualSubtitle.textContent = `เครือข่าย: ${effectiveLabel || 'ไม่ระบุเครือข่าย'}${stageNote}`;
        }
        if (judgeManualCopySelect) {
            judgeManualCopySelect.value = '';
        }
        if (judgeManualState.stageScope === 'area') {
            populateJudgeManualCopyOptions(activityId);
            judgeManualCopyWrapper?.classList.remove('hidden');
        } else {
            if (judgeManualCopyWrapper) judgeManualCopyWrapper.classList.add('hidden');
            if (judgeManualCopySelect) {
                judgeManualCopySelect.innerHTML = '<option value="">-- เลือกกรรมการ --</option>';
            }
        }
        populateJudgeModalSchools(effectiveKey, isEditing ? (record.schoolId || '') : '');
        judgeManualNameInput.value = isEditing ? (record.judgeName || '') : '';
        judgeManualRoleInput.value = isEditing ? (record.role || '') : '';
        judgeManualPhoneInput.value = isEditing ? (record.phone || '') : '';
        judgeManualEmailInput.value = isEditing ? (record.email || '') : '';
        const statusMessage = isEditing
            ? 'แก้ไขข้อมูลแล้วกด “อัปเดตกรรมการ”'
            : 'กรอกข้อมูลให้ครบแล้วกด “บันทึกกรรมการ”';
        setJudgeModalStatus(statusMessage, 'info');
        setJudgeModalBusy(false);
        judgeManualModal.classList.remove('hidden');
        judgeManualModal.classList.add('flex');
        judgeManualNameInput.focus();
    }

    function closeJudgeManualModal() {
        if (!judgeManualModal) return;
        judgeManualModal.classList.add('hidden');
        judgeManualModal.classList.remove('flex');
        judgeManualState.activityId = '';
        judgeManualState.clusterKey = '';
        judgeManualState.clusterLabel = '';
        judgeManualState.panel = null;
        judgeManualState.mode = 'create';
        judgeManualState.rowNumber = null;
        judgeManualState.stageScope = 'cluster';
        if (judgeManualCopyWrapper) judgeManualCopyWrapper.classList.add('hidden');
        if (judgeManualCopySelect) {
            judgeManualCopySelect.innerHTML = '<option value="">-- เลือกกรรมการ --</option>';
            judgeManualCopySelect.value = '';
        }
        updateJudgeModalActionUi();
    }

    function populateJudgeModalSchools(clusterKey, selectedSchoolId = '') {
        if (!judgeManualSchoolSelect) return;
        const options = getSchoolsForJudgeModal(clusterKey);
        const optionParts = [
            '<option value="">-- เลือกโรงเรียน --</option>',
            `<option value="${EXTERNAL_JUDGE_SCHOOL_ID}">${escapeHtmlClient(EXTERNAL_JUDGE_SCHOOL_SELECT_LABEL)}</option>`
        ];
        if (options.length) {
            optionParts.push(
                ...options.map(
                    school => `<option value="${escapeHtmlClient(school.id || '')}">[${escapeHtmlClient(school.id || '')}] ${escapeHtmlClient(school.name || '')}</option>`
                )
            );
        } else {
            optionParts.push('<option value="" disabled>-- ไม่พบโรงเรียนในเครือข่าย --</option>');
        }
        judgeManualSchoolSelect.disabled = false;
        judgeManualSchoolSelect.innerHTML = optionParts.join('');
        const normalizedSelected = (selectedSchoolId || '').toString().trim();
        judgeManualSchoolSelect.value = normalizedSelected;
    }

    function populateJudgeManualCopyOptions(activityId) {
        if (!judgeManualCopySelect) return;
        if (judgeManualState.stageScope !== 'area') {
            judgeManualCopySelect.innerHTML = '<option value="">-- เลือกกรรมการ --</option>';
            judgeManualCopySelect.value = '';
            return;
        }
        const normalizedActivity = (activityId || '').toString().trim();
        const dataset = Array.isArray(JUDGE_ASSIGNMENTS)
            ? JUDGE_ASSIGNMENTS.filter(record => {
                const sameActivity = (record.activityId || '').toString().trim() === normalizedActivity;
                return sameActivity && normalizeJudgeStageScope(record.stageScope) !== 'area';
            })
            : [];
        if (!dataset.length) {
            judgeManualCopySelect.innerHTML = '<option value="">ยังไม่มีกรรมการรอบกลุ่มเครือข่าย</option>';
            judgeManualCopySelect.value = '';
            return;
        }
        const options = ['<option value="">-- เลือกกรรมการ --</option>'].concat(
            dataset.map(record => {
                const safeLabel = escapeHtmlClient(record.judgeName || '-');
                const safeSchool = escapeHtmlClient(record.schoolName || record.schoolId || '-');
                const safeCluster = escapeHtmlClient(record.clusterLabel || record.clusterKey || 'ไม่ระบุเครือข่าย');
                return `<option value="${escapeHtmlClient(record.rowNumber || '')}">[${safeCluster}] ${safeLabel} • ${safeSchool}</option>`;
            })
        );
        judgeManualCopySelect.innerHTML = options.join('');
        judgeManualCopySelect.value = '';
    }

    function handleJudgeManualCopySelect(event) {
        const selectedRow = event?.target?.value || '';
        if (!selectedRow) return;
        const record = getJudgeRecordByRow(selectedRow);
        if (!record) return;
        const newClusterKey = getEffectiveClusterKey(record.clusterKey || record.clusterId || judgeManualState.clusterKey || '');
        const newClusterLabel = getEffectiveClusterLabel(record.clusterLabel || record.clusterKey || judgeManualState.clusterLabel || '');
        if (newClusterKey) judgeManualState.clusterKey = newClusterKey;
        if (newClusterLabel) judgeManualState.clusterLabel = newClusterLabel;
        if (judgeManualSubtitle) {
            const stageNote = judgeManualState.stageScope === 'area' ? ' • ระดับเขต' : '';
            judgeManualSubtitle.textContent = `เครือข่าย: ${newClusterLabel || 'ไม่ระบุเครือข่าย'}${stageNote}`;
        }
        if (judgeManualNameInput) judgeManualNameInput.value = record.judgeName || '';
        populateJudgeModalSchools(judgeManualState.clusterKey, record.schoolId || '');
        if (judgeManualRoleInput) judgeManualRoleInput.value = record.role || '';
        if (judgeManualPhoneInput) judgeManualPhoneInput.value = record.phone || '';
        if (judgeManualEmailInput) judgeManualEmailInput.value = record.email || '';
        if (judgeManualStatus) {
            judgeManualStatus.textContent = 'คัดลอกจากรายชื่อกรรมการรอบกลุ่มแล้ว';
        }
    }

    function getJudgeModalActionLabel() {
        return judgeManualState.mode === 'edit' ? 'อัปเดตกรรมการ' : 'บันทึกกรรมการ';
    }

    function updateJudgeModalActionUi() {
        if (judgeManualSubmitLabel) {
            judgeManualSubmitLabel.textContent = getJudgeModalActionLabel();
        }
        if (judgeManualSubmitIcon) {
            judgeManualSubmitIcon.textContent = judgeManualState.mode === 'edit' ? 'sync_saved_locally' : 'save';
        }
    }

    function getSchoolsForJudgeModal(clusterKey) {
        if (!Array.isArray(SCHOOL_OPTIONS) || !SCHOOL_OPTIONS.length) return [];
        if (judgeManualState.stageScope === 'area') {
            return [...SCHOOL_OPTIONS];
        }
        const level = getCurrentUserLevel();
        const normalizedCluster = normalizeText(clusterKey || '');
        const isClusterScoped = Boolean(normalizedCluster);
        return SCHOOL_OPTIONS.filter(school => {
            if (level === 'group_admin') {
                const userCluster = getUserClusterForFilter();
                if (userCluster) {
                    const schoolCluster = normalizeText(school.clusterId || school.cluster);
                    if (schoolCluster !== userCluster) return false;
                }
            }
            if (!isClusterScoped) return true;
            const schoolCluster = normalizeText(school.clusterId || school.cluster);
            return schoolCluster === normalizedCluster;
        });
    }

    function setJudgeModalStatus(message, type = 'info') {
        if (!judgeManualStatus) return;
        const activityId = judgeManualState.activityId || '';
        if (activityId) requestActivityFocus(activityId);
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        judgeManualStatus.textContent = message || '';
        judgeManualStatus.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        judgeManualStatus.classList.add(classMap[type] || classMap.info);
        if (type === 'info') {
            showJudgeActionLoading(message || 'กำลังจัดการกรรมการ...');
        } else {
            stopJudgeActionLoading();
            if (type === 'success') {
                notifyJudgeAction(message || 'บันทึกกรรมการแล้ว', 'success');
            } else if (type === 'error') {
                notifyJudgeAction(message || 'ไม่สามารถจัดการกรรมการได้', 'error');
            }
        }
    }

    function setJudgeModalBusy(isBusy) {
        if (judgeManualSubmit) {
            judgeManualSubmit.disabled = isBusy;
            judgeManualSubmit.classList.toggle('opacity-60', isBusy);
        }
        if (judgeManualSpinner) {
            judgeManualSpinner.classList.toggle('hidden', !isBusy);
        }
        if (judgeManualSubmitIcon) {
            judgeManualSubmitIcon.classList.toggle('hidden', isBusy);
        }
        if (judgeManualSubmitLabel) {
            judgeManualSubmitLabel.textContent = isBusy ? 'กำลังบันทึก...' : getJudgeModalActionLabel();
        }
        if (judgeManualForm) {
            const fields = judgeManualForm.querySelectorAll('input, select, button');
            fields.forEach(field => {
                if (isBusy) {
                    field.dataset.prevDisabled = field.disabled ? 'true' : 'false';
                    field.disabled = true;
                } else if ('prevDisabled' in field.dataset) {
                    const wasDisabled = field.dataset.prevDisabled === 'true';
                    if (!wasDisabled) {
                        field.disabled = false;
                    }
                    delete field.dataset.prevDisabled;
                }
            });
        }
    }

    function handleJudgeManualSubmit(event) {
        event.preventDefault();
        if (!currentUser) {
            Swal.fire({ icon: 'info', title: 'กรุณาเข้าสู่ระบบ', text: 'ต้องเข้าสู่ระบบก่อนเพิ่มกรรมการ' });
            return;
        }
        if (!canManageJudgesClient()) {
            Swal.fire({ icon: 'info', title: 'ไม่มีสิทธิ์', text: 'บัญชีของคุณไม่สามารถเพิ่มกรรมการได้' });
            return;
        }
        const activityId = judgeManualState.activityId;
        const clusterKey = judgeManualState.clusterKey;
        if (!activityId) {
            setJudgeModalStatus('กรุณาระบุกิจกรรม', 'error');
            return;
        }
        const isEditing = judgeManualState.mode === 'edit';
        const judgeName = (judgeManualNameInput.value || '').trim();
        const schoolId = (judgeManualSchoolSelect.value || '').trim();
        if (!judgeName || !schoolId) {
            setJudgeModalStatus('กรุณากรอกชื่อกรรมการและเลือกโรงเรียน', 'error');
            return;
        }
        setJudgeModalBusy(true);
        setJudgeModalStatus('กำลังบันทึก...', 'info');
        const runner = google.script.run
            .withSuccessHandler(res => {
                setJudgeModalBusy(false);
                if (res && res.success) {
                    const successText = isEditing ? 'อัปเดตกรรมการสำเร็จ' : 'บันทึกกรรมการสำเร็จ';
                    setJudgeModalStatus(successText, 'success');
                    const targetPanel = judgeManualState.panel;
                    closeJudgeManualModal();
                    if (targetPanel) {
                        const panelMessage = isEditing ? 'อัปเดตรายชื่อกรรมการแล้ว' : 'เพิ่มกรรมการสำเร็จ';
                        setJudgePanelStatus(targetPanel, panelMessage, 'success');
                    }
                    loadJudgeAssignments(true);
                } else {
                    setJudgeModalStatus((res && res.error) || 'ไม่สามารถบันทึกกรรมการได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setJudgeModalBusy(false);
                setJudgeModalStatus(error.message || 'ไม่สามารถบันทึกกรรมการได้', 'error');
            });
        const payload = {
            actor: buildActorPayload(),
            activityId,
            clusterKey,
            clusterLabel: judgeManualState.clusterLabel,
            schoolId,
            judgeName,
            role: (judgeManualRoleInput.value || '').trim(),
            phone: (judgeManualPhoneInput.value || '').trim(),
            email: (judgeManualEmailInput.value || '').trim(),
            stageScope: judgeManualState.stageScope
        };
        if (isEditing) {
            payload.rowNumber = judgeManualState.rowNumber;
            runner.updateJudge(payload);
        } else {
            runner.addJudge(payload);
        }
    }

    function promptJudgeDeletion(rowNumber, panel) {
        const record = getJudgeRecordByRow(rowNumber);
        if (!record) {
            if (panel) {
                setJudgePanelStatus(panel, 'ไม่พบข้อมูลกรรมการ', 'error');
            }
            return;
        }
        Swal.fire({
            icon: 'warning',
            title: 'ยืนยันการลบกรรมการ',
            html: `<p class="text-sm text-slate-600">ลบ <strong>${escapeHtmlClient(record.judgeName || '-')}</strong> ออกจากรายชื่อนี้หรือไม่?</p>`,
            confirmButtonText: 'ลบกรรมการ',
            confirmButtonColor: '#ef4444',
            cancelButtonText: 'ยกเลิก',
            showCancelButton: true,
            reverseButtons: true
        }).then(result => {
            if (!result.isConfirmed) return;
            if (panel) {
                setJudgePanelStatus(panel, 'กำลังลบกรรมการ...', 'info');
            }
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.success) {
                        if (panel) {
                            setJudgePanelStatus(panel, 'ลบกรรมการแล้ว', 'success');
                        }
                        loadJudgeAssignments(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถลบกรรมการได้';
                        if (panel) setJudgePanelStatus(panel, message, 'error');
                        Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                    }
                })
                .withFailureHandler(error => {
                    const message = error.message || 'ไม่สามารถลบกรรมการได้';
                    if (panel) setJudgePanelStatus(panel, message, 'error');
                    Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                })
                .deleteJudge({
                    actor: buildActorPayload(),
                    rowNumber: record.rowNumber
                });
        });
    }


    function renderProfileTeams() {
        if (!profileTeamList) return;
        if (!currentUser) {
            profileTeamList.innerHTML = '<p class="text-slate-500">เข้าสู่ระบบเพื่อดูทีมของคุณ</p>';
            return;
        }
        const teams = filterTeamsForCurrentUser(ALL_TEAMS);
        const rejectedTeams = Array.isArray(teams)
            ? teams.filter(team => (team.status || '').toLowerCase() === 'rejected')
            : [];
        if (!rejectedTeams.length) {
            profileTeamList.innerHTML = '<p class="text-slate-500">ยังไม่มีทีมที่ถูกปฏิเสธ</p>';
            return;
        }
        const html = rejectedTeams.map(team => {
            const members = safeJsonParse(team.members, { teachers: [], students: [] });
            const teachers = Array.isArray(members.teachers) ? members.teachers : [];
            const students = Array.isArray(members.students) ? members.students : [];
            const contact = safeJsonParse(team.contact, {});
            const activityObj = ALL_ACTIVITIES.find(a => a.id === team.activity);
            const activityName = activityObj ? activityObj.name : (team.activity || '-');
            const canManage = canManageTeam(team);
            const locked = isTeamLockedForEdit(team);
            const manageDisabled = canManage ? '' : 'disabled';
            const manageLabel = locked ? 'ดูข้อมูล' : 'จัดการทีม';
            const reasonText = (team.statusReason || '').trim();
            return `
                <div class="rounded-2xl border border-slate-200 p-4 space-y-3">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(team.teamName || '-')}</p>
                            <p class="text-xs text-slate-500">รหัสทีม: ${escapeHtmlClient(team.teamId || '-')} | กิจกรรม: ${escapeHtmlClient(activityName)}</p>
                            <div class="mt-1 text-xs text-slate-500">สถานะ: ${getStatusBadge(team.status)}</div>
                        </div>
                        <div class="text-xs text-slate-500 md:text-right">
                            <p class="font-semibold text-slate-600">ผู้ประสานงาน</p>
                            <p>${escapeHtmlClient(contact.name || '-')}</p>
                            <p>${escapeHtmlClient(contact.phone || '')}</p>
                            <p>${escapeHtmlClient(contact.email || '')}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
                            <p class="text-xs font-semibold text-slate-600 mb-1">ครู (${teachers.length})</p>
                            <ul class="space-y-1 text-xs text-slate-500">
                                ${teachers.length ? teachers.map(t => `<li>• ${escapeHtmlClient(t.name || '-')} ${t.phone ? `(${escapeHtmlClient(t.phone)})` : ''}</li>`).join('') : '<li>ไม่มีข้อมูล</li>'}
                            </ul>
                        </div>
                        <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
                            <p class="text-xs font-semibold text-slate-600 mb-1">นักเรียน (${students.length})</p>
                            <ul class="space-y-1 text-xs text-slate-500">
                                ${students.length ? students.map(s => `<li>• ${escapeHtmlClient(s.name || '-')} ${s.class ? `(${escapeHtmlClient(s.class)})` : ''}</li>`).join('') : '<li>ไม่มีข้อมูล</li>'}
                            </ul>
                        </div>
                    </div>
                    <div class="rounded-xl border border-red-200 bg-red-50 p-3">
                        <p class="text-xs font-semibold text-red-700">เหตุผลที่ไม่อนุมัติ</p>
                        <p class="text-[11px] text-red-600 mt-1">${reasonText ? escapeHtmlClient(reasonText) : 'ยังไม่ระบุเหตุผล'}</p>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-2 border-t border-slate-100 pt-3">
                        <p class="text-[11px] text-slate-500">${locked ? 'สถานะ Print: เปิดอ่านอย่างเดียว' : (canManage ? 'คุณสามารถจัดการทีมนี้' : 'กรุณาเข้าสู่ระบบเพื่อจัดการทีม')}</p>
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold ${manageDisabled ? 'text-slate-400 cursor-not-allowed bg-slate-50' : 'text-sky-600 hover:bg-sky-50'}"
                            ${manageDisabled}
                            onclick="openTeamManager('${team.teamId}')">
                            <span class="material-symbols-outlined text-base">construction</span>
                            <span>${manageLabel}</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        profileTeamList.innerHTML = html;
    }

    function enhanceSchoolSelectWithSearch(selectEl) {
        if (!selectEl || !window.jQuery || typeof window.jQuery.fn.select2 !== 'function') return;
        if (selectEl.dataset.enableSearch === 'false') return;
        const parent = selectEl.closest('.select2-parent');
        const dropdownParent = parent ? window.jQuery(parent) : window.jQuery(document.body);
        const $select = window.jQuery(selectEl);
        if ($select.data('select2')) {
            $select.select2('destroy');
        }
        $select.select2({
            placeholder: selectEl.dataset.placeholder || '-- เลือกโรงเรียน --',
            width: '100%',
            allowClear: !!selectEl.dataset.allowClear,
            dropdownParent,
            language: {
                noResults: () => 'ไม่พบโรงเรียนที่ค้นหา'
            }
        });
    }

    function clearSelect2Selection(selectEl) {
        if (!selectEl || !window.jQuery || typeof window.jQuery.fn.select2 !== 'function') return;
        const instance = window.jQuery(selectEl).data('select2');
        if (instance) {
            window.jQuery(selectEl).val(null).trigger('change');
        }
    }

    function populateSchoolSelectElement(selectEl, schools, {
        placeholderText = '-- เลือกโรงเรียน --',
        keepPreviousValue = true,
        ensureValue = ''
    } = {}) {
        if (!selectEl) return;
        const previousValue = keepPreviousValue ? (selectEl.value || '') : '';
        selectEl.innerHTML = `<option value="">${placeholderText}</option>`;
        if (Array.isArray(schools) && schools.length) {
            schools.forEach(school => {
                if (!school || !school.name) return;
                const option = document.createElement('option');
                option.value = school.id || school.name;
                option.textContent = school.id ? `[${school.id}] ${school.name}` : school.name;
                option.dataset.schoolName = school.name;
                option.dataset.schoolId = school.id || '';
                option.dataset.schoolCluster = school.cluster || '';
                selectEl.appendChild(option);
            });
        }
        const targetValue = ensureValue || previousValue;
        if (targetValue) {
            const hasOption = Array.from(selectEl.options).some(opt => opt.value === targetValue);
            if (!hasOption) {
                const fallbackOption = document.createElement('option');
                fallbackOption.value = targetValue;
                fallbackOption.textContent = targetValue;
                selectEl.appendChild(fallbackOption);
            }
            selectEl.value = targetValue;
        }
        enhanceSchoolSelectWithSearch(selectEl);
    }

    function getSignupFieldValue(field) {
        if (field === 'username') {
            return (signupUsernameInput?.value || '').trim();
        }
        if (field === 'email') {
            return (signupEmailInput?.value || '').trim();
        }
        return '';
    }

    function getSignupHintElement(field) {
        if (field === 'username') return signupUsernameHint;
        if (field === 'email') return signupEmailHint;
        return null;
    }

    function setSignupFieldState(field, {
        status = 'idle',
        message,
        available = false,
        value
    } = {}) {
        if (!signupAvailabilityState[field]) {
            signupAvailabilityState[field] = { status: 'idle', value: '', available: false };
        }
        const store = signupAvailabilityState[field];
        store.status = status;
        if (typeof available === 'boolean') store.available = available;
        if (value !== undefined) store.value = value;
        const hintEl = getSignupHintElement(field);
        if (hintEl) {
            const defaultText = SIGNUP_HINT_DEFAULTS[field] || hintEl.dataset?.defaultText || '';
            const text = message || defaultText;
            const baseClasses = 'text-xs mt-1 leading-snug';
            let colorClass = 'text-slate-500';
            if (status === 'checking') colorClass = 'text-sky-600';
            if (status === 'invalid' || status === 'unavailable') colorClass = 'text-rose-600';
            if (status === 'available') colorClass = 'text-emerald-600';
            hintEl.textContent = text;
            hintEl.className = `${baseClasses} ${colorClass}`;
        }
    }

    function resetSignupAvailabilityState() {
        setSignupFieldState('username', { status: 'idle', value: '', available: false });
        setSignupFieldState('email', { status: 'idle', value: '', available: false });
    }

    function validateSignupFieldFormat(field, value) {
        const trimmed = (value || '').trim();
        if (!trimmed) {
            setSignupFieldState(field, { status: 'idle', value: '', available: false });
            return false;
        }
        if (field === 'username') {
            const usernameRegex = /^[a-zA-Z0-9._-]{4,20}$/;
            if (!usernameRegex.test(trimmed)) {
                setSignupFieldState('username', {
                    status: 'invalid',
                    value: trimmed,
                    available: false,
                    message: 'ใช้ a-z, 0-9 ความยาว 4-20 ตัวอักษร'
                });
                return false;
            }
            return true;
        }
        if (field === 'email') {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(trimmed)) {
                setSignupFieldState('email', {
                    status: 'invalid',
                    value: trimmed,
                    available: false,
                    message: 'รูปแบบอีเมลไม่ถูกต้อง'
                });
                return false;
            }
            return true;
        }
        return false;
    }

    function requestSignupAvailabilityCheck() {
        if (signupAvailabilityTimer) {
            clearTimeout(signupAvailabilityTimer);
        }
        signupAvailabilityTimer = setTimeout(() => {
            performSignupAvailabilityCheck();
        }, 450);
    }

    function performSignupAvailabilityCheck() {
        const username = getSignupFieldValue('username');
        const email = getSignupFieldValue('email');
        const shouldCheckUsername = validateSignupFieldFormat('username', username);
        const shouldCheckEmail = validateSignupFieldFormat('email', email);
        if (!shouldCheckUsername && !shouldCheckEmail) return;
        const payload = {};
        if (shouldCheckUsername) {
            payload.username = username;
            setSignupFieldState('username', {
                status: 'checking',
                value: username,
                available: false,
                message: 'กำลังตรวจสอบชื่อผู้ใช้...'
            });
        }
        if (shouldCheckEmail) {
            payload.email = email;
            setSignupFieldState('email', {
                status: 'checking',
                value: email,
                available: false,
                message: 'กำลังตรวจสอบอีเมล...'
            });
        }
        if (!Object.keys(payload).length) return;
        google.script.run
            .withSuccessHandler(result => handleSignupAvailabilityResponse(result, username, email))
            .withFailureHandler(() => {
                if (shouldCheckUsername) {
                    setSignupFieldState('username', {
                        status: 'invalid',
                        available: false,
                        message: 'ไม่สามารถตรวจสอบชื่อผู้ใช้ได้ ลองใหม่อีกครั้ง'
                    });
                }
                if (shouldCheckEmail) {
                    setSignupFieldState('email', {
                        status: 'invalid',
                        available: false,
                        message: 'ไม่สามารถตรวจสอบอีเมลได้ ลองใหม่อีกครั้ง'
                    });
                }
            })
            .checkAccountAvailability(payload);
    }

    function handleSignupAvailabilityResponse(response, expectedUsername, expectedEmail) {
        if (!response || response.success === false) {
            if (expectedUsername) {
                setSignupFieldState('username', {
                    status: 'invalid',
                    available: false,
                    message: response?.error || 'ตรวจสอบชื่อผู้ใช้ไม่สำเร็จ'
                });
            }
            if (expectedEmail) {
                setSignupFieldState('email', {
                    status: 'invalid',
                    available: false,
                    message: response?.error || 'ตรวจสอบอีเมลไม่สำเร็จ'
                });
            }
            return;
        }
        const currentUsername = getSignupFieldValue('username');
        const currentEmail = getSignupFieldValue('email');
        if (expectedUsername && expectedUsername === currentUsername) {
            const result = response.username || {};
            if (result.available) {
                setSignupFieldState('username', {
                    status: 'available',
                    value: expectedUsername,
                    available: true,
                    message: 'ชื่อผู้ใช้นี้สามารถใช้งานได้'
                });
            } else {
                setSignupFieldState('username', {
                    status: 'unavailable',
                    value: expectedUsername,
                    available: false,
                    message: result.message || 'ชื่อผู้ใช้นี้ถูกใช้แล้ว'
                });
            }
        }
        if (expectedEmail && expectedEmail === currentEmail) {
            const result = response.email || {};
            if (result.available) {
                setSignupFieldState('email', {
                    status: 'available',
                    value: expectedEmail,
                    available: true,
                    message: 'อีเมลนี้สามารถใช้งานได้'
                });
            } else {
                setSignupFieldState('email', {
                    status: 'unavailable',
                    value: expectedEmail,
                    available: false,
                    message: result.message || 'อีเมลนี้ถูกใช้แล้ว'
                });
            }
        }
    }

    function getSelectedSchoolLabel(selectEl) {
        if (!selectEl) return '';
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.schoolName || option?.textContent || '';
    }

    function setSignupBusyState(state) {
        isSignupBusy = state;
        if (signupLoadingOverlay) {
            signupLoadingOverlay.classList.toggle('hidden', !state);
        }
        if (signupSubmitButton) {
            signupSubmitButton.disabled = state;
            signupSubmitButton.classList.toggle('opacity-60', state);
        }
        if (authSignupForm) {
            const controls = authSignupForm.querySelectorAll('input, select, button, textarea');
            controls.forEach(control => {
                control.disabled = state;
            });
        }
    }

    function showSignupSuccessModal(data = {}) {
        const { username, password, schoolLabel, email, tel } = data;
        const items = [
            { label: 'ชื่อผู้ใช้', value: username },
            { label: 'รหัสผ่าน', value: password },
            { label: 'อีเมล', value: email },
            { label: 'เบอร์ติดต่อ', value: tel },
            { label: 'โรงเรียน', value: schoolLabel }
        ].filter(item => item.value);
        const rows = items.map(item => `
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-[11px] text-slate-500">${escapeHtmlClient(item.label)}</p>
                <p class="text-sm font-semibold text-slate-900 break-all">${escapeHtmlClient(item.value)}</p>
            </div>
        `).join('');
        Swal.fire({
            icon: 'success',
            title: 'สมัครสมาชิกสำเร็จ',
            html: `
                <div class="text-left space-y-3">
                    <p class="text-sm text-slate-600">เก็บข้อมูลนี้ไว้เพื่อเข้าสู่ระบบครั้งถัดไป</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${rows}</div>
                </div>
            `,
            confirmButtonText: 'ไปหน้าเข้าสู่ระบบ',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            navigateTo('section-auth');
            if (loginUsernameInput && username) {
                loginUsernameInput.value = username;
            }
        });
    }


    function handleSignupSubmit(event) {
        event.preventDefault();
        if (!authSignupForm || isSignupBusy) return;
        const username = getSignupFieldValue('username');
        const password = signupPasswordInput?.value || '';
        const confirmPassword = signupConfirmPasswordInput?.value || '';
        const schoolId = authSchoolSelect ? authSchoolSelect.value : '';
        const email = getSignupFieldValue('email');
        if (!username || !password) {
            showAuthStatus(signupStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน', 'error');
            return;
        }
        if (password !== confirmPassword) {
            showAuthStatus(signupStatus, 'รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน', 'error');
            return;
        }
        if (!schoolId) {
            showAuthStatus(signupStatus, 'กรุณาเลือกโรงเรียนจากรายการ', 'error');
            return;
        }
        if (!email) {
            showAuthStatus(signupStatus, 'กรุณากรอกอีเมล', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showAuthStatus(signupStatus, 'รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        const usernameState = signupAvailabilityState.username || {};
        if (usernameState.status !== 'available' || usernameState.value !== username) {
            showAuthStatus(signupStatus, 'กรุณาตรวจสอบความซ้ำของชื่อผู้ใช้ก่อน', 'error');
            requestSignupAvailabilityCheck();
            return;
        }
        const emailState = signupAvailabilityState.email || {};
        if (emailState.status !== 'available' || emailState.value !== email) {
            showAuthStatus(signupStatus, 'กรุณาตรวจสอบความซ้ำของอีเมลก่อน', 'error');
            requestSignupAvailabilityCheck();
            return;
        }
        const payload = {
            username,
            password,
            name: (signupNameInput?.value || '').trim(),
            surname: (signupSurnameInput?.value || '').trim(),
            tel: (signupTelInput?.value || '').trim(),
            schoolId,
            email
        };
        if (USER_AVATAR_FILE_DATA) {
            payload.avatarFileData = USER_AVATAR_FILE_DATA;
        }
        setSignupBusyState(true);
        showAuthStatus(signupStatus, 'กำลังสมัครสมาชิก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setSignupBusyState(false);
                if (response && response.success) {
                    const schoolLabel = getSelectedSchoolLabel(authSchoolSelect);
                    showAuthStatus(signupStatus, 'สมัครสมาชิกสำเร็จ! สามารถเข้าสู่ระบบได้ทันที', 'success');
                    authSignupForm.reset();
                    if (authSchoolSelect) {
                        authSchoolSelect.value = '';
                        clearSelect2Selection(authSchoolSelect);
                    }
                    resetSignupAvatarUI();
                    setSignupFormVisibility(false);
                    resetSignupAvailabilityState();
                    showSignupSuccessModal({
                        username,
                        password,
                        schoolLabel,
                        email,
                        tel: (signupTelInput?.value || '').trim()
                    });
                } else {
                    showAuthStatus(signupStatus, (response && response.error) || 'ไม่สามารถสมัครสมาชิกได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setSignupBusyState(false);
                showAuthStatus(signupStatus, error.message || 'เกิดข้อผิดพลาดในการสมัครสมาชิก', 'error');
            })
            .registerNormalUser(payload);
    }

    function handleLoginSubmit(event) {
        event.preventDefault();
        if (!authLoginForm) return;
        const username = (loginUsernameInput?.value || '').trim();
        const password = loginPasswordInput?.value || '';
        if (!username || !password) {
            showAuthStatus(loginStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'error');
            return;
        }
        showAuthStatus(loginStatus, 'กำลังเข้าสู่ระบบ...', 'info');
        setLoginFormDisabled(true);
        setLoginBusyState(true);
        google.script.run
            .withSuccessHandler(response => {
                setLoginBusyState(false);
                if (response && response.success) {
                    const displayName = response.user?.name || response.user?.username || username;
                    if (response.user) {
                        setCurrentUser(response.user);
                        authLoginForm.reset();
                    }
                    showAuthStatus(loginStatus, `เข้าสู่ระบบสำเร็จ ยินดีต้อนรับ ${displayName}`, 'success');
                    navigateTo('section-form');
                } else {
                    setLoginFormDisabled(false);
                    showAuthStatus(loginStatus, (response && response.error) || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setLoginBusyState(false);
                setLoginFormDisabled(false);
                showAuthStatus(loginStatus, error.message || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
            })
            .loginUser({ username, password });
    }

    function handleLogout(event) {
        if (event) event.preventDefault();
        if (!currentUser) return;
        setLoginBusyState(false);
        clearUserSession();
        if (authLoginForm) authLoginForm.reset();
        setLoginFormDisabled(false);
        resetNavProfileAvatarUI();
        closeProfileMenu();
        closeTeamManager();
        showAuthStatus(loginStatus, 'ออกจากระบบเรียบร้อย', 'info');
    }

    function initializeAuthSection() {
        if (authSignupForm) {
            authSignupForm.addEventListener('submit', handleSignupSubmit);
        }
        if (signupUsernameInput) {
            signupUsernameInput.addEventListener('input', requestSignupAvailabilityCheck);
        }
        if (signupEmailInput) {
            signupEmailInput.addEventListener('input', requestSignupAvailabilityCheck);
        }
        if (authLoginForm) {
            authLoginForm.addEventListener('submit', handleLoginSubmit);
        }
        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout);
        }
        if (toggleSignupFormBtn) {
            toggleSignupFormBtn.addEventListener('click', toggleSignupFormVisibility);
            setSignupFormVisibility(false);
        }
        resetSignupAvailabilityState();
        updateAuthUI();
        updateRegistrationAccess();
    }
    function isActivityClosed(activity) {
        if (!activity) return false;
        const maxTeams = typeof activity.maxTeams === 'number' && activity.maxTeams > 0 ? activity.maxTeams : null;
        const remaining = calculateRemainingTeams(activity);
        const limitReached = maxTeams !== null ? remaining <= 0 : false;
        const deadlineIso = activity.registrationDeadline || null;
        const deadlinePassed = activity.deadlinePassed !== undefined
            ? activity.deadlinePassed
            : (deadlineIso ? Date.now() > new Date(deadlineIso).getTime() : false);
        return Boolean(activity.isClosed) || limitReached || deadlinePassed;
    }
    function setSubmitButtonState(disabled) {
        if (!submitButton) return;
        const effectiveDisabled = disabled || (registrationFieldset && registrationFieldset.disabled);
        submitButton.disabled = effectiveDisabled;
        if (effectiveDisabled) {
            submitButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
            submitButton.classList.add('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
        } else {
            submitButton.classList.remove('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
            submitButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
        }
    }
    function validateStep(stepNumber) {
        const stepIndex = stepNumber - 1;
        if (!formSteps[stepIndex]) return true;
        const inputs = formSteps[stepIndex].querySelectorAll('input, select, textarea');
        for (const input of inputs) {
            if (input.hasAttribute('required') && !input.checkValidity()) {
                const label = input.id ? form.querySelector(`label[for="${input.id}"]`) : null;
                const fieldName = label ? label.textContent.replace('*', '').trim() : (input.getAttribute('placeholder') || input.name || 'ช่องนี้');
                input.classList.add('ring-2', 'ring-red-300', 'border-red-400');
                const removeError = () => {
                    input.classList.remove('ring-2', 'ring-red-300', 'border-red-400');
                    input.removeEventListener('input', removeError);
                    input.removeEventListener('change', removeError);
                };
                input.addEventListener('input', removeError);
                input.addEventListener('change', removeError);
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบ',
                    text: `กรุณากรอก ${fieldName} ให้ครบถ้วน`
                }).then(() => input.focus());
                return false;
            }
        }
        return true;
    }
    function escapeHtmlClient(value) {
        if (value === null || value === undefined) return '';
        return value.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function buildClassLevelControlHtml(type, index, selectedValue = '', { disabled = false, scope = 'form', managedIndex = null } = {}) {
        const normalized = selectedValue ? selectedValue.toString() : '';
        const isCustom = normalized && !CLASS_LEVEL_OPTIONS.includes(normalized);
        const selectOptions = CLASS_LEVEL_OPTIONS.map(level => {
            const sel = level === normalized ? 'selected' : '';
            return `<option value="${level}" ${sel}>${level}</option>`;
        }).join('');
        const selectDisabled = disabled ? 'disabled' : '';
        const customDisabled = disabled || !isCustom ? 'disabled' : '';
        const customClasses = isCustom ? '' : 'hidden';
        const customValue = isCustom ? escapeHtmlClient(normalized) : '';
        const managedAttr = managedIndex !== null ? ` data-managed-index="${managedIndex}"` : '';
        return `
            <div class="space-y-2" data-class-select-wrapper="${type}-${index}-${scope}">
                <select
                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-sky-500"
                    data-class-level-select="true"
                    data-member-type="${type}"
                    data-member-index="${index}"
                    data-class-scope="${scope}"
                    ${managedAttr}
                    ${selectDisabled}
                    required
                >
                    <option value="">เลือกระดับชั้น</option>
                    ${selectOptions}
                    <option value="custom" ${isCustom ? 'selected' : ''}>อื่นๆ (พิมพ์เอง)</option>
                </select>
                <input type="text"
                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-xs ${customClasses}"
                    data-class-level-custom="true"
                    data-member-type="${type}"
                    data-member-index="${index}"
                    data-class-scope="${scope}"
                    ${managedAttr}
                    placeholder="ระบุระดับ/ห้อง"
                    value="${customValue}"
                    ${customDisabled}
                >
            </div>
        `;
    }
    function getSelectedClassLevelValue(type, index, scope = 'form') {
        const select = document.querySelector(`[data-class-level-select="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
        if (!select) return '';
        if (select.value === 'custom') {
            const customInput = document.querySelector(`[data-class-level-custom="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
            return (customInput?.value || '').trim();
        }
        return (select.value || '').trim();
    }
    function toggleClassLevelCustomInput(select) {
        if (!select) return;
        const type = select.dataset.memberType || 'student';
        const index = select.dataset.memberIndex || '1';
        const scope = select.dataset.classScope || 'form';
        const customInput = document.querySelector(`[data-class-level-custom="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
        if (!customInput) return;
        const isCustom = select.value === 'custom';
        customInput.classList.toggle('hidden', !isCustom);
        customInput.disabled = (!isCustom) || select.disabled;
        customInput.required = isCustom && !select.disabled;
        if (!isCustom) {
            customInput.value = '';
        } else {
            customInput.focus();
        }
    }
    function generateMemberKey(type) {
        return `${type}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 7)}`;
    }
    function ensureMemberKey(member, type) {
        if (!member) return generateMemberKey(type);
        if (!member._key) {
            member._key = generateMemberKey(type);
        }
        return member._key;
    }
    function getManagedMemberPreviewUrl(memberKey, fallbackUrl = '') {
        const pending = TEAM_MANAGE_MEMBER_PHOTO_DATA[memberKey];
        if (pending && pending.dataUrl) {
            return pending.dataUrl;
        }
        return fallbackUrl;
    }
    function sanitizeDigits(value) {
        return (value || '').toString().replace(/\D+/g, '');
    }
    function formatDisplayPhone(value) {
        const raw = (value || '').toString().trim();
        if (!raw) return '';
        if (/^\d+$/.test(raw)) {
            if (raw.startsWith('0')) return raw;
            if (raw.length === 9) return '0' + raw;
        }
        return raw;
    }
    function handleNumericInputEvent(event) {
        const target = event.target;
        if (target && target.dataset && target.dataset.onlyDigits === 'true') {
            const cleaned = sanitizeDigits(target.value);
            if (target.value !== cleaned) {
                target.value = cleaned;
                const len = cleaned.length;
                try {
                    target.setSelectionRange(len, len);
                } catch (err) {
                    /* ignore */
                }
            }
        }
    }
    function getOpenActivities() {
        return ALL_ACTIVITIES.filter(a => !isActivityClosed(a));
    }
    function getAllCategories(activities = ALL_ACTIVITIES) {
        if (!Array.isArray(activities)) return [];
        const set = new Set();
        activities.forEach(a => { if (a && a.category) set.add(a.category); });
        return Array.from(set).sort((a, b) => a.localeCompare(b, 'th'));
    }

    // --- Home cards ---
    function renderHomeActivityCards(activities) {
        if (!homeActivityContainer) return;
        if (!activities || activities.length === 0) {
            homeActivityContainer.innerHTML = '';
            return;
        }
        const canEditActivity = canEditActivities();
        const cardsHtml = activities.map(act => {
            const levels = Array.isArray(act.levels) ? act.levels : [];
            const levelsHtml = levels.map(l => `<span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${l}</span>`).join(' ');
            const remainingTeams = calculateRemainingTeams(act);
            const hasLimit = typeof act.maxTeams === 'number' && act.maxTeams > 0;
            const availabilityText = hasLimit
                ? `เหลือ ${typeof remainingTeams === 'number' ? Math.max(remainingTeams, 0) : 0} ทีม จาก ${act.maxTeams}`
                : 'ไม่จำกัดทีม';
            const deadlineText = formatDeadline(act.registrationDeadline, 'ไม่ระบุ');
            const currentTeams = act.currentTeams || 0;
            const categoryLabel = act.category || 'ไม่ระบุหมวดหมู่';
            const isClosed = isActivityClosed(act);
            const statusClass = isClosed
                ? 'text-rose-600 bg-rose-50 border border-rose-200'
                : 'text-emerald-600 bg-emerald-50 border border-emerald-200';
            const statusText = isClosed ? 'ปิดรับสมัคร' : 'เปิดรับสมัคร';
            const statusBadge = `<span class="inline-flex items-center text-xs font-semibold px-2.5 py-1 rounded-full border ${statusClass}">${statusText}</span>`;
            const actionButton = isClosed
                ? `<button type="button" class="w-full bg-slate-200 text-slate-500 font-semibold px-4 py-2 rounded-lg border border-slate-200 cursor-not-allowed" disabled>ปิดรับสมัครแล้ว</button>`
                : `<button type="button" class="w-full bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-sky-600 transition-colors" onclick="selectActivityForForm('${act.id}')">เลือกกิจกรรม</button>`;
            const closingHint = isClosed && deadlineText
                ? `<p class="text-xs text-rose-500">สิ้นสุดเมื่อ ${deadlineText}</p>`
                : '';
            const showCountdown = !isClosed && act.registrationDeadline && isDeadlineApproaching(act.registrationDeadline);
            const countdownHtml = showCountdown
                ? `<div class="flex items-center gap-1 text-xs font-semibold text-rose-600" data-deadline-countdown data-activity-id="${act.id}" data-deadline="${act.registrationDeadline}">
                        <span class="material-symbols-outlined text-base">hourglass_bottom</span>
                        <span>กำลังนับเวลา...</span>
                   </div>`
                : '';
            const adminActions = canEditActivity
                ? `<button type="button"
                        class="w-full border border-slate-200 text-slate-600 font-semibold px-4 py-2 rounded-lg hover:bg-white transition-colors mt-2"
                        onclick="openActivityEditDialog('${act.id}')">
                        <span class="inline-flex items-center gap-1 justify-center">
                            <span class="material-symbols-outlined text-base">edit</span>
                            แก้ไขกิจกรรม
                        </span>
                   </button>`
                : '';
            return `
                <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col h-full">
                    <div class="p-5 space-y-4 flex-1">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-900 leading-tight">${act.name}</h3>
                                <p class="text-sm text-slate-500">${categoryLabel}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="flex flex-wrap gap-2">${levelsHtml}</div>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><span class="font-medium text-slate-700">รูปแบบ:</span> ${act.mode || '-'}</p>
                            <p><span class="font-medium text-slate-700">โควต้า:</span> ${availabilityText}</p>
                            <p><span class="font-medium text-slate-700">ส่งแล้ว:</span> ${currentTeams}</p>
                            <p><span class="font-medium text-slate-700">ปิดรับสมัคร:</span> ${deadlineText}</p>
                            ${closingHint}
                            ${countdownHtml}
                        </div>
                    </div>
                    <div class="border-t border-slate-200 bg-slate-50 p-4">
                        <div class="space-y-2">
                            ${actionButton}
                            ${adminActions}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        homeActivityContainer.innerHTML = cardsHtml;
        initHomeDeadlineCountdowns();
    }

    function isDeadlineApproaching(deadlineIso, thresholdHours = DEADLINE_WARNING_HOURS) {
        if (!deadlineIso) return false;
        const target = new Date(deadlineIso).getTime();
        if (isNaN(target)) return false;
        const now = Date.now();
        if (target <= now) return false;
        const hoursDiff = (target - now) / (1000 * 60 * 60);
        return hoursDiff <= thresholdHours;
    }

    function formatDuration(durationMs) {
        if (!durationMs || durationMs <= 0) return '0 ชม.';
        const totalSeconds = Math.floor(durationMs / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        if (days > 0) {
            return `${days} วัน ${hours} ชม.`;
        }
        if (hours > 0) {
            return `${hours} ชม. ${minutes} นาที`;
        }
        return `${minutes} นาที`;
    }

    function initHomeDeadlineCountdowns() {
        if (!homeActivityContainer) return;
        homeCountdownElements = Array.from(homeActivityContainer.querySelectorAll('[data-deadline-countdown]'));
        if (!homeCountdownElements.length) {
            stopHomeCountdownInterval();
            return;
        }
        updateHomeCountdownElements();
        if (!homeCountdownInterval) {
            homeCountdownInterval = setInterval(updateHomeCountdownElements, 1000);
        }
    }

    function stopHomeCountdownInterval() {
        if (homeCountdownInterval) {
            clearInterval(homeCountdownInterval);
            homeCountdownInterval = null;
        }
    }

    function updateHomeCountdownElements() {
        if (!homeCountdownElements || homeCountdownElements.length === 0) {
            stopHomeCountdownInterval();
            return;
        }
        const now = Date.now();
        homeCountdownElements.forEach(el => {
            const deadline = el.dataset.deadline;
            if (!deadline) {
                el.classList.add('hidden');
                return;
            }
            const target = new Date(deadline).getTime();
            if (isNaN(target)) {
                el.classList.add('hidden');
                return;
            }
            const diff = target - now;
            if (diff <= 0) {
                el.classList.remove('text-rose-600');
                el.classList.add('text-slate-500');
                el.innerHTML = `<span class="material-symbols-outlined text-base">event_busy</span><span>ปิดรับสมัครแล้ว</span>`;
                return;
            }
            el.classList.remove('hidden');
            el.innerHTML = `<span class="material-symbols-outlined text-base">hourglass_bottom</span><span>เหลือเวลา ${formatDuration(diff)}</span>`;
        });
    }

    function updateHomeActivities({ resetVisibleCount = false } = {}) {
        if (!homeActivityContainer || !homeActivityMeta) return;
        if (resetVisibleCount) homeActivityState.visibleCount = homeActivityState.pageSize;

        const allowedSet = getAllowedActivityIdSet();
        let activities = Array.isArray(ALL_ACTIVITIES) ? [...ALL_ACTIVITIES] : [];
        if (allowedSet instanceof Set) {
            if (!allowedSet.size) {
                activities = [];
            } else {
                activities = activities.filter(act => allowedSet.has(normalizeText(act.id || '')));
            }
        }
        const searchTerm = (homeActivityState.search || '').trim().toLowerCase();
        const selectedCategory = (homeActivityState.category || '').trim();
        let filtered = activities;

        if (selectedCategory) {
            filtered = filtered.filter(a => (a.category || '').toLowerCase() === selectedCategory.toLowerCase());
        }
        if (searchTerm) {
            filtered = filtered.filter(act => {
                const levels = Array.isArray(act.levels) ? act.levels.join(' ') : '';
                const blob = [act.name || '', act.category || '', levels, act.mode || ''].join(' ').toLowerCase();
                return blob.includes(searchTerm);
            });
        }

        const totalCount = filtered.length;
        const openCount = filtered.filter(a => !isActivityClosed(a)).length;
        const closedCount = totalCount - openCount;

        const restrictedNoAssignments = allowedSet instanceof Set && allowedSet.size === 0;
        if (totalCount === 0) {
            if (restrictedNoAssignments) {
                homeActivityMeta.textContent = 'โรงเรียนของคุณยังไม่ได้รับมอบหมายกิจกรรมจาก Group Admin';
                renderHomeActivityCards([]);
                homeActivityLoadMoreBtn?.classList.add('hidden');
                homeActivityEmpty?.classList.remove('hidden');
                return;
            }
            const keyword = (homeActivityState.search || '').trim();
            const categorySuffix = selectedCategory ? `หมวด "${selectedCategory}"` : '';
            const keywordText = keyword ? `คำค้น "${keyword}"` : '';
            const extraText = [categorySuffix, keywordText].filter(Boolean).join(' ');
            const baseText = activities.length === 0
                ? 'ยังไม่มีกิจกรรมให้แสดง'
                : 'ไม่มีกิจกรรมที่ตรงเงื่อนไข';
            homeActivityMeta.textContent = `${baseText}${extraText ? ' | ' + extraText : ''}`;
            renderHomeActivityCards([]);
            homeActivityLoadMoreBtn?.classList.add('hidden');
            homeActivityEmpty?.classList.remove('hidden');
            return;
        }

        homeActivityEmpty?.classList.add('hidden');

        const sorted = filtered.slice().sort((a, b) => {
            const closedDiff = Number(isActivityClosed(a)) - Number(isActivityClosed(b));
            if (closedDiff !== 0) return closedDiff;
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB, 'th');
        });

        const itemsToRender = sorted.slice(0, homeActivityState.visibleCount);
        renderHomeActivityCards(itemsToRender);

        const summaryParts = [`ทั้งหมด ${totalCount} รายการ`, `เปิด ${openCount}`, `ปิด ${closedCount}`];
        const filterTags = [];
        if (selectedCategory) filterTags.push(`หมวด ${selectedCategory}`);
        if (homeActivityState.search) filterTags.push(`คำค้น "${homeActivityState.search.trim()}"`);
        const filterText = filterTags.length ? ` | ${filterTags.join(' ? ')}` : '';
        homeActivityMeta.textContent = `พบกิจกรรม ${summaryParts.join(' / ')}${filterText}`;

        if (homeActivityLoadMoreBtn) {
            if (sorted.length > itemsToRender.length) {
                homeActivityLoadMoreBtn.classList.remove('hidden');
            } else {
                homeActivityLoadMoreBtn.classList.add('hidden');
            }
        }
    }

    function openActivityEditDialog(activityId) {
        if (!canEditActivities()) return;
        const activity = ALL_ACTIVITIES.find(act => act.id === activityId);
        if (!activity) {
            Swal.fire({ icon: 'error', title: 'ไม่พบกิจกรรม', text: 'ไม่สามารถแก้ไขกิจกรรมนี้ได้' });
            return;
        }
        const levelsValue = Array.isArray(activity.levels) ? activity.levels.join(', ') : '';
        const deadlineValue = activity.registrationDeadline
            ? new Date(activity.registrationDeadline).toISOString().slice(0, 16)
            : '';
        Swal.fire({
            title: `แก้ไขกิจกรรม`,
            html: `
                <div class="space-y-3 text-left">
                    <label class="block text-xs font-medium text-slate-600">ชื่อกิจกรรม</label>
                    <input id="activity-edit-name" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.name || '')}" required>
                    <label class="block text-xs font-medium text-slate-600">หมวดหมู่</label>
                    <input id="activity-edit-category" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.category || '')}">
                    <label class="block text-xs font-medium text-slate-600">ระดับที่รับ (คั่นด้วย ,)</label>
                    <input id="activity-edit-levels" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(levelsValue)}" placeholder="เช่น ม.1, ม.2">
                    <label class="block text-xs font-medium text-slate-600">รูปแบบการจัด (ออนไลน์/ออนไซต์)</label>
                    <input id="activity-edit-mode" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.mode || '')}">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600">ครูที่ต้องการ</label>
                            <input id="activity-edit-req-teachers" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.reqTeachers || '')}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600">นักเรียนที่ต้องการ</label>
                            <input id="activity-edit-req-students" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.reqStudents || '')}">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600">จำนวนทีมสูงสุด</label>
                            <input id="activity-edit-max-teams" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.maxTeams ?? '')}" placeholder="0 = ไม่จำกัด">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600">ปิดรับสมัคร</label>
                            <input id="activity-edit-deadline" type="datetime-local" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${deadlineValue}">
                        </div>
                    </div>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            preConfirm: () => {
                const nameInput = document.getElementById('activity-edit-name');
                const reqTeacherInput = document.getElementById('activity-edit-req-teachers');
                const reqStudentInput = document.getElementById('activity-edit-req-students');
                if (!nameInput.value.trim()) {
                    Swal.showValidationMessage('กรุณากรอกชื่อกิจกรรม');
                    return false;
                }
                return {
                    id: activityId,
                    name: nameInput.value.trim(),
                    category: document.getElementById('activity-edit-category').value.trim(),
                    levels: document.getElementById('activity-edit-levels').value.split(',').map(v => v.trim()).filter(Boolean),
                    mode: document.getElementById('activity-edit-mode').value.trim(),
                    reqTeachers: reqTeacherInput.value,
                    reqStudents: reqStudentInput.value,
                    maxTeams: document.getElementById('activity-edit-max-teams').value,
                    registrationDeadline: document.getElementById('activity-edit-deadline').value
                };
            }
        }).then(result => {
            if (result.isConfirmed && result.value) {
                submitActivityEdit(result.value);
            }
        });
    }

    function submitActivityEdit(formData) {
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถแก้ไขกิจกรรมได้' });
            return;
        }
        Swal.fire({
            title: 'กำลังบันทึก...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        const payload = { ...formData, actor };
        google.script.run
            .withSuccessHandler(res => {
                Swal.close();
                if (res && res.success) {
                    Swal.fire({ icon: 'success', title: 'อัปเดตกิจกรรมสำเร็จ', timer: 1600, showConfirmButton: false });
                    loadInitialData(true);
                } else {
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: (res && res.error) || 'ไม่สามารถอัปเดตกิจกรรมได้' });
                }
            })
            .withFailureHandler(error => {
                Swal.close();
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: error.message || 'ไม่สามารถอัปเดตกิจกรรมได้' });
            })
            .updateActivityDetails(payload);
    }

    function handleHomeActivitySearchInput(e) {
        const value = e.target.value || '';
        if (homeSearchDebounce) clearTimeout(homeSearchDebounce);
        homeSearchDebounce = setTimeout(() => {
            homeActivityState.search = value;
            updateHomeActivities({ resetVisibleCount: true });
        }, 250);
    }
    function handleHomeActivityLoadMore() {
        homeActivityState.visibleCount += homeActivityState.pageSize;
        updateHomeActivities();
    }

    function handleHomeCategoryClick(e) {
        const { category } = e.currentTarget.dataset;
        homeActivityState.category = (homeActivityState.category === category) ? '' : category;
        updateHomeCategoryUI();
        updateHomeActivities({ resetVisibleCount: true });
    }

    function updateHomeCategoryUI() {
        if (!homeCategoryFilter) return;
        const buttons = homeCategoryFilter.querySelectorAll('button[data-category]');
        buttons.forEach(btn => {
            if (homeActivityState.category === btn.dataset.category) {
                btn.classList.add('bg-sky-500', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white', 'border-slate-300', 'text-slate-600');
            } else {
                btn.classList.remove('bg-sky-500', 'text-white', 'border-transparent');
                btn.classList.add('bg-white', 'border-slate-300', 'text-slate-600');
            }
        });
    }

    function renderHomeCategoryFilter(categories) {
        if (!homeCategoryFilter) return;
        if (!categories || categories.length === 0) {
            homeCategoryFilter.innerHTML = '';
            homeActivityState.category = '';
            return;
        }
        if (homeActivityState.category && !categories.includes(homeActivityState.category)) {
            homeActivityState.category = '';
        }
        const buttonsHtml = [
            `<button type="button" data-category="" class="px-3 py-1.5 text-sm font-medium rounded-full border bg-white border-slate-300 text-slate-600 hover:bg-slate-100 transition-colors">ทั้งหมด</button>`
        ].concat(categories.map(c =>
            `<button type="button" data-category="${c}" class="px-3 py-1.5 text-sm font-medium rounded-full border bg-white border-slate-300 text-slate-600 hover:bg-slate-100 transition-colors">${c}</button>`
        )).join('');
        homeCategoryFilter.innerHTML = buttonsHtml;
        homeCategoryFilter.querySelectorAll('button[data-category]').forEach(btn => {
            btn.addEventListener('click', handleHomeCategoryClick);
        });
        updateHomeCategoryUI();
    }

    // --- Activities Filter section ---
    function renderGroupedActivityCards(activities) {
        const container = activityContainer;
        const loading = activityLoading;
        if (!container || !loading) return;

        if (!Array.isArray(activities) || activities.length === 0) {
            loading.innerText = 'ไม่พบกิจกรรมที่ตรงกับเงื่อนไข';
            loading.style.display = 'block';
            container.innerHTML = '';
            return;
        }

        loading.style.display = 'none';
        const grouped = activities.reduce((acc, act) => {
            const cat = act.category || 'ไม่ระบุหมวดหมู่';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(act);
            return acc;
        }, {});

        let html = '';
        for (const category of Object.keys(grouped).sort()) {
            html += `<h2 class="text-2xl font-bold mb-3 px-2 mt-6 text-slate-800">${category}</h2>`;
            html += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">`;
            grouped[category].forEach(act => {
                const levels = Array.isArray(act.levels) ? act.levels : [];
                const levelsHtml = levels.map(l => `<span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${l}</span>`).join(' ');
                const isClosed = isActivityClosed(act);
                const canSelect = canCurrentUserSelectActivity(act.id);
                const remainingTeams = calculateRemainingTeams(act);
                const hasLimit = typeof act.maxTeams === 'number' && act.maxTeams > 0;
                const limitText = hasLimit
                    ? `รับ ${act.maxTeams} ทีม (เหลือ ${typeof remainingTeams === 'number' ? remainingTeams : '-'} ทีม)`
                    : 'ไม่จำกัดทีม';
                const deadlineText = formatDeadline(act.registrationDeadline);
                const statusBadge = isClosed
                    ? '<span class="inline-flex items-center text-xs font-semibold text-rose-600 bg-rose-100 px-3 py-1 rounded-full">ปิดรับสมัคร</span>'
                    : '<span class="inline-flex items-center text-xs font-semibold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">เปิดรับสมัคร</span>';
                const buttonClasses = (isClosed || !canSelect)
                    ? 'w-full bg-slate-300 text-slate-500 font-semibold px-5 py-2 rounded-lg shadow-sm cursor-not-allowed'
                    : 'w-full bg-sky-500 text-white font-semibold px-5 py-2 rounded-lg shadow-sm hover:bg-sky-600 transition-colors';
                const buttonAction = (isClosed || !canSelect) ? '' : `onclick="selectActivityForForm('${act.id}')"`;
                const buttonDisabled = (isClosed || !canSelect) ? 'disabled' : '';
                const buttonLabel = isClosed ? 'ปิดรับสมัคร' : (canSelect ? 'สมัครทีม' : 'รอการมอบหมาย');
                const currentTeamsText = `ทีมที่ลงแล้ว: ${act.currentTeams || 0}`;
                const restrictionNote = (!isClosed && !canSelect)
                    ? '<p class="mt-2 text-xs text-amber-600 text-center">โรงเรียนของคุณต้องรอ Group Admin กำหนดกิจกรรม</p>'
                    : '';
                html += `
                    <div class="activity-card bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden flex flex-col">
                        <div class="p-5 flex-grow space-y-3">
                            <div class="flex items-center justify-between gap-2">
                                <h3 class="text-xl font-bold text-slate-900">${act.name}</h3>
                                ${statusBadge}
                            </div>
                            <div class="flex flex-wrap gap-2">${levelsHtml}</div>
                            <div class="text-sm font-semibold ${act.mode === 'Onsite' ? 'text-blue-600' : 'text-purple-600'}">${act.mode}</div>
                            <div class="text-sm text-slate-600 space-y-1">
                                <p><span class="font-medium text-slate-700">จำนวนทีม:</span> ${limitText}</p>
                                <p><span class="font-medium text-slate-700">ปิดรับสมัคร:</span> ${deadlineText}</p>
                                <p><span class="font-medium text-slate-700">${currentTeamsText}</span></p>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4">
                            <button class="${buttonClasses}" ${buttonAction} ${buttonDisabled}>${buttonLabel}</button>
                            ${restrictionNote}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        container.innerHTML = html;
    }

    function populateActivityFilters(activities) {
        const categorySelect = document.getElementById('filter-category');
        const nameSelect = document.getElementById('filter-activity-name');
        const previousCategory = categorySelect.value;
        const previousName = nameSelect.value;

        categorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่กิจกรรม --</option>';
        nameSelect.innerHTML = '<option value="">-- เลือกกิจกรรม --</option>';

        const categories = [...new Set(activities.map(a => a.category))].filter(Boolean);
        categories.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
        activities.forEach(act => nameSelect.innerHTML += `<option value="${act.name}">${act.name}</option>`);

        if (!categorySelect.dataset.initialized) {
            categorySelect.addEventListener('change', updateActivityView);
            categorySelect.dataset.initialized = 'true';
        }
        if (!nameSelect.dataset.initialized) {
            nameSelect.addEventListener('change', updateActivityView);
            nameSelect.dataset.initialized = 'true';
        }

        if (previousCategory && categories.includes(previousCategory)) categorySelect.value = previousCategory;
        if (previousName && activities.some(a => a.name === previousName)) nameSelect.value = previousName;
    }

    function updateActivityView() {
        const catFilter = document.getElementById('filter-category').value;
        const nameFilter = document.getElementById('filter-activity-name').value;
        let filtered = ALL_ACTIVITIES;
        if (catFilter) filtered = filtered.filter(a => a.category === catFilter);
        if (nameFilter) filtered = filtered.filter(a => a.name === nameFilter);
        renderGroupedActivityCards(filtered);
    }

    function populateFormActivitySelect(activities) {
        activitySelect.innerHTML = '<option value="">-- เลือกกิจกรรม --</option>';
        activitySelect.disabled = activities.length === 0;
        activities.forEach(act => {
            const closed = isActivityClosed(act);
            const labelSuffix = closed ? ' - ปิดรับสมัคร' : '';
            const categoryLabel = act.category || 'ไม่ระบุหมวดหมู่';
            activitySelect.innerHTML += `<option value="${act.id}" data-closed="${closed}">${act.name} (${categoryLabel})${labelSuffix}</option>`;
        });
    }

    function populateFormCategorySelect(categories) {
        if (!activityCategorySelect) return;
        const prev = activityCategorySelect.value;
        activityCategorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
        categories.forEach(c => activityCategorySelect.innerHTML += `<option value="${c}">${c}</option>`);
        if (prev && categories.includes(prev)) activityCategorySelect.value = prev;
        else activityCategorySelect.value = '';
    }

    function refreshActivityTeamCounts() {
        if (!Array.isArray(ALL_ACTIVITIES) || ALL_ACTIVITIES.length === 0) return;
        const prevId = activitySelect.value;
        const counts = {};
        ALL_TEAMS.forEach(t => {
            if (!t.activity) return;
            counts[t.activity] = (counts[t.activity] || 0) + 1;
        });
        ALL_ACTIVITIES = ALL_ACTIVITIES.map(activity => {
            const updated = { ...activity };
            const maxTeams = typeof updated.maxTeams === 'number' && updated.maxTeams > 0 ? updated.maxTeams : null;
            updated.currentTeams = counts[activity.id] || 0;
            if (maxTeams !== null) {
                updated.remainingTeams = Math.max(maxTeams - updated.currentTeams, 0);
                updated.isFull = updated.remainingTeams === 0;
            } else {
                updated.remainingTeams = null;
                updated.isFull = false;
            }
            const deadlineIso = updated.registrationDeadline || null;
            const deadlinePassed = deadlineIso ? Date.now() > new Date(deadlineIso).getTime() : !!updated.deadlinePassed;
            updated.deadlinePassed = deadlinePassed;
            updated.isClosed = updated.isFull || deadlinePassed;
            return updated;
        });

        const categories = getAllCategories(ALL_ACTIVITIES);
        populateFormCategorySelect(categories);
        renderHomeCategoryFilter(categories);
        const formActs = getFormActivities();
        populateFormActivitySelect(formActs);

        if (prevId) {
            const selected = ALL_ACTIVITIES.find(a => a.id === prevId);
            const still = formActs.some(a => a.id === prevId);
            if (selected && !isActivityClosed(selected) && still) {
                activitySelect.value = prevId;
            } else {
                activitySelect.value = '';
            }
        }

        updateFormBasedOnActivity(activitySelect.value || '');
        updateHomeActivities();
        updateActivityView();
        renderScoreAssignmentPanel();
    }

    function getStatusBadge(status) {
        if (status === 'Approved') {
            return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-green">Approved</span>';
        }
        if (status === 'Rejected') {
            return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-red">Rejected</span>';
        }
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-yellow">Pending</span>';
    }

    const ROLE_BADGE_STYLES = {
        admin: 'bg-rose-50 text-rose-700 border border-rose-200',
        area: 'bg-indigo-50 text-indigo-700 border border-indigo-200',
        group_admin: 'bg-amber-50 text-amber-700 border border-amber-200',
        school_admin: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
        score: 'bg-sky-50 text-sky-700 border border-sky-200',
        user: 'bg-slate-100 text-slate-600 border border-slate-200'
    };

    const ROLE_ROW_CLASS_MAP = {
        admin: 'user-role-row user-role-row--admin',
        area: 'user-role-row user-role-row--area',
        group_admin: 'user-role-row user-role-row--group',
        school_admin: 'user-role-row user-role-row--school',
        score: 'user-role-row user-role-row--score',
        user: 'user-role-row user-role-row--user'
    };

    function getRoleBadgeHtml(level) {
        const normalized = normalizeText(level || '');
        const style = ROLE_BADGE_STYLES[normalized] || ROLE_BADGE_STYLES.user;
        return `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${style}">
            ${escapeHtmlClient(getRoleDisplayName(level))}
        </span>`;
    }

    function getRoleRowClass(level) {
        const normalized = normalizeText(level || '');
        return ROLE_ROW_CLASS_MAP[normalized] || 'user-role-row user-role-row--default';
    }

    function isAreaStageActive() {
        return competitionStage === 'area';
    }

    function isTeamRepresentative(team) {
        if (!team) return false;
        const overrideFlag = normalizeBooleanFlagClient(team.representativeOverride);
        if (overrideFlag !== null) return overrideFlag;
        if (typeof team.isRepresentative === 'boolean') {
            return team.isRepresentative;
        }
        return false;
    }

    function isAreaTeam(team) {
        if (!team) return false;
        const teamStage = normalizeCompetitionStageClient(team.stage || '');
        if (teamStage === 'area') return true;
        return isTeamRepresentative(team);
    }

    function getStageFilteredTeams(teams = ALL_TEAMS) {
        if (!Array.isArray(teams)) return [];
        if (!isAreaStageActive()) return [...teams];
        return teams.filter(team => isAreaTeam(team));
    }

    function canManageScoreAssignments() {
        const level = getCurrentUserLevel();
        return Boolean(currentUser) && ['admin', 'area', 'group_admin'].includes(level);
    }
    function canManageJudgesClient() {
        const level = getCurrentUserLevel();
        return ['admin', 'area', 'group_admin'].includes(level);
    }

    function shouldShowReportUserSummary() {
        if (!currentUser) return false;
        const level = getCurrentUserLevel();
        return ['group_admin', 'admin', 'area'].includes(level);
    }

    function shouldUseScopedReportSummary() {
        if (!currentUser) return false;
        const level = getCurrentUserLevel();
        return !['admin', 'area'].includes(level);
    }

    function shouldRestrictClusterView() {
        return Boolean(currentUser) && !['admin', 'area'].includes(getCurrentUserLevel());
    }

    function getClusterFilterForDisplay() {
        if (!shouldRestrictClusterView()) return '';
        return getUserClusterForFilter() || '';
    }

    function matchesClusterKey(clusterKey, clusterLabel, filterKey) {
        if (!filterKey) return true;
        const normalizedKey = normalizeText(clusterKey || '');
        if (normalizedKey && normalizedKey === filterKey) return true;
        const normalizedLabel = normalizeText(clusterLabel || '');
        return normalizedLabel === filterKey;
    }

    function filterClustersForDisplay(clusters) {
        if (!Array.isArray(clusters)) return [];
        const filterKey = getClusterFilterForDisplay();
        if (!filterKey) return clusters;
        return clusters.filter(cluster =>
            matchesClusterKey(cluster.clusterKey || cluster.clusterId || '', cluster.clusterLabel, filterKey)
        );
    }

    function getClusterActivitySummaryDataset(report) {
        if (!report || !report.clusterActivitySummary) return [];
        const globalData = report.clusterActivitySummary.global;
        return Array.isArray(globalData) ? globalData : [];
    }

    function getClusterTotalsForDisplay(report, fallbackTotals) {
        if (!currentUser) return fallbackTotals;
        if (!report || !report.clusterActivitySummary) return fallbackTotals;
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) {
            return fallbackTotals;
        }
        const filterKey = getClusterFilterForDisplay();
        if (!filterKey) return fallbackTotals;
        const dataset = getClusterActivitySummaryDataset(report);
        if (!Array.isArray(dataset) || !dataset.length) return fallbackTotals;
        const target = dataset.find(entry =>
            matchesClusterKey(entry.clusterKey || entry.clusterId || '', entry.clusterLabel, filterKey)
        );
        if (!target || !target.totals) return fallbackTotals;
        const totals = target.totals;
        return {
            teams: totals.teams || 0,
            teachers: totals.teachers || 0,
            students: totals.students || 0,
            allMembers: totals.allMembers || ((totals.teachers || 0) + (totals.students || 0))
        };
    }

    function applyReportTotals(totals) {
        const safe = totals || { teams: 0, teachers: 0, students: 0, allMembers: 0 };
        document.getElementById('report-total-teams').innerText = safe.teams ?? 0;
        document.getElementById('report-total-teachers').innerText = safe.teachers ?? 0;
        document.getElementById('report-total-students').innerText = safe.students ?? 0;
        document.getElementById('report-total-all').innerText = (safe.allMembers ?? (safe.teachers + safe.students)) || 0;
        if (reportTotalsHint) {
            if (hasCompetitionStageInfo) {
                const copy = getStageCopy();
                reportTotalsHint.textContent = `${copy.totalsHint} • ทีม ${safe.teams ?? 0}`;
            } else {
                reportTotalsHint.textContent = 'กำลังโหลดข้อมูลภาพรวม...';
            }
        }
    }

    function getActivityInfoById(activityId) {
        if (!activityId) return null;
        const acts = Array.isArray(ALL_ACTIVITIES) ? ALL_ACTIVITIES : [];
        return acts.find(a => String(a.id).trim() === String(activityId).trim()) ||
            acts.find(a => String(a.name).trim() === String(activityId).trim()) ||
            null;
    }

    function getActivityLabel(activityId) {
        const info = getActivityInfoById(activityId);
        return info ? info.name || info.id || activityId : activityId;
    }

    // --- Team Photos helpers ---
    function buildDriveThumbUrl(fileId, size) {
        if (!fileId) return null;
        const s = size || 256;
        return 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(fileId) + '&sz=w' + s;
    }
    function getUserAvatarUrl(user, size = 128) {
        if (!user) return '';
        if (user.avatarFileId) return buildDriveThumbUrl(user.avatarFileId, size);
        if (user.avatarUrl) return user.avatarUrl;
        return '';
    }
    function getMemberPhotoUrl(member) {
        if (!member || typeof member !== 'object') return null;
        if (member.photoUrl) return member.photoUrl;
        if (member.photoURL) return member.photoURL;
        if (member.photoDriveId) return buildDriveThumbUrl(member.photoDriveId, 256);
        if (member.photoId) return buildDriveThumbUrl(member.photoId, 256);
        return null;
    }
    function renderMemberCard(member, index, labelPrefix) {
        const name = escapeHtmlClient(member.name || `${labelPrefix} ${index}`);
        const phoneValue = formatDisplayPhone(member.phone || member.tel || '');
        const phone = phoneValue ? escapeHtmlClient(phoneValue) : '';
        const cls = escapeHtmlClient(member.class || member.room || '');
        const role = escapeHtmlClient(member.role || '');
        const photoUrl = getMemberPhotoUrl(member);
        const photoBlock = photoUrl
            ? `<img src="${photoUrl}" alt="${name}" class="w-14 h-14 rounded-full object-cover border border-slate-200" loading="lazy">`
            : `<div class="w-14 h-14 rounded-full bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-400">
                    <span class="material-symbols-outlined text-base">person</span>
               </div>`;
        return `
            <div class="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                ${photoBlock}
                <div class="text-xs leading-snug">
                    <div class="font-semibold text-slate-800">${name}</div>
                    ${role ? `<div class="text-slate-500">${role}</div>` : ''}
                    ${cls ? `<div class="text-slate-500">ชั้น: ${cls}</div>` : ''}
                    ${phone ? `<div class="text-slate-500">โทร: ${phone}</div>` : ''}
                </div>
            </div>
        `;
    }

    // --- Modal: รูปทีม + รายละเอียดกิจกรรม/รูปประจำทีม ---
function openTeamPhotoModal(teamId) {
  const modal = document.getElementById('team-photo-modal');
  const content = document.getElementById('team-photo-modal-content');
  const titleEl = document.getElementById('team-photo-modal-title');
  const subtitleEl = document.getElementById('team-photo-modal-subtitle');
  if (!modal || !content) return;

  const team = (Array.isArray(ALL_TEAMS) ? ALL_TEAMS : []).find(t => t.teamId === teamId);
  if (!team) {
    Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูลทีม', text: 'ไม่พบทีมที่ต้องการแสดงข้อมูล' });
    return;
  }

  const activities = Array.isArray(ALL_ACTIVITIES) ? ALL_ACTIVITIES : [];
  const activityObj = activities.find(a => a.id === team.activity) || {};
  const activityName = activityObj.name || 'ไม่ระบุกิจกรรม';
  const category = activityObj.category || 'ไม่ระบุหมวดหมู่';

  const members = safeJsonParse(team.members, { teachers: [], students: [] }) || {};
  const teachers = Array.isArray(members.teachers) ? members.teachers : [];
  const students = Array.isArray(members.students) ? members.students : [];

  const people = [
    ...teachers.map((t, i) => ({
      type: 'ครูผู้ฝึกสอน',
      roleKey: 'teacher',
      typeIndex: i,
      prefix: t.prefix || '',
      name: t.name || '',
      school: team.school || '',
      raw: t
    })),
    ...students.map((s, i) => ({
      type: 'นักเรียน',
      roleKey: 'student',
      typeIndex: i,
      prefix: s.prefix || '',
      name: s.name || '',
      school: team.school || '',
      raw: s
    }))
  ].filter(p => (p.prefix || p.name));

  if (titleEl) {
    titleEl.textContent = 'บัตรประจำตัวเข้าแข่งขันดิจิทัล';
  }
  if (subtitleEl) {
    const infoLine = [
      team.teamId ? `รหัสทีม ${team.teamId}` : '',
      team.teamName ? `ทีม: ${team.teamName}` : '',
      team.school ? `สถานศึกษา: ${team.school}` : ''
    ].filter(Boolean).join(' • ');
    subtitleEl.textContent =
      `กิจกรรม: ${activityName} • หมวดหมู่: ${category}` +
      (infoLine ? ` • ${infoLine}` : '');
  }

  if (!people.length) {
    content.innerHTML = `
      <div class="w-full h-full flex flex-col items-center justify-center gap-2 text-slate-500">
        <div class="text-sm font-semibold text-slate-800">
          ยังไม่มีข้อมูลสมาชิกสำหรับทีมนี้
        </div>
        <div class="text-[10px] text-slate-500">
          กรุณาบันทึกรายชื่อครูผู้ฝึกสอนและนักเรียนในหน้าจัดการทีม
        </div>
      </div>
    `;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return;
  }

  const memberListHtml = people.map((p, idx) => {
    const fullName = `${p.prefix} ${p.name}`.trim() || '-';
    const safeName = escapeHtmlClient(fullName);
    const typeLabel = escapeHtmlClient(p.type);
    return `
      <div class="flex items-center gap-1.5">
        <button
          type="button"
          class="member-item flex-1 text-left px-3 py-2 rounded-lg border border-transparent
                 hover:border-sky-300 hover:bg-sky-50 hover:text-slate-900
                 text-[11px] text-slate-700
                 flex items-center justify-between gap-2"
          data-person-index="${idx}">
          <span class="truncate">${idx + 1}. ${safeName}</span>
          <span class="text-[9px] text-sky-500">${typeLabel}</span>
        </button>
        <button
          type="button"
          class="shrink-0 px-2 py-1 rounded-full border border-sky-500/50
                 bg-slate-900 text-sky-300 text-[8.5px] flex items-center gap-1"
          onclick="openMemberDigitalPass('${team.teamId}', '${p.roleKey}', ${p.typeIndex})">
          <span class="material-symbols-outlined text-[14px] leading-none">badge</span>
          <span>บัตรของฉัน</span>
        </button>
      </div>
    `;
  }).join('');

  content.innerHTML = `
    <div class="flex flex-col md:flex-row gap-4 h-full">
      <div class="w-full md:w-1/3 flex flex-col gap-2 border-r border-slate-100 pr-0 md:pr-2">
        <div class="text-[10px] font-semibold text-slate-600">
          รายชื่อสมาชิกในทีม
        </div>
        <div id="team-photo-member-list"
             class="flex flex-col gap-1.5 max-h-[60vh] overflow-y-auto no-scrollbar">
          ${memberListHtml}
        </div>
      </div>
      <div class="w-full md:w-2/3 flex items-center justify-center">
        <div id="team-photo-card"
             class="idcard-shell w-full max-w-md aspect-[5/3]">
        </div>
      </div>
    </div>
  `;

  const memberListEl = content.querySelector('#team-photo-member-list');
  const cardEl = content.querySelector('#team-photo-card');
  const buttons = memberListEl ? Array.from(memberListEl.querySelectorAll('.member-item')) : [];

  function setActiveButton(btn) {
    buttons.forEach(b => {
      b.classList.remove(
        'bg-sky-500',
        'text-white',
        'border-sky-500',
        'hover:bg-sky-600',
        'hover:text-white'
      );
    });
    if (btn) {
      btn.classList.add(
        'bg-sky-500',
        'text-white',
        'border-sky-500',
        'hover:bg-sky-600',
        'hover:text-white'
      );
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-person-index'), 10);
      const p = people[idx];
      const fullName = `${p.prefix} ${p.name}`.trim() || '-';

      const cardNumber = `${team.teamId || 'TEAM'}-${String(idx + 1).padStart(2, '0')}`;
      const qrPayload = `EVPASS|${team.teamId || ''}|${fullName}|${p.type}|${team.school || ''}|${activityName}|${cardNumber}`;
      const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + encodeURIComponent(qrPayload);

      const photoUrl = (typeof getMemberPhotoUrl === 'function')
        ? (getMemberPhotoUrl(p.raw) || '')
        : '';

      renderDigitalIdCard(cardEl, {
        fullName,
        roleLabel: p.type,
        teamName: team.teamName || '',
        schoolName: p.school || team.school || '',
        activityName,
        cardNumber,
        qrUrl,
        photoUrl
      });

      setActiveButton(btn);
    });
  });

  if (buttons.length > 0) {
    buttons[0].click();
  }

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}




function openMemberDigitalPass(teamId, memberType, memberIndex) {
  const modal = document.getElementById('personal-pass-modal');
  const cardEl = document.getElementById('personal-pass-card');
  const titleEl = document.getElementById('personal-pass-title');
  const subtitleEl = document.getElementById('personal-pass-subtitle');
  if (!modal || !cardEl) return;

  const team = (Array.isArray(ALL_TEAMS) ? ALL_TEAMS : []).find(t => t.teamId === teamId);
  if (!team) {
    Swal.fire({ icon: 'error', title: 'ไม่พบทีม', text: 'ไม่สามารถเปิดบัตรได้' });
    return;
  }

  const activityObj = (Array.isArray(ALL_ACTIVITIES) ? ALL_ACTIVITIES : []).find(a => a.id === team.activity) || {};
  const activityName = activityObj.name || 'ไม่ระบุกิจกรรม';
  const activityId = activityObj.id || '';

  const members = safeJsonParse(team.members, { teachers: [], students: [] }) || {};
  const teachers = Array.isArray(members.teachers) ? members.teachers : [];
  const students = Array.isArray(members.students) ? members.students : [];

  // รวมสมาชิกทั้งหมดในทีมตามลำดับ: ครู -> นักเรียน
  const ordered = [
    ...teachers.map((m, i) => ({
      memberType: 'teacher',
      memberTypeCode: 'T',
      index: i,
      roleLabel: 'ครูผู้ฝึกสอน',
      raw: m
    })),
    ...students.map((m, i) => ({
      memberType: 'student',
      memberTypeCode: 'S',
      index: i,
      roleLabel: 'นักเรียน',
      raw: m
    }))
  ];

  if (!ordered.length) {
    Swal.fire({ icon: 'warning', title: 'ยังไม่มีสมาชิก', text: 'ทีมนี้ยังไม่มีข้อมูลครูหรือนักเรียน' });
    return;
  }

  // หา index เริ่มต้นจาก args (memberType, memberIndex)
  let startIndex = ordered.findIndex(
    m => m.memberType === memberType && m.index === Number(memberIndex)
  );
  if (startIndex < 0) startIndex = 0;

  // เก็บ context ไว้ใช้ปัดซ้าย/ขวา
  PERSONAL_PASS_CTX = {
    team,
    activityObj,
    activityName,
    activityId,
    members: ordered,
    activeIndex: startIndex
  };

  if (titleEl) {
    titleEl.textContent = 'บัตรประจำตัวเข้าแข่งขันของฉัน';
  }
  if (subtitleEl) {
    subtitleEl.textContent = `${activityName} • ทีม: ${team.teamName || '-'} • ${team.school || ''}`;
  }

  // render ครั้งแรก
  renderPersonalPassAtIndex(cardEl, PERSONAL_PASS_CTX, startIndex);

  // ติด swipe (เขียนแบบ override handler เดิมทุกครั้ง ป้องกันซ้อน)
  attachPersonalPassSwipe(cardEl);

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function renderPersonalPassAtIndex(cardEl, ctx, index) {
  if (!ctx || !ctx.members || !ctx.members[index]) return;

  ctx.activeIndex = index;
  const { team, activityName, activityId, members } = ctx;
  const m = members[index];
  const raw = m.raw || {};

  const fullName = `${raw.prefix || ''} ${raw.name || ''}`.trim() || '-';

  const cardNumber = `${team.teamId || 'TEAM'}-${m.memberTypeCode}${String(m.index + 1).padStart(2, '0')}`;

  // หาเบอร์โทรจากข้อมูลที่พอเป็นไปได้
  const phone =
    raw.phone ||
    raw.tel ||
    raw.mobile ||
    raw.phoneNumber ||
    (raw.contact && (raw.contact.phone || raw.contact.tel || raw.contact.mobile)) ||
    '';

  // payload QR สำหรับเช็คอิน
  // EVCHK|1|TEAM_ID|ACTIVITY_ID|TYPE|INDEX|CARD_NO
  const qrPayload = [
    'EVCHK',
    '1',
    team.teamId || '',
    activityId || '',
    m.memberTypeCode,
    (m.index + 1),
    cardNumber
  ].join('|');

  const qrUrl =
    'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' +
    encodeURIComponent(qrPayload);

  const photoUrl = (typeof getMemberPhotoUrl === 'function')
    ? (getMemberPhotoUrl(raw) || '')
    : '';

  // ใส่ animation class ทุกครั้งที่เปลี่ยนคน
  cardEl.classList.remove('personal-pass-anim');
  void cardEl.offsetWidth; // force reflow
  cardEl.classList.add('personal-pass-anim');

  renderPersonalIdCard(cardEl, {
    fullName,
    roleLabel: m.roleLabel,
    teamName: team.teamName || '',
    schoolName: team.school || '',
    activityName,
    cardNumber,
    qrUrl,
    photoUrl,
    phone
  });
}

function showNextPersonalPass() {
  if (!PERSONAL_PASS_CTX || !PERSONAL_PASS_CTX.members) return;
  const { members, activeIndex } = PERSONAL_PASS_CTX;
  if (!members.length) return;
  const nextIndex = (activeIndex + 1) % members.length;
  const cardEl = document.getElementById('personal-pass-card');
  if (!cardEl) return;
  renderPersonalPassAtIndex(cardEl, PERSONAL_PASS_CTX, nextIndex);
}

function showPrevPersonalPass() {
  if (!PERSONAL_PASS_CTX || !PERSONAL_PASS_CTX.members) return;
  const { members, activeIndex } = PERSONAL_PASS_CTX;
  if (!members.length) return;
  const prevIndex = (activeIndex - 1 + members.length) % members.length;
  const cardEl = document.getElementById('personal-pass-card');
  if (!cardEl) return;
  renderPersonalPassAtIndex(cardEl, PERSONAL_PASS_CTX, prevIndex);
}

function attachPersonalPassSwipe(cardEl) {
  if (!cardEl) return;

  let startX = null;
  const threshold = 40;

  // touch
  cardEl.ontouchstart = (e) => {
    if (!e.changedTouches || !e.changedTouches[0]) return;
    startX = e.changedTouches[0].clientX;
  };
  cardEl.ontouchend = (e) => {
    if (startX === null || !e.changedTouches || !e.changedTouches[0]) return;
    const dx = e.changedTouches[0].clientX - startX;
    startX = null;
    if (Math.abs(dx) > threshold) {
      if (dx < 0) {
        showNextPersonalPass(); // ปัดซ้าย -> คนถัดไป
      } else {
        showPrevPersonalPass(); // ปัดขวา -> คนก่อนหน้า
      }
    }
  };

  // mouse (เผื่อใช้บน desktop)
  let mouseDownX = null;
  cardEl.onmousedown = (e) => {
    mouseDownX = e.clientX;
  };
  cardEl.onmouseup = (e) => {
    if (mouseDownX === null) return;
    const dx = e.clientX - mouseDownX;
    mouseDownX = null;
    if (Math.abs(dx) > threshold) {
      if (dx < 0) {
        showNextPersonalPass();
      } else {
        showPrevPersonalPass();
      }
    }
  };
}


function closePersonalPassModal() {
  const modal = document.getElementById('personal-pass-modal');
  if (!modal) return;
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function toggleAddToHomeGuide() {
  const box = document.getElementById('add-to-home-guide');
  if (!box) return;
  box.classList.toggle('hidden');
}






// บัตรแนวนอน (Panel ขวาใน Team Modal) - ใช้ธีมเข้ม ดิจิทัล
function renderDigitalIdCard(container, opts) {
  if (!container) return;

  const {
    fullName = '-',
    roleLabel = '-',
    teamName = '',
    schoolName = '',
    activityName = '',
    cardNumber = '',
    qrUrl = '',
    photoUrl = ''
  } = opts || {};

  const initials = (fullName || '-')
    .split(' ')
    .filter(Boolean)
    .map(w => w[0])
    .join('')
    .slice(0, 2)
    .toUpperCase();

  container.innerHTML = `
    <div class="idcard-wrapper relative w-full h-full rounded-2xl overflow-hidden
                bg-slate-900 text-slate-50 shadow-xl">

      <div class="absolute inset-0 pointer-events-none"
           style="
             background:
               radial-gradient(circle at top left, rgba(56,189,248,0.32), transparent),
               radial-gradient(circle at bottom right, rgba(14,165,233,0.22), transparent);
           ">
      </div>

      <div class="absolute inset-0 opacity-[0.08] pointer-events-none"
           style="
             background-image:
               linear-gradient(to right, #38bdf8 1px, transparent 1px),
               linear-gradient(to bottom, #38bdf8 1px, transparent 1px);
             background-size: 46px 46px;
           ">
      </div>

      <div class="relative z-10 flex flex-col h-full px-4 py-3">

        <div class="flex items-start justify-between gap-2 text-[8px]">
          <div class="flex flex-col gap-0.5">
            <div class="uppercase tracking-[0.18em] text-sky-300">
              digital entry pass
            </div>
            <div class="text-[8px] text-slate-300 truncate max-w-[70vw] md:max-w-[180px]">
              ${escapeHtmlClient(activityName || '')}
            </div>
          </div>
          <div class="text-right text-[7px] text-slate-300">
            <div>Card No.</div>
            <div class="text-[9px] font-semibold text-sky-300">
              ${escapeHtmlClient(cardNumber || '-')}
            </div>
          </div>
        </div>

        <div class="flex-1 flex items-center gap-3 mt-2 mb-1">

          <!-- รูป / Initial -->
          <div class="flex items-center justify-center">
            <div class="w-12 h-12 md:w-16 md:h-16 rounded-2xl bg-slate-900/80 border border-sky-400/60
                        flex items-center justify-center overflow-hidden shadow-md">
              ${
                photoUrl
                  ? `<img src="${photoUrl}" alt="photo"
                           class="w-full h-full object-cover" referrerpolicy="no-referrer">`
                  : `<div class="w-full h-full flex items-center justify-center
                               bg-gradient-to-br from-sky-500/50 to-cyan-400/40
                               text-[16px] md:text-[18px] font-semibold text-sky-50">
                       ${escapeHtmlClient(initials || '?')}
                     </div>`
              }
            </div>
          </div>

          <!-- ข้อมูล -->
          <div class="flex-1 flex flex-col gap-0.5">
            <div class="text-[8px] text-slate-300">ชื่อ - นามสกุล</div>
            <div class="text-[14px] md:text-[16px] font-semibold text-sky-50 leading-tight">
              ${escapeHtmlClient(fullName)}
            </div>

            <div class="grid grid-cols-2 gap-1 mt-1 text-[7.5px] text-slate-300">
              <div>
                <div class="text-slate-400">บทบาท</div>
                <div class="font-medium text-sky-300">
                  ${escapeHtmlClient(roleLabel)}
                </div>
              </div>
              <div>
                <div class="text-slate-400">ทีม</div>
                <div class="font-medium text-sky-200 truncate">
                  ${escapeHtmlClient(teamName || '-')}
                </div>
              </div>
            </div>

            <div class="mt-1 text-[7.5px] text-slate-300">
              สถานศึกษา:
              <span class="text-sky-100 font-medium">
                ${escapeHtmlClient(schoolName || '-')}
              </span>
            </div>
          </div>

          <!-- QR -->
          <div class="flex flex-col items-center justify-center gap-0.5">
            <div class="w-12 h-12 md:w-14 md:h-14 rounded-xl bg-slate-900/90 border border-sky-400/60
                        flex items-center justify-center overflow-hidden">
              ${
                qrUrl
                  ? `<img src="${qrUrl}" alt="QR Code" class="w-full h-full object-contain">`
                  : ''
              }
            </div>
            <div class="text-[6.5px] text-sky-300 uppercase tracking-wide">
              verify
            </div>
          </div>

        </div>

        <div class="mt-auto flex items-center justify-between text-[6.5px] text-slate-400">
          <div class="flex items-center gap-1">
            <span class="inline-block w-1.5 h-1.5 rounded-full bg-sky-400"></span>
            <span>แบบลงทะเบียนรายงานตัว</span>
          </div>
          <div class="text-[6.5px] text-slate-500">
            สำหรับใช้ตรวจสอบตัวตนในวันแข่งขัน
          </div>
        </div>

      </div>
    </div>
  `;
}




function renderPersonalIdCard(container, opts) {
  if (!container) return;

  const {
    fullName = '-',
    roleLabel = '-',
    teamName = '',
    schoolName = '',
    activityName = '',
    cardNumber = '',
    qrUrl = '',
    photoUrl = '',
    phone = ''
  } = opts || {};

  const initials = (fullName || '-')
    .split(' ')
    .filter(Boolean)
    .map(w => w[0])
    .join('')
    .slice(0, 2)
    .toUpperCase();

  const rawPhone = String(phone || '').trim();
  const cleanedPhone = rawPhone.replace(/[^\d+]/g, '');
  const telHref = cleanedPhone ? `tel:${cleanedPhone}` : '';
  const phoneDisplay = rawPhone || '';

  container.innerHTML = `
    <div class="personal-pass-card relative w-full h-full rounded-3xl overflow-hidden
                bg-slate-900 text-slate-50 shadow-2xl flex flex-col">

      <!-- แสงพื้นหลัง -->
      <div class="absolute inset-0 pointer-events-none"
           style="
             background:
               radial-gradient(circle at top, rgba(56,189,248,0.32), transparent),
               radial-gradient(circle at bottom, rgba(14,165,233,0.18), transparent);
           ">
      </div>

      <!-- ลายกริด -->
      <div class="absolute inset-0 opacity-[0.06] pointer-events-none"
           style="
             background-image:
               linear-gradient(to right, #38bdf8 1px, transparent 1px),
               linear-gradient(to bottom, #38bdf8 1px, transparent 1px);
             background-size: 40px 40px;
           ">
      </div>

      <!-- เนื้อหาการ์ด -->
      <div class="relative z-10 flex flex-col h-full px-4 pt-3 pb-3 leading-relaxed">

        <!-- Header -->
        <div class="flex items-start justify-between gap-3">
          <div class="flex flex-col gap-0.5">
            <div class="text-[9px] uppercase tracking-[0.18em] text-sky-300">
              digital entry pass
            </div>
            <div class="text-[9px] text-slate-300 leading-snug line-clamp-2">
              ${escapeHtmlClient(activityName || '')}
            </div>
          </div>
          <div class="text-right text-[8px] text-slate-300 leading-snug">
            <div>Card No.</div>
            <div class="text-[10px] font-semibold text-sky-300">
              ${escapeHtmlClient(cardNumber || '-')}
            </div>
          </div>
        </div>

        <!-- รูป: ใหญ่ขึ้นอีกขั้น (เด่นกว่าทุกอย่าง และใหญ่กว่า QR ชัดเจน) -->
        <div class="mt-3 flex justify-center">
          <div class="w-44 h-44 md:w-48 md:h-48 rounded-3xl bg-slate-900/95 border border-sky-400/80
                      flex items-center justify-center overflow-hidden
                      shadow-[0_14px_40px_rgba(15,23,42,0.8)]">
            ${
              photoUrl
                ? `<img src="${photoUrl}" alt="photo"
                         class="w-full h-full object-cover" referrerpolicy="no-referrer">`
                : `<div class="w-full h-full flex items-center justify-center
                             bg-gradient-to-br from-sky-500/70 to-cyan-400/50
                             text-[34px] md:text-[40px] font-semibold text-sky-50">
                     ${escapeHtmlClient(initials || '?')}
                   </div>`
            }
          </div>
        </div>

        <!-- ชื่อ + บทบาท -->
        <div class="mt-2.5 text-center">
          <div class="text-[10px] text-slate-300 leading-snug">ชื่อ - นามสกุล</div>
          <div class="text-[20px] font-semibold text-sky-50 leading-tight">
            ${escapeHtmlClient(fullName)}
          </div>
          <div class="mt-1 inline-flex items-center gap-1.5 px-3.5 py-0.5
                      rounded-full bg-sky-500/12 border border-sky-500/40
                      text-[9px] text-sky-300">
            <span class="material-symbols-outlined text-[14px] leading-none">badge</span>
            <span>${escapeHtmlClient(roleLabel)}</span>
          </div>
        </div>

        <!-- Box รายละเอียด: ถอยจากขอบซ้ายขวาเล็กน้อย -->
        <div class="mt-3 px-2.5 py-2 rounded-2xl bg-slate-900/60 border border-slate-700/80
                    space-y-1.6 text-[10px] text-slate-300 leading-relaxed">

          <div class="flex justify-between gap-3">
            <span class="text-slate-400">ทีม</span>
            <span class="font-semibold text-sky-200 line-clamp-1 text-right">
              ${escapeHtmlClient(teamName || '-')}
            </span>
          </div>

          <div class="flex justify-between gap-3">
            <span class="text-slate-400">สถานศึกษา</span>
            <span class="font-semibold text-sky-100 line-clamp-2 text-right">
              ${escapeHtmlClient(schoolName || '-')}
            </span>
          </div>

          ${
            phoneDisplay
              ? `
                <div class="flex justify-between items-center gap-3">
                  <span class="text-slate-400">เบอร์ติดต่อ</span>
                  <div class="flex items-center gap-1.5">
                    ${
                      telHref
                        ? `<a href="${telHref}"
                              class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full
                                     bg-emerald-500/10 border border-emerald-400/50
                                     text-[9px] text-emerald-300 hover:bg-emerald-500/18">
                              <span class="material-symbols-outlined text-[14px] leading-none">call</span>
                              <span>${escapeHtmlClient(phoneDisplay)}</span>
                           </a>`
                        : `<span class="text-[9px] text-emerald-300">
                             ${escapeHtmlClient(phoneDisplay)}
                           </span>`
                    }
                    <button type="button"
                            onclick="copyPhoneToClipboard('${escapeHtmlClient(phoneDisplay)}')"
                            class="inline-flex items-center justify-center w-6 h-6 rounded-full
                                   bg-slate-800/90 border border-slate-600/80
                                   hover:bg-slate-700 text-sky-300 text-[13px]">
                      <span class="material-symbols-outlined text-[14px] leading-none">content_copy</span>
                    </button>
                  </div>
                </div>
              `
              : ''
          }
        </div>

        <!-- QR Code + ข้อความท้ายบัตร: ขยับขึ้นมานิด ไม่ชิดขอบล่างเกินไป -->
        <div class="mt-2 flex flex-col items-center gap-1.2 pt-1">
          <div class="w-16 h-16 md:w-18 md:h-18 rounded-2xl bg-slate-900/95 border border-sky-400/80
                      flex items-center justify-center overflow-hidden">
            ${
              qrUrl
                ? `<img src="${qrUrl}" alt="QR Code" class="w-full h-full object-contain">`
                : ''
            }
          </div>
          <div class="text-[8px] text-sky-300 uppercase tracking-wide leading-snug">
            scan to check-in / verify
          </div>
          <div class="text-[7px] text-slate-400 text-center leading-snug">
            ปัดซ้าย / ขวา เพื่อดูสมาชิกคนอื่น ๆ ในทีม
          </div>
        </div>

      </div>
    </div>
  `;
}


function copyPhoneToClipboard(phone) {
  const text = (phone || '').trim();
  if (!text) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      if (window.Swal) {
        Swal.fire({
          toast: true,
          position: 'top',
          icon: 'success',
          title: 'คัดลอกเบอร์โทรแล้ว',
          showConfirmButton: false,
          timer: 1200
        });
      }
    }).catch(() => fallbackCopyText(text));
  } else {
    fallbackCopyText(text);
  }
}

function fallbackCopyText(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand('copy'); } catch (e) {}
  document.body.removeChild(ta);
  if (window.Swal) {
    Swal.fire({
      toast: true,
      position: 'top',
      icon: 'success',
      title: 'คัดลอกเบอร์โทรแล้ว',
      showConfirmButton: false,
      timer: 1200
    });
  }
}







function closeTeamPhotoModal() {
  const modal = document.getElementById('team-photo-modal');
  if (!modal) return;
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

    

    document.addEventListener('click', (e) => {
        const modal = document.getElementById('team-photo-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        if (e.target === modal) closeTeamPhotoModal();
    });

    // --- Team table ---
    function applyTeamFilters(teams, activityMap) {
        if (!teamSearchTerm) return [...teams];
        const keyword = teamSearchTerm;
        return teams.filter(team => {
            const activityObj = activityMap.get(team.activity) || {};
            const contact = safeJsonParse(team.contact, {});
            const values = [
                team.teamId,
                team.teamName,
                team.school,
                team.level,
                activityObj.name,
                activityObj.category,
                contact.name,
                contact.phone,
                contact.email,
                team.status
            ];
            return values.some(v => (v || '').toString().toLowerCase().includes(keyword));
        });
    }

    function applyTeamLogoFallbacks() {
        if (!teamTableBody) return;
        const images = teamTableBody.querySelectorAll('img[data-team-logo="true"]');
        images.forEach(img => {
            img.addEventListener('error', () => {
                const wrapper = img.closest('.team-logo-wrapper');
                if (wrapper) {
                    wrapper.innerHTML = '<span class="material-symbols-outlined text-lg text-slate-400">image_not_supported</span>';
                    wrapper.classList.remove('bg-white');
                    wrapper.classList.add('bg-slate-100', 'flex', 'items-center', 'justify-center', 'text-slate-400');
                }
            }, { once: true });
        });
    }


    function parseScoreValueClient(value) {
        if (value === null || value === undefined || value === '') return null;
        const num = Number(value);
        return Number.isFinite(num) ? num : null;
    }

    function resolveMedalFromScoreClient(score) {
        if (!Number.isFinite(score)) return null;
        const clamped = Math.max(0, Math.min(100, score));
        return TEAM_MEDAL_CONFIG.find(config => clamped >= config.min) || null;
    }

    function getManualMedalOverride(team) {
        if (!team || team.scoreManualMedal === undefined) return null;
        const normalized = (team.scoreManualMedal || '').toString().trim().toLowerCase();
        if (!normalized) return null;
        if (normalized.includes('ทองแดง') || normalized.includes('bronze')) {
            return TEAM_MEDAL_CONFIG_MAP.bronze || null;
        }
        if (normalized.includes('เงิน') || normalized.includes('silver')) {
            return TEAM_MEDAL_CONFIG_MAP.silver || null;
        }
        if (normalized.includes('ทอง') || normalized.includes('gold')) {
            return TEAM_MEDAL_CONFIG_MAP.gold || null;
        }
        if (normalized.includes('ชม') || normalized.includes('merit')) {
            return TEAM_MEDAL_CONFIG_MAP.merit || null;
        }
        return null;
    }

    function getTeamMedalInfo(team) {
        if (!team) return null;
        const manual = getManualMedalOverride(team);
        if (manual) return manual;
        const stageValue = getTeamStageValue(team);
        const score = stageValue === 'area'
            ? parseScoreValueClient(team.areaScore)
            : parseScoreValueClient(team.scoreTotal);
        if (score === null) return null;
        return resolveMedalFromScoreClient(score);
    }

    function summarizeTeamMedals(teams) {
        const counts = TEAM_MEDAL_KEYS.reduce((acc, key) => {
            acc[key] = 0;
            return acc;
        }, {});
        if (!Array.isArray(teams) || !teams.length) {
            return { total: 0, counts };
        }
        teams.forEach(team => {
            const medal = getTeamMedalInfo(team);
            if (medal && Object.prototype.hasOwnProperty.call(counts, medal.key)) {
                counts[medal.key] += 1;
            }
        });
        const total = TEAM_MEDAL_KEYS.reduce((sum, key) => sum + (counts[key] || 0), 0);
        return { total, counts };
    }

    function formatMedalBreakdown(counts = {}) {
        return [
            `ทอง ${counts.gold || 0}`,
            `เงิน ${counts.silver || 0}`,
            `ทองแดง ${counts.bronze || 0}`,
            `ชมเชย ${counts.merit || 0}`
        ].join(' • ');
    }

    function updateTeamInsights(teams, options = {}) {
        if (!teamInsightsWrapper) return;
        const state = options.state || (Array.isArray(teams) ? 'ready' : 'loading');
        const isDimmed = state !== 'ready';
        teamInsightsWrapper.classList.toggle('opacity-60', isDimmed);
        if (state === 'loading') {
            if (teamRepresentativeCountEl) teamRepresentativeCountEl.textContent = '...';
            if (teamMedalCountEl) teamMedalCountEl.textContent = '...';
            if (teamMedalBreakdownEl) teamMedalBreakdownEl.textContent = 'กำลังโหลดข้อมูลทีม...';
            return;
        }
        if (state === 'unavailable') {
            if (teamRepresentativeCountEl) teamRepresentativeCountEl.textContent = '--';
            if (teamMedalCountEl) teamMedalCountEl.textContent = '--';
            if (teamMedalBreakdownEl) teamMedalBreakdownEl.textContent = 'เข้าสู่ระบบเพื่อดูสถิติทีม';
            return;
        }
        const dataset = Array.isArray(teams) ? teams : [];
        const representativeCount = dataset.filter(team => isTeamRepresentative(team)).length;
        const medalStats = summarizeTeamMedals(dataset);
        if (teamRepresentativeCountEl) teamRepresentativeCountEl.textContent = representativeCount.toString();
        if (teamMedalCountEl) teamMedalCountEl.textContent = medalStats.total.toString();
        if (teamMedalBreakdownEl) {
            teamMedalBreakdownEl.textContent = medalStats.total
                ? formatMedalBreakdown(medalStats.counts)
                : dataset.length
                    ? 'ยังไม่มีการบันทึกเหรียญ'
                    : 'ยังไม่มีข้อมูลในขอบเขตนี้';
        }
    }


function renderTeamTableSkeleton(rows = 3) {
        if (!teamTableBody) return;
        CURRENTLY_VISIBLE_TEAMS = []; 

        const exportCsvBtn = document.getElementById('export-csv-button');
        const exportPdfBtn = document.getElementById('export-pdf-button');
        const exportAttBtn = document.getElementById('export-attendance-pdf-button'); // << เพิ่มบรรทัดนี้
        if (exportCsvBtn) exportCsvBtn.disabled = true;
        if (exportPdfBtn) exportPdfBtn.disabled = true;
        if (exportAttBtn) exportAttBtn.disabled = true; // << เพิ่มบรรทัดนี้
        updateTeamInsights(null, { state: 'loading' });

        const skeletonRow = `
            <tr class="animate-pulse">
                <td colspan="9" class="p-4">
                    <div class="space-y-2">
                        <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                        <div class="h-3 bg-slate-100 rounded w-full"></div>
                        <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                    </div>
                </td>
            </tr>
        `;
        teamTableBody.innerHTML = Array.from({ length: rows }).map(() => skeletonRow).join('');
    }

    function showProfileTeamsLoadingState() {
        if (!profileTeamList || !currentUser) return;
        profileTeamList.innerHTML = `
            <div class="rounded-2xl border border-slate-200 p-4 bg-white animate-pulse space-y-2">
                <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                <div class="h-3 bg-slate-100 rounded w-full"></div>
            </div>
            <p class="text-xs text-slate-500 mt-2">กำลังตรวจสอบทีมของคุณ...</p>
        `;
    }



    function renderTeamTable(teams) {
        if (!teamTableBody) return;

        // -------- จัดการปุ่ม Export ----------
    const exportCsvBtn = document.getElementById('export-csv-button');
    const exportPdfBtn = document.getElementById('export-pdf-button');
    const exportAttBtn = document.getElementById('export-attendance-pdf-button');

    const setExportButtonsState = (disabled) => {
        if (exportCsvBtn) {
            exportCsvBtn.disabled = disabled;
            exportCsvBtn.classList.toggle('opacity-50', disabled);
            exportCsvBtn.classList.toggle('cursor-not-allowed', disabled);
        }
        if (exportPdfBtn) {
            exportPdfBtn.disabled = disabled;
            exportPdfBtn.classList.toggle('opacity-50', disabled);
            exportPdfBtn.classList.toggle('cursor-not-allowed', disabled);
        }
        if (exportAttBtn) {
            exportAttBtn.disabled = disabled;
            exportAttBtn.classList.toggle('opacity-50', disabled);
            exportAttBtn.classList.toggle('cursor-not-allowed', disabled);
        }
    };
    // ------------------------------------

    const userId = getCurrentUserId();
    if (!userId) {
        teamTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-500">กรุณาเข้าสู่ระบบเพื่อดูทีมของคุณ</td></tr>';
        setExportButtonsState(true);
        CURRENTLY_VISIBLE_TEAMS = [];
        updateTeamInsights(null, { state: 'unavailable' });
        return;
    }

    if (!Array.isArray(teams) || teams.length === 0) {
        teamTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-500">ยังไม่มีทีมที่ลงทะเบียนในระบบ</td></tr>';
        setExportButtonsState(true);
        CURRENTLY_VISIBLE_TEAMS = [];
        updateTeamInsights([]);
        return;
    }

    const activityMap = new Map(
        (Array.isArray(ALL_ACTIVITIES) ? ALL_ACTIVITIES : []).map(act => [act.id, act])
    );

    // ให้เห็นเฉพาะทีมในสิทธิ์
    const userTeams = filterTeamsForCurrentUser(teams);
    if (userTeams.length === 0) {
        teamTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-500">ไม่มีทีมในสิทธิ์ของคุณ</td></tr>';
        setExportButtonsState(true);
        CURRENTLY_VISIBLE_TEAMS = [];
        updateTeamInsights([]);
        return;
    }

    // ใช้ฟิลเตอร์ค้นหา / เงื่อนไขอื่น ๆ เดิม
    const role = getCurrentUserLevel();
    updateAreaTransferButtonState();
    const areaScoreAllowed = isAreaStageActive() && ['admin', 'area'].includes(role);
    const isAdminLike = ['admin', 'area', 'group_admin'].includes(role);
    const filteredTeams = applyTeamFilters(userTeams, activityMap);
    const restrictToRepresentatives = competitionStage === 'area' && isAdminLike;
    const visibleTeams = restrictToRepresentatives
        ? filteredTeams.filter(team => getTeamStageValue(team) === 'area')
        : filteredTeams;
    if (visibleTeams.length === 0) {
        const emptyMessage = restrictToRepresentatives
            ? 'ยังไม่มีทีมตัวแทนระดับเขตให้แสดง'
            : 'ไม่พบทีมของคุณที่ตรงกับคำค้นหา';
        teamTableBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-slate-500">${emptyMessage}</td></tr>`;
        setExportButtonsState(true);
        CURRENTLY_VISIBLE_TEAMS = [];
        updateTeamInsights([]);
        return;
    }

    CURRENTLY_VISIBLE_TEAMS = [...visibleTeams];
    updateTeamInsights(visibleTeams);

    let html = '';

    // =============== โหมด admin / area / group_admin ===============
    // แยกตาม "หมวดหมู่กิจกรรม" และเรียง "ชื่อกิจกรรม"
if (isAdminLike) {
    const categoryMap = new Map();

    visibleTeams.forEach(team => {
        const activityObj = activityMap.get(team.activity) || {};
        const categoryLabel = activityObj.category || 'ไม่ระบุหมวดหมู่';
        if (!categoryMap.has(categoryLabel)) categoryMap.set(categoryLabel, []);
        categoryMap.get(categoryLabel).push({ team, activityObj });
    });

    const sortedCategories = Array.from(categoryMap.keys())
        .sort((a, b) => a.localeCompare(b, 'th'));

    sortedCategories.forEach((categoryName, catIndex) => {
        const catUid = `cat-${catIndex}`;
        const entries = categoryMap.get(categoryName) || [];

        // แถวหัว "หมวดหมู่" (accordion ชั้นที่ 1)
        html += `
            <tr class="bg-slate-100 cursor-pointer category-header-row"
                onclick="toggleCategoryRows('${catUid}')">
                <td colspan="9" class="p-3 text-sm font-semibold text-slate-700">
                    <div class="cat-header-inner flex items-center justify-between gap-2">
                        <span>หมวดหมู่: ${escapeHtmlClient(categoryName)}</span>
                        <span class="flex items-center gap-1 text-[10px] text-slate-500">
                            <span class="material-symbols-outlined text-[16px]"
                                  data-cat-toggle-icon="${catUid}">
                                expand_more
                            </span>
                            แสดง/ซ่อนหมวดหมู่
                        </span>
                    </div>
                </td>
            </tr>
        `;

        // แบ่งในหมวดออกตามกิจกรรม
        const activityGroups = new Map();
        entries.forEach(({ team, activityObj }) => {
            const actId = (activityObj && activityObj.id) || team.activity || 'unknown';
            if (!activityGroups.has(actId)) {
                activityGroups.set(actId, { activityObj, teams: [] });
            }
            activityGroups.get(actId).teams.push(team);
        });

        const sortedActivities = Array.from(activityGroups.keys()).sort((a, b) => {
            const aName = activityGroups.get(a).activityObj.name || a;
            const bName = activityGroups.get(b).activityObj.name || b;
            return aName.localeCompare(bName, 'th');
        });

        sortedActivities.forEach((actId, actIndex) => {
            const actUid = `${catUid}-act-${actIndex}`;
            const group = activityGroups.get(actId);
            const actObj = group.activityObj || {};
            const actName = actObj.name || actId;
            const normalizedActId = (actObj.id || actId || '').toString().trim();
            const activityDataId = normalizedActId || actId || '';
            const isActivityExpanded = activityDataId && expandedActivityIds.has(activityDataId);
            const activityIcon = isActivityExpanded ? 'expand_more' : 'chevron_right';
            const headerActiveClass = isActivityExpanded ? ' activity-header-row--active' : '';
            const childRowVisibilityClass = isActivityExpanded ? '' : ' hidden';
            const childRowClass = `category-child-row category-child-${catUid} activity-child-row activity-child-${actUid}${childRowVisibilityClass}`;

            const teamsInAct = group.teams.slice().sort((a, b) => {
                const nameA = getTeamDisplayName(a);
                const nameB = getTeamDisplayName(b);
                const ta = nameA.localeCompare(nameB, 'th');
                if (ta !== 0) return ta;
                return (a.school || '').localeCompare(b.school || '', 'th');
            });
            const teamCount = teamsInAct.length;
            const canShowActivityControls = ['admin', 'area'].includes(role) || (!isAreaStageActive() && role === 'group_admin');
            const activityControls = canShowActivityControls
                ? (() => {
                    const hasMultipleTeams = teamCount > 1;
                    const scoreBtnClass = hasMultipleTeams
                        ? 'inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-[10px] font-semibold bg-violet-500 text-white shadow-sm ring-1 ring-violet-300/70 hover:bg-violet-600'
                        : 'inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-600 border border-emerald-400/60 text-[10px] font-semibold hover:bg-emerald-500/15';
                    const scoreBtnTitle = hasMultipleTeams
                        ? 'กิจกรรมนี้มีหลายทีม – แยกสีเพื่อให้เห็นชัด'
                        : 'กิจกรรมนี้มีทีมเดียว';
                    const visibleJudges = getScoreSheetJudges(activityDataId || actId);
                    const hasActivityJudges = Array.isArray(visibleJudges) && visibleJudges.length > 0;
                    const judgeTimesheetButtonClass = hasActivityJudges
                        ? 'inline-flex items-center gap-1 px-3 py-1 rounded-full bg-amber-500 text-white text-[10px] font-semibold shadow-sm hover:bg-amber-600'
                        : 'inline-flex items-center gap-1 px-3 py-1 rounded-full border border-amber-200 text-[10px] font-semibold text-amber-700 bg-white hover:bg-amber-50';
                    const judgeTimesheetButtonTitle = hasActivityJudges
                        ? 'กรรมการพร้อมใช้งาน'
                        : 'ยังไม่มีกรรมการสำหรับกิจกรรมนี้';
                    return `
                        <button type="button"
                                class="${scoreBtnClass}"
                                title="${scoreBtnTitle}"
                                onclick="event.stopPropagation(); openScoreSheetPrompt('${actId}')">
                            <span class="material-symbols-outlined text-[14px] leading-none">print</span>
                            <span>ใบลงคะแนน</span>
                        </button>
                        <button type="button"
                                class="${judgeTimesheetButtonClass}"
                                title="${judgeTimesheetButtonTitle}"
                                onclick="event.stopPropagation(); openJudgeTimesheetModal('${actId}')">
                            <span class="material-symbols-outlined text-[14px] leading-none">schedule</span>
                            <span>ใบลงเวลาของกรรมการ</span>
                        </button>
                    `;
                })()
                : '';

            // Header กิจกรรม (accordion ชั้นที่ 2) + แสดงจำนวนทีม
            html += `
                <tr class="bg-white activity-header-row category-child-row category-child-${catUid} cursor-pointer${headerActiveClass}"
                    data-act-uid="${actUid}"
                    data-activity-id="${escapeHtmlClient(activityDataId)}"
                    onclick="toggleActivityRows('${actUid}')">
                    <td colspan="9" class="px-4 py-2 text-[13px] text-slate-700 border-t border-slate-100">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[16px] text-sky-500">flag</span>
                                <div>
                                    <div class="font-semibold text-slate-800">
                                        กิจกรรม: ${escapeHtmlClient(actName)}
                                    </div>
                                    <div class="text-[10px] text-slate-500">
                                        ${escapeHtmlClient(categoryName)} • ${teamCount} ทีมในกิจกรรมนี้
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${activityControls}
                                <span class="flex items-center gap-0.5 text-[9px] text-slate-500">
                                    <span class="material-symbols-outlined text-[16px]"
                                          data-act-toggle-icon="${actUid}">
                                        ${activityIcon}
                                    </span>
                                    แสดง/ซ่อนทีม
                                </span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;

            const clusterBuckets = buildActivityClusterBuckets(teamsInAct);
            if (isAdminLike) {
                const judgesPanelMarkup = renderActivityJudgesPanel(actId, clusterBuckets);
                if (judgesPanelMarkup) {
                    html += `
                        <tr class="${childRowClass}">
                            <td colspan="9" class="p-3 bg-slate-50">
                                ${judgesPanelMarkup}
                            </td>
                        </tr>
                    `;
                }
            }

            // แถวทีมในกิจกรรมนั้น (เริ่มต้น "ซ่อน" ไว้)
            teamsInAct.forEach(team => {
                const representative = isTeamRepresentative(team);
                const representativeClass = representative ? ' team-row--representative' : '';
                const representativeBadge = representative ? '<span class="competition-representative-badge mt-1">ตัวแทน</span>' : '';
                const members = getTeamMembersForStage(team);
                const teachers = Array.isArray(members.teachers) ? members.teachers : [];
                const students = Array.isArray(members.students) ? members.students : [];
                const numTeachers = teachers.length;
                const numStudents = students.length;

                const requiredTeachers = team.requiredTeachers || (actObj ? actObj.reqTeachers : '-');
                const requiredStudents = team.requiredStudents || (actObj ? actObj.reqStudents : '-');

                const canManage = canManageTeam(team);
                const teamLocked = isTeamLockedForEdit(team);
                const manageDisabledAttr = canManage ? '' : 'disabled';
                const manageBtnClass = canManage
                    ? 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-sky-600 hover:bg-sky-50'
                    : 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-400 cursor-not-allowed bg-slate-50';
                const manageLabel = teamLocked ? 'ดูข้อมูล' : 'จัดการ';
                const scoreButton = canCurrentUserScoreActivity(team.activity, team)
                    ? `<button type="button"
                           class="inline-flex items-center gap-1 rounded-full border border-purple-200 px-3 py-1 text-xs font-semibold text-purple-600 hover:bg-purple-50"
                           onclick="openScoreEntryModal('${escapeHtmlClient(team.activity || '')}')">
                           <span class="material-symbols-outlined text-base">edit_note</span>
                           <span>ให้คะแนน</span>
                       </button>`
                    : '';

                let logoHtml = `
                    <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-slate-100
                                flex items-center justify-center mr-3 text-slate-400">
                        <span class="material-symbols-outlined text-lg">image_not_supported</span>
                    </div>
                `;
                if (team.logoUrl) {
                    const publicLogoUrl = buildDriveThumbUrl(team.logoUrl, 80);
                    logoHtml = `
                        <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-white
                                    overflow-hidden mr-3 flex items-center justify-center">
                            <img src="${publicLogoUrl}"
                                 alt="โลโก้ทีม ${escapeHtmlClient(getTeamDisplayName(team))}"
                                 class="w-full h-full object-cover"
                                 loading="lazy"
                                 referrerpolicy="no-referrer"
                                 data-team-logo="true">
                        </div>
                    `;
                }
                const activityCode = activityDataId || team.activity || '';

                html += `
                    <tr class="hover:bg-slate-50${representativeClass} ${childRowClass}">
                        <td class="p-3 text-sm text-slate-700 font-semibold whitespace-nowrap">
                            ${escapeHtmlClient(team.teamId || '')}
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="font-medium text-slate-800">
                                ${escapeHtmlClient(actName)}
                            </div>
                            <div class="text-xs text-slate-500">
                                ${escapeHtmlClient(categoryName || '')}
                            </div>
                        </td>
                        <td class="p-3 text-sm font-mono text-slate-600 whitespace-nowrap">
                            ${escapeHtmlClient(activityCode || '-')}
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="flex items-center">
                                ${logoHtml}
                                <div>
                                    <div class="font-medium text-slate-800">
                                        ${escapeHtmlClient(getTeamDisplayName(team))}
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        ${escapeHtmlClient(team.school || '-')}
                                    </div>
                                    <div class="text-[11px] text-amber-600">
                                        เครือข่าย: ${escapeHtmlClient(getTeamClusterLabel(team) || 'ไม่ระบุ')}
                                    </div>
                                    <div class="text-[11px] text-sky-600">
                                        ระดับ: ${escapeHtmlClient(getTeamStageLabel(team))}
                                    </div>
                                    ${representativeBadge}
                                    <button type="button"
                                        class="mt-1 inline-flex items-center gap-1 text-[10px] text-sky-600 hover:text-sky-800"
                                        onclick="openTeamPhotoModal('${team.teamId}')">
                                        <span class="material-symbols-outlined text-[14px] leading-none">image</span>
                                        สมาชิก
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredTeachers)} / <strong>${numTeachers}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredStudents)} / <strong>${numStudents}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(team.level || '-')}
                        </td>
                        <td class="p-3 text-sm">
                            ${getStatusBadge(team.status)}
                        </td>
                        <td class="p-3 text-sm">
                            <div class="flex flex-wrap justify-end gap-1">
                                ${scoreButton}
                                ${areaScoreAllowed ? `
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-full border border-purple-200 px-3 py-1 text-xs font-semibold text-purple-600 hover:bg-purple-50"
                                        onclick="openScoreEntryModal('${escapeHtmlClient(team.activity || '')}')">
                                        <span class="material-symbols-outlined text-base">edit_note</span>
                                        <span>ระดับเขต</span>
                                    </button>
                                ` : ''}
                                <button type="button"
                                    class="${manageBtnClass}"
                                    ${manageDisabledAttr}
                                    onclick="openTeamManager('${team.teamId}')">
                                    <span class="material-symbols-outlined text-base">settings</span>
                                    <span>${manageLabel}</span>
                                </button>
                            </div>
                            ${teamLocked
                                ? '<p class="text-[11px] text-amber-600 mt-1">สถานะ Print: เปิดอ่านอย่างเดียว</p>'
                                : ''}
                        </td>
                    </tr>
                `;
            });
        });
    });
}

    // =============== โหมดผู้ใช้ทั่วไป ===============
     else {
        const groupedByKey = new Map();

        visibleTeams.forEach(team => {
            const activityObj = activityMap.get(team.activity);
            const categoryLabel = activityObj && activityObj.category
                ? activityObj.category
                : 'ไม่ระบุหมวดหมู่';

            if (!groupedByKey.has(categoryLabel)) {
                groupedByKey.set(categoryLabel, []);
            }
            groupedByKey.get(categoryLabel).push({ team, activityObj });
        });

        const sortedGroups = Array.from(groupedByKey.keys())
            .sort((a, b) => a.localeCompare(b, 'th'));

        sortedGroups.forEach(group => {
            html += `
                <tr class="bg-slate-100">
                    <td colspan="9" class="p-3 text-sm font-semibold text-slate-700">
                        หมวดหมู่: ${escapeHtmlClient(group)}
                    </td>
                </tr>
            `;

            const rows = groupedByKey.get(group) || [];
            const sortedRows = rows.slice().sort((a, b) => {
                const nameA = (a.activityObj && a.activityObj.name) || a.team.activity || '';
                const nameB = (b.activityObj && b.activityObj.name) || b.team.activity || '';
                const byAct = nameA.localeCompare(nameB, 'th');
                if (byAct !== 0) return byAct;
                            const teamA = getTeamDisplayName(a.team);
                            const teamB = getTeamDisplayName(b.team);
                return teamA.localeCompare(teamB, 'th');
            });

            sortedRows.forEach(({ team, activityObj }) => {
                const representative = isTeamRepresentative(team);
                const representativeClass = representative ? ' team-row--representative' : '';
                const representativeBadge = representative ? '<span class="competition-representative-badge mt-1">ตัวแทน</span>' : '';
                const members = getTeamMembersForStage(team);
                const teachers = Array.isArray(members.teachers) ? members.teachers : [];
                const students = Array.isArray(members.students) ? members.students : [];
                const numTeachers = teachers.length;
                const numStudents = students.length;

                const activityName = activityObj
                    ? (activityObj.name || (team.activity || 'N/A'))
                    : (team.activity || 'N/A');
                const category = activityObj && activityObj.category
                    ? activityObj.category
                    : 'ไม่ระบุหมวดหมู่';
                const activityCode = (activityObj && activityObj.id) ? activityObj.id : (team.activity || '');

                const requiredTeachers = team.requiredTeachers || (activityObj ? activityObj.reqTeachers : '-');
                const requiredStudents = team.requiredStudents || (activityObj ? activityObj.reqStudents : '-');

                const canManage = canManageTeam(team);
                const teamLocked = isTeamLockedForEdit(team);
                const manageDisabledAttr = canManage ? '' : 'disabled';
                const manageBtnClass = canManage
                    ? 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-sky-600 hover:bg-sky-50'
                    : 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-400 cursor-not-allowed bg-slate-50';
                const manageLabel = teamLocked ? 'ดูข้อมูล' : 'จัดการ';
                const scoreButton = canCurrentUserScoreActivity(team.activity, team)
                    ? `<button type="button"
                           class="inline-flex items-center gap-1 rounded-full border border-purple-200 px-3 py-1 text-xs font-semibold text-purple-600 hover:bg-purple-50"
                           onclick="openScoreEntryModal('${escapeHtmlClient(team.activity || '')}')">
                           <span class="material-symbols-outlined text-base">edit_note</span>
                           <span>ให้คะแนน</span>
                       </button>`
                    : '';

                let logoHtml = `
                    <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-slate-100
                                flex items-center justify-center mr-3 text-slate-400">
                        <span class="material-symbols-outlined text-lg">image_not_supported</span>
                    </div>
                `;
                if (team.logoUrl) {
                    const publicLogoUrl = buildDriveThumbUrl(team.logoUrl, 80);
                    logoHtml = `
                        <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-white
                                    overflow-hidden mr-3 flex items-center justify-center">
                                <img src="${publicLogoUrl}"
                                 alt="โลโก้ทีม ${escapeHtmlClient(getTeamDisplayName(team))}"
                                 class="w-full h-full object-cover"
                                 loading="lazy"
                                 referrerpolicy="no-referrer"
                                 data-team-logo="true">
                            </div>
                    `;
                }

                html += `
                    <tr class="hover:bg-slate-50${representativeClass}">
                        <td class="p-3 text-sm text-slate-700 font-semibold whitespace-nowrap">
                            ${escapeHtmlClient(team.teamId || '')}
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="font-medium text-slate-800">
                                ${escapeHtmlClient(activityName)}
                            </div>
                            <div class="text-xs text-slate-500">
                                ${escapeHtmlClient(category || '')}
                            </div>
                        </td>
                        <td class="p-3 text-sm font-mono text-slate-600 whitespace-nowrap">
                            ${escapeHtmlClient(activityCode || '-')}
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="flex items-center">
                                ${logoHtml}
                                <div>
                                    <div class="font-medium text-slate-800">
                                        ${escapeHtmlClient(getTeamDisplayName(team))}
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        ${escapeHtmlClient(team.school || '-')}
                                    </div>
                                    <div class="text-[11px] text-amber-600">
                                        เครือข่าย: ${escapeHtmlClient(getTeamClusterLabel(team) || 'ไม่ระบุ')}
                                    </div>
                                    <div class="text-[11px] text-sky-600">
                                        ระดับ: ${escapeHtmlClient(getTeamStageLabel(team))}
                                    </div>
                                    ${representativeBadge}
                                    <button type="button"
                                        class="mt-1 inline-flex items-center gap-1 text-[10px] text-sky-600 hover:text-sky-800"
                                        onclick="openTeamPhotoModal('${team.teamId}')">
                                        <span class="material-symbols-outlined text-[14px] leading-none">image</span>
                                        สมาชิก
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredTeachers)} / <strong>${numTeachers}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredStudents)} / <strong>${numStudents}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(team.level || '-')}
                        </td>
                        <td class="p-3 text-sm">
                            ${getStatusBadge(team.status)}
                        </td>
                        <td class="p-3 text-sm">
                            <div class="flex flex-wrap justify-end gap-1">
                                ${scoreButton}
                                ${areaScoreAllowed ? `
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-full border border-purple-200 px-3 py-1 text-xs font-semibold text-purple-600 hover:bg-purple-50"
                                        onclick="openScoreEntryModal('${escapeHtmlClient(team.activity || '')}')">
                                        <span class="material-symbols-outlined text-base">edit_note</span>
                                        <span>ระดับเขต</span>
                                    </button>
                                ` : ''}
                                <button type="button"
                                    class="${manageBtnClass}"
                                    ${manageDisabledAttr}
                                    onclick="openTeamManager('${team.teamId}')">
                                    <span class="material-symbols-outlined text-base">settings</span>
                                    <span>${manageLabel}</span>
                                </button>
                            </div>
                            ${teamLocked
                                ? '<p class="text-[11px] text-amber-600 mt-1">สถานะ Print: เปิดอ่านอย่างเดียว</p>'
                                : ''}
                        </td>
                    </tr>
                `;
            });
        });
    }

    teamTableBody.innerHTML = html;
    applyTeamLogoFallbacks();
    applyPendingActivityScroll();
    setExportButtonsState(false);
}


function toggleCategoryRows(uid) {
    const rows = document.querySelectorAll(`.category-child-${uid}`);
    if (!rows.length) return;

    const first = rows[0];
    const willHide = !first.classList.contains('hidden'); // ถ้ายังไม่ซ่อน -> กดแล้วซ่อน

    rows.forEach(tr => {
        tr.classList.toggle('hidden', willHide);
    });

    const icon = document.querySelector(`span[data-cat-toggle-icon="${uid}"]`);
    if (icon) {
        icon.textContent = willHide ? 'chevron_right' : 'expand_more';
    }
}

function toggleActivityRows(actUid) {
    const rows = document.querySelectorAll(`.activity-child-${actUid}`);
    if (!rows.length) return;
    const first = rows[0];
    const willHide = !first.classList.contains('hidden');
    const header = document.querySelector(`.activity-header-row[data-act-uid="${actUid}"]`);
    const activityId = header?.dataset?.activityId || '';

    rows.forEach(tr => {
        tr.classList.toggle('hidden', willHide);
    });

    const icon = document.querySelector(`span[data-act-toggle-icon="${actUid}"]`);
    if (icon) {
        icon.textContent = willHide ? 'chevron_right' : 'expand_more';
    }

    if (header) {
        header.classList.toggle('activity-header-row--active', !willHide);
    }

    const normalizedId = (activityId || '').toString().trim();
    if (normalizedId) {
        if (!willHide) {
            requestActivityFocus(normalizedId);
        } else {
            expandedActivityIds.delete(normalizedId);
        }
    }
}



    function getTeamStatusMode(team) {
        const level = getCurrentUserLevel();
        if (!team || !level) return 'none';
        if (level === 'admin' || level === 'area') return 'full';
        if (level === 'group_admin') {
            const userCluster = getUserClusterForFilter();
            const teamCluster = normalizeText(getTeamCluster(team));
            const clusterMatch = Boolean(userCluster && userCluster === teamCluster);
            const hasManageAccess = canManageTeam(team);
            if (competitionStage === 'cluster' && hasManageAccess) {
                return 'full';
            }
            if (clusterMatch) {
                return 'group';
            }
        }
        return 'none';
    }

    function updateTeamManageReasonVisibility(statusValue) {
        if (!teamManageReasonWrapper) return;
        const status = (statusValue || '').toLowerCase();
        const shouldShow = status === 'rejected' && teamManageStatusMode !== 'none';
        teamManageReasonWrapper.classList.toggle('hidden', !shouldShow);
    }

    function updateTeamManageStatusPill(status) {
        if (!teamManageStatusPill) return;
        const normalized = (status || '').toString().trim().toLowerCase();
        const classMap = {
            approved: 'bg-emerald-50 border-emerald-200 text-emerald-700',
            print: 'bg-slate-100 border-slate-200 text-slate-600',
            rejected: 'bg-red-50 border-red-200 text-red-600',
            pending: 'bg-amber-50 border-amber-200 text-amber-700'
        };
        const classes = classMap[normalized] || 'bg-slate-50 border-slate-200 text-slate-600';
        teamManageStatusPill.className = `px-2 py-1 text-xs font-semibold rounded-full border ${classes}`;
        teamManageStatusPill.textContent = status || '-';
    }

    function openTeamManager(teamId) {
        if (!teamManagePanel) return;
        const team = ALL_TEAMS.find(t => t.teamId === teamId);
        if (!team) {
            Swal.fire({ icon: 'error', title: 'ไม่พบทีม', text: 'ไม่สามารถเปิดการจัดการทีมได้' });
            return;
        }
        const contact = safeJsonParse(team.contact, {});
        const members = safeJsonParse(team.members, { teachers: [], students: [] });
        activeManagedTeam = { ...team, contact };
        resetTeamManageLogoUI();
        resetTeamManagePhotoUI();
        resetTeamManageMemberPhotoData();
        initializeTeamManageData(team, contact, members);
        const teamStageIsArea = getTeamStageValue(team) === 'area';
        teamManageStageAvailable = competitionStage === 'area' || teamStageIsArea;
        const defaultScope = teamManageStageAvailable && (competitionStage === 'area' || teamStageIsArea) ? 'area' : 'cluster';
        applyTeamManageStageScope(defaultScope, { force: true });
        teamManageEditable = canManageTeam(team) && !isTeamLockedForEdit(team);
        teamManageStatusMode = getTeamStatusMode(team);
        const hasFullStatusControl = teamManageStatusMode === 'full';
        teamManageStatusEditable = (teamManageEditable || hasFullStatusControl) && teamManageStatusMode !== 'none';
        teamManageImageEditable = teamManageEditable && canEditTeamImagesClient();
        if (teamManageTitle) teamManageTitle.textContent = `${team.teamId || ''} • ${getTeamDisplayName(team)}`;
        if (teamManageClusterLabel) teamManageClusterLabel.textContent = `เครือข่าย: ${getTeamClusterLabel(team) || 'ไม่ระบุ'}`;
        if (teamManageStatusSelect) {
            teamManageStatusSelect.value = team.status || 'Pending';
            const options = Array.from(teamManageStatusSelect.options);
            if (teamManageStatusMode === 'group') {
                const allowed = new Set(['Rejected', 'Print', 'Pending']);
                options.forEach(option => {
                    const value = option.value || '';
                    option.disabled = !allowed.has(value) && value !== (team.status || 'Pending');
                });
            } else {
                options.forEach(option => option.disabled = false);
            }
            teamManageStatusSelect.disabled = !teamManageStatusEditable;
        }
        if (teamManageContactNameInput) teamManageContactNameInput.value = contact.name || '';
        if (teamManageContactPhoneInput) teamManageContactPhoneInput.value = contact.phone || '';
        if (teamManageContactEmailInput) teamManageContactEmailInput.value = contact.email || '';
        if (teamManageLockNotice) teamManageLockNotice.classList.toggle('hidden', teamManageEditable);
        if (teamManageStatusReasonInput) {
            teamManageStatusReasonInput.value = team.statusReason || '';
        }
        updateTeamManageReasonVisibility(team.status || teamManageStatusSelect?.value || '');
        const logoUrl = team.logoUrl ? buildDriveThumbUrl(team.logoUrl, 200) : '';
        if (logoUrl && teamManageLogoPreview) {
            teamManageLogoPreview.src = logoUrl;
            teamManageLogoPreview.classList.remove('hidden');
            teamManageLogoPlaceholder?.classList.add('hidden');
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'ใช้โลโก้เดิมอยู่ (อัปโหลดใหม่เพื่อเปลี่ยน)';
                teamManageLogoStatus.style.color = '#64748b';
            }
        }
        const teamPhotoId = team.teamPhotoId || team.teamPhotoUrl;
        const photoUrl = teamPhotoId ? (team.teamPhotoUrl || buildDriveThumbUrl(teamPhotoId, 320)) : '';
        if (photoUrl && teamManagePhotoPreview) {
            teamManagePhotoPreview.src = photoUrl;
            teamManagePhotoPreview.classList.remove('hidden');
            teamManagePhotoPlaceholder?.classList.add('hidden');
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'ใช้รูปทีมเดิมอยู่ (อัปโหลดใหม่เพื่อเปลี่ยน)';
                teamManagePhotoStatus.style.color = '#64748b';
            }
        }
        if (teamManageLogoInput) teamManageLogoInput.disabled = !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = !teamManageImageEditable;
        if (teamManagePhotoOpen) {
            teamManagePhotoOpen.disabled = !teamPhotoId;
            teamManagePhotoOpen.dataset.teamId = team.teamId || '';
        }
        updateTeamManageStatusPill(team.status || 'Pending');
        updateTeamManageControlsState();
        renderTeamManageMembers();
        if (teamManageFeedback) {
            if (teamManageEditable) {
                teamManageFeedback.textContent = 'ปรับปรุงข้อมูลแล้วกดบันทึก';
            } else if (teamManageStatusEditable) {
                teamManageFeedback.textContent = 'ข้อมูลทีมถูกล็อก แต่คุณยังสามารถเปลี่ยนสถานะแล้วกดบันทึกได้';
            } else {
                teamManageFeedback.textContent = 'ทีมนี้ถูกล็อก ไม่สามารถแก้ไขได้';
            }
        }
        teamManagePanel.classList.remove('hidden');
        teamManagePanel.classList.add('flex');
    }

    function closeTeamManager() {
        if (!teamManagePanel) return;
        teamManagePanel.classList.add('hidden');
        teamManagePanel.classList.remove('flex');
        activeManagedTeam = null;
        managedTeamMembers = { teachers: [], students: [] };
        teamManageEditable = false;
        teamManageStatusEditable = false;
        teamManageImageEditable = false;
        teamManageStatusMode = 'none';
        teamManageStageScope = 'cluster';
        teamManageStageAvailable = false;
        teamManageData = { cluster: null, area: null };
        resetTeamManageLogoUI();
        resetTeamManagePhotoUI();
        resetTeamManageMemberPhotoData();
        if (teamManageLogoInput) teamManageLogoInput.disabled = true;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = true;
        if (teamManagePhotoOpen) {
            teamManagePhotoOpen.disabled = true;
            delete teamManagePhotoOpen.dataset.teamId;
        }
        if (teamManageClusterLabel) {
            teamManageClusterLabel.textContent = 'เครือข่าย: -';
        }
        if (teamManageStatusReasonInput) {
            teamManageStatusReasonInput.value = '';
        }
        updateTeamManageReasonVisibility('');
        if (teamManageFeedback) {
            teamManageFeedback.textContent = 'ปรับปรุงข้อมูลให้ถูกต้องก่อนบันทึก';
        }
        if (teamManageStageSwitch) {
            teamManageStageSwitch.classList.add('hidden');
        }
    }

    function updateTeamManageControlsState() {
        const disabled = !teamManageEditable;
        [teamManageNameInput, teamManageContactNameInput, teamManageContactPhoneInput, teamManageContactEmailInput].forEach(el => {
            if (el) el.disabled = disabled;
        });
        if (teamManageStatusSelect) {
            teamManageStatusSelect.disabled = !teamManageStatusEditable;
        }
        if (teamManageSaveButton) {
            const canSubmit = teamManageEditable || teamManageStatusEditable;
            teamManageSaveButton.disabled = !canSubmit;
            teamManageSaveButton.classList.toggle('opacity-60', !canSubmit);
        }
        if (teamManageDeleteButton) {
            teamManageDeleteButton.disabled = disabled;
            teamManageDeleteButton.classList.toggle('opacity-60', disabled);
        }
        if (teamAddTeacherBtn) teamAddTeacherBtn.disabled = disabled;
        if (teamAddStudentBtn) teamAddStudentBtn.disabled = disabled;
        if (teamManageLogoInput) teamManageLogoInput.disabled = disabled || !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = disabled || !teamManageImageEditable;
        if (teamManagePhotoOpen) {
            const previewSrc = teamManagePhotoPreview ? teamManagePhotoPreview.src : '';
            teamManagePhotoOpen.disabled = !activeManagedTeam || (!activeManagedTeam.teamPhotoId && !previewSrc);
        }
        updateTeamManageStatusHint(teamManageStatusEditable);
    }

    function updateTeamManageStatusHint(canEdit) {
        if (!teamManageStatusHint) return;
        if (!canEdit) {
            teamManageStatusHint.textContent = 'สิทธิ์ของคุณไม่สามารถแก้สถานะได้';
            return;
        }
        if (teamManageStatusMode === 'full') {
            const level = getCurrentUserLevel();
            if (level === 'group_admin') {
                teamManageStatusHint.textContent = 'สิทธิ์ Group Admin ในรอบกลุ่มเครือข่ายสามารถแก้สถานะได้ทุกแบบ';
            } else {
                teamManageStatusHint.textContent = 'สิทธิ์ Admin/Area สามารถแก้สถานะได้ทุกแบบ';
            }
        } else if (teamManageStatusMode === 'group') {
            teamManageStatusHint.textContent = 'คุณสามารถเปลี่ยนสถานะเป็น Print หรือ Rejected (โปรดระบุเหตุผลเมื่อเลือก Rejected)';
        } else {
            teamManageStatusHint.textContent = 'สิทธิ์ของคุณไม่สามารถแก้สถานะได้';
        }
    }

    function renderTeamManageMembers() {
        const editable = teamManageEditable;
        if (teamManageTeachersContainer) {
            teamManageTeachersContainer.innerHTML = managedTeamMembers.teachers.length
                ? managedTeamMembers.teachers.map((teacher, index) => renderManagedTeacherCard(teacher, index, editable)).join('')
                : '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลครู</p>';
        }
        if (teamManageStudentsContainer) {
            teamManageStudentsContainer.innerHTML = managedTeamMembers.students.length
                ? managedTeamMembers.students.map((student, index) => renderManagedStudentCard(student, index, editable)).join('')
                : '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลนักเรียน</p>';
        }
        attachMemberPhotoListeners();
        updateMemberAddButtonsState();
        document.querySelectorAll('[data-class-level-select="true"]').forEach(select => toggleClassLevelCustomInput(select));
    }

    function renderManagedTeacherCard(teacher, index, editable) {
        const displayIndex = index + 1;
        const memberKey = ensureMemberKey(teacher, 'teacher');
        const previewId = `teacher-manage-${memberKey}-preview`;
        const placeholderId = `teacher-manage-${memberKey}-placeholder`;
        const statusId = `teacher-manage-${memberKey}-status`;
        const photoUrl = getManagedMemberPreviewUrl(memberKey, getMemberPhotoUrl(teacher));
        const removeButton = editable
            ? `<button type="button" class="text-[11px] text-red-500 hover:text-red-600" onclick="removeManagedMember('teacher', ${index})">ลบครูคนนี้</button>`
            : '';
        return `
            <div class="rounded-lg border border-slate-200 bg-white p-3 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs managed-member-grid managed-member-grid--teacher">
                    <input type="text"
                        list="teacher-prefix-options"
                        class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="คำนำหน้า"
                        value="${escapeHtmlClient(teacher.prefix || '')}"
                        ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('teacher', ${index}, 'prefix', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="ชื่อ-สกุล" value="${escapeHtmlClient(teacher.name || '')}" ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('teacher', ${index}, 'name', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="เบอร์โทร" value="${escapeHtmlClient(teacher.phone || '')}" ${editable ? '' : 'disabled'}
                        data-only-digits="true" inputmode="numeric" pattern="[0-9]*"
                        oninput="updateManagedMember('teacher', ${index}, 'phone', this.value)">
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        ${photoUrl ? `<img id="${previewId}" src="${photoUrl}" alt="Teacher ${displayIndex}" class="w-full h-full object-cover">`
                            : `<img id="${previewId}" alt="Teacher ${displayIndex}" class="hidden w-full h-full object-cover">
                               <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>`}
                        ${photoUrl ? `<span id="${placeholderId}" class="hidden"></span>` : ''}
                    </div>
                    <div class="flex-1 space-y-1">
                        <input type="file"
                            data-member-photo="true"
                            data-member-type="teacher"
                            data-member-index="${displayIndex}"
                            data-photo-scope="manage"
                            data-member-key="${memberKey}"
                            data-preview-target="${previewId}"
                            data-placeholder-target="${placeholderId}"
                            data-status-target="${statusId}"
                            class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200"
                            accept="image/png,image/jpeg"
                            ${editable ? '' : 'disabled'}>
                        <p id="${statusId}" class="text-[11px] text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)">
                            ${photoUrl ? 'ใช้รูปเดิมอยู่' : 'อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)'}
                        </p>
                    </div>
                </div>
                ${removeButton}
            </div>
        `;
    }
    function getManagedMemberLimit(type) {
        if (!activeManagedTeam) return null;
        const activity = ALL_ACTIVITIES.find(a => a.id === activeManagedTeam.activity);
        if (type === 'teachers') {
            return Number(activeManagedTeam.requiredTeachers || activity?.reqTeachers || 0) || null;
        }
        if (type === 'students') {
            return Number(activeManagedTeam.requiredStudents || activity?.reqStudents || 0) || null;
        }
        return null;
    }
    function updateMemberAddButtonsState() {
        const teacherLimit = getManagedMemberLimit('teachers');
        const studentLimit = getManagedMemberLimit('students');
        if (teamAddTeacherBtn) {
            const disabled = !teamManageEditable || (teacherLimit && managedTeamMembers.teachers.length >= teacherLimit);
            teamAddTeacherBtn.disabled = disabled;
            teamAddTeacherBtn.classList.toggle('opacity-50', disabled);
        }
        if (teamAddStudentBtn) {
            const disabled = !teamManageEditable || (studentLimit && managedTeamMembers.students.length >= studentLimit);
            teamAddStudentBtn.disabled = disabled;
            teamAddStudentBtn.classList.toggle('opacity-50', disabled);
        }
    }

    function renderManagedStudentCard(student, index, editable) {
        const displayIndex = index + 1;
        const memberKey = ensureMemberKey(student, 'student');
        const previewId = `student-manage-${memberKey}-preview`;
        const placeholderId = `student-manage-${memberKey}-placeholder`;
        const statusId = `student-manage-${memberKey}-status`;
        const photoUrl = getManagedMemberPreviewUrl(memberKey, getMemberPhotoUrl(student));
        const removeButton = editable
            ? `<button type="button" class="text-[11px] text-red-500 hover:text-red-600" onclick="removeManagedMember('student', ${index})">ลบนักเรียนคนนี้</button>`
            : '';
        return `
            <div class="rounded-lg border border-slate-200 bg-white p-3 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs managed-member-grid managed-member-grid--student">
                    <input type="text"
                        list="student-prefix-options"
                        class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="คำนำหน้า"
                        value="${escapeHtmlClient(student.prefix || '')}"
                        ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('student', ${index}, 'prefix', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="ชื่อนักเรียน" value="${escapeHtmlClient(student.name || '')}" ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('student', ${index}, 'name', this.value)">
                    ${buildClassLevelControlHtml('student', displayIndex, student.class || '', { scope: 'manage', disabled: !editable, managedIndex: index })}
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        ${photoUrl ? `<img id="${previewId}" src="${photoUrl}" alt="Student ${displayIndex}" class="w-full h-full object-cover">`
                            : `<img id="${previewId}" alt="Student ${displayIndex}" class="hidden w-full h-full object-cover">
                               <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>`}
                        ${photoUrl ? `<span id="${placeholderId}" class="hidden"></span>` : ''}
                    </div>
                    <div class="flex-1 space-y-1">
                        <input type="file"
                            data-member-photo="true"
                            data-member-type="student"
                            data-member-index="${displayIndex}"
                            data-photo-scope="manage"
                            data-member-key="${memberKey}"
                            data-preview-target="${previewId}"
                            data-placeholder-target="${placeholderId}"
                            data-status-target="${statusId}"
                            class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200"
                            accept="image/png,image/jpeg"
                            ${editable ? '' : 'disabled'}>
                        <p id="${statusId}" class="text-[11px] text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)">
                            ${photoUrl ? 'ใช้รูปเดิมอยู่' : 'อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)'}
                        </p>
                    </div>
                </div>
                ${removeButton}
            </div>
        `;
    }

    function resolveMemberCollectionKey(type) {
        if (!type) return '';
        const normalized = type.toString().toLowerCase();
        if (normalized === 'teacher' || normalized === 'teachers') return 'teachers';
        if (normalized === 'student' || normalized === 'students') return 'students';
        return normalized;
    }

    function addManagedMember(type) {
        if (!teamManageEditable) return;
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key]) return;
        const limit = getManagedMemberLimit(key);
        if (limit && managedTeamMembers[key].length >= limit) {
            if (teamManageFeedback) {
                teamManageFeedback.textContent = `จำนวน${key === 'teachers' ? 'ครู' : 'นักเรียน'}ครบตามเงื่อนไขแล้ว`;
            }
            return;
        }
        const template = key === 'teachers'
            ? { prefix: '', name: '', phone: '', role: '' } // ครูไม่ใช้ class แล้ว
            : { prefix: '', name: '', class: '', role: '' };
        ensureMemberKey(template, key === 'teachers' ? 'teacher' : 'student');
        managedTeamMembers[key].push(template);
        renderTeamManageMembers();
    }

    function updateManagedMember(type, index, field, value) {
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key] || !managedTeamMembers[key][index]) return;
        managedTeamMembers[key][index][field] = value;
    }

    function removeManagedMember(type, index) {
        if (!teamManageEditable) return;
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key]) return;
        const removed = managedTeamMembers[key][index];
        if (removed && removed._key) {
            delete TEAM_MANAGE_MEMBER_PHOTO_DATA[removed._key];
        }
        managedTeamMembers[key].splice(index, 1);
        renderTeamManageMembers();
    }

    function setTeamManageBusyState(isBusy) {
        if (teamManageSaveButton) {
            const canSubmit = teamManageEditable || teamManageStatusEditable;
            teamManageSaveButton.disabled = isBusy || !canSubmit;
            teamManageSaveButton.classList.toggle('opacity-60', isBusy || !canSubmit);
        }
        if (teamManageDeleteButton) {
            teamManageDeleteButton.disabled = isBusy || !teamManageEditable;
            teamManageDeleteButton.classList.toggle('opacity-60', isBusy || !teamManageEditable);
        }
        if (teamAddTeacherBtn) teamAddTeacherBtn.disabled = isBusy || !teamManageEditable;
        if (teamAddStudentBtn) teamAddStudentBtn.disabled = isBusy || !teamManageEditable;
        if (teamManageLogoInput) teamManageLogoInput.disabled = isBusy || !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = isBusy || !teamManageImageEditable;
        if (teamManageLoadingOverlay) {
            teamManageLoadingOverlay.classList.toggle('hidden', !isBusy);
        }
        if (teamManagePanel) {
            const memberInputs = teamManagePanel.querySelectorAll('input[data-member-photo="true"][data-photo-scope="manage"]');
            memberInputs.forEach(input => {
                input.disabled = isBusy || !teamManageEditable;
            });
        }
        if (teamManageStageSwitch) {
            const buttons = teamManageStageSwitch.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = isBusy;
            });
        }
    }

    function buildManagedMemberPayload() {
        const teachers = managedTeamMembers.teachers.map((member, index) => {
            const key = ensureMemberKey(member, 'teacher');
            const entry = {
                prefix: (member.prefix || '').trim(),
                name: (member.name || '').trim(),
                phone: (member.phone || '').trim(),
                role: member.role || '',
                class: (member.class || '').trim()
            };
            if (member.photoDriveId) {
                entry.photoDriveId = member.photoDriveId;
            }
            const photo = TEAM_MANAGE_MEMBER_PHOTO_DATA[key];
            if (photo) entry.photoFileData = photo;
            return entry;
        });
        const students = managedTeamMembers.students.map((member, index) => {
            const key = ensureMemberKey(member, 'student');
            const entry = {
                prefix: (member.prefix || '').trim(),
                name: (member.name || '').trim(),
                class: (member.class || '').trim(),
                role: member.role || ''
            };
            if (member.photoDriveId) {
                entry.photoDriveId = member.photoDriveId;
            }
            const photo = TEAM_MANAGE_MEMBER_PHOTO_DATA[key];
            if (photo) entry.photoFileData = photo;
            return entry;
        });
        return { teachers, students };
    }

    function cloneMemberCollections(source = { teachers: [], students: [] }) {
        const cloneEntries = list => (Array.isArray(list) ? list.map(item => ({ ...item })) : []);
        return {
            teachers: cloneEntries(source.teachers),
            students: cloneEntries(source.students)
        };
    }

    function initializeTeamManageData(team, clusterContact, clusterMembers) {
        const areaContactRaw = safeJsonParse(team.contactArea, {});
        const areaMembersRaw = safeJsonParse(team.membersArea, { teachers: [], students: [] });
        const normalizedClusterMembers = {
            teachers: Array.isArray(clusterMembers.teachers) ? clusterMembers.teachers : [],
            students: Array.isArray(clusterMembers.students) ? clusterMembers.students : []
        };
        const normalizedAreaMembers = {
            teachers: Array.isArray(areaMembersRaw.teachers) ? areaMembersRaw.teachers : [],
            students: Array.isArray(areaMembersRaw.students) ? areaMembersRaw.students : []
        };
        const hasAreaMembers = normalizedAreaMembers.teachers.length > 0 || normalizedAreaMembers.students.length > 0;
        const areaContactReady = areaContactRaw && Object.keys(areaContactRaw).length ? areaContactRaw : clusterContact;
        teamManageData = {
            cluster: {
                contact: { ...clusterContact },
                members: cloneMemberCollections(normalizedClusterMembers),
                teamName: team.teamNameCluster || team.teamName || ''
            },
            area: {
                contact: { ...areaContactReady },
                members: hasAreaMembers ? cloneMemberCollections(normalizedAreaMembers) : cloneMemberCollections(normalizedClusterMembers),
                teamName: team.teamNameArea || team.teamNameCluster || team.teamName || ''
            }
        };
    }

    function captureTeamManageFormToData(scope = teamManageStageScope) {
        if (!teamManageData[scope]) return;
        const target = teamManageData[scope];
        target.teamName = (teamManageNameInput?.value || '').trim();
        target.contact = {
            name: (teamManageContactNameInput?.value || '').trim(),
            phone: (teamManageContactPhoneInput?.value || '').trim(),
            email: (teamManageContactEmailInput?.value || '').trim()
        };
        target.members = buildManagedMemberPayload();
    }

    function applyTeamManageStageScope(scope, options = {}) {
        if (!teamManageData[scope]) return;
        const force = Boolean(options.force);
        if (!force && scope === teamManageStageScope) return;
        if (!force) {
            captureTeamManageFormToData(teamManageStageScope);
        }
        teamManageStageScope = scope;
        const dataset = teamManageData[scope];
        if (teamManageNameInput) teamManageNameInput.value = dataset.teamName || '';
        if (teamManageContactNameInput) teamManageContactNameInput.value = dataset.contact?.name || '';
        if (teamManageContactPhoneInput) teamManageContactPhoneInput.value = dataset.contact?.phone || '';
        if (teamManageContactEmailInput) teamManageContactEmailInput.value = dataset.contact?.email || '';
        managedTeamMembers = cloneMemberCollections(dataset.members);
        renderTeamManageMembers();
        updateTeamManageStageUI();
    }

    function updateTeamManageStageUI() {
        if (teamManageStageLabel && activeManagedTeam) {
            const baseLabel = getTeamStageLabel(activeManagedTeam);
            const scopeLabel = teamManageStageAvailable
                ? teamManageStageScope === 'area'
                    ? ' • ข้อมูลรอบระดับเขต'
                    : ' • ข้อมูลรอบกลุ่ม'
                : '';
            teamManageStageLabel.textContent = `ระดับการแข่งขัน: ${baseLabel}${scopeLabel}`;
        }
        if (!teamManageStageSwitch) return;
        teamManageStageSwitch.classList.toggle('hidden', !teamManageStageAvailable);
        if (!teamManageStageAvailable) return;
        const buttons = teamManageStageSwitch.querySelectorAll('[data-stage-scope]');
        buttons.forEach(button => {
            const scope = button.dataset.stageScope || 'cluster';
            const isActive = scope === teamManageStageScope;
            button.classList.toggle('bg-slate-900', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('border-slate-900', isActive);
            button.classList.toggle('bg-white', !isActive);
            button.classList.toggle('text-slate-600', !isActive);
            button.classList.toggle('border-slate-300', !isActive);
        });
    }

    function handleTeamManageStageSwitch(event) {
        const target = event.target.closest('[data-stage-scope]');
        if (!target) return;
        const scope = target.dataset.stageScope || 'cluster';
        if (scope === 'area' && !teamManageStageAvailable) return;
        if (scope === teamManageStageScope) return;
        if (!teamManageEditable) {
            teamManageStageScope = scope;
            applyTeamManageStageScope(scope, { force: true });
            return;
        }
        captureTeamManageFormToData(teamManageStageScope);
        applyTeamManageStageScope(scope);
    }

    function handleManagedClassLevelValue(type, displayIndex, memberIndex) {
        if (memberIndex === undefined || memberIndex === null) return;
        const numericIndex = Number(memberIndex);
        if (Number.isNaN(numericIndex)) return;
        const value = getSelectedClassLevelValue(type, displayIndex, 'manage');
        updateManagedMember(type, numericIndex, 'class', value);
    }

    function saveManagedTeam() {
        if (!activeManagedTeam || (!teamManageEditable && !teamManageStatusEditable)) return;
        const actorPayload = buildActorPayload();
        if (!actorPayload) {
            if (teamManageFeedback) {
            teamManageFeedback.textContent = 'กรุณาเข้าสู่ระบบก่อนบันทึก';
        }
        return;
    }
        captureTeamManageFormToData();
        const scopeData = teamManageData[teamManageStageScope] || {
            teamName: activeManagedTeam.teamName || '',
            contact: {},
            members: cloneMemberCollections()
        };
        const resolvedTeamName = (scopeData.teamName || '').trim()
            || (teamManageStageScope === 'area'
                ? (teamManageData.cluster?.teamName || activeManagedTeam.teamNameCluster || activeManagedTeam.teamName || '')
                : (activeManagedTeam.teamNameCluster || activeManagedTeam.teamName || ''));
        const payload = {
            teamId: activeManagedTeam.teamId,
            teamName: resolvedTeamName,
            contact: {
                name: (scopeData.contact?.name || '').trim(),
                phone: (scopeData.contact?.phone || '').trim(),
                email: (scopeData.contact?.email || '').trim()
            },
            members: scopeData.members || { teachers: [], students: [] },
            actor: actorPayload,
            stageScope: teamManageStageScope
        };
        if (teamManageStatusEditable && teamManageStatusSelect) {
            const nextStatus = (teamManageStatusSelect.value || activeManagedTeam.status || 'Pending').trim();
            if (nextStatus) {
                payload.status = nextStatus;
            }
        }
        if (payload.status === 'Rejected') {
            const reasonValue = (teamManageStatusReasonInput?.value || '').trim();
            if (!reasonValue) {
                if (teamManageFeedback) {
                    teamManageFeedback.textContent = 'กรุณาระบุเหตุผลการไม่อนุมัติ';
                }
                return;
            }
            payload.statusReason = reasonValue;
        } else if (teamManageStatusReasonInput && teamManageStatusReasonInput.value.trim()) {
            payload.statusReason = teamManageStatusReasonInput.value.trim();
        }
        if (teamManageImageEditable) {
            if (teamManageLogoFileData) {
                payload.logoFileData = teamManageLogoFileData;
            }
            if (teamManagePhotoFileData) {
                payload.teamPhotoFileData = teamManagePhotoFileData;
            }
        }
        setTeamManageBusyState(true);
        if (teamManageFeedback) teamManageFeedback.textContent = 'กำลังบันทึก...';
        google.script.run
            .withSuccessHandler(response => {
                setTeamManageBusyState(false);
                if (response && response.success) {
                    if (teamManageFeedback) teamManageFeedback.textContent = 'บันทึกสำเร็จ';
                    loadRegisteredTeams(true);
                    closeTeamManager();
                } else if (teamManageFeedback) {
                    teamManageFeedback.textContent = (response && response.error) || 'บันทึกไม่สำเร็จ';
                }
            })
            .withFailureHandler(error => {
                setTeamManageBusyState(false);
                if (teamManageFeedback) teamManageFeedback.textContent = error.message || 'บันทึกไม่สำเร็จ';
            })
            .updateTeamMembers(payload);
    }

    function deleteActiveTeam() {
        if (!activeManagedTeam || !teamManageEditable) return;
        Swal.fire({
            icon: 'warning',
            title: 'ลบทีมนี้หรือไม่?',
            text: `ทีม ${activeManagedTeam.teamId} จะถูกลบถาวร`,
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ลบทีม'
        }).then(result => {
            if (!result.isConfirmed) return;
            const actorPayload = buildActorPayload();
            if (!actorPayload) {
                if (teamManageFeedback) teamManageFeedback.textContent = 'กรุณาเข้าสู่ระบบก่อนลบทีม';
                return;
            }
            setTeamManageBusyState(true);
            if (teamManageFeedback) teamManageFeedback.textContent = 'กำลังลบทีม...';
            google.script.run
                .withSuccessHandler(response => {
                    setTeamManageBusyState(false);
                    if (response && response.success) {
                        Swal.fire({ icon: 'success', title: 'ลบทีมแล้ว', timer: 1600, showConfirmButton: false });
                        loadRegisteredTeams(true);
                        closeTeamManager();
                    } else if (teamManageFeedback) {
                        teamManageFeedback.textContent = (response && response.error) || 'ลบทีมไม่สำเร็จ';
                    }
                })
                .withFailureHandler(error => {
                    setTeamManageBusyState(false);
                    if (teamManageFeedback) teamManageFeedback.textContent = error.message || 'ลบทีมไม่สำเร็จ';
                })
                .deleteTeam({ teamId: activeManagedTeam.teamId, actor: actorPayload });
        });
    }

    // --- School options ---
    function getRegistrationSchoolList(schools) {
        if (!Array.isArray(schools)) return [];
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) {
            return schools;
        }
        const clusterFilter = getUserClusterForFilter();
        if (level === 'group_admin' && clusterFilter) {
            return schools.filter(school => normalizeText(school.clusterId) === clusterFilter || normalizeText(school.cluster) === clusterFilter);
        }
        const userSchoolId = normalizeText(currentUser?.schoolId || currentUser?.SchoolID || '');
        if (level === 'school_admin' && userSchoolId) {
            return schools.filter(school => normalizeText(school.id) === userSchoolId);
        }
        if (userSchoolId) {
            return schools.filter(school => normalizeText(school.id) === userSchoolId);
        }
        return schools;
    }

    function normalizeRegistrationModeClient(mode) {
        const raw = normalizeText(mode || '');
        if (raw === 'group' || raw === 'group_assigned' || raw === 'assigned') {
            return 'group_assigned';
        }
        return 'self';
    }

    function getCurrentUserSchoolInfo() {
        if (!currentUser) return null;
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        return getSchoolInfoById(schoolId) || getSchoolInfoByName(currentUser.schoolName || '');
    }

    function getAllowedActivityIdSet() {
        if (!currentUser) return null;
        const level = getCurrentUserLevel();
        if (['admin', 'area', 'group_admin', 'score'].includes(level)) {
            return null;
        }
        const schoolInfo = getCurrentUserSchoolInfo();
        if (!schoolInfo) return null;
        const mode = normalizeRegistrationModeClient(schoolInfo.registrationMode);
        if (mode !== 'group_assigned') {
            return null;
        }
        const assigned = Array.isArray(schoolInfo.assignedActivities) ? schoolInfo.assignedActivities : [];
        const set = new Set();
        assigned.forEach(id => {
            const key = normalizeText(id);
            if (key) set.add(key);
        });
        return set;
    }

    function filterActivitiesForCurrentUser(activities) {
        const allowedSet = getAllowedActivityIdSet();
        if (!(allowedSet instanceof Set)) return activities;
        if (!allowedSet.size) return [];
        return activities.filter(activity => allowedSet.has(normalizeText(activity.id || '')));
    }

    function canCurrentUserSelectActivity(activityId) {
        const allowedSet = getAllowedActivityIdSet();
        if (!(allowedSet instanceof Set)) return true;
        if (!allowedSet.size) return false;
        return allowedSet.has(normalizeText(activityId || ''));
    }

    function getAssignedActivityNames(activityIds) {
        if (!Array.isArray(activityIds) || !activityIds.length) return [];
        return activityIds.map(id => {
            const key = normalizeText(id);
            if (!key) return '';
            const match = ALL_ACTIVITIES.find(act => normalizeText(act.id) === key);
            return match ? match.name : id;
        }).filter(Boolean);
    }

    function extractSchoolIdentifiers(value) {
        const raw = (value || '').toString().trim();
        if (!raw) return { id: '', name: '' };
        const idMatch = raw.match(/\[([^\]]+)\]/);
        const id = idMatch ? idMatch[1].trim() : '';
        const name = idMatch ? raw.replace(idMatch[0], '').trim() : raw;
        return { id, name };
    }

    function isSchoolAllowedForCurrentUser(schoolName) {
        if (!currentUser) return true;
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) return true;
        const allowedSchools = getRegistrationSchoolList(SCHOOL_OPTIONS);
        if (!allowedSchools.length) return true;
        const identifiers = extractSchoolIdentifiers(schoolName);
        const normalizedInputName = normalizeText(identifiers.name || schoolName);
        const normalizedInputId = normalizeText(identifiers.id);
        return allowedSchools.some(school => {
            const nameMatch = normalizeText(school.name) === normalizedInputName;
            const idMatch = normalizedInputId && normalizeText(school.id) === normalizedInputId;
            return nameMatch || idMatch;
        });
    }

    function applySchoolOptions(schools) {
        SCHOOL_LOOKUP_BY_NAME = new Map();
        SCHOOL_LOOKUP_BY_ID = new Map();
        if (Array.isArray(schools)) {
            schools.forEach(school => {
                const nameKey = normalizeText(school?.name);
                if (nameKey) {
                    SCHOOL_LOOKUP_BY_NAME.set(nameKey, school);
                }
                const idKey = normalizeText(school?.id);
                if (idKey) {
                    SCHOOL_LOOKUP_BY_ID.set(idKey, school);
                }
            });
        }
        updateSchoolClusterLookup(schools);
        if (schoolOptionsList) {
            schoolOptionsList.innerHTML = '';
            const registrationSchools = getRegistrationSchoolList(schools);
            registrationSchools.forEach(school => {
                if (!school || !school.name) return;
                const option = document.createElement('option');
                option.value = school.name;
                const parts = [];
                if (school.id) parts.push(`[${school.id}]`);
                parts.push(school.name);
                const clusterLabel = school.clusterName || school.cluster;
                if (clusterLabel) parts.push(`(${clusterLabel})`);
                option.label = parts.join(' ');
                option.dataset.schoolId = school.id || '';
                option.dataset.schoolCluster = school.clusterId || school.cluster || '';
                option.dataset.schoolClusterName = clusterLabel || '';
                schoolOptionsList.appendChild(option);
            });
        }
        const hasSchools = Array.isArray(schools) && schools.length > 0;
        populateSchoolSelectElement(authSchoolSelect, hasSchools ? schools : [], {
            placeholderText: hasSchools ? '-- เลือกโรงเรียน --' : '-- ไม่พบข้อมูลโรงเรียน --'
        });
        applyUserSchoolToForm();
        const ensureProfileValue = currentUser?.schoolId || currentUser?.SchoolID || '';
        populateSchoolSelectElement(profileSchoolSelect, schools, {
            placeholderText: '-- เลือกโรงเรียน --',
            ensureValue: ensureProfileValue
        });
        populateSchoolSelectElement(navSignupSchoolSelect, schools, {
            placeholderText: '-- เลือกโรงเรียน --'
        });
        refreshUserFormSchoolOptions();
        updateProfileSection();
        updateRegistrationAssignmentNotice();
        updateHomeActivities({ resetVisibleCount: true });
        if (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            populateUploadTeamSelect(ALL_TEAMS);
        }
    }

    function loadSchoolOptions(force = false) {
        if (!schoolOptionsList && !authSchoolSelect && !profileSchoolSelect) return;
        const now = Date.now();
        if (!force && SCHOOL_OPTIONS.length > 0 && (now - lastSchoolFetch) < SCHOOL_FETCH_COOLDOWN_MS) {
            applySchoolOptions(SCHOOL_OPTIONS);
            return;
        }
        if (isLoadingSchools) return;
        isLoadingSchools = true;
        google.script.run
            .withSuccessHandler(schools => {
                isLoadingSchools = false;
                if (schools && !schools.error && Array.isArray(schools)) {
                    SCHOOL_OPTIONS = schools;
                    lastSchoolFetch = Date.now();
                    applySchoolOptions(SCHOOL_OPTIONS);
                }
            })
            .withFailureHandler(error => {
                isLoadingSchools = false;
                console.error('โหลดรายชื่อโรงเรียนผิดพลาด', error);
            })
            .getSchoolList();
    }

    // --- Navigation & steps ---
    function navigateTo(sectionId, clickedItem = null) {
        closeProfileMenu();
        sections.forEach(s => s.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            window.scrollTo(0, 0);
        }
        navItems.forEach(i => i.classList.remove('active'));
        if (clickedItem) {
            clickedItem.classList.add('active');
        } else {
            const match = document.querySelector(`.nav-item[onclick*="'${sectionId}'"]`);
            if (match) match.classList.add('active');
        }
        if (sectionId === 'section-teams' && ALL_TEAMS.length === 0) loadRegisteredTeams();
        if (sectionId === 'section-report') {
            if (!Array.isArray(ALL_TEAMS) || ALL_TEAMS.length === 0) {
                loadRegisteredTeams();
            } else {
                refreshReportUserSummary();
            }
            loadReportData();
            updateReportManagementVisibility();
            if (canViewUserManagement()) loadUserManagementData();
            if (canViewSchoolManagement()) loadSchoolManagementData();
        }
        if (sectionId === 'section-admin') loadFilesForReview();
    }

    function nextStep(stepNumber) {
        if (!requireLoginForRegistration()) return;
        const current = CURRENT_STEP;
        if (!validateStep(current)) return;
        CURRENT_STEP = stepNumber;
        updateFormStepUI();
    }
    function prevStep(stepNumber) {
        CURRENT_STEP = stepNumber;
        updateFormStepUI();
    }
    function updateFormStepUI() {
        formSteps.forEach((step, index) => {
            step.classList.toggle('active', (index + 1) === CURRENT_STEP);
        });
        stepIndicators.forEach((indicator, index) => {
            const circle = indicator.querySelector('div');
            const label = indicator.querySelector('p');
            if ((index + 1) < CURRENT_STEP) {
                circle.classList.add('bg-green-500', 'text-white');
                circle.classList.remove('bg-slate-300', 'text-slate-600', 'bg-sky-500');
                label.classList.add('text-green-600');
                label.classList.remove('text-slate-500', 'text-sky-600');
            } else if ((index + 1) === CURRENT_STEP) {
                circle.classList.add('bg-sky-500', 'text-white');
                circle.classList.remove('bg-slate-300', 'text-slate-600', 'bg-green-500');
                label.classList.add('text-sky-600');
                label.classList.remove('text-slate-500', 'text-green-600');
            } else {
                circle.classList.add('bg-slate-300', 'text-slate-600');
                circle.classList.remove('bg-sky-500', 'bg-green-500', 'text-white');
                label.classList.add('text-slate-500');
                label.classList.remove('text-sky-600', 'text-green-600');
            }
        });
        if (CURRENT_STEP === 2) {
            applyUserContactToForm();
        }
    }

    // --- Data loading ---
    function loadInitialData(force = false) {
        const now = Date.now();
        if (isLoadingActivities) return;
        if (!force && lastActivitiesFetch && (now - lastActivitiesFetch) < FETCH_COOLDOWN_MS) {
            updateHomeActivities();
            return;
        }
        isLoadingActivities = true;
        showLoading();
        google.script.run
            .withSuccessHandler(activities => {
                lastActivitiesFetch = Date.now();
                isLoadingActivities = false;
                onActivitiesLoaded(activities);
            })
            .withFailureHandler(error => {
                isLoadingActivities = false;
                handleError(error);
            })
            .getActivities();

        google.script.run
            .withSuccessHandler(isAdmin => {
                isAppAdmin = Boolean(isAdmin);
                refreshProfileMenuState();
            })
            .withFailureHandler(err => console.error("Admin check failed:", err))
            .isAdmin();
    }

    function onActivitiesLoaded(activities) {
        hideLoading();
        if (activities.error) {
            activityLoading.innerText = 'เกิดข้อผิดพลาด: ' + activities.error;
            return;
        }
        const previousActivityId = activitySelect.value;
        ALL_ACTIVITIES = activities;
        renderGroupedActivityCards(activities);
        populateActivityFilters(activities);
        const categories = getAllCategories(activities);
        renderHomeCategoryFilter(categories);
        populateFormCategorySelect(categories);
        populateFormActivitySelect(getFormActivities());
        updateHomeActivities({ resetVisibleCount: true });

        if (previousActivityId) {
            const selectedActivity = ALL_ACTIVITIES.find(a => a.id === previousActivityId);
            if (selectedActivity && !isActivityClosed(selectedActivity)) {
                activitySelect.value = previousActivityId;
                updateFormBasedOnActivity(previousActivityId);
            } else {
                activitySelect.value = '';
                updateFormBasedOnActivity('');
            }
        } else {
            updateFormBasedOnActivity('');
        }
        updateActivityView();
    }

    function loadRegisteredTeams(force = false) {
        const now = Date.now();
        if (isLoadingTeams) return;
        if (!force && lastTeamsFetch && (now - lastTeamsFetch) < FETCH_COOLDOWN_MS && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            return;
        }
        isLoadingTeams = true;
        renderTeamTableSkeleton();
        if (currentUser) {
            showProfileTeamsLoadingState();
        }
        showLoading();
        google.script.run
            .withSuccessHandler(teams => {
                lastTeamsFetch = Date.now();
                isLoadingTeams = false;
                onTeamsLoaded(teams);
            })
            .withFailureHandler(error => {
                isLoadingTeams = false;
                handleError(error);
            })
            .getRegisteredTeams();
    }

    function onTeamsLoaded(teams) {
        hideLoading();
        if (teams.error) {
            teamTableBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-red-500">เกิดข้อผิดพลาด: ${teams.error}</td></tr>`;
            return;
        }
        ALL_TEAMS = teams;
        refreshSchoolRepresentativeStats();
        renderTeamTable(teams);
        populateUploadTeamSelect(teams);
        refreshActivityTeamCounts();
        updateProfileSection();
        if (currentUser) {
            loadJudgeAssignments();
        }
        refreshReportUserSummary();
        if (latestReportData) {
            renderClusterLeaderboard(latestReportData);
        }
    }

    function canUseAreaTransferTools() {
        if (!currentUser) return false;
        const level = getCurrentUserLevel();
        return AREA_TRANSFER_ALLOWED_ROLES.includes(level);
    }

    function getTransferableAreaTeams() {
        if (!currentUser || !Array.isArray(ALL_TEAMS) || !ALL_TEAMS.length) return [];
        const scopedTeams = filterTeamsForCurrentUser(ALL_TEAMS);
        if (!scopedTeams.length) return [];
        return scopedTeams.filter(team => isTeamRepresentative(team) && team.teamId);
    }

    function updateAreaTransferButtonState() {
        if (!areaTransferButton) return;
        const canUse = canUseAreaTransferTools();
        const hasRepresentatives = getTransferableAreaTeams().length > 0;
        const shouldShow = canUse && hasRepresentatives;
        areaTransferButton.classList.toggle('hidden', !shouldShow);
        const disabled = !canUse || !hasRepresentatives || isAreaTransferInProgress;
        areaTransferButton.disabled = disabled;
        areaTransferButton.classList.toggle('opacity-50', disabled);
        areaTransferButton.classList.toggle('cursor-not-allowed', disabled);
    }

    function getAreaTransferProgressTemplate(total) {
        return `
            <div class="space-y-3">
                <p class="text-sm text-slate-600">กำลังโอนข้อมูลทีมตัวแทน...</p>
                <div class="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
                    <div id="area-transfer-progress-bar" class="h-full bg-sky-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <p class="text-xs text-slate-500">
                    <span id="area-transfer-progress-current">0</span>
                    /
                    <span id="area-transfer-progress-total">${total}</span>
                    ทีม
                    <span id="area-transfer-progress-percent">(0%)</span>
                </p>
            </div>
        `;
    }

    function transferAreaChunk(teamIds, actor) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(result => resolve(result))
                .withFailureHandler(error => reject(error))
                .transferRepresentativeAreaData({
                    teamIds,
                    actor
                });
        });
    }

    async function handleAreaTransferClick(event) {
        if (event) event.preventDefault();
        if (isAreaTransferInProgress) return;
        updateAreaTransferButtonState();
        if (!canUseAreaTransferTools()) {
            Swal.fire({ icon: 'warning', title: 'ไม่สามารถโอนข้อมูลได้', text: 'คุณไม่มีสิทธิ์ในขั้นตอนนี้' });
            return;
        }
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถดำเนินการได้' });
            return;
        }
        const candidates = getTransferableAreaTeams();
        if (!candidates.length) {
            Swal.fire({ icon: 'info', title: 'ไม่พบทีมตัวแทน', text: 'ไม่มีทีมตัวแทนในสิทธิ์ของคุณสำหรับการโอนข้อมูล' });
            return;
        }
        const { isConfirmed } = await Swal.fire({
            icon: 'question',
            title: 'ยืนยันการโอนข้อมูล?',
            text: `ระบบจะโอนข้อมูลทีมตัวแทน ${candidates.length} ทีมไปยังข้อมูลระดับเขต`,
            showCancelButton: true,
            confirmButtonText: 'เริ่มโอนข้อมูล',
            cancelButtonText: 'ยกเลิก'
        });
        if (!isConfirmed) return;
        const teamIds = candidates.map(team => team.teamId).filter(Boolean);
        if (!teamIds.length) {
            Swal.fire({ icon: 'info', title: 'ไม่พบรหัสทีม', text: 'ไม่พบรหัสทีมที่สามารถโอนได้' });
            return;
        }
        try {
            isAreaTransferInProgress = true;
            updateAreaTransferButtonState();
            const batches = [];
            for (let i = 0; i < teamIds.length; i += AREA_TRANSFER_BATCH_SIZE) {
                batches.push(teamIds.slice(i, i + AREA_TRANSFER_BATCH_SIZE));
            }
            let processed = 0;
            let updatedTotal = 0;
            Swal.fire({
                title: 'กำลังโอนข้อมูล...',
                html: getAreaTransferProgressTemplate(teamIds.length),
                allowOutsideClick: false,
                showConfirmButton: false
            });
            const updateProgressDisplay = () => {
                const container = Swal.getHtmlContainer();
                if (!container) return;
                const percent = teamIds.length ? Math.round((processed / teamIds.length) * 100) : 100;
                const bar = container.querySelector('#area-transfer-progress-bar');
                const currentEl = container.querySelector('#area-transfer-progress-current');
                const totalEl = container.querySelector('#area-transfer-progress-total');
                const percentEl = container.querySelector('#area-transfer-progress-percent');
                if (bar) bar.style.width = `${percent}%`;
                if (currentEl) currentEl.textContent = processed;
                if (totalEl) totalEl.textContent = teamIds.length;
                if (percentEl) percentEl.textContent = `(${percent}%)`;
            };
            updateProgressDisplay();
            for (const chunk of batches) {
                const result = await transferAreaChunk(chunk, actor);
                if (!result || result.success !== true) {
                    throw new Error(result?.error || 'ไม่สามารถโอนข้อมูลได้');
                }
                const processedCount = typeof result.total === 'number' ? result.total : chunk.length;
                processed = Math.min(processed + processedCount, teamIds.length);
                updatedTotal += result.updated || 0;
                updateProgressDisplay();
            }
            Swal.close();
            Swal.fire({
                icon: 'success',
                title: 'โอนข้อมูลสำเร็จ',
                text: `โอนข้อมูลแล้ว ${updatedTotal} / ${teamIds.length} ทีม`
            });
            loadRegisteredTeams(true);
        } catch (error) {
            console.error(error);
            Swal.close();
            Swal.fire({
                icon: 'error',
                title: 'โอนข้อมูลไม่สำเร็จ',
                text: (error && error.message) || 'ไม่สามารถโอนข้อมูลได้'
            });
        } finally {
            isAreaTransferInProgress = false;
            updateAreaTransferButtonState();
        }
    }

    function populateUploadTeamSelect(teams) {
        if (!uploadTeamIdSelect) return;
        const userId = getCurrentUserId();
        if (!userId) {
            uploadTeamIdSelect.innerHTML = '<option value="">-- กรุณาเข้าสู่ระบบเพื่อเลือกทีม --</option>';
            return;
        }
        const userTeams = filterTeamsForCurrentUser(teams);
        if (!userTeams.length) {
            uploadTeamIdSelect.innerHTML = '<option value="">-- ไม่มีทีมในสิทธิ์ของคุณ --</option>';
            return;
        }
        uploadTeamIdSelect.innerHTML = '<option value="">-- กรุณาเลือกรหัสทีม --</option>';
        userTeams.forEach(team => {
            const activityObj = ALL_ACTIVITIES.find(a => a.id === team.activity);
            const activityName = activityObj ? activityObj.name : team.activity;
            uploadTeamIdSelect.innerHTML += `<option value="${team.teamId}">${team.teamId} - ${activityName} (${team.teamName || 'N/A'})</option>`;
        });
    }

    function loadReportData(force = false) {
        const now = Date.now();
        if (!force && cachedReport && lastReportFetch && (now - lastReportFetch) < FETCH_COOLDOWN_MS) {
            onReportLoaded(cachedReport);
            return;
        }
        if (isLoadingReport) return;

        isLoadingReport = true;
        reportTableBody.innerHTML = '<div class="p-4 text-center text-slate-500 border border-dashed border-slate-200 rounded-xl">กำลังโหลดข้อมูลรายงาน...</div>';
        document.getElementById('report-total-teams').innerText = '...';
        document.getElementById('report-total-teachers').innerText = '...';
        document.getElementById('report-total-students').innerText = '...';
        document.getElementById('report-total-all').innerText = '...';
        latestReportData = null;
        updateScoreDutySummary(null);
        refreshReportUserSummary();
        resetCompetitionResultsUI();
        resetClusterLeaderboard();
        updateReportTotalsVisibility();

        showLoading();
        const actorPayload = buildActorPayload();
        google.script.run
            .withSuccessHandler(report => {
                isLoadingReport = false;
                if (report && !report.error) {
                    cachedReport = report;
                    lastReportFetch = Date.now();
                } else {
                    cachedReport = null;
                }
                onReportLoaded(report);
            })
            .withFailureHandler(error => {
                isLoadingReport = false;
                releaseScoreDutyBlockIfPending();
                resetScoreDutyFocusIntent();
                handleError(error);
            })
            .getReportData({ actor: actorPayload });
    }

    function onReportLoaded(report) {
        hideLoading();
        scoreDutyFocusReady = false;
        if (!report) {
            reportTableBody.innerHTML = '<div class="p-4 text-center text-red-500 border border-dashed border-red-200 rounded-xl">ไม่สามารถโหลดข้อมูลรายงานได้</div>';
            refreshReportUserSummary();
            updateScoreDutySummary(null);
            resetCompetitionResultsUI();
            resetClusterLeaderboard();
            releaseScoreDutyBlockIfPending();
            resetScoreDutyFocusIntent();
            return;
        }
        if (report.error) {
            reportTableBody.innerHTML = `<div class="p-4 text-center text-red-500 border border-dashed border-red-200 rounded-xl">เกิดข้อผิดพลาด: ${report.error}</div>`;
            refreshReportUserSummary();
            updateScoreDutySummary(null);
            resetCompetitionResultsUI();
            resetClusterLeaderboard();
            releaseScoreDutyBlockIfPending();
            resetScoreDutyFocusIntent();
            return;
        }
        latestReportData = report;
        if (pendingScoreDutyFocusId && scoreDutyFocusPending) {
            scoreDutyFocusReady = true;
        }
        const useScoped = shouldUseScopedReportSummary();
        const baseTotals = useScoped && report.userTotals ? report.userTotals : report.totals;
        const displayTotals = getClusterTotalsForDisplay(report, baseTotals);
        applyReportTotals(displayTotals);
        refreshReportUserSummary(report.userTotals || null);
        updateScoreDutySummary(report);
        updateReportTotalsVisibility();
        if (report?.competitionStage) {
            updateCompetitionStageState(report.competitionStage, { skipSchoolRender: true });
        }
        updateCompetitionResultsUI(report);
        renderClusterLeaderboard(report);
        renderClusterActivitySummary(report);
    }

    function updateCompetitionStageState(stage, options = {}) {
        const normalized = normalizeCompetitionStageClient(stage);
        const previous = competitionStage;
        competitionStage = normalized;
        hasCompetitionStageInfo = true;
        updateCompetitionStageUI();
        updateAreaScoreCard();
        if (
            options.skipSchoolRender !== true &&
            previous !== normalized &&
            Array.isArray(MANAGED_SCHOOLS) &&
            MANAGED_SCHOOLS.length
        ) {
            renderSchoolManagement(MANAGED_SCHOOLS);
        }
    }

    function updateCompetitionStageUI() {
        const label = getCompetitionStageLabel(competitionStage);
        if (competitionStageStatus) {
            const loadingText = competitionStageStatus.dataset?.loadingText || 'กำลังโหลดสถานะรอบการแข่งขัน...';
            competitionStageStatus.textContent = hasCompetitionStageInfo ? `ขณะนี้ระบบอยู่ใน${label}` : loadingText;
        }
        if (competitionStageNote && hasCompetitionStageInfo) {
            competitionStageNote.textContent = getCompetitionStageNote(competitionStage);
        }
        const canManageStage = canManageCompetitionStage();
        const showControls = canManageStage && hasCompetitionStageInfo;
        if (competitionStageControls) {
            competitionStageControls.classList.toggle('hidden', !showControls);
        }
        if (competitionStageSelect) {
            competitionStageSelect.value = competitionStage;
            competitionStageSelect.disabled = !showControls || isSavingCompetitionStage;
        }
        if (competitionStageSaveBtn) {
            competitionStageSaveBtn.disabled = !showControls || isSavingCompetitionStage;
            competitionStageSaveBtn.classList.toggle('opacity-60', isSavingCompetitionStage);
            if (isSavingCompetitionStage) {
                competitionStageSaveBtn.innerHTML = `
                    <span class="inline-flex h-4 w-4 items-center justify-center">
                        <span class="h-4 w-4 border-2 border-white/70 border-t-transparent rounded-full animate-spin"></span>
                    </span>
                    <span>กำลังบันทึก...</span>
                `;
            } else {
                competitionStageSaveBtn.innerHTML = competitionStageSaveDefault || '<span class="material-symbols-outlined text-base">save</span><span>บันทึก</span>';
            }
        }
        refreshStageAwareUI();
    }

    function handleCompetitionStageSave() {
        if (!competitionStageSelect || !canManageCompetitionStage() || isSavingCompetitionStage) return;
        const selectedStage = normalizeCompetitionStageClient(competitionStageSelect.value);
        if (hasCompetitionStageInfo && selectedStage === competitionStage) {
            Swal.fire({ icon: 'info', title: 'ไม่มีการเปลี่ยนแปลง', text: `ระบบอยู่ใน${getCompetitionStageLabel(selectedStage)}อยู่แล้ว` });
            return;
        }
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถบันทึกได้' });
            return;
        }
        isSavingCompetitionStage = true;
        updateCompetitionStageUI();
        Swal.fire({
            title: 'กำลังบันทึกรอบการแข่งขัน...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });
        google.script.run
            .withSuccessHandler(res => {
                isSavingCompetitionStage = false;
                Swal.close();
                if (res && res.success) {
                    updateCompetitionStageState(res.stage || selectedStage);
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                    loadReportData(true);
                } else {
                    const message = (res && res.error) || 'ไม่สามารถอัปเดตรอบการแข่งขันได้';
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                }
                updateCompetitionStageUI();
            })
            .withFailureHandler(error => {
                isSavingCompetitionStage = false;
                Swal.close();
                const message = error.message || 'ไม่สามารถอัปเดตรอบการแข่งขันได้';
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                updateCompetitionStageUI();
            })
            .updateCompetitionStage({ stage: selectedStage, actor });
    }

    function loadCompetitionSettings() {
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    updateCompetitionStageState(response.stage || 'cluster');
                } else {
                    hasCompetitionStageInfo = true;
                    updateCompetitionStageUI();
                }
            })
            .withFailureHandler(() => {
                hasCompetitionStageInfo = true;
                updateCompetitionStageUI();
            })
            .getCompetitionSettings();
    }

    function canViewUserManagement() {
        const level = getCurrentUserLevel();
        return currentUser && ['admin', 'area', 'group_admin', 'school_admin'].includes(level);
    }

    function canViewSchoolManagement() {
        return canViewUserManagement();
    }

    function canEditActivities() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function canManageUsersClient() {
        return canViewUserManagement();
    }

    function canEditSchoolCluster() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function canEditSchoolRegistrationMode() {
        const level = getCurrentUserLevel();
        if (level === 'group_admin') {
            return hasCompetitionStageInfo && competitionStage === 'cluster';
        }
        return level === 'admin' || level === 'area';
    }

    function canAssignActivitiesToSchool(school) {
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) return true;
        if (level === 'group_admin' && school) {
            const schoolCluster = normalizeText(school.clusterId || school.cluster);
            const userCluster = getUserClusterForFilter();
            return Boolean(userCluster) && schoolCluster === userCluster;
        }
        return false;
    }

    function getAssignableSchoolsForUserForm() {
        if (Array.isArray(MANAGED_SCHOOLS) && MANAGED_SCHOOLS.length) {
            return MANAGED_SCHOOLS;
        }
        if (Array.isArray(SCHOOL_OPTIONS) && SCHOOL_OPTIONS.length) {
            return SCHOOL_OPTIONS;
        }
        return [];
    }

    function refreshUserFormSchoolOptions() {
        if (!userFormSchoolSelect) return;
        const schools = getAssignableSchoolsForUserForm();
        populateSchoolSelectElement(userFormSchoolSelect, schools, {
            placeholderText: schools.length ? '-- เลือกโรงเรียน --' : '-- ไม่พบข้อมูลโรงเรียน --'
        });
    }

    function updateUserManagementControls() {
        const canManage = Boolean(currentUser) && canManageUsersClient();
        if (userManagementActions) {
            userManagementActions.classList.toggle('hidden', !canManage);
        }
        if (!canManage) {
            hideUserManagementForm();
        }
    }

    function updateUserFormLevelOptions(selectedLevel = 'User') {
        if (!userFormLevel) return;
        const level = getCurrentUserLevel();
        const allowedMap = {
            admin: ['User', 'School_Admin', 'Group_Admin', 'Score', 'Area', 'Admin'],
            area: ['User', 'School_Admin', 'Group_Admin', 'Score', 'Area'],
            group_admin: ['User', 'School_Admin'],
            school_admin: ['User']
        };
        const allowed = allowedMap[level] || ['User'];
        Array.from(userFormLevel.options).forEach(option => {
            const value = option.value || option.text;
            option.disabled = !allowed.includes(value);
        });
        if (allowed.includes(selectedLevel)) {
            userFormLevel.value = selectedLevel;
        } else {
            userFormLevel.value = allowed[0] || 'User';
        }
    }

    function updateReportManagementVisibility() {
        if (!reportManagementWrapper) return;
        const shouldShow = Boolean(currentUser) && (canViewUserManagement() || canViewSchoolManagement());
        reportManagementWrapper.classList.toggle('hidden', !shouldShow);
        updateUserManagementControls();
        if (!shouldShow) {
            if (userManagementStatus) userManagementStatus.textContent = 'เฉพาะผู้ใช้ที่มีสิทธิ์';
            if (userManagementContent) userManagementContent.innerHTML = '';
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'เฉพาะผู้ใช้ที่มีสิทธิ์';
            if (schoolManagementContent) schoolManagementContent.innerHTML = '';
        }
        renderScoreAssignmentPanel();
    }

    function loadUserManagementData(force = false) {
        if (!canViewUserManagement()) {
            MANAGED_USERS = [];
            renderUserManagement([]);
            return;
        }
        if (isLoadingManagedUsers && !force) return;
        const actor = buildActorPayload();
        if (!actor) {
            if (userManagementStatus) userManagementStatus.textContent = 'กรุณาเข้าสู่ระบบ';
            return;
        }
        isLoadingManagedUsers = true;
        managedUsersLoadAttempted = true;
        if (userManagementStatus) userManagementStatus.textContent = 'กำลังโหลดข้อมูลผู้ใช้...';
        userManagementContent && (userManagementContent.innerHTML = '');
        google.script.run
            .withSuccessHandler(res => {
                isLoadingManagedUsers = false;
                if (res && res.success) {
                    hasLoadedManagedUsers = true;
                    MANAGED_USERS = Array.isArray(res.users) ? res.users : [];
                    renderUserManagement(MANAGED_USERS);
                } else {
                    hasLoadedManagedUsers = false;
                    if (userManagementStatus) userManagementStatus.textContent = (res && res.error) || 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้';
                    renderScoreAssignmentPanel();
                }
            })
            .withFailureHandler(error => {
                isLoadingManagedUsers = false;
                hasLoadedManagedUsers = false;
                if (userManagementStatus) userManagementStatus.textContent = error.message || 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้';
                renderScoreAssignmentPanel();
            })
            .getManagedUsers({ actor });
    }

    function renderUserTableRows(users, { showActions = false, hideClusterColumn = false } = {}) {
        return users.map(user => {
            const actionCell = showActions ? renderManagedUserActionsCell(user) : '';
            const fullName = `${user.name || ''} ${user.surname || ''}`.trim() || user.username || '-';
            const roleClass = getRoleRowClass(user.level);
            const schoolId = getUserSchoolId(user);
            const schoolInfo = getSchoolInfoById(schoolId) || getSchoolInfoByName(schoolId);
            const schoolName = schoolInfo?.name || user.schoolName || user.school || schoolId || '-';
            const clusterLabel = getUserClusterLabel(user) || '-';
            const clusterCell = hideClusterColumn
                ? ''
                : `<td class="p-2 text-slate-600">${escapeHtmlClient(clusterLabel)}</td>`;
            const phoneDisplay = formatDisplayPhone(user.tel || '');
            return `
                <tr class="border-b last:border-0 ${roleClass}">
                    <td class="p-2 text-slate-700 font-semibold">${escapeHtmlClient(user.username || '-')}</td>
                    <td class="p-2 text-slate-600">
                        <div>${escapeHtmlClient(fullName)}</div>
                        <div class="mt-1">${getRoleBadgeHtml(user.level)}</div>
                    </td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(schoolName)}</td>
                    ${clusterCell}
                    <td class="p-2 text-slate-600 break-all">${escapeHtmlClient(user.email || '-')}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(phoneDisplay || '-')}</td>
                    ${actionCell}
                </tr>
            `;
        }).join('');
    }

    function getManagedUserActionButtons(user, inline = false) {
        if (!canManageUsersClient()) return '';
        const recordId = (user?.userId || user?.userid || '').toString();
        if (!recordId) return '';
        const safeId = escapeHtmlClient(recordId);
        const isSelf = normalizeText(recordId) === normalizeText(getCurrentUserId());
        const editButton = `
            <button type="button"
                class="text-sky-600 hover:text-sky-800"
                data-user-action="edit-user"
                data-user-id="${safeId}">
                แก้ไข
            </button>`;
        const deleteButton = isSelf
            ? ''
            : `
            <button type="button"
                class="text-red-500 hover:text-red-600"
                data-user-action="delete-user"
                data-user-id="${safeId}">
                ลบ
            </button>`;
        const containerClass = inline
            ? 'flex flex-wrap gap-2 text-xs font-semibold mt-1'
            : 'flex justify-end gap-2 text-xs font-semibold';
        return `<div class="${containerClass}">
            ${editButton}
            ${deleteButton}
        </div>`;
    }

    function renderManagedUserActionsCell(user) {
        const actions = getManagedUserActionButtons(user);
        if (!actions) {
            return '<td class="p-2 text-right text-xs text-slate-400">-</td>';
        }
        return `<td class="p-2 text-right">${actions}</td>`;
    }

    function renderUserManagement(users) {
        if (!userManagementContent) return;
        if (!canViewUserManagement()) {
            userManagementSearchTerm = '';
            if (userManagementSearchInput) {
                userManagementSearchInput.value = '';
                userManagementSearchInput.disabled = true;
            }
            if (userManagementStatus) userManagementStatus.textContent = 'ยังไม่มีสิทธิ์เข้าถึงเมนูนี้';
            if (userManagementClusterNote) {
                userManagementClusterNote.classList.add('hidden');
                userManagementClusterNote.textContent = '';
            }
            userManagementContent.innerHTML = '';
            return;
        }
        if (userManagementSearchInput) {
            userManagementSearchInput.disabled = false;
        }
        if (isLoadingManagedUsers) {
            userManagementContent.innerHTML = `
                <div class="animate-pulse space-y-2">
                    <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                    <div class="h-3 bg-slate-100 rounded w-full"></div>
                    <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                </div>
            `;
            return;
        }
        const level = getCurrentUserLevel();
        if (userManagementClusterNote) {
            if (level === 'group_admin') {
                const clusterLabel = getCurrentUserClusterLabel() || 'กลุ่มเครือข่ายของคุณ';
                userManagementClusterNote.textContent = `เครือข่ายที่คุณดูแล: ${clusterLabel}`;
                userManagementClusterNote.classList.remove('hidden');
            } else {
                userManagementClusterNote.classList.add('hidden');
            }
        }
        const clusterFilterRaw = level === 'group_admin' ? getUserClusterForFilter() : '';
        const clusterFilter = normalizeText(clusterFilterRaw);
        const schoolFilter = level === 'school_admin'
            ? normalizeText(currentUser?.schoolId || currentUser?.SchoolID || '')
            : '';
        let scopedUsers = Array.isArray(users) ? users.slice() : [];
        if (level === 'group_admin') {
            scopedUsers = clusterFilter
                ? scopedUsers.filter(user => getUserClusterKey(user) === clusterFilter)
                : [];
        } else if (level === 'school_admin') {
            scopedUsers = schoolFilter
                ? scopedUsers.filter(user => normalizeText(getUserSchoolId(user)) === schoolFilter)
                : [];
        }
        if (!Array.isArray(scopedUsers) || scopedUsers.length === 0) {
            if (userManagementStatus) userManagementStatus.textContent = 'ไม่พบผู้ใช้ในสิทธิ์ของคุณ';
            userManagementContent.innerHTML = '<p class="text-slate-500 text-sm">ยังไม่มีรายการผู้ใช้ให้แสดง</p>';
            return;
        }
        const searchValue = normalizeText(userManagementSearchTerm);
        const visibleUsers = searchValue
            ? scopedUsers.filter(user => matchesUserManagementSearch(user, searchValue))
            : scopedUsers.slice();
        if (!visibleUsers.length) {
            const message = userManagementSearchTerm
                ? `ไม่พบผู้ใช้ที่ตรงกับ "${escapeHtmlClient(userManagementSearchTerm)}"`
                : 'ไม่พบผู้ใช้ในสิทธิ์ของคุณ';
            if (userManagementStatus) userManagementStatus.textContent = message;
            userManagementContent.innerHTML = '<p class="text-slate-500 text-sm">' + message + '</p>';
            return;
        }
        const showActions = canManageUsersClient();
        const levelGroups = new Map();
        visibleUsers.forEach(user => {
            const levelKey = normalizeText(user.level) || 'user';
            if (!levelGroups.has(levelKey)) levelGroups.set(levelKey, []);
            levelGroups.get(levelKey).push(user);
        });
        const hideClusterColumn = level === 'group_admin';
        const accordions = Array.from(levelGroups.entries())
            .sort((a, b) => {
                const labelA = getRoleDisplayName(a[0]) || a[0];
                const labelB = getRoleDisplayName(b[0]) || b[0];
                return labelA.localeCompare(labelB, 'th');
            })
            .map(([levelKey, list], index) =>
                renderUserRoleAccordion(levelKey, list, showActions, index === 0, { hideClusterColumn })
            )
            .join('');
        userManagementContent.innerHTML = accordions;
        if (userManagementStatus) {
            const summaryLabel = searchValue
                ? `ผลการค้นหา ${visibleUsers.length} คน`
                : `พบผู้ใช้ทั้งหมด ${visibleUsers.length} คน (จำแนกตามสิทธิ์)`;
            userManagementStatus.textContent = summaryLabel;
        }
    }

    function matchesUserManagementSearch(user, term) {
        if (!user) return false;
        const targets = [
            user.username,
            user.name,
            user.surname,
            user.school,
            user.SchoolID,
            `${user.name || ''} ${user.surname || ''}`,
            user.email
        ];
        return targets.some(value => {
            const text = normalizeText(value);
            return text && text.includes(term);
        });
    }

    function getUserSchoolId(user) {
        if (!user) return '';
        return (user.schoolId || user.SchoolID || user.school || '').toString().trim();
    }

    function getUserClusterLabel(user) {
        if (!user) return '';
        if (user.cluster) return user.cluster;
        const schoolId = getUserSchoolId(user);
        const info = getSchoolInfoById(schoolId) || getSchoolInfoByName(schoolId);
        return getSchoolClusterName(info) || '';
    }

    function getUserClusterKey(user) {
        if (!user) return '';
        if (user.clusterNormalized) return user.clusterNormalized;
        const schoolId = getUserSchoolId(user);
        const info = getSchoolInfoById(schoolId) || getSchoolInfoByName(schoolId);
        const clusterId = normalizeText(getSchoolClusterId(info));
        if (clusterId) return clusterId;
        const fallback = user.clusterId || user.clusterKey || user.cluster || '';
        return normalizeText(fallback);
    }

    function renderUserRoleAccordion(levelKey, users, showActions, openByDefault, options = {}) {
        const levelLabel = getRoleDisplayName(levelKey) || levelKey || 'ผู้ใช้';
        const actionHeader = showActions ? '<th class="p-2 text-left w-24">จัดการ</th>' : '';
        const hideClusterColumn = Boolean(options.hideClusterColumn);
        const clusterHeader = hideClusterColumn ? '' : '<th class="p-2 text-left">เครือข่าย</th>';
        return `
            <details class="border border-slate-200 rounded-xl bg-white" ${openByDefault ? 'open' : ''}>
                <summary class="cursor-pointer list-none px-3 py-2 text-sm font-semibold text-slate-800 flex items-center justify-between gap-2">
                    <span>สิทธิ์: ${escapeHtmlClient(levelLabel)}</span>
                    <span class="text-xs text-slate-500">${users.length} คน</span>
                </summary>
                <div class="overflow-x-auto mt-2">
                    <table class="user-management-table min-w-full text-sm divide-y divide-slate-200">
                        <thead class="bg-slate-100 text-slate-600">
                            <tr>
                                <th class="p-2 text-left">ชื่อผู้ใช้</th>
                                <th class="p-2 text-left">ชื่อ-สกุล</th>
                                <th class="p-2 text-left">โรงเรียน</th>
                                ${clusterHeader}
                                <th class="p-2 text-left">อีเมล</th>
                                <th class="p-2 text-left">โทร</th>
                                ${actionHeader}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${renderUserTableRows(users, { showActions, hideClusterColumn })}
                        </tbody>
                    </table>
                </div>
            </details>
        `;
    }

    function handleUserManagementSearchInput(event) {
        userManagementSearchTerm = (event?.target?.value || '').trim();
        if (isLoadingManagedUsers) return;
        renderUserManagement(MANAGED_USERS);
    }

    function buildScoreAssignmentActivityCache() {
        const acts = Array.isArray(ALL_ACTIVITIES) ? [...ALL_ACTIVITIES] : [];
        const counts = {};
        getStageFilteredTeams().forEach(team => {
            if (!team.activity) return;
            counts[team.activity] = (counts[team.activity] || 0) + 1;
        });
        const options = acts
            .map(act => ({
                id: act.id || act.name || '',
                label: `${act.name || act.id || '-'}${act.category ? ` (${act.category})` : ''}`,
                category: act.category || 'ไม่ระบุหมวดหมู่',
                teamCount: counts[act.id] || 0
            }))
            .filter(option => option.id && option.teamCount > 0)
            .sort((a, b) => a.label.localeCompare(b.label, 'th'));
        const categorySet = new Set(options.map(opt => opt.category));
        const categories = [{ value: '__all__', label: 'ทุกหมวดหมู่' }];
        Array.from(categorySet).sort((a, b) => a.localeCompare(b, 'th')).forEach(cat => {
            categories.push({ value: cat, label: cat });
        });
        return { options, categories };
    }

    function renderScoreAssignmentPanel() {
        if (!scoreAssignmentCard || !scoreAssignmentContent) return;
        if (!currentUser || !canManageScoreAssignments()) {
            scoreAssignmentCard.classList.add('hidden');
            scoreAssignmentContent.innerHTML = '';
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '';
            return;
        }
        scoreAssignmentCard.classList.remove('hidden');
        if (isLoadingManagedUsers) {
            scoreAssignmentContent.innerHTML = '<p class="text-xs text-slate-500">กำลังโหลดข้อมูลผู้ใช้ Score...</p>';
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">กำลังประมวลผล...</p>';
            return;
        }
        if (!hasLoadedManagedUsers) {
            const message = managedUsersLoadAttempted
                ? 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้'
                : 'กำลังรอข้อมูลผู้ใช้...';
            scoreAssignmentContent.innerHTML = `<p class="text-sm text-slate-500">${message}</p>`;
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">รอข้อมูลจากระบบ</p>';
            return;
        }
        const scoreUsers = (Array.isArray(MANAGED_USERS) ? MANAGED_USERS : [])
            .filter(user => normalizeText(user.level) === 'score');
        if (!scoreUsers.length) {
            scoreAssignmentContent.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีผู้ใช้ระดับ Score ในสิทธิ์ของคุณ</p>';
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลการมอบหมาย</p>';
            return;
        }
        if (!Array.isArray(ALL_TEAMS) || !ALL_TEAMS.length) {
            scoreAssignmentContent.innerHTML = '<p class="text-sm text-slate-500">กำลังรอข้อมูลทีม... โปรดลองอีกครั้งหลังจากโหลดทีมสำเร็จ</p>';
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">รอข้อมูลทีม</p>';
            return;
        }
        scoreAssignmentActivityCache = buildScoreAssignmentActivityCache();
        const activityOptions = scoreAssignmentActivityCache.options;
        if (!activityOptions.length) {
            scoreAssignmentContent.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีกิจกรรมให้มอบหมาย</p>';
            if (scoreAssignmentSummary) scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลกิจกรรม</p>';
            return;
        }
        const categoryOptions = scoreAssignmentActivityCache.categories || [{ value: '__all__', label: 'ทุกหมวดหมู่' }];
        scoreAssignmentContent.innerHTML = scoreUsers.map(user => {
            const selected = Array.isArray(user.scoreActivities) ? user.scoreActivities : [];
            const displayName = `${user.name || ''} ${user.surname || ''}`.trim() || user.username || '-';
            const schoolLabel = user.schoolName ? `โรงเรียน: ${user.schoolName}` : 'ไม่ระบุโรงเรียน';
            const selectedCategory = getDefaultScoreAssignmentCategory(selected);
            const categoryHtml = categoryOptions.map(opt => `
                <option value="${opt.value}" ${opt.value === selectedCategory ? 'selected' : ''}>
                    ${escapeHtmlClient(opt.label)}
                </option>
            `).join('');
            const optionsHtml = renderScoreAssignmentOptionsHtml(selectedCategory, selected);
            return `
                <div class="border border-slate-200 rounded-xl p-4 space-y-3">
                    <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(displayName)}</p>
                            <p class="text-xs text-slate-500">${escapeHtmlClient(schoolLabel)}</p>
                        </div>
                        <span class="text-[11px] text-slate-500">${escapeHtmlClient(user.username || '')}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1fr)_auto] gap-3">
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs font-semibold text-slate-600 mb-1 block">เลือกหมวดกิจกรรม</label>
                                <select data-score-category="${user.userId}" class="w-full rounded-lg border border-slate-300 text-sm p-2 focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                    ${categoryHtml}
                                </select>
                            </div>
                            <label class="text-xs font-semibold text-slate-600 mb-1 block">กิจกรรมที่รับผิดชอบ</label>
                            <select multiple size="4"
                                data-score-select="${user.userId}"
                                data-score-active-category="${selectedCategory}"
                                class="w-full rounded-lg border border-slate-300 text-sm p-2 focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                ${optionsHtml}
                            </select>
                            <p data-score-status="${user.userId}" class="text-[11px] text-slate-500 mt-1">
                                เลือกได้หลายกิจกรรม (กด Ctrl/Cmd เพื่อเลือกหลายรายการ)
                            </p>
                        </div>
                        <div class="flex items-end justify-end">
                            <button type="button"
                                data-score-save="${user.userId}"
                                class="inline-flex items-center gap-2 rounded-full bg-sky-500 px-4 py-1.5 text-sm font-semibold text-white hover:bg-sky-600">
                                <span class="material-symbols-outlined text-base">save</span>
                                <span>บันทึก</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        renderScoreAssignmentActivitySummary(scoreUsers);
    }

    function getDefaultScoreAssignmentCategory(selected) {
        if (!Array.isArray(selected) || !selected.length) return '__all__';
        const categories = selected
            .map(id => getScoreAssignmentCategoryForActivity(id))
            .filter(Boolean);
        const unique = Array.from(new Set(categories));
        return unique.length === 1 ? unique[0] : '__all__';
    }

    function getScoreAssignmentCategoryForActivity(activityId) {
        if (!scoreAssignmentActivityCache || !Array.isArray(scoreAssignmentActivityCache.options)) return null;
        const match = scoreAssignmentActivityCache.options.find(opt => opt.id === activityId);
        return match ? match.category : null;
    }

    function getScoreAssignmentOptionsByCategory(category) {
        if (!scoreAssignmentActivityCache || !Array.isArray(scoreAssignmentActivityCache.options)) return [];
        if (!category || category === '__all__') return scoreAssignmentActivityCache.options;
        return scoreAssignmentActivityCache.options.filter(opt => opt.category === category);
    }

    function renderScoreAssignmentOptionsHtml(category, selected) {
        const selectedSet = new Set(Array.isArray(selected) ? selected : []);
        const primary = getScoreAssignmentOptionsByCategory(category);
        const missing = scoreAssignmentActivityCache.options.filter(opt => selectedSet.has(opt.id) && !primary.some(item => item.id === opt.id));
        const merged = [...primary, ...missing];
        if (!merged.length) {
            return '<option value="" disabled>ไม่มีรายการในหมวดนี้</option>';
        }
        return merged.map(opt => `
            <option value="${opt.id}" ${selectedSet.has(opt.id) ? 'selected' : ''}>
                ${escapeHtmlClient(opt.label)} • ${opt.teamCount} ทีม
            </option>
        `).join('');
    }

    function handleScoreAssignmentCategoryChange(event) {
        const select = event.target.closest('[data-score-category]');
        if (!select) return;
        const userId = select.dataset.scoreCategory;
        applyScoreAssignmentCategory(userId, select.value || '__all__');
    }

    function applyScoreAssignmentCategory(userId, categoryValue) {
        if (!scoreAssignmentContent || !userId) return;
        const select = scoreAssignmentContent.querySelector(`[data-score-select="${userId}"]`);
        if (!select) return;
        const currentValues = Array.from(select.selectedOptions).map(opt => opt.value);
        select.innerHTML = renderScoreAssignmentOptionsHtml(categoryValue, currentValues);
        select.dataset.scoreActiveCategory = categoryValue;
    }

    function renderScoreAssignmentActivitySummary(scoreUsers) {
        if (!scoreAssignmentSummary) return;
        const activityAssignments = new Map();
        scoreUsers.forEach(user => {
            (user.scoreActivities || []).forEach(actId => {
                if (!activityAssignments.has(actId)) activityAssignments.set(actId, []);
                activityAssignments.get(actId).push(user);
            });
        });
        if (!activityAssignments.size) {
            scoreAssignmentSummary.innerHTML = '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลการมอบหมาย</p>';
            return;
        }
        const categoryGroups = new Map();
        activityAssignments.forEach((users, activityId) => {
            const info = getActivityInfoById(activityId);
            const category = info?.category || 'หมวดหมู่ทั่วไป';
            if (!categoryGroups.has(category)) categoryGroups.set(category, []);
            categoryGroups.get(category).push({
                id: activityId,
                label: info ? info.name || info.id : activityId,
                users
            });
        });
        const html = Array.from(categoryGroups.entries())
            .sort((a, b) => a[0].localeCompare(b[0], 'th'))
            .map(([category, activities], index) => {
                const activityCards = activities
                    .sort((a, b) => (a.label || '').localeCompare(b.label || '', 'th'))
                    .map(activity => {
                        const userList = activity.users.map(user => {
                            const displayName = `${user.name || ''} ${user.surname || ''}`.trim() || user.username || '-';
                            const school = user.schoolName ? `โรงเรียน: ${user.schoolName}` : '';
                            return `
                                <li class="flex flex-col text-[11px] text-slate-600">
                                    <span class="font-medium text-slate-700">${escapeHtmlClient(displayName)}</span>
                                    <span class="text-slate-500">${escapeHtmlClient(school)}</span>
                                </li>
                            `;
                        }).join('');
                        return `
                            <div class="rounded-lg border border-slate-100 p-3 space-y-2">
                                <div class="flex items-center justify-between gap-2">
                                    <div>
                                        <p class="text-xs font-semibold text-slate-800">${escapeHtmlClient(activity.label || '-')}</p>
                                        <p class="text-[11px] text-slate-500">${activity.users.length} ผู้รับผิดชอบ</p>
                                    </div>
                                </div>
                                <ul class="space-y-1">
                                    ${userList}
                                </ul>
                            </div>
                        `;
                    }).join('');
                return `
                    <details class="rounded-lg border border-slate-200 bg-white" ${index === 0 ? 'open' : ''}>
                        <summary class="cursor-pointer list-none px-3 py-2 text-xs font-semibold text-slate-700 flex items-center justify-between gap-2">
                            <span>${escapeHtmlClient(category)}</span>
                            <span class="text-[11px] text-slate-500">${activities.length} กิจกรรม</span>
                        </summary>
                        <div class="mt-2 space-y-2 px-2 pb-3">
                            ${activityCards || '<p class="text-[11px] text-slate-500">ยังไม่มีการมอบหมาย</p>'}
                        </div>
                    </details>
                `;
            }).join('');
        scoreAssignmentSummary.innerHTML = html;
    }

    function setScoreAssignmentStatus(userId, message, type = 'info') {
        if (!scoreAssignmentContent) return;
        const statusEl = scoreAssignmentContent.querySelector(`[data-score-status="${userId}"]`);
        if (!statusEl) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        statusEl.textContent = message || '';
        statusEl.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        statusEl.classList.add(classMap[type] || classMap.info);
    }

    function handleScoreAssignmentAction(event) {
        const button = event.target.closest('[data-score-save]');
        if (!button) return;
        const userId = button.dataset.scoreSave;
        if (!userId || !scoreAssignmentContent) return;
        const select = scoreAssignmentContent.querySelector(`[data-score-select="${userId}"]`);
        if (!select) return;
        const values = Array.from(select.selectedOptions).map(opt => opt.value);
        saveScoreAssignment(userId, values, button);
    }

    function saveScoreAssignment(userId, activityIds, button) {
        if (!userId) return;
        const actor = buildActorPayload();
        if (!actor) {
            setScoreAssignmentStatus(userId, 'กรุณาเข้าสู่ระบบ', 'error');
            return;
        }
        if (SCORE_ASSIGNMENT_SAVING.has(userId)) return;
        SCORE_ASSIGNMENT_SAVING.add(userId);
        button.disabled = true;
        setScoreAssignmentStatus(userId, 'กำลังบันทึก...', 'info');
        google.script.run
            .withSuccessHandler(res => {
                SCORE_ASSIGNMENT_SAVING.delete(userId);
                button.disabled = false;
                setScoreAssignmentStatus(userId, 'บันทึกสำเร็จ', 'success');
                loadUserManagementData(true);
            })
            .withFailureHandler(error => {
                SCORE_ASSIGNMENT_SAVING.delete(userId);
                setScoreAssignmentStatus(userId, error.message || 'ไม่สามารถบันทึกได้', 'error');
                button.disabled = false;
            })
            .saveScoreAssignments({ userId, activityIds, actor });
    }

    function findManagedUserById(userId) {
        if (!userId || !Array.isArray(MANAGED_USERS)) return null;
        return MANAGED_USERS.find(user => (user.userId || '').toString() === userId.toString()) || null;
    }

    function openUserManagementForm(user = null) {
        if (!userManagementForm || !canManageUsersClient()) return;
        refreshUserFormSchoolOptions();
        userFormMode = user && (user.userId || user.userid) ? 'edit' : 'create';
        if (userFormTitle) {
            userFormTitle.textContent = userFormMode === 'edit'
                ? `แก้ไขผู้ใช้: ${user?.username || user?.userId || '-'}` : 'เพิ่มผู้ใช้ใหม่';
        }
        if (userFormUserId) userFormUserId.value = user?.userId || '';
        if (userFormUsername) userFormUsername.value = user?.username || '';
        if (userFormName) userFormName.value = user?.name || '';
        if (userFormSurname) userFormSurname.value = user?.surname || '';
        if (userFormEmail) userFormEmail.value = user?.email || '';
        if (userFormTel) userFormTel.value = user?.tel || '';
        if (userFormPassword) userFormPassword.value = '';
        if (userFormPasswordConfirm) userFormPasswordConfirm.value = '';
        const initialLevel = user?.level || 'User';
        updateUserFormLevelOptions(initialLevel);
        if (userFormSchoolSelect) {
            let targetSchoolId = user?.schoolId || '';
            if (!targetSchoolId && user?.schoolName) {
                const info = getSchoolInfoByName(user.schoolName);
                if (info?.id) targetSchoolId = info.id;
            }
            userFormSchoolSelect.value = targetSchoolId || '';
        }
        setUserFormSavingState(false);
        userManagementForm.classList.remove('hidden');
        if (typeof userManagementForm.scrollIntoView === 'function') {
            userManagementForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function resetUserManagementForm() {
        userFormMode = 'create';
        if (userManagementForm) userManagementForm.reset();
        if (userFormTitle) userFormTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
        updateUserFormLevelOptions('User');
        setUserFormSavingState(false);
    }

    function hideUserManagementForm() {
        if (!userManagementForm) return;
        userManagementForm.classList.add('hidden');
        resetUserManagementForm();
    }

    function setUserFormSavingState(isSaving) {
        isSavingManagedUser = isSaving;
        if (userFormSubmitBtn) {
            userFormSubmitBtn.disabled = isSaving;
            userFormSubmitBtn.classList.toggle('opacity-60', isSaving);
        }
        if (userFormSubmitLabel) {
            userFormSubmitLabel.textContent = isSaving
                ? 'กำลังบันทึก...'
                : (userFormMode === 'edit' ? 'บันทึกการแก้ไข' : 'บันทึกผู้ใช้');
        }
    }

    function handleUserManagementFormSubmit(event) {
        event.preventDefault();
        if (isSavingManagedUser || !canManageUsersClient()) return;
        if (!userManagementForm || !userManagementForm.reportValidity()) {
            userManagementForm?.reportValidity();
            return;
        }
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูลผู้ใช้', text: 'กรุณาเข้าสู่ระบบอีกครั้ง' });
            return;
        }
        const password = (userFormPassword?.value || '').trim();
        const confirmPassword = (userFormPasswordConfirm?.value || '').trim();
        if ((password || confirmPassword) && password !== confirmPassword) {
            Swal.fire({ icon: 'warning', title: 'ยืนยันรหัสผ่านไม่ตรงกัน', text: 'กรุณาตรวจสอบรหัสผ่านอีกครั้ง' });
            return;
        }
        const schoolId = (userFormSchoolSelect?.value || '').trim();
        if (!schoolId) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกโรงเรียน', text: 'โปรดเลือกโรงเรียนสำหรับผู้ใช้นี้' });
            return;
        }
        const payload = {
            actor,
            user: {
                userId: (userFormUserId?.value || '').trim(),
                username: (userFormUsername?.value || '').trim(),
                level: userFormLevel?.value || 'User',
                name: (userFormName?.value || '').trim(),
                surname: (userFormSurname?.value || '').trim(),
                email: (userFormEmail?.value || '').trim(),
                tel: (userFormTel?.value || '').trim(),
                password,
                schoolId
            }
        };
        setUserFormSavingState(true);
        if (userManagementStatus) userManagementStatus.textContent = 'กำลังบันทึกข้อมูลผู้ใช้...';
        google.script.run
            .withSuccessHandler(res => {
                setUserFormSavingState(false);
                if (res && res.success) {
                    hideUserManagementForm();
                    if (userManagementStatus) userManagementStatus.textContent = 'บันทึกข้อมูลผู้ใช้สำเร็จ';
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1600, showConfirmButton: false });
                    loadUserManagementData(true);
                } else {
                    const message = (res && res.error) || 'ไม่สามารถบันทึกข้อมูลผู้ใช้ได้';
                    if (userManagementStatus) userManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                }
            })
            .withFailureHandler(error => {
                setUserFormSavingState(false);
                const message = error.message || 'ไม่สามารถบันทึกข้อมูลผู้ใช้ได้';
                if (userManagementStatus) userManagementStatus.textContent = message;
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
            })
            .saveManagedUser(payload);
    }

    function handleManagedUserEdit(userId) {
        const user = findManagedUserById(userId);
        if (!user) {
            Swal.fire({ icon: 'error', title: 'ไม่พบผู้ใช้', text: 'ไม่สามารถแก้ไขผู้ใช้นี้ได้' });
            return;
        }
        openUserManagementForm(user);
    }

    function handleManagedUserDelete(userId) {
        const user = findManagedUserById(userId);
        if (!user) {
            Swal.fire({ icon: 'error', title: 'ไม่พบผู้ใช้', text: 'ไม่สามารถลบผู้ใช้นี้ได้' });
            return;
        }
        Swal.fire({
            icon: 'warning',
            title: `ลบผู้ใช้ ${user.username || userId}?`,
            text: 'การลบไม่สามารถย้อนกลับได้',
            showCancelButton: true,
            confirmButtonText: 'ลบผู้ใช้',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#dc2626'
        }).then(result => {
            if (!result.isConfirmed) return;
            const actor = buildActorPayload();
            if (!actor) {
                Swal.fire({ icon: 'error', title: 'ไม่สามารถดำเนินการได้', text: 'กรุณาเข้าสู่ระบบอีกครั้ง' });
                return;
            }
            if (userManagementStatus) userManagementStatus.textContent = `กำลังลบผู้ใช้ ${user.username || userId}...`;
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.success) {
                        Swal.fire({ icon: 'success', title: 'ลบผู้ใช้แล้ว', timer: 1500, showConfirmButton: false });
                        loadUserManagementData(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถลบผู้ใช้ได้';
                        if (userManagementStatus) userManagementStatus.textContent = message;
                        Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                    }
                })
                .withFailureHandler(error => {
                    const message = error.message || 'ไม่สามารถลบผู้ใช้ได้';
                    if (userManagementStatus) userManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                })
                .deleteManagedUser({ userId, actor });
        });
    }

    function handleUserManagementContentClick(event) {
        const actionEl = event.target.closest('[data-user-action]');
        if (!actionEl) return;
        const action = actionEl.dataset.userAction;
        const userId = actionEl.dataset.userId;
        if (!userId) return;
        if (action === 'edit-user') {
            handleManagedUserEdit(userId);
        } else if (action === 'delete-user') {
            handleManagedUserDelete(userId);
        }
    }

    function loadSchoolManagementData(force = false) {
        if (!canViewSchoolManagement()) {
            MANAGED_SCHOOLS = [];
            renderSchoolManagement([]);
            refreshUserFormSchoolOptions();
            return;
        }
        if (isLoadingManagedSchools && !force) return;
        const actor = buildActorPayload();
        if (!actor) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'กรุณาเข้าสู่ระบบ';
            return;
        }
        isLoadingManagedSchools = true;
        if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังโหลดข้อมูลโรงเรียน...';
        schoolManagementContent && (schoolManagementContent.innerHTML = '');
        google.script.run
            .withSuccessHandler(res => {
                isLoadingManagedSchools = false;
                if (res && res.success) {
                    MANAGED_SCHOOLS = Array.isArray(res.schools) ? res.schools : [];
                    refreshUserFormSchoolOptions();
                    renderSchoolManagement(MANAGED_SCHOOLS);
                } else {
                    if (schoolManagementStatus) schoolManagementStatus.textContent = (res && res.error) || 'ไม่สามารถโหลดข้อมูลโรงเรียนได้';
                }
            })
            .withFailureHandler(error => {
                isLoadingManagedSchools = false;
                if (schoolManagementStatus) schoolManagementStatus.textContent = error.message || 'ไม่สามารถโหลดข้อมูลโรงเรียนได้';
            })
            .getManagedSchools({ actor });
    }

    function handleSchoolManagementSearchInput(event) {
        schoolManagementState.search = event.target.value || '';
        renderSchoolManagement(MANAGED_SCHOOLS);
    }

    function renderSchoolManagement(schools) {
        if (!schoolManagementContent) return;
        const stageLockNote = getCurrentUserLevel() === 'group_admin' && hasCompetitionStageInfo && competitionStage !== 'cluster'
            ? ' • รอบระดับเขตจะปิดการเปลี่ยนโหมดลงทะเบียน'
            : '';
        if (schoolManagementSearchInput && schoolManagementSearchInput.value !== (schoolManagementState.search || '')) {
            schoolManagementSearchInput.value = schoolManagementState.search || '';
        }
        if (!canViewSchoolManagement()) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'เฉพาะผู้ดูแลระบบเท่านั้นที่เข้าถึงได้';
            schoolManagementContent.innerHTML = '';
            return;
        }
        if (isLoadingManagedSchools) {
            schoolManagementContent.innerHTML = `
                <div class="animate-pulse space-y-2">
                    <div class="h-4 bg-slate-200 rounded w-1/4"></div>
                    <div class="h-3 bg-slate-100 rounded w-full"></div>
                </div>
            `;
            return;
        }
        if (!Array.isArray(schools) || schools.length === 0) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'ไม่พบโรงเรียนในสิทธิ์ของคุณ' + stageLockNote;
            schoolManagementContent.innerHTML = '<p class="text-slate-500 text-sm">ไม่มีข้อมูลโรงเรียนให้แสดง</p>';
            return;
        }
        const totalSchools = schools.length;
        const searchRawValue = schoolManagementState.search || '';
        const searchTerm = normalizeText(searchRawValue);
        const hasSearch = !!searchTerm;
        let filtered = [...schools];
        if (hasSearch) {
            filtered = filtered.filter(school => {
                const name = normalizeText(school.name || '');
                const id = normalizeText(school.id || '');
                const cluster = normalizeText(school.cluster || '');
                return name.includes(searchTerm) || id.includes(searchTerm) || cluster.includes(searchTerm);
            });
        }
        if (!filtered.length) {
            const searchDisplay = searchRawValue.trim();
            const message = searchDisplay
                ? `ไม่พบโรงเรียนที่ตรงกับ "${escapeHtmlClient(searchDisplay)}"`
                : 'ไม่พบโรงเรียนที่ตรงกับคำค้น';
            schoolManagementContent.innerHTML = `<p class="text-slate-500 text-sm">${message}</p>`;
            if (schoolManagementStatus) {
                const text = searchDisplay
                    ? `ไม่พบโรงเรียนที่ตรงกับ "${searchDisplay}"`
                    : 'ไม่พบโรงเรียนที่ตรงกับคำค้น';
                schoolManagementStatus.textContent = text + stageLockNote;
            }
            return;
        }
        const groupedMap = new Map();
        filtered.forEach(school => {
            const key = normalizeText(school.cluster || '') || '__no_cluster__';
            if (!groupedMap.has(key)) {
                groupedMap.set(key, {
                    label: (school.cluster || '').trim() || 'ไม่ระบุเครือข่าย',
                    items: []
                });
            }
            groupedMap.get(key).items.push(school);
        });
        const groupedSections = Array.from(groupedMap.values())
            .map(group => ({
                label: group.label,
                items: [...group.items].sort((a, b) => (a.name || '').localeCompare(b.name || '', 'th'))
            }))
            .sort((a, b) => a.label.localeCompare(b.label, 'th'));
        schoolManagementContent.innerHTML = groupedSections.map((group, index) => {
            const clusterId = `school-cluster-${index}`;
            return `
                <div class="school-cluster-card border border-slate-200 rounded-2xl bg-white">
                    <button type="button" class="school-cluster-toggle" data-school-cluster="${clusterId}">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(group.label)}</p>
                            <p class="text-[11px] text-slate-500">${group.items.length} โรงเรียน</p>
                        </div>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div class="school-cluster-body ${index === 0 ? '' : 'hidden'}" data-school-cluster-panel="${clusterId}">
                        <div class="space-y-3">
                            ${group.items.map(renderSchoolManagementCard).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        bindSchoolClusterToggles();
        if (schoolManagementStatus) {
            const summaryText = hasSearch
                ? `ผลการค้นหา ${filtered.length} โรงเรียน (จากทั้งหมด ${totalSchools})`
                : `พบโรงเรียนทั้งหมด ${totalSchools} แห่ง`;
            schoolManagementStatus.textContent = summaryText + stageLockNote;
        }
    }

    function renderSchoolManagementCard(school) {
        const safeId = escapeHtmlClient(school.id || '-');
        const safeName = escapeHtmlClient(school.name || '-');
        const clusterLabel = escapeHtmlClient(school.cluster || '-');
        const modeBadge = renderSchoolRegistrationModeBadge(school.registrationMode);
        const assignedCount = Array.isArray(school.assignedActivities) ? school.assignedActivities.length : 0;
        const assignedPreview = formatAssignedActivitiesPreview(school);
        const modeButton = canEditSchoolRegistrationMode()
            ? `<button type="button" class="text-xs text-sky-600 hover:text-sky-800" data-school-action="change-mode" data-school-id="${safeId}">เปลี่ยนโหมด</button>`
            : '';
        const assignButton = canAssignActivitiesToSchool(school) && normalizeRegistrationModeClient(school.registrationMode) === 'group_assigned'
            ? `<button type="button" class="text-xs text-sky-600 hover:text-sky-800" data-school-action="assign-activities" data-school-id="${safeId}">กำหนดกิจกรรม</button>`
            : '';
        const clusterButton = canEditSchoolCluster()
            ? `<button type="button" class="text-xs text-slate-600 hover:text-slate-800" data-school-action="edit-cluster" data-school-id="${safeId}" data-school-cluster="${escapeHtmlClient(school.cluster || '')}">เปลี่ยนเครือข่าย</button>`
            : '';
        return `
            <div class="rounded-2xl border border-slate-200 bg-white p-4 space-y-4">
                <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-base font-semibold text-slate-900">${safeName}</p>
                        <p class="text-xs text-slate-500">รหัส: ${safeId} • เครือข่าย: ${clusterLabel}</p>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        ${clusterButton}
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <p class="text-xs font-semibold text-slate-500">โหมดการสมัคร</p>
                        <div class="flex items-center gap-2">
                            ${modeBadge}
                            ${modeButton}
                        </div>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs font-semibold text-slate-500">กิจกรรมที่มอบหมาย (${assignedCount})</p>
                        <div class="flex flex-col gap-1 text-sm text-slate-700">
                            ${assignedPreview}
                            ${assignButton}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function bindSchoolClusterToggles() {
        if (!schoolManagementContent) return;
        const toggles = schoolManagementContent.querySelectorAll('[data-school-cluster]');
        toggles.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.schoolCluster;
                const panel = schoolManagementContent.querySelector(`[data-school-cluster-panel="${target}"]`);
                const icon = btn.querySelector('.material-symbols-outlined');
                if (panel) panel.classList.toggle('hidden');
                if (icon) icon.classList.toggle('rotate-180');
            });
        });
    }

    function renderSchoolRegistrationModeBadge(mode) {
        const normalized = normalizeRegistrationModeClient(mode);
        if (normalized === 'group_assigned') {
            return '<span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700">คัดเลือกโดยเครือข่าย</span>';
        }
        return '<span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">โรงเรียนลงทะเบียนเอง</span>';
    }

    function formatAssignedActivitiesPreview(school) {
        const assigned = Array.isArray(school?.assignedActivities) ? school.assignedActivities : [];
        if (!assigned.length) {
            return '<span class="text-xs text-slate-500">ยังไม่ได้กำหนดกิจกรรม</span>';
        }
        const names = getAssignedActivityNames(assigned);
        const preview = names.slice(0, 3).map(name => escapeHtmlClient(name)).join(', ');
        const extra = names.length - Math.min(names.length, 3);
        const extraHtml = extra > 0 ? `<span class="text-xs text-slate-500">+${extra}</span>` : '';
        return `<span>${preview}</span>${extraHtml}`;
    }

    function handleSchoolManagementContentClick(event) {
        const actionEl = event.target.closest('[data-school-action]');
        if (!actionEl) return;
        const action = actionEl.dataset.schoolAction;
        const schoolId = actionEl.dataset.schoolId;
        if (!schoolId) return;
        if (action === 'edit-cluster') {
            const currentCluster = actionEl.dataset.schoolCluster || '';
            promptSchoolClusterUpdate(schoolId, currentCluster);
        } else if (action === 'change-mode') {
            promptSchoolRegistrationModeUpdate(schoolId);
        } else if (action === 'assign-activities') {
            openSchoolAssignmentModal(schoolId);
        }
    }

    function findManagedSchoolById(schoolId) {
        if (!schoolId || !Array.isArray(MANAGED_SCHOOLS)) return null;
        return MANAGED_SCHOOLS.find(school => (school.id || '').toString() === schoolId.toString()) || null;
    }

    function promptSchoolRegistrationModeUpdate(schoolId) {
        if (!canEditSchoolRegistrationMode() || !schoolId || isUpdatingSchoolMode) return;
        const level = getCurrentUserLevel();
        if (level === 'group_admin' && competitionStage !== 'cluster') {
            Swal.fire({ icon: 'info', title: 'ปิดการแก้ไข', text: 'รอบระดับเขตไม่อนุญาตให้ Group Admin เปลี่ยนโหมดการสมัคร' });
            return;
        }
        const school = findManagedSchoolById(schoolId);
        if (!school) return;
        const currentMode = normalizeRegistrationModeClient(school.registrationMode);
        Swal.fire({
            title: `โหมดลงทะเบียน: ${school.name || schoolId}`,
            input: 'radio',
            inputOptions: {
                self: 'โรงเรียนลงทะเบียนด้วยตนเอง',
                group_assigned: 'คัดเลือกโดย Group Admin'
            },
            inputValue: currentMode,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            showCancelButton: true,
            customClass: { input: 'text-left' },
            inputValidator: value => {
                if (!value) {
                    return 'กรุณาเลือกโหมดลงทะเบียน';
                }
            }
        }).then(result => {
            if (!result.isConfirmed) return;
            const selectedMode = result.value;
            const actor = buildActorPayload();
            if (!actor) {
                Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถอัปเดตโหมดได้' });
                return;
            }
            if (!selectedMode) return;
            isUpdatingSchoolMode = true;
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังบันทึกโหมดลงทะเบียน...';
            Swal.fire({
                title: 'กำลังบันทึกโหมดลงทะเบียน...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });
            google.script.run
                .withSuccessHandler(res => {
                    isUpdatingSchoolMode = false;
                    Swal.close();
                    if (res && res.success) {
                        Swal.fire({ icon: 'success', title: 'อัปเดตสำเร็จ', timer: 1500, showConfirmButton: false });
                        loadSchoolManagementData(true);
                        loadSchoolOptions(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถอัปเดตโหมดได้';
                        Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                        if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                    }
                })
                .withFailureHandler(error => {
                    isUpdatingSchoolMode = false;
                    Swal.close();
                    const message = error.message || 'ไม่สามารถอัปเดตโหมดได้';
                    Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                    if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                })
                .updateSchoolRegistrationMode({ schoolId, mode: selectedMode, actor });
        });
    }

    function promptSchoolClusterUpdate(schoolId, currentCluster = '') {
        if (!canEditSchoolCluster() || !schoolId || isUpdatingSchoolCluster) return;
        Swal.fire({
            title: 'เปลี่ยนเครือข่ายโรงเรียน',
            input: 'text',
            inputLabel: 'ชื่อเครือข่ายใหม่',
            inputValue: currentCluster || '',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            inputPlaceholder: 'ตัวอย่าง: กลุ่มสาระ ICT'
        }).then(result => {
            if (!result.isConfirmed) return;
            const nextCluster = (result.value || '').trim();
            const actor = buildActorPayload();
            if (!actor) {
                Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถอัปเดตเครือข่ายได้' });
                return;
            }
            isUpdatingSchoolCluster = true;
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังอัปเดตเครือข่าย...';
            google.script.run
                .withSuccessHandler(res => {
                    isUpdatingSchoolCluster = false;
                    if (res && res.success) {
                        Swal.fire({ icon: 'success', title: 'อัปเดตสำเร็จ', timer: 1500, showConfirmButton: false });
                        loadSchoolManagementData(true);
                        loadUserManagementData(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถอัปเดตเครือข่ายได้';
                        if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                        Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                    }
                })
                .withFailureHandler(error => {
                    isUpdatingSchoolCluster = false;
                    const message = error.message || 'ไม่สามารถอัปเดตเครือข่ายได้';
                    if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                })
                .updateSchoolCluster({ schoolId, cluster: nextCluster, actor });
        });
    }

    function openSchoolAssignmentModal(schoolId) {
        if (!schoolAssignmentModal) return;
        const school = findManagedSchoolById(schoolId);
        if (!school) return;
        if (!school.id) {
            Swal.fire({ icon: 'error', title: 'ไม่พบรหัสโรงเรียน', text: 'ไม่สามารถกำหนดกิจกรรมได้' });
            return;
        }
        if (!canAssignActivitiesToSchool(school)) {
            Swal.fire({ icon: 'info', title: 'ไม่มีสิทธิ์', text: 'คุณไม่สามารถกำหนดกิจกรรมให้โรงเรียนนี้ได้' });
            return;
        }
        if (normalizeRegistrationModeClient(school.registrationMode) !== 'group_assigned') {
            Swal.fire({ icon: 'info', title: 'โหมดไม่ถูกต้อง', text: 'กรุณาเปลี่ยนโหมดเป็น "คัดเลือกโดย Group Admin" ก่อน' });
            return;
        }
        assignmentModalState.school = school;
        assignmentModalState.filter = '';
        assignmentModalState.selectedMap = new Map();
        (school.assignedActivities || []).forEach(id => {
            const key = normalizeText(id);
            if (key) assignmentModalState.selectedMap.set(key, id);
        });
        renderSchoolAssignmentModal();
        schoolAssignmentModal.classList.remove('hidden');
        schoolAssignmentModal.classList.add('flex');
    }

    function closeSchoolAssignmentModal() {
        if (!schoolAssignmentModal) return;
        schoolAssignmentModal.classList.add('hidden');
        schoolAssignmentModal.classList.remove('flex');
        assignmentModalState.school = null;
        assignmentModalState.filter = '';
        assignmentModalState.selectedMap = new Map();
        setAssignmentSavingState(false);
        if (schoolAssignmentList) {
            schoolAssignmentList.innerHTML = '<p class="text-center text-slate-500 text-sm">เลือกโรงเรียนอีกครั้งเพื่อกำหนดกิจกรรม</p>';
        }
    }

    function renderSchoolAssignmentModal() {
        if (!assignmentModalState.school) return;
        const school = assignmentModalState.school;
        if (schoolAssignmentTitle) {
            schoolAssignmentTitle.textContent = school.name || school.id || '-';
        }
        if (schoolAssignmentSubtitle) {
            const clusterText = school.cluster ? `เครือข่าย: ${school.cluster}` : 'เครือข่าย: -';
            schoolAssignmentSubtitle.textContent = `${clusterText} • เลือกกิจกรรมที่ต้องการให้โรงเรียนนี้ลงทะเบียน`;
        }
        if (schoolAssignmentSearch) {
            schoolAssignmentSearch.value = assignmentModalState.filter || '';
        }
        renderSchoolAssignmentList();
    }

    function renderSchoolAssignmentList() {
        if (!schoolAssignmentList) return;
        if (!Array.isArray(ALL_ACTIVITIES) || ALL_ACTIVITIES.length === 0) {
            schoolAssignmentList.innerHTML = '<p class="text-center text-slate-500 text-sm">ยังไม่มีข้อมูลกิจกรรม</p>';
            return;
        }
        const filterValue = normalizeText(assignmentModalState.filter || '');
        const filtered = ALL_ACTIVITIES.filter(activity => {
            if (!filterValue) return true;
            const blob = `${activity.name || ''} ${activity.category || ''}`.toLowerCase();
            return blob.includes(filterValue);
        });
        if (!filtered.length) {
            schoolAssignmentList.innerHTML = '<p class="text-center text-slate-500 text-sm">ไม่พบกิจกรรมที่ตรงกับคำค้นหา</p>';
            return;
        }
        const grouped = new Map();
        filtered.forEach(activity => {
            const category = activity.category || 'ไม่ระบุหมวดหมู่';
            if (!grouped.has(category)) grouped.set(category, []);
            grouped.get(category).push(activity);
        });
        schoolAssignmentList.innerHTML = Array.from(grouped.entries()).map(([category, activities]) => `
            <div class="space-y-2">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">${escapeHtmlClient(category)}</p>
                <div class="space-y-2">
                    ${activities.map(activity => {
                        const normalizedId = normalizeText(activity.id || '');
                        const checked = assignmentModalState.selectedMap.has(normalizedId);
                        return `
                            <label class="flex items-start gap-3 rounded-xl border border-slate-200 bg-white px-3 py-2 hover:border-sky-300">
                                <input type="checkbox"
                                       class="mt-1 h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                       data-activity-id="${escapeHtmlClient(activity.id || '')}"
                                       ${checked ? 'checked' : ''}>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-slate-800">${escapeHtmlClient(activity.name || '-')}</p>
                                    <p class="text-xs text-slate-500">รหัส: ${escapeHtmlClient(activity.id || '-')}</p>
                                </div>
                            </label>
                        `;
                    }).join('')}
                </div>
            </div>
        `).join('');
    }

    function handleAssignmentSearchInput(event) {
        assignmentModalState.filter = event.target.value || '';
        renderSchoolAssignmentList();
    }

    function handleAssignmentListToggle(event) {
        const target = event.target;
        if (!target || target.type !== 'checkbox') return;
        const activityId = target.dataset.activityId || '';
        if (!activityId) return;
        const normalized = normalizeText(activityId);
        if (!normalized) return;
        if (target.checked) {
            assignmentModalState.selectedMap.set(normalized, activityId);
        } else {
            assignmentModalState.selectedMap.delete(normalized);
        }
    }

    function getScoreSheetJudges(activityId) {
        if (!activityId || !hasLoadedJudgeAssignments || !Array.isArray(JUDGE_ASSIGNMENTS)) return [];
        const normalized = (activityId || '').toString().trim();
        if (!normalized) return [];
        const judges = getJudgesForActivity(normalized);
        if (!Array.isArray(judges) || !judges.length) return [];
        const desiredStage = competitionStage === 'area' ? 'area' : 'cluster';
        let stageFiltered = judges.filter(judge => {
            const judgeStage = normalizeJudgeStageScope(judge.stageScope);
            if (judgeStage === desiredStage) return true;
            return desiredStage === 'cluster' && !judge.stageScope;
        });
        if (competitionStage === 'cluster') {
            const clusterKey = getClusterFilterForDisplay();
            if (clusterKey) {
                return stageFiltered.filter(judge =>
                    matchesClusterKey(judge.clusterKey || judge.clusterId, judge.clusterLabel, clusterKey)
                );
            }
            return stageFiltered;
        }
        if (competitionStage === 'area') {
            const level = getCurrentUserLevel();
            if (['admin', 'area'].includes(level)) {
                return stageFiltered;
            }
            return [];
        }
        return stageFiltered;
    }

    function resolveScoreSheetJudges(activityId, selectedKeys = []) {
        const judges = getScoreSheetJudges(activityId);
        if (!Array.isArray(selectedKeys) || !selectedKeys.length) {
            return judges;
        }
        const normalizedKeys = selectedKeys
            .map(value => (value || '').toString().trim())
            .filter(Boolean);
        if (!normalizedKeys.length) {
            return judges;
        }
        const judgeMap = new Map();
        judges.forEach(judge => {
            const key = buildJudgeSelectionKey(judge);
            if (key && !judgeMap.has(key)) {
                judgeMap.set(key, judge);
            }
        });
        const selection = normalizedKeys
            .map(key => judgeMap.get(key))
            .filter(Boolean);
        return selection.length ? selection : judges;
    }
    function getScoreSheetJudgesStageNote() {
        if (competitionStage === 'cluster') {
            const clusterLabel = getCurrentUserClusterLabel();
            if (clusterLabel) {
                return `<p class="text-[11px] text-emerald-600 mt-2">แสดงกรรมการในเครือข่าย ${escapeHtmlClient(clusterLabel)} เท่านั้น</p>`;
            }
            return '<p class="text-[11px] text-emerald-600 mt-2">แสดงกรรมการในกลุ่มเครือข่ายของคุณ</p>';
        }
        if (competitionStage === 'area') {
            return '<p class="text-[11px] text-amber-600 mt-2">รอบระดับเขต: แสดงเฉพาะกรรมการที่ถูกกำหนดเป็นระดับเขต</p>';
        }
        return '';
    }

    let isSavingSchoolAssignments = false;
    function setAssignmentSavingState(isSaving) {
        isSavingSchoolAssignments = isSaving;
        if (!schoolAssignmentSave) return;
        schoolAssignmentSave.disabled = isSaving;
        schoolAssignmentSave.classList.toggle('opacity-60', isSaving);
        schoolAssignmentSave.innerHTML = isSaving
            ? `<span class="inline-flex h-4 w-4 items-center justify-center"><span class="h-4 w-4 border-2 border-white/70 border-t-transparent rounded-full animate-spin"></span></span><span>กำลังบันทึก...</span>`
            : schoolAssignmentSaveDefault;
    }

    function submitSchoolAssignments() {
        if (!assignmentModalState.school || isSavingSchoolAssignments) return;
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถบันทึกได้' });
            return;
        }
        const activityIds = Array.from(assignmentModalState.selectedMap.values());
        if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังบันทึกกิจกรรมที่มอบหมาย...';
        setAssignmentSavingState(true);
        google.script.run
            .withSuccessHandler(res => {
                setAssignmentSavingState(false);
                if (res && res.success) {
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                    closeSchoolAssignmentModal();
                    loadSchoolManagementData(true);
                    loadSchoolOptions(true);
                } else {
                    const message = (res && res.error) || 'ไม่สามารถบันทึกข้อมูลได้';
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                    if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                }
            })
            .withFailureHandler(error => {
                setAssignmentSavingState(false);
                const message = error.message || 'ไม่สามารถบันทึกข้อมูลได้';
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                if (schoolManagementStatus) schoolManagementStatus.textContent = message;
            })
            .updateSchoolAssignments({
                schoolId: assignmentModalState.school.id,
                activityIds,
                actor
            });
    }

    function loadFilesForReview() {
        adminLoading.innerText = 'กำลังโหลดรายการ...';
        adminReviewList.innerHTML = '';
        showLoading();
        google.script.run
            .withSuccessHandler(onFilesLoaded)
            .withFailureHandler(handleError)
            .getFilesForReview();
    }

    function onFilesLoaded(files) {
        hideLoading();
        if (files.error) {
            adminLoading.innerText = 'เกิดข้อผิดพลาด: ' + files.error;
            return;
        }
        if (!files.length) {
            adminLoading.innerText = 'ไม่พบไฟล์ที่รอตรวจสอบ (หรือคุณไม่มีสิทธิ์)';
            return;
        }
        adminLoading.innerText = '';
        let html = '';
        files.forEach(file => {
            html += `
                <div class="p-4 border border-slate-200 rounded-lg flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <p class="font-semibold text-slate-800">Team: ${escapeHtmlClient(file.teamId)} | ${escapeHtmlClient(file.fileType)}</p>
                        <a href="${file.fileUrl}" target="_blank" class="text-sm text-sky-600 hover:underline break-all">ดูไฟล์ (${escapeHtmlClient(file.fileId)})</a>
                    </div>
                    <div class="flex gap-2">
                        <button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-medium" onclick="approveFile('${file.fileId}')">อนุมัติ</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm font-medium" onclick="rejectFile('${file.fileId}')">? ไม่ผ่าน</button>
                    </div>
                </div>
            `;
        });
        adminReviewList.innerHTML = html;
    }

    // --- Logo & photo handlers ---
    function resetSignupAvatarUI() {
        USER_AVATAR_FILE_DATA = null;
        if (signupAvatarPreview) {
            signupAvatarPreview.src = '';
            signupAvatarPreview.classList.add('hidden');
        }
        if (signupAvatarPlaceholder) {
            signupAvatarPlaceholder.classList.remove('hidden');
        }
        if (signupAvatarStatus) {
            const defaultText = signupAvatarStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ขนาดไม่เกิน 2MB';
            signupAvatarStatus.textContent = defaultText;
            signupAvatarStatus.style.color = '#64748b';
        }
        if (signupAvatarInput) {
            signupAvatarInput.value = '';
        }
    }

    function handleSignupAvatarSelect(e) {
        const file = e.target.files[0];
        if (!file) {
            resetSignupAvatarUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                signupAvatarStatus.style.color = '#ef4444';
            }
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                signupAvatarStatus.style.color = '#ef4444';
            }
            return;
        }
        if (signupAvatarStatus) {
            signupAvatarStatus.textContent = `กำลังอัปโหลด: ${file.name}`;
            signupAvatarStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            USER_AVATAR_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (signupAvatarPreview) {
                signupAvatarPreview.src = ev.target.result;
                signupAvatarPreview.classList.remove('hidden');
            }
            if (signupAvatarPlaceholder) {
                signupAvatarPlaceholder.classList.add('hidden');
            }
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                signupAvatarStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = 'ไม่สามารถอัปโหลดรูปได้';
                signupAvatarStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }
    function resetFormLogoPreview() {
        if (formLogoPreview) {
            formLogoPreview.src = '';
            formLogoPreview.classList.add('hidden');
        }
        if (formLogoPlaceholder) {
            formLogoPlaceholder.classList.remove('hidden');
        }
    }

    function handleLogoSelect(e) {
        const file = e.target.files[0];
        if (!file) {
            LOGO_FILE_DATA = null;
            logoStatus.innerText = "รองรับ .png, .jpg (ไม่เกิน 2MB)";
            logoStatus.style.color = '#64748b';
            resetFormLogoPreview();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            logoStatus.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
            logoStatus.style.color = '#ef4444';
            e.target.value = '';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            logoStatus.innerText = '? รองรับ .jpg, .png เท่านั้น';
            logoStatus.style.color = '#ef4444';
            e.target.value = '';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
            return;
        }
        logoStatus.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
        logoStatus.style.color = '#0ea5e9';
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            LOGO_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (formLogoPreview) {
                formLogoPreview.src = ev.target.result;
                formLogoPreview.classList.remove('hidden');
            }
            if (formLogoPlaceholder) {
                formLogoPlaceholder.classList.add('hidden');
            }
            logoStatus.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
            logoStatus.style.color = '#22c55e';
        };
        reader.onerror = () => {
            logoStatus.innerText = '? อ่านไฟล์ไม่สำเร็จ';
            logoStatus.style.color = '#ef4444';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
        };
        reader.readAsDataURL(file);
    }

    function resetTeamPhotoUI() {
        TEAM_PHOTO_FILE_DATA = null;
        if (teamPhotoPreview) {
            teamPhotoPreview.src = '';
            teamPhotoPreview.classList.add('hidden');
        }
        if (teamPhotoPlaceholder) teamPhotoPlaceholder.classList.remove('hidden');
        if (teamPhotoStatus) {
            const d = teamPhotoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 3MB';
            teamPhotoStatus.innerText = d;
            teamPhotoStatus.style.color = '#64748b';
        }
        if (teamPhotoInput) teamPhotoInput.value = '';
    }

    function handleTeamPhotoSelect(e) {
        const file = e.target.files[0];
        if (!file) { resetTeamPhotoUI(); return; }
        const MAX = 3;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            teamPhotoStatus.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
            teamPhotoStatus.style.color = '#ef4444';
            e.target.value = '';
            resetTeamPhotoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            teamPhotoStatus.innerText = '? รองรับ .jpg, .png เท่านั้น';
            teamPhotoStatus.style.color = '#ef4444';
            e.target.value = '';
            resetTeamPhotoUI();
            return;
        }
        teamPhotoStatus.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
        teamPhotoStatus.style.color = '#0ea5e9';
        const reader = new FileReader();
        reader.onload = ev => {
            const dataUrl = ev.target.result;
            const base64 = dataUrl.split(',')[1];
            TEAM_PHOTO_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            teamPhotoPreview.src = dataUrl;
            teamPhotoPreview.classList.remove('hidden');
            teamPhotoPlaceholder.classList.add('hidden');
            teamPhotoStatus.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
            teamPhotoStatus.style.color = '#22c55e';
        };
        reader.onerror = () => {
            teamPhotoStatus.innerText = '? อ่านไฟล์ไม่สำเร็จ';
            teamPhotoStatus.style.color = '#ef4444';
            resetTeamPhotoUI();
        };
        reader.readAsDataURL(file);
    }

    function resetTeamManageLogoUI() {
        teamManageLogoFileData = null;
        if (teamManageLogoPreview) {
            teamManageLogoPreview.src = '';
            teamManageLogoPreview.classList.add('hidden');
        }
        if (teamManageLogoPlaceholder) {
            teamManageLogoPlaceholder.classList.remove('hidden');
        }
        if (teamManageLogoStatus) {
            const defaultText = teamManageLogoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 2MB (Admin/Area เท่านั้น)';
            teamManageLogoStatus.textContent = defaultText;
            teamManageLogoStatus.style.color = '#64748b';
        }
        if (teamManageLogoInput) teamManageLogoInput.value = '';
    }

    function resetTeamManagePhotoUI() {
        teamManagePhotoFileData = null;
        if (teamManagePhotoPreview) {
            teamManagePhotoPreview.src = '';
            teamManagePhotoPreview.classList.add('hidden');
        }
        if (teamManagePhotoPlaceholder) {
            teamManagePhotoPlaceholder.classList.remove('hidden');
        }
        if (teamManagePhotoStatus) {
            const defaultText = teamManagePhotoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 3MB (Admin/Area เท่านั้น)';
            teamManagePhotoStatus.textContent = defaultText;
            teamManagePhotoStatus.style.color = '#64748b';
        }
        if (teamManagePhotoInput) teamManagePhotoInput.value = '';
    }

    function handleTeamManageLogoSelect(event) {
        if (!teamManageImageEditable) {
            resetTeamManageLogoUI();
            return;
        }
        const file = event?.target?.files?.[0];
        if (!file) {
            resetTeamManageLogoUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                teamManageLogoStatus.style.color = '#ef4444';
            }
            resetTeamManageLogoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                teamManageLogoStatus.style.color = '#ef4444';
            }
            resetTeamManageLogoUI();
            return;
        }
        if (teamManageLogoStatus) {
            teamManageLogoStatus.textContent = `กำลังประมวลผล: ${file.name}`;
            teamManageLogoStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            teamManageLogoFileData = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (teamManageLogoPreview) {
                teamManageLogoPreview.src = ev.target.result;
                teamManageLogoPreview.classList.remove('hidden');
            }
            if (teamManageLogoPlaceholder) teamManageLogoPlaceholder.classList.add('hidden');
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                teamManageLogoStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetTeamManageLogoUI();
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'ไม่สามารถอ่านไฟล์ได้';
                teamManageLogoStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }

    function handleTeamManagePhotoSelect(event) {
        if (!teamManageImageEditable) {
            resetTeamManagePhotoUI();
            return;
        }
        const file = event?.target?.files?.[0];
        if (!file) {
            resetTeamManagePhotoUI();
            return;
        }
        const MAX = 3;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                teamManagePhotoStatus.style.color = '#ef4444';
            }
            resetTeamManagePhotoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                teamManagePhotoStatus.style.color = '#ef4444';
            }
            resetTeamManagePhotoUI();
            return;
        }
        if (teamManagePhotoStatus) {
            teamManagePhotoStatus.textContent = `กำลังประมวลผล: ${file.name}`;
            teamManagePhotoStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            teamManagePhotoFileData = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (teamManagePhotoPreview) {
                teamManagePhotoPreview.src = ev.target.result;
                teamManagePhotoPreview.classList.remove('hidden');
            }
            if (teamManagePhotoPlaceholder) teamManagePhotoPlaceholder.classList.add('hidden');
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                teamManagePhotoStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetTeamManagePhotoUI();
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'ไม่สามารถอ่านไฟล์ได้';
                teamManagePhotoStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }

    function resetMemberPhotoData() {
        Object.keys(MEMBER_PHOTO_DATA).forEach(k => delete MEMBER_PHOTO_DATA[k]);
    }
    function resetTeamManageMemberPhotoData() {
        Object.keys(TEAM_MANAGE_MEMBER_PHOTO_DATA).forEach(k => delete TEAM_MANAGE_MEMBER_PHOTO_DATA[k]);
    }
    function getMemberPhotoStore(scope = 'form') {
        return scope === 'manage' ? TEAM_MANAGE_MEMBER_PHOTO_DATA : MEMBER_PHOTO_DATA;
    }

    function attachMemberPhotoListeners() {
        const inputs = document.querySelectorAll('input[data-member-photo="true"]');
        inputs.forEach(input => {
            input.removeEventListener('change', handleMemberPhotoSelect);
            input.addEventListener('change', handleMemberPhotoSelect);
        });
    }

    function handleMemberPhotoSelect(e) {
        const input = e.target;
        const file = input.files[0];
        const memberType = input.dataset.memberType || 'member';
        const memberIndex = input.dataset.memberIndex || '0';
        const previewId = input.dataset.previewTarget;
        const placeholderId = input.dataset.placeholderTarget;
        const statusId = input.dataset.statusTarget;
        const scope = input.dataset.photoScope || 'form';
        const memberKey = input.dataset.memberKey || `${memberType}-${memberIndex}`;
        const store = getMemberPhotoStore(scope);
        const previewEl = previewId ? document.getElementById(previewId) : null;
        const placeholderEl = placeholderId ? document.getElementById(placeholderId) : null;
        const statusEl = statusId ? document.getElementById(statusId) : null;
        const defaultStatus = statusEl ? (statusEl.dataset.defaultStatus || statusEl.textContent) : '';

        const showPlaceholder = () => {
            if (previewEl) {
                previewEl.src = '';
                previewEl.classList.add('hidden');
            }
            if (placeholderEl) placeholderEl.classList.remove('hidden');
        };
        const resetStatus = () => {
            if (statusEl && defaultStatus) {
                statusEl.innerText = defaultStatus;
                statusEl.style.color = '#64748b';
            }
        };

        if (!file) {
            delete store[memberKey];
            showPlaceholder();
            resetStatus();
            return;
        }

        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (statusEl) {
                statusEl.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
                statusEl.style.color = '#ef4444';
            }
            input.value = '';
            delete store[memberKey];
            showPlaceholder();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (statusEl) {
                statusEl.innerText = '? รองรับ .jpg, .png เท่านั้น';
                statusEl.style.color = '#ef4444';
            }
            input.value = '';
            delete store[memberKey];
            showPlaceholder();
            return;
        }

        if (statusEl) {
            statusEl.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
            statusEl.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const dataUrl = ev.target.result;
            const base64 = dataUrl.split(',')[1];
            store[memberKey] = { base64Data: base64, mimeType: file.type, fileName: file.name, dataUrl };
            if (previewEl) {
                previewEl.src = dataUrl;
                previewEl.classList.remove('hidden');
            }
            if (placeholderEl) placeholderEl.classList.add('hidden');
            if (statusEl) {
                statusEl.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
                statusEl.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            if (statusEl) {
                statusEl.innerText = '? อ่านไฟล์ไม่สำเร็จ';
                statusEl.style.color = '#ef4444';
            }
            delete store[memberKey];
            showPlaceholder();
        };
        reader.readAsDataURL(file);
    }

    // --- Form behavior based on activity ---
    function selectActivityForForm(activityId) {
        if (!requireLoginForRegistration()) return;
        if (!canCurrentUserSelectActivity(activityId)) {
            Swal.fire({
                icon: 'info',
                title: 'ไม่สามารถเลือกกิจกรรมนี้ได้',
                text: 'โรงเรียนของคุณต้องรอให้ Group Admin กำหนดกิจกรรมก่อน'
            });
            return;
        }
        const activity = ALL_ACTIVITIES.find(a => a.id === activityId);
        if (isActivityClosed(activity)) {
            Swal.fire({ icon: 'info', title: 'กิจกรรมนี้ปิดรับสมัครแล้ว', text: 'ไม่สามารถสมัครทีมใหม่ได้' });
            return;
        }
        if (activityCategorySelect && activity) {
            syncCategoryForActivity(activity);
        }
        activitySelect.value = activityId;
        updateFormBasedOnActivity(activityId);
        navigateTo('section-form');
    }

    function syncCategoryForActivity(activity) {
        if (!activityCategorySelect || !activity) return;
        const target = activity.category || '';
        if (activityCategorySelect.value !== target) {
            suppressCategorySync = true;
            activityCategorySelect.value = target;
            suppressCategorySync = false;
        }
        refreshActivitiesAfterCategoryChange(activity.id);
    }

    function refreshActivitiesAfterCategoryChange(preferredActivityId = null) {
        if (!activitySelect) return;
        const activities = getFormActivities();
        populateFormActivitySelect(activities);
        if (preferredActivityId && activities.some(a => a.id === preferredActivityId)) {
            activitySelect.value = preferredActivityId;
        } else if (preferredActivityId) {
            activitySelect.value = '';
        }
    }

    function updateFormBasedOnActivity(activityId) {
        const activity = ALL_ACTIVITIES.find(a => a.id === activityId);
        if (!activity) {
            levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
            memberReqText.innerText = 'กรุณาเลือกกิจกรรม...';
            teacherFields.innerHTML = '';
            studentFields.innerHTML = '';
            resetMemberPhotoData();
            setSubmitButtonState(true);
            return;
        }
        if (isActivityClosed(activity)) {
            levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
            memberReqText.innerText = 'กิจกรรมนี้ปิดรับสมัครแล้ว';
            teacherFields.innerHTML = '';
            studentFields.innerHTML = '';
            resetMemberPhotoData();
            setSubmitButtonState(true);
            return;
        }

        setSubmitButtonState(false);
        levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
        (Array.isArray(activity.levels) ? activity.levels : []).forEach(level => {
            levelSelect.innerHTML += `<option value="${level}">${level}</option>`;
        });
        if (Array.isArray(activity.levels) && activity.levels.length === 1) {
            levelSelect.value = activity.levels[0];
        } else {
            levelSelect.value = '';
        }

        const reqs = {
            teachers: activity.reqTeachers || 1,
            students: activity.reqStudents || 2
        };
        const remainingTeams = calculateRemainingTeams(activity);
        const hasLimit = typeof activity.maxTeams === 'number' && activity.maxTeams > 0;
        const limitText = hasLimit
            ? `รับ ${activity.maxTeams} ทีม (เหลือ ${typeof remainingTeams === 'number' ? remainingTeams : '-'} ทีม)`
            : 'ไม่จำกัดทีม';
        const deadlineText = formatDeadline(activity.registrationDeadline);

        memberReqText.innerHTML =
            `กิจกรรมนี้ต้องการ: ครู ${reqs.teachers} คน, นักเรียน ${reqs.students} คน` +
            `<br>จำนวนทีม: ${limitText}` +
            `<br>ปิดรับสมัคร: ${deadlineText}`;

        resetMemberPhotoData();
        teacherFields.innerHTML = '';
        for (let i = 1; i <= reqs.teachers; i++) {
            const pid = `teacher-photo-${i}`;
            const previewId = `${pid}-preview`;
            const placeholderId = `${pid}-placeholder`;
            const statusId = `${pid}-status`;
            teacherFields.innerHTML += `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="font-medium mb-2">ครู คนที่ ${i}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input type="text" name="teacherPrefix" list="teacher-prefix-options" placeholder="คำนำหน้า" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="text" name="teacherName" placeholder="ชื่อ-สกุล ครู" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="tel" name="teacherPhone" placeholder="เบอร์โทร ครู" class="w-full p-2 border border-slate-300 rounded-lg" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                    <div class="mt-3 flex items-center gap-3">
                        <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white.flex items-center justify-center overflow-hidden">
                            <img id="${previewId}" alt="Teacher preview ${i}" class="hidden w-full h-full object-cover">
                            <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>
                        </div>
                        <div class="flex-1 space-y-1">
                            <input type="file"
                                   id="${pid}"
                                   data-member-photo="true"
                                   data-member-type="teacher"
                                   data-member-index="${i}"
                                   data-preview-target="${previewId}"
                                   data-placeholder-target="${placeholderId}"
                                   data-status-target="${statusId}"
                                   class="w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-sky-100 file:text-sky-700
                                        hover:file:bg-sky-200"
                                   accept="image/png, image/jpeg">
                            <p id="${statusId}" class="text-xs text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)">อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)</p>
                        </div>
                    </div>
                </div>
            `;
        }

        studentFields.innerHTML = '';
        for (let i = 1; i <= reqs.students; i++) {
            const pid = `student-photo-${i}`;
            const previewId = `${pid}-preview`;
            const placeholderId = `${pid}-placeholder`;
            const statusId = `${pid}-status`;
            studentFields.innerHTML += `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="font-medium mb-2">นักเรียน คนที่ ${i}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input type="text" name="studentPrefix" list="student-prefix-options" placeholder="คำนำหน้า" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="text" name="studentName" placeholder="ชื่อ-สกุล นักเรียน" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        ${buildClassLevelControlHtml('student', i, '', { scope: 'form' })}
                    </div>
                    <div class="mt-3 flex items-center gap-3">
                        <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                            <img id="${previewId}" alt="Student preview ${i}" class="hidden w-full h-full object-cover">
                            <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>
                        </div>
                        <div class="flex-1 space-y-1">
                            <input type="file"
                                   id="${pid}"
                                   data-member-photo="true"
                                   data-member-type="student"
                                   data-member-index="${i}"
                                   data-preview-target="${previewId}"
                                   data-placeholder-target="${placeholderId}"
                                   data-status-target="${statusId}"
                                   class="w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-sky-100 file:text-sky-700
                                        hover:file:bg-sky-200"
                                   accept="image/png, image/jpeg">
                            <p id="${statusId}" class="text-xs text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)">อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)</p>
                        </div>
                    </div>
                </div>
            `;
        }
        attachMemberPhotoListeners();
    }

    function getFormActivities() {
        let activities = Array.isArray(ALL_ACTIVITIES) ? [...ALL_ACTIVITIES] : [];
        activities = filterActivitiesForCurrentUser(activities);
        if (!activityCategorySelect) return activities;
        const selectedCategory = activityCategorySelect.value || '';
        if (selectedCategory) {
            activities = activities.filter(a => (a.category || '') === selectedCategory);
        }
        return activities;
    }

    // --- Export Teams ---
    function base64ToBlob(base64, mimeType) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return new Blob([bytes], { type: mimeType });
    }
    function downloadBase64File(base64, mimeType, fileName) {
        const blob = base64ToBlob(base64, mimeType);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
function handleTeamsExport(format) {
        const allowed = ['csv', 'pdf'];
        if (!allowed.includes(format)) {
            Swal.fire({ icon: 'error', title: 'รูปแบบไม่รองรับ', text: 'ไม่สามารถส่งออกไฟล์ได้' });
            return;
        }

        // ตรวจสอบข้อมูลที่กรองแล้วในตาราง
        if (!CURRENTLY_VISIBLE_TEAMS || !CURRENTLY_VISIBLE_TEAMS.length) {
            Swal.fire({ icon: 'warning', title: 'ยังไม่มีข้อมูลทีม', text: 'โปรดรอให้ข้อมูลทีมโหลดเสร็จก่อน หรือข้อมูลในตารางว่างเปล่า' });
            return;
        }

        const fileTypeLabel = format.toUpperCase();
        
        Swal.fire({
            title: `กำลังเตรียมไฟล์ ${fileTypeLabel}...`,
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        
        google.script.run
            .withSuccessHandler(res => {
                Swal.close();
                if (!res || !res.success) {
                    const msg = (res && res.error) || 'ไม่สามารถส่งออกข้อมูลได้';
                    Swal.fire({ icon: 'error', title: 'ส่งออกไม่สำเร็จ', text: msg });
                    return;
                }
                try {
                    downloadBase64File(res.data, res.mimeType || 'text/csv', res.fileName || `teams.${format}`);
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งออกสำเร็จ',
                        text: `ไฟล์ ${res.fileName || `teams.${format}`} ถูกดาวน์โหลดแล้ว`,
                        timer: 2200,
                        showConfirmButton: false
                    });
                } catch (err) {
                    handleError(err);
                }
            })
            .withFailureHandler(err => {
                Swal.close();
                handleError(err);
            })
            // เรียกฟังก์ชันใน code.gs ที่รองรับทั้ง 2 format
            .exportFilteredData(CURRENTLY_VISIBLE_TEAMS, ALL_ACTIVITIES, format); 
    }

    function generateTeamsSummaryPdfKanit() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

        // เตรียม DOM ชั่วคราวสำหรับเรนเดอร์
        const container = document.createElement('div');
        container.className = 'pdf-kanit';
        container.style.position = 'fixed';
        container.style.left = '-10000px';
        container.style.top = '0';
        container.style.width = '1120px';
        container.style.background = '#ffffff';
        container.style.padding = '16px';

        const updatedAt = new Date().toLocaleString('th-TH');

        let html = '';
        html += '<div class="pdf-title">รายงานทีมที่ลงทะเบียน</div>';
        html += '<div class="pdf-subtitle">อัปเดตล่าสุด: ' + escapeHtmlForPdf(updatedAt) + '</div>';
        html += '<table class="pdf-table"><thead><tr>';
        html += '<th>#</th><th>รหัสทีม</th><th>กิจกรรม</th><th>ชื่อทีม</th><th>โรงเรียน</th>';
        html += '<th>ครู (ต้อง/มี)</th><th>นร. (ต้อง/มี)</th><th>ระดับ</th><th>สถานะ</th>';
        html += '</tr></thead><tbody>';

        (ALL_TEAMS || []).forEach((t, i) => {
            let teachers = 0, students = 0;
            try {
                const m = t.members ? JSON.parse(t.members) : {};
                teachers = Array.isArray(m.teachers) ? m.teachers.length : 0;
                students = Array.isArray(m.students) ? m.students.length : 0;
            } catch (e) {}

            html += '<tr>';
            html += '<td>' + (i + 1) + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.teamId || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.activityName || t.activity || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.teamName || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.school || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf((t.requiredTeachers || '-') + ' / ' + teachers) + '</td>';
            html += '<td>' + escapeHtmlForPdf((t.requiredStudents || '-') + ' / ' + students) + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.level || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.status || '') + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        document.body.appendChild(container);

        Swal.fire({
            title: 'กำลังสร้าง PDF...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        pdf.html(container, {
            margin: 20,
            autoPaging: 'text',
            html2canvas: { scale: 2, useCORS: true, logging: false }
        }).then(() => {
            Swal.close();
            pdf.save('teams-summary.pdf');
            document.body.removeChild(container);
        }).catch(err => {
            Swal.close();
            document.body.removeChild(container);
            handleError(err);
        });
    }


function handleAttendanceExport() {
        if (!CURRENTLY_VISIBLE_TEAMS || !CURRENTLY_VISIBLE_TEAMS.length) {
            Swal.fire({ icon: 'warning', title: 'ยังไม่มีข้อมูลทีม', text: 'โปรดรอให้ข้อมูลทีมโหลดเสร็จก่อน หรือข้อมูลในตารางว่างเปล่า' });
            return;
        }

        Swal.fire({
            title: `กำลังสร้างใบลงเวลา...`,
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // เรียกฟังก์ชันใหม่ใน code.gs
        google.script.run
            .withSuccessHandler(res => {
                Swal.close();
                if (!res || !res.success) {
                    const msg = (res && res.error) || 'ไม่สามารถส่งออกข้อมูลได้';
                    Swal.fire({ icon: 'error', title: 'ส่งออกไม่สำเร็จ', text: msg });
                    return;
                }
                try {
                    downloadBase64File(res.data, res.mimeType || 'application/pdf', res.fileName || 'attendance.pdf');
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งออกสำเร็จ',
                        text: `ไฟล์ ${res.fileName || 'attendance.pdf'} ถูกดาวน์โหลดแล้ว`,
                        timer: 2200,
                        showConfirmButton: false
                    });
                } catch (err) {
                    handleError(err);
                }
            })
            .withFailureHandler(err => {
                Swal.close();
                handleError(err);
            })
            .exportAttendanceSheet(CURRENTLY_VISIBLE_TEAMS, ALL_ACTIVITIES);
    }

// --- Upload (section 5) ---
    uploadButton.addEventListener('click', () => {
        const teamId = uploadTeamIdSelect.value;
        const fileType = uploadFileTypeSelect.value;
        const file = fileInput.files[0];
        if (!teamId || !fileType || !file) {
            Swal.fire({ icon: 'warning', title: 'กรุณากรอกข้อมูลให้ครบ', text: 'โปรดเลือกทีม ประเภทไฟล์ และไฟล์ที่ต้องการอัปโหลด' });
            return;
        }
        const MAX = 5;
        if (file.size > MAX * 1024 * 1024) {
            uploadStatusDiv.innerHTML = `<p class="text-red-600 font-semibold">? ไฟล์ใหญ่เกิน ${MAX}MB (ไฟล์ของคุณ ${(file.size/1024/1024).toFixed(2)}MB)</p>`;
            return;
        }
        const ALLOWED = ['application/pdf', 'image/jpeg', 'image/png'];
        if (!ALLOWED.includes(file.type)) {
            uploadStatusDiv.innerHTML = `<p class="text-red-600 font-semibold">? รองรับเฉพาะไฟล์ .pdf, .jpg, .png เท่านั้น (ไฟล์ของคุณคือ ${file.type})</p>`;
            return;
        }
        showLoading();
        uploadStatusDiv.innerHTML = `<p class="text-sky-600">กำลังอัปโหลด ${file.name}...</p>`;
        const reader = new FileReader();
        reader.onload = e => {
            const base64Data = e.target.result.split(',')[1];
            const fileData = {
                base64Data,
                mimeType: file.type,
                fileName: file.name,
                teamId,
                fileType
            };
            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onUploadFailure)
                .uploadFile(fileData);
        };
        reader.readAsDataURL(file);
    });

    function onUploadSuccess(res) {
        hideLoading();
        if (res.success) {
        uploadStatusDiv.innerHTML = `<p class="text-green-600">${res.message}</p>`;
            fileInput.value = '';
            uploadFileTypeSelect.value = '';
        } else {
            onUploadFailure({ message: res.error });
        }
    }
    function onUploadFailure(error) {
        hideLoading();
        uploadStatusDiv.innerHTML = `<p class="text-red-600">? อัปโหลดล้มเหลว: ${error.message}</p>`;
    }

    // --- Admin actions ---
    async function approveFile(fileLogId) {
        const result = await Swal.fire({
            icon: 'question',
            title: `ยืนยันการอนุมัติไฟล์ ${fileLogId}?`,
            confirmButtonText: 'อนุมัติ',
            cancelButtonText: 'ยกเลิก',
            showCancelButton: true
        });
        if (!result.isConfirmed) return;
        showLoading();
        google.script.run
            .withSuccessHandler(onAdminActionSuccess)
            .withFailureHandler(handleError)
            .updateFileStatus(fileLogId, 'Approved', '');
    }

    async function rejectFile(fileLogId) {
        const result = await Swal.fire({
            icon: 'warning',
            title: `กรุณาระบุเหตุผลที่ 'ไม่ผ่าน' สำหรับไฟล์ ${fileLogId}`,
            input: 'textarea',
            inputPlaceholder: 'พิมพ์เหตุผลที่ต้องการแจ้งทีม...',
            showCancelButton: true,
            confirmButtonText: 'ส่ง',
            cancelButtonText: 'ยกเลิก'
        });
        if (!result.isConfirmed) return;
        const remarks = result.value || '';
        showLoading();
        google.script.run
            .withSuccessHandler(onAdminActionSuccess)
            .withFailureHandler(handleError)
            .updateFileStatus(fileLogId, 'Rejected', remarks);
    }

    function onAdminActionSuccess(res) {
        hideLoading();
        if (res.success) {
            Swal.fire({ icon: 'success', title: 'อัปเดตสำเร็จ', text: res.message });
            loadFilesForReview();
        } else {
            handleError({ message: res.error });
        }
    }

    // --- Validate form + submit ---
    function validateTeamRegistration(data, activity, teachers, students) {
        const errors = [];
        const trim = v => (v || '').toString().trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^[0-9+()\-\s]{9,20}$/;

        if (!activity) errors.push('กรุณาเลือกกิจกรรมที่ต้องการสมัคร');
        if (!trim(data.level)) errors.push('กรุณาเลือกระดับการแข่งขัน');
        if (!trim(data.school)) {
            errors.push('กรุณากรอกชื่อสถานศึกษา');
        } else if (!isSchoolAllowedForCurrentUser(data.school)) {
            errors.push('คุณไม่มีสิทธิ์เลือกโรงเรียนนี้');
        }

        const contactName = trim(data.contact.name);
        const contactPhone = trim(data.contact.phone);
        const contactEmail = trim(data.contact.email);
        if (!contactName) errors.push('กรุณากรอกชื่อผู้ประสานงาน');
        if (!contactPhone) {
            errors.push('กรุณากรอกเบอร์โทรติดต่อ');
        } else if (!phoneRegex.test(contactPhone)) {
            errors.push('เบอร์โทรต้องมีอย่างน้อย 9 หลัก และสามารถใช้ตัวเลข + - ( ) และเว้นวรรคได้');
        }
        if (!contactEmail) {
            errors.push('กรุณากรอกอีเมลผู้ประสานงาน');
        } else if (!emailRegex.test(contactEmail)) {
            errors.push('รูปแบบอีเมลผู้ประสานงานไม่ถูกต้อง');
        }

        const expectedTeachers = Number(activity?.reqTeachers ?? data.requiredTeachers ?? teachers.length);
        const expectedStudents = Number(activity?.reqStudents ?? data.requiredStudents ?? students.length);

        teachers.forEach((t, i) => {
            const prefix = trim(t.prefix);
            const name = trim(t.name);
            const phone = trim(t.phone);
            if (!prefix || !name || !phone) {
                errors.push(`กรุณากรอกคำนำหน้า ชื่อ และเบอร์โทรของครูคนที่ ${i + 1}`);
            } else if (!phoneRegex.test(phone)) {
                errors.push(`เบอร์โทรของครูคนที่ ${i + 1} ต้องมีอย่างน้อย 9 หลัก และสามารถใช้ตัวเลข + - ( ) และเว้นวรรคได้`);
            }
        });

        students.forEach((s, i) => {
            const prefix = trim(s.prefix);
            const name = trim(s.name);
            const classroom = trim(s.class);
            if (!prefix || !name || !classroom) {
                errors.push(`กรุณากรอกคำนำหน้า ชื่อ และชั้นเรียนของนักเรียนคนที่ ${i + 1}`);
            }
        });

        if (teachers.length !== expectedTeachers) {
            errors.push(`จำนวนครูไม่ตรงตามเงื่อนไข (${expectedTeachers} คน)`);
        }
        if (students.length !== expectedStudents) {
            errors.push(`จำนวนนักเรียนไม่ตรงตามเงื่อนไข (${expectedStudents} คน)`);
        }

        return errors;
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        if (!requireLoginForRegistration()) return;
        if (!form.reportValidity()) return;

        const fd = new FormData(form);
        const getVal = name => (fd.get(name) || '').toString().trim();

        const data = {
            activity: getVal('activity'),
            level: getVal('level'),
            school: getVal('school'),
            teamName: getVal('teamName')
        };

        if (!data.activity) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกกิจกรรม', text: 'โปรดเลือกกิจกรรมที่ต้องการสมัคร' });
            return;
        }

        const activity = ALL_ACTIVITIES.find(a => a.id === data.activity);
        if (!activity) {
            Swal.fire({ icon: 'error', title: 'ไม่พบกิจกรรมที่เลือก', text: 'กรุณาลองใหม่อีกครั้ง' });
            return;
        }
        if (isActivityClosed(activity)) {
            Swal.fire({ icon: 'info', title: 'กิจกรรมนี้ปิดรับสมัครแล้ว', text: 'ไม่สามารถสมัครทีมใหม่ได้' });
            return;
        }

        data.contact = {
            name: getVal('contactName'),
            phone: getVal('contactPhone'),
            email: getVal('contactEmail')
        };

        const teacherNameInputs = Array.from(form.querySelectorAll('input[name="teacherName"]'));
        const teacherPhoneInputs = Array.from(form.querySelectorAll('input[name="teacherPhone"]'));
        const teacherPrefixInputs = Array.from(form.querySelectorAll('input[name="teacherPrefix"]'));
        const teachers = teacherNameInputs.map((input, idx) => {
            const t = {
                prefix: (teacherPrefixInputs[idx]?.value || '').trim(),
                name: (input.value || '').trim(),
                phone: (teacherPhoneInputs[idx]?.value || '').trim()
            };
            const key = `teacher-${idx + 1}`;
            const photo = MEMBER_PHOTO_DATA[key];
            if (photo) t.photoFileData = photo;
            return t;
        });

        const studentNameInputs = Array.from(form.querySelectorAll('input[name="studentName"]'));
        const studentPrefixInputs = Array.from(form.querySelectorAll('input[name="studentPrefix"]'));
        const students = studentNameInputs.map((input, idx) => {
            const s = {
                prefix: (studentPrefixInputs[idx]?.value || '').trim(),
                name: (input.value || '').trim(),
                class: getSelectedClassLevelValue('student', idx + 1, 'form')
            };
            const key = `student-${idx + 1}`;
            const photo = MEMBER_PHOTO_DATA[key];
            if (photo) s.photoFileData = photo;
            return s;
        });

        data.members = { teachers, students };
        data.requiredTeachers = activity ? Number(activity.reqTeachers || teachers.length) : teachers.length;
        data.requiredStudents = activity ? Number(activity.reqStudents || students.length) : students.length;
        const creatorId = getCurrentUserId();
        if (creatorId) {
            data.createdByUserId = creatorId;
            data.createdByUsername = currentUser?.username || '';
        }

        const errors = validateTeamRegistration(data, activity, teachers, students);
        if (errors.length > 0) {
            const html = `<ul class="text-left list-disc list-inside space-y-1">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
            Swal.fire({ icon: 'warning', title: 'กรุณาตรวจสอบข้อมูล', html });
            return;
        }

        if (LOGO_FILE_DATA) data.logoFileData = LOGO_FILE_DATA;
        if (TEAM_PHOTO_FILE_DATA) data.teamPhotoFileData = TEAM_PHOTO_FILE_DATA;

        showLoading();
        google.script.run
            .withSuccessHandler(onRegistrationSuccess)
            .withFailureHandler(handleError)
            .registerTeam(data);
    });

    function onRegistrationSuccess(res) {
        hideLoading();
        if (res.success) {
            Swal.fire({
                icon: 'success',
                title: 'ลงทะเบียนสำเร็จ!',
                text: `รหัสทีมของคุณคือ: ${res.teamId}`
            }).then(() => {
                form.reset();
                LOGO_FILE_DATA = null;
                logoStatus.innerText = "รองรับ .png, .jpg (ไม่เกิน 2MB)";
                logoStatus.style.color = '#64748b';
                logoInput.value = '';
                resetFormLogoPreview();
                resetTeamPhotoUI();
                resetMemberPhotoData();
                activitySelect.value = '';
                updateFormBasedOnActivity('');
                setSubmitButtonState(true);
                CURRENT_STEP = 1;
                updateFormStepUI();
                loadRegisteredTeams(true);
                cachedReport = null;
                lastReportFetch = 0;
                loadSchoolOptions(true);
                navigateTo('section-teams');
            });
        } else {
            handleError({ message: res.error });
        }
    }

    // --- Search handlers ---
    function handleTeamSearchInput(e) {
        const val = e.target.value || '';
        if (teamSearchDebounce) clearTimeout(teamSearchDebounce);
        teamSearchDebounce = setTimeout(() => {
            teamSearchTerm = val.trim().toLowerCase();
            renderTeamTable(ALL_TEAMS);
        }, 200);
    }


function shouldAllowAreaJudgeSelection() {
  if (competitionStage !== 'area') return false;
  const level = getCurrentUserLevel();
  return ['admin', 'area'].includes(level);
}

function shouldUseAreaJudgeManagement() {
  return competitionStage === 'area' && ['admin', 'area'].includes(getCurrentUserLevel());
}

function getJudgeSelectionStore() {
    if (!SCORE_SHEET_PROMPT_STATE.judgeSelections) {
        SCORE_SHEET_PROMPT_STATE.judgeSelections = {};
    }
    return SCORE_SHEET_PROMPT_STATE.judgeSelections;
}

function getStoredJudgeSelection(activityId) {
    const key = (activityId || '').toString().trim();
    if (!key) return [];
    const store = getJudgeSelectionStore();
    const selection = store[key];
    return Array.isArray(selection) ? selection.slice() : [];
}

function setStoredJudgeSelection(activityId, rows) {
    const key = (activityId || '').toString().trim();
    if (!key) return;
    const store = getJudgeSelectionStore();
    store[key] = Array.isArray(rows) ? rows.filter(Boolean) : [];
}


// ฟอร์มถามจำนวนกรรมการ & จำนวนหัวข้อคะแนน ก่อนสร้างใบลงคะแนน
async function openScoreSheetPrompt(activityId){
  const storedJudges = Math.max(1, SCORE_SHEET_PROMPT_STATE.judges || SCORE_SHEET_CONFIG.defaultJudges || 3);
  const storedScoreCols = Math.max(1, SCORE_SHEET_PROMPT_STATE.scoreCols || SCORE_SHEET_CONFIG.defaultScoreCols || 10);
  const storedVisibility = SCORE_SHEET_PROMPT_STATE.showJudgeNames ? 'show' : 'hide';
  const allowAreaJudgeSelection = shouldAllowAreaJudgeSelection();
  const storedJudgeRows = getStoredJudgeSelection(activityId);
  const areaJudgeOptions = allowAreaJudgeSelection ? getJudgesForActivity(activityId) : [];
  const canSelectAreaJudges = Array.isArray(areaJudgeOptions) && areaJudgeOptions.length > 0;
  const judgeOptionsHtml = canSelectAreaJudges
    ? areaJudgeOptions.map(judge => {
        const value = buildJudgeSelectionKey(judge);
        const selected = storedJudgeRows.includes(value) ? 'selected' : '';
        const metaParts = [];
        if (judge.clusterLabel) metaParts.push(judge.clusterLabel);
        if (judge.schoolName) metaParts.push(judge.schoolName);
        const subtitle = metaParts.length ? ` (${metaParts.join(' • ')})` : '';
        const roleLabel = judge.role ? ` • ${judge.role}` : '';
        const optionLabel = `${judge.judgeName || 'ไม่ระบุชื่อ'}${roleLabel}${subtitle}`;
        return `<option value="${escapeHtmlClient(value)}" ${selected}>${escapeHtmlClient(optionLabel)}</option>`;
      }).join('')
    : '';
  const judgeSelectBlock = allowAreaJudgeSelection
    ? (canSelectAreaJudges
        ? `
        <div class="score-swal-field">
          <label for="swal-judge-select">เลือกกรรมการรอบระดับเขต</label>
          <select id="swal-judge-select" multiple size="${Math.min(8, Math.max(4, areaJudgeOptions.length))}" class="swal2-input score-swal-input min-h-[140px]">
            ${judgeOptionsHtml}
          </select>
          <span class="score-swal-hint">กด Ctrl/Cmd เพื่อเลือกหลายคน หากไม่เลือก ระบบจะใช้รายชื่อทั้งหมด</span>
        </div>`
        : `
        <div class="score-swal-field">
          <label>เลือกกรรมการรอบระดับเขต</label>
          <div class="score-swal-hint text-rose-600">ยังไม่มีรายชื่อกรรมการสำหรับกิจกรรมนี้</div>
        </div>`)
    : '';
  const { value: form } = await Swal.fire({
    title: 'ตั้งค่าใบลงคะแนน',
    html: `
      <p class="score-swal-hint text-center">กำหนดจำนวนกรรมการและหัวข้อให้คะแนนก่อนสร้างเอกสาร</p>
      <div class="score-swal-grid">
        <div class="score-swal-field">
          <label for="swal-judges">จำนวนกรรมการ</label>
          <input id="swal-judges" type="number" min="1" max="15" step="1" value="${escapeHtmlClient(String(storedJudges))}"
                 class="swal2-input score-swal-input" inputmode="numeric">
          <span class="score-swal-hint">แนะนำ 3–9 คน</span>
        </div>
        <div class="score-swal-field">
          <label for="swal-scorecols">จำนวนหัวข้อให้คะแนน</label>
          <input id="swal-scorecols" type="number" min="1" max="30" step="1" value="${escapeHtmlClient(String(storedScoreCols))}"
                 class="swal2-input score-swal-input" inputmode="numeric">
          <span class="score-swal-hint">กำหนดได้ตามหัวข้อที่ต้องการ</span>
        </div>
        <div class="score-swal-field">
          <label for="swal-judge-visibility">รายชื่อกรรมการ</label>
          <select id="swal-judge-visibility" class="swal2-input score-swal-input">
            <option value="show" ${storedVisibility === 'show' ? 'selected' : ''}>แสดงเฉพาะในช่องลายเซ็น</option>
            <option value="hide" ${storedVisibility === 'hide' ? 'selected' : ''}>ซ่อนรายชื่อ</option>
          </select>
          <span class="score-swal-hint">เลือกว่าใบลงคะแนนจะแสดงรายชื่อหรือไม่</span>
        </div>
      </div>
      ${judgeSelectBlock}
      <p class="score-swal-note">Tip: ค่าที่ตั้งไว้จะถูกใช้เป็นค่าเริ่มต้นของกิจกรรมนี้</p>
    `,
    customClass: {
      popup: 'score-swal-popup',
      htmlContainer: 'score-swal-container'
    },
    width: 'min(520px, 92vw)',
    confirmButtonText: 'สร้างใบลงคะแนน',
    showCancelButton: true,
    focusConfirm: false,
    allowOutsideClick: false,
    didOpen: () => {
      const judgesInput = Swal.getPopup()?.querySelector('#swal-judges');
      if (judgesInput) {
        judgesInput.focus();
        judgesInput.select();
      }
    },
    preConfirm: () => {
      const popup = Swal.getPopup();
      if (!popup) return false;
      const judgesInput = popup.querySelector('#swal-judges');
      const scoreColsInput = popup.querySelector('#swal-scorecols');
      const visibilitySelect = popup.querySelector('#swal-judge-visibility');
      const judgeSelect = popup.querySelector('#swal-judge-select');
      const judges = parseInt(judgesInput?.value || '', 10);
      const scoreCols = parseInt(scoreColsInput?.value || '', 10);
      const showJudgeNames = (visibilitySelect?.value || 'show') === 'show';
      const judgeRows = allowAreaJudgeSelection && judgeSelect
        ? Array.from(judgeSelect.selectedOptions || []).map(opt => opt.value).filter(Boolean)
        : [];
      if (!judges || judges < 1) {
        Swal.showValidationMessage('กรุณาระบุจำนวนกรรมการ ≥ 1');
        return false;
      }
      if (!scoreCols || scoreCols < 1) {
        Swal.showValidationMessage('กรุณาระบุจำนวนหัวข้อ ≥ 1');
        return false;
      }
      return { judges, scoreCols, showJudgeNames, judgeRows };
    }
  });
  if (!form) return;
  SCORE_SHEET_PROMPT_STATE.judges = Math.max(1, form.judges);
  SCORE_SHEET_PROMPT_STATE.scoreCols = Math.max(1, form.scoreCols);
  SCORE_SHEET_PROMPT_STATE.showJudgeNames = Boolean(form.showJudgeNames);
  if (allowAreaJudgeSelection) {
    setStoredJudgeSelection(activityId, form.judgeRows || []);
  }
  openScoreSheetModal(activityId, {
    judges: form.judges,
    scoreCols: form.scoreCols,
    showJudgeNames: form.showJudgeNames,
    selectedJudgeRows: form.judgeRows || []
  });
}



function openScoreSheetModal(activityId, opts = {}) {
  const modal = document.getElementById('score-sheet-modal');
  const body  = document.getElementById('score-sheet-body');
  const titleEl = document.getElementById('score-sheet-title');
  const subtitleEl = document.getElementById('score-sheet-subtitle');
  if (!modal || !body) return;

  // ---- meta กิจกรรม (กันกรณีชื่อกลายเป็นรหัส) ----
  const meta = getActivityMeta(activityId);
  const actName = meta.name || meta.id || 'กิจกรรม';
  const category = meta.category || '';

  // ค่าจำนวนคอลัมน์คะแนน/กรรมการ (จาก prompt) หากไม่ส่งมา ใช้ default
  const scoreCols = Math.max(1, parseInt(opts.scoreCols ?? (SCORE_SHEET_CONFIG?.defaultScoreCols || 10), 10));
  const judgeCount = Math.max(1, parseInt(opts.judges ?? (SCORE_SHEET_CONFIG?.defaultJudges || 3), 10));
  const allowAreaJudgeSelection = shouldAllowAreaJudgeSelection();
  const fallbackSelectedRows = allowAreaJudgeSelection ? getStoredJudgeSelection(activityId) : [];
  const selectedJudgeRows = Array.isArray(opts.selectedJudgeRows) && opts.selectedJudgeRows.length
    ? opts.selectedJudgeRows
    : fallbackSelectedRows;
  const visibleJudges = resolveScoreSheetJudges(activityId, selectedJudgeRows);
  const showJudgeNames = opts.showJudgeNames !== false;

  // ทีมในกิจกรรมนี้ (อิงชุดที่กำลังแสดง)
  const teamsAll = Array.isArray(CURRENTLY_VISIBLE_TEAMS) ? CURRENTLY_VISIBLE_TEAMS : [];
  const teams = teamsAll
    .filter(t => String(t.activity).trim() === String(meta.id).trim() || String(t.activity).trim() === String(actName).trim())
    .sort((a, b) => {
      const byName = (a.teamName||'').localeCompare(b.teamName||'', 'th');
      return byName !== 0 ? byName : (a.school||'').localeCompare(b.school||'', 'th');
    });

  if (titleEl) titleEl.textContent = `ใบลงคะแนน : ${actName}`;
  if (subtitleEl) {
    // ไม่ต้องโชว์ข้อความ "ช่องคะแนน/กรรมการ" ตามคำสั่ง
    subtitleEl.textContent = category ? `หมวดหมู่: ${category} • ทีม ${teams.length}` : `ทีม ${teams.length}`;
  }

  if (!teams.length) {
    body.innerHTML = `
      <div class="p-6 text-center text-sm text-slate-500 bg-white rounded-2xl">
        ยังไม่มีทีมในกิจกรรมนี้ ไม่สามารถสร้างใบลงคะแนนได้
      </div>`;
    modal.classList.remove('hidden'); modal.classList.add('flex');
    return;
  }

  // ====== สร้างหัวข้อคะแนน (ค1..คN) ======
  const scoreHeaders = Array.from({ length: scoreCols })
    .map((_, i) => `<th>ค ${i + 1}</th>`).join('');

  // ====== แถวทีม: ไม่มี "รหัสทีม" แล้ว, ลดความกว้างคอลัมน์ "รวม", "ผลการแข่งขัน" เว้นว่างให้เขียน ======
  const rowsHtml = teams.map((team, idx) => `
    <tr>
      <td>${idx + 1}</td>
      <td class="text-left">
        <div class="team-name-cell">
          <div class="font-semibold">${escapeHtmlClient(team.school || '-')}</div>
          <div class="sub">${escapeHtmlClient(team.teamName || '-')}</div>
        </div>
      </td>
      ${Array.from({ length: scoreCols }).map(() => '<td class="score-cell"></td>').join('')}
      <td class="sum-cell"></td>
      <td class="result-cell"></td>   <!-- << เว้นว่างไว้ ไม่ใส่ checkbox/ตัวเลือกแล้ว -->
      <td class="note-cell"></td>
    </tr>
  `).join('');


  // ====== ส่วนลายเซ็นกรรมการ ======
  const signatureList = buildSignatureListForCount(visibleJudges, judgeCount);
  const sigHtml = renderSignatureBoxes(signatureList, { showNames: showJudgeNames });

  // ====== Header + Logo บนหัวตาราง ======
  const logoUrl = 'https://raw.githubusercontent.com/infobwd/APPWD/refs/heads/main/logo/OBEC3D.png';

  body.innerHTML = `
    <div id="score-sheet-print-wrapper" class="bg-white rounded-2xl p-4 shadow-sm">
      <div class="text-center mb-3">
        <div class="flex items-center justify-center gap-3 mb-1">
          <img src="${logoUrl}" alt="logo" class="h-10 w-10 object-contain" onerror="this.style.display='none'">
          <div class="text-base font-semibold">แบบฟอร์มใบลงคะแนนการแข่งขัน</div>
        </div>
        <div class="text-[12px] text-slate-600">
          กิจกรรม: ${escapeHtmlClient(actName)}${category ? ` | หมวดหมู่: ${escapeHtmlClient(category)}` : ''}
        </div>
      </div>
      <div class="text-sm font-semibold text-slate-700 mb-2">รายชื่อโรงเรียนที่เข้าแข่งขัน</div>
      <div class="overflow-x-auto">
        <table class="score-sheet-table w-full border-collapse text-[10px]">
          <thead>
            <tr>
              <th style="width:42px;">อันดับ</th>
              <th class="text-left">สถานศึกษา / ชื่อทีม</th>
              ${scoreHeaders}
              <th style="width:56px;">รวม</th> <!-- ลดความกว้าง -->
              <th style="width:170px;">ผลการแข่งขัน</th>
              <th style="width:150px;">หมายเหตุ</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      </div>

      <div class="mt-4 sig-grid text-[10px]">
        ${sigHtml}
      </div>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}


function buildSignaturePlaceholderList(count) {
  const total = Math.max(1, parseInt(count, 10) || 0);
  return Array.from({ length: total }, () => ({}));
}

function buildSignatureListForCount(judges, count) {
  const required = Math.max(1, parseInt(count, 10) || 0);
  if (!Array.isArray(judges) || !judges.length) {
    return buildSignaturePlaceholderList(required);
  }
  const limited = judges.slice(0, required);
  if (limited.length === required) {
    return limited;
  }
  const placeholders = buildSignaturePlaceholderList(required - limited.length);
  return limited.concat(placeholders);
}

function sortJudgesForSignatures(judges) {
  if (!Array.isArray(judges)) return [];
  return judges
    .map((judge, idx) => ({ judge, idx }))
    .sort((a, b) => {
      const orderDiff = getJudgeRoleOrderValue(a.judge?.role) - getJudgeRoleOrderValue(b.judge?.role);
      if (orderDiff !== 0) return orderDiff;
      return a.idx - b.idx;
    })
    .map(item => item.judge);
}

function renderSignatureBoxes(judges, options = {}) {
  if (!Array.isArray(judges) || !judges.length) return '';
  const showNames = options.showNames !== false;
  const sortedJudges = sortJudgesForSignatures(judges);
  const total = sortedJudges.length;
  return sortedJudges
    .map((judge, idx) => {
      const roleLabel = escapeHtmlClient(
        (judge?.role || '').toString().trim() || getDefaultJudgeRoleLabel(idx, total)
      );
      const phoneValue = formatDisplayPhone(judge?.phone || '');
      const nameHtml = showNames
        ? `<div class="name">${
            judge?.judgeName
              ? escapeHtmlClient(judge.judgeName)
              : '<span class="text-slate-400">ยังไม่ระบุชื่อ</span>'
          }</div>`
        : '';
      let metaHtml = '';
      if (showNames && judge) {
        const metaParts = [];
        if (judge.clusterLabel || judge.clusterKey) {
          metaParts.push(escapeHtmlClient(judge.clusterLabel || judge.clusterKey || ''));
        }
        if (judge.schoolName || judge.schoolId) {
          metaParts.push(escapeHtmlClient(judge.schoolName || judge.schoolId || ''));
        }
        if (metaParts.length) {
          metaHtml = `<div class="sig-meta">${metaParts.join(' • ')}</div>`;
        }
      }
      const phoneHtml = phoneValue ? `<div class="sig-meta">โทร: ${escapeHtmlClient(phoneValue)}</div>` : '';
      return `
        <div class="sig-box" data-sig-index="${idx}">
          <div class="role">${roleLabel}</div>
          ${nameHtml}
          ${metaHtml}
          <div class="line"></div>
          <div class="hint">ลงชื่อ .......................................................</div>
          <div class="hint under">เบอร์โทร ...............................................</div>
        </div>
      `;
    })
    .join('');
}

function getDefaultJudgeRoleLabel(index, total) {
  if (total <= 1) return 'ประธานกรรมการและเลขา';
  if (index === 0) return 'ประธานกรรมการ';
  if (index === total - 1) return 'กรรมการและเลขา';
  return 'กรรมการ';
}

// รับ activityId แล้วคืน {id, name, category}
function getActivityMeta(activityId) {
  const acts = Array.isArray(ALL_ACTIVITIES) ? ALL_ACTIVITIES : [];
  if (!activityId) return { id: '', name: '', category: '' };

  // แม็พตรง id ก่อน
  let a = acts.find(x => String(x.id).trim() === String(activityId).trim());

  // กันกรณีส่งชื่อมาแทน id → ลองแม็พด้วยชื่อ
  if (!a) a = acts.find(x => String(x.name).trim() === String(activityId).trim());

  // ถ้ายังไม่เจอ ให้คืนอย่างน้อย id เดิม (แต่ไม่บังคับโชว์เป็นชื่อ)
  return {
    id: a?.id || String(activityId),
    name: a?.name || '',            // ถ้าไม่เจอ “ชื่อ” ให้เป็นค่าว่าง (จะไม่โชว์รหัสแทนชื่อ)
    category: a?.category || ''     // ไม่ใส่ “ไม่ระบุหมวดหมู่” เพื่อเลี่ยงข้อความรบกวน
  };
}


function closeScoreSheetModal() {
    const modal = document.getElementById('score-sheet-modal');
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// พิมพ์เฉพาะใบลงคะแนน (ใช้ CSS ช่วยตอน print)
function printScoreSheet() {
  const el = document.getElementById('score-sheet-print-wrapper');
  if (!el) return;
  document.body.classList.add('score-sheet-printing');
  setTimeout(() => {
    window.print();
    setTimeout(() => document.body.classList.remove('score-sheet-printing'), 150);
  }, 20);
}

function printSchoolAwardTable() {
  if (!schoolAwardModal) return;
  document.body.classList.add('school-award-printing');
  setTimeout(() => {
    window.print();
    setTimeout(() => document.body.classList.remove('school-award-printing'), 150);
  }, 20);
}

    function openJudgeTimesheetModal(activityId) {
        if (!judgeTimesheetModal || !judgeTimesheetBody) return;
        judgeTimesheetState.activityId = activityId;
        judgeTimesheetState.isOpen = true;
        renderJudgeTimesheet(activityId);
        judgeTimesheetModal.classList.remove('hidden');
        judgeTimesheetModal.classList.add('flex');
    }

    function renderJudgeTimesheet(activityId) {
        if (!judgeTimesheetBody) return;
        const meta = getActivityMeta(activityId);
        if (judgeTimesheetTitle) {
            judgeTimesheetTitle.textContent = `ใบลงเวลาของกรรมการ : ${meta.name || meta.id || '-'}`;
        }
        if (!hasLoadedJudgeAssignments || !Array.isArray(JUDGE_ASSIGNMENTS)) {
            judgeTimesheetBody.innerHTML = `
                <div id="judge-timesheet-print-wrapper" class="bg-white rounded-2xl p-4 shadow-sm">
                    <p class="text-sm text-slate-600">กำลังโหลดข้อมูลกรรมการ...</p>
                </div>
            `;
            loadJudgeAssignments(true);
            return;
        }
        let judges = getJudgesForActivity(activityId);
        if (competitionStage === 'cluster' && getCurrentUserLevel() === 'group_admin') {
            const userCluster = getUserClusterForFilter();
            if (userCluster) {
                judges = judges.filter(judge =>
                    matchesClusterKey(judge.clusterKey || judge.clusterId, judge.clusterLabel, userCluster)
                );
            }
        }
        if (judgeTimesheetSubtitle) {
            judgeTimesheetSubtitle.textContent = `จำนวนกรรมการ ${judges.length || 0} คน`;
        }
        judgeTimesheetBody.innerHTML = renderJudgeTimesheetContent(meta, judges);
    }

    function renderJudgeTimesheetContent(meta, judges) {
        if (!Array.isArray(judges) || !judges.length) {
            if (judgeTimesheetSubtitle) {
                judgeTimesheetSubtitle.textContent = 'ยังไม่มีรายชื่อกรรมการสำหรับกิจกรรมนี้';
            }
            return `
                <div id="judge-timesheet-print-wrapper" class="bg-white rounded-2xl p-4 shadow-sm">
                    <p class="text-sm text-slate-600 text-center">ยังไม่พบรายชื่อกรรมการในระบบสำหรับกิจกรรมนี้</p>
                </div>
            `;
        }
        const clusterSummary = Array.from(
            new Set(
                judges
                    .map(judge => (judge.clusterLabel || judge.clusterKey || '').toString().trim())
                    .filter(Boolean)
            )
        ).join(', ');
        const tableHtml = buildJudgeTimesheetTable(judges);
        return `
            <div id="judge-timesheet-print-wrapper" class="bg-white rounded-2xl p-4 shadow-sm space-y-4">
                <div class="text-center">
                    <div class="text-base font-semibold text-slate-800">ใบลงเวลาของกรรมการ</div>
                    <div class="text-sm text-slate-600">กิจกรรม: ${escapeHtmlClient(meta.name || meta.id || '-')}</div>
                    ${clusterSummary ? `<div class="text-xs text-slate-500">เครือข่าย: ${escapeHtmlClient(clusterSummary)}</div>` : ''}
                </div>
                <div class="overflow-x-auto">
                    <table class="judge-timesheet-table w-full">
                        ${tableHtml}
                    </table>
                </div>
                <p class="judge-timesheet-note">หมายเหตุ: ให้กรรมการลงเวลาเข้า-ออกและลงชื่อกำกับทุกครั้ง</p>
            </div>
        `;
    }

    function buildJudgeTimesheetTable(judges) {
        const sorted = judges.slice().sort((a, b) => {
            const orderDiff = getJudgeRoleOrderValue(a.role) - getJudgeRoleOrderValue(b.role);
            if (orderDiff !== 0) return orderDiff;
            return (a.judgeName || '').localeCompare(b.judgeName || '', 'th');
        });
        let currentRole = null;
        let rowIndex = 1;
        const rows = [];
        sorted.forEach(judge => {
            const roleOrder = getJudgeRoleOrderValue(judge.role);
            const displayRole = getJudgeRoleDisplay(judge.role);
            const phoneText = formatDisplayPhone(judge.phone || '');
            if (roleOrder !== currentRole) {
                currentRole = roleOrder;
                rows.push(`
                    <tr class="judge-timesheet-role-heading">
                        <td colspan="7">ตำแหน่ง: ${escapeHtmlClient(displayRole)}</td>
                    </tr>
                `);
            }
            rows.push(`
                <tr>
                    <td class="text-center">${rowIndex++}</td>
                    <td>
                        <div class="font-semibold text-slate-800">${escapeHtmlClient(judge.judgeName || '-')}</div>
                        ${phoneText ? `<div class="text-[10px] text-slate-500">โทร: ${escapeHtmlClient(phoneText)}</div>` : ''}
                        ${judge.email ? `<div class="text-[10px] text-slate-500">อีเมล: ${escapeHtmlClient(judge.email)}</div>` : ''}
                    </td>
                    <td>${escapeHtmlClient(judge.schoolName || judge.schoolId || '-')}</td>
                    <td>${escapeHtmlClient(displayRole)}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            `);
        });
        return `
            <thead>
                <tr>
                    <th style="width:55px;">ลำดับ</th>
                    <th>ชื่อ-นามสกุล</th>
                    <th>สังกัด</th>
                    <th>ตำแหน่ง</th>
                    <th style="width:120px;">เวลาเข้า</th>
                    <th style="width:120px;">เวลาออก</th>
                    <th style="width:180px;">ลายเซ็น/หมายเหตุ</th>
                </tr>
            </thead>
            <tbody>${rows.join('')}</tbody>
        `;
    }

    function getJudgeRoleOrderValue(role) {
        const text = (role || '').toString().toLowerCase();
        if (text.includes('ประธาน')) return 0;
        if (text.includes('เลขา')) return 2;
        return 1;
    }

    function getJudgeRoleDisplay(role) {
        const text = (role || '').toString().trim();
        if (!text) {
            const order = getJudgeRoleOrderValue(role);
            if (order === 0) return 'ประธานกรรมการ';
            if (order === 2) return 'กรรมการและเลขา';
            return 'กรรมการ';
        }
        if (/ประธาน/i.test(text)) return 'ประธานกรรมการ';
        if (/เลขา/i.test(text)) return 'กรรมการและเลขา';
        return text;
    }

    function closeJudgeTimesheetModal() {
        if (!judgeTimesheetModal) return;
        judgeTimesheetModal.classList.add('hidden');
        judgeTimesheetModal.classList.remove('flex');
        judgeTimesheetState.activityId = '';
        judgeTimesheetState.isOpen = false;
    }

    function printJudgeTimesheet() {
        if (!judgeTimesheetModal) return;
        document.body.classList.add('judge-timesheet-printing');
        setTimeout(() => {
            window.print();
            setTimeout(() => document.body.classList.remove('judge-timesheet-printing'), 150);
        }, 20);
    }

// เมื่อ DOM โหลดเสร็จแล้วค่อยเริ่มผูก event / โหลดข้อมูลต่าง ๆ
document.addEventListener('DOMContentLoaded', () => {
    // ====== การตั้งค่าพื้นฐานตอนเริ่มโหลดหน้า ======
    setSubmitButtonState(true);          // กำหนดสถานะเริ่มต้นของปุ่มส่งแบบฟอร์ม
    updateAuthUI();                      // อัปเดต UI ส่วนล็อกอิน/โปรไฟล์ ตามสถานะผู้ใช้
    restoreUserSession();                // กู้คืน session ผู้ใช้ (ถ้ามี)
    loadInitialData();                   // โหลดข้อมูลเริ่มต้นที่จำเป็น
    initializeAuthSection();             // เตรียมส่วนการยืนยันตัวตน / ล็อกอิน
    loadSchoolOptions();                 // โหลดรายชื่อโรงเรียนสำหรับเลือก
    loadCompetitionSettings();           // โหลดการตั้งค่าการแข่งขัน (เช่น รอบ, ตัวเลือกกิจกรรม)
    navigateTo('section-hero', document.querySelector('.nav-item')); // ไปยังหน้า/section แรก

    // ====== การอัปโหลดรูปภาพ (โลโก้ทีม / รูปทีม / รูปโปรไฟล์ตอนสมัคร) ======
    if (logoInput) {
        logoInput.addEventListener('change', handleLogoSelect); // เลือกไฟล์โลโก้ทีม
    }
    if (teamPhotoInput) {
        teamPhotoInput.addEventListener('change', handleTeamPhotoSelect); // เลือกรูปภาพทีม
    }
    if (signupAvatarInput) {
        signupAvatarInput.addEventListener('change', handleSignupAvatarSelect); // เลือกรูปโปรไฟล์ในหน้าสมัคร
    }

    // ====== หน้าหลัก: ค้นหา/โหลดกิจกรรมเพิ่มเติม ======
    if (homeActivitySearchInput) {
        homeActivitySearchInput.addEventListener('input', handleHomeActivitySearchInput); // ค้นหากิจกรรมในหน้าแรก
    }
    if (homeActivityLoadMoreBtn) {
        homeActivityLoadMoreBtn.addEventListener('click', handleHomeActivityLoadMore);   // ปุ่มโหลดกิจกรรมเพิ่ม
    }

    // ====== การค้นหาทีม + ปุ่มพิมพ์ตารางเหรียญโรงเรียน ======
    if (teamSearchInput) {
        teamSearchInput.addEventListener('input', handleTeamSearchInput); // ค้นหารายชื่อทีม
    }
    if (areaTransferButton) {
        areaTransferButton.addEventListener('click', handleAreaTransferClick);
    }
    updateAreaTransferButtonState();
    if (schoolAwardPrintButton) {
        schoolAwardPrintButton.addEventListener('click', printSchoolAwardTable); // สั่งพิมพ์ตารางสรุปเหรียญรายโรงเรียน
    }

    // ====== การเลือกกิจกรรม / หมวดกิจกรรมในแบบฟอร์มสมัครทีม ======
    if (activitySelect) {
        activitySelect.addEventListener('change', e => {
            // เปลี่ยนกิจกรรมแล้วอัปเดตฟอร์มตามกิจกรรมที่เลือก
            updateFormBasedOnActivity(e.target.value);
        });
    }

    if (activityCategorySelect) {
        activityCategorySelect.addEventListener('change', () => {
            // suppressCategorySync = true หมายถึงไม่ให้ sync activity อัตโนมัติในบางช่วง
            if (suppressCategorySync) return;

            // เมื่อเปลี่ยนหมวด ให้รีเฟรชรายการกิจกรรม และอัปเดตฟอร์มตามกิจกรรมที่เลือกอยู่
            refreshActivitiesAfterCategoryChange();
            updateFormBasedOnActivity(activitySelect.value || '');
        });
    }

    // ====== ช่องเลือกโรงเรียน (ให้โหลดตัวเลือกทุกครั้งที่โฟกัส/พิมพ์) ======
    if (schoolInput) {
        schoolInput.addEventListener('focus', () => loadSchoolOptions()); // โฟกัสช่อง -> รีโหลดตัวเลือกโรงเรียน
        schoolInput.addEventListener('input', () => loadSchoolOptions()); // พิมพ์ตัวอักษร -> โหลด/กรองโรงเรียน
    }

    // ====== ปุ่ม Export ข้อมูลทีม (CSV / PDF / ใบรายงานตัว) ======
    const exportCsvBtn = document.getElementById('export-csv-button');
    const exportPdfBtn = document.getElementById('export-pdf-button');
    const exportAttBtn = document.getElementById('export-attendance-pdf-button');

    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', () => handleTeamsExport('csv')); // ส่งออกข้อมูลทีมเป็น CSV
    }
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', () => handleTeamsExport('pdf')); // ส่งออกข้อมูลทีมเป็น PDF รวม
    }

    // ★★★ ปุ่ม Export ใบลงเวลา / ใบรายงานตัว (Attendance PDF) ★★★
    if (exportAttBtn) {
        exportAttBtn.addEventListener('click', handleAttendanceExport);
    }

    // ====== ช่องติดต่อประสานงาน (ชื่อ / เบอร์ / อีเมล) ======
    [contactNameInput, contactPhoneInput, contactEmailInput].forEach(input => {
        if (input) {
            // เมื่อมีการกรอก/แก้ไข ให้ mark ว่าผู้ใช้แก้ไขเอง (ไม่ดึงอัตโนมัติ)
            input.addEventListener('input', markContactFieldManual);
        }
    });

    // ====== ฟอร์มโปรไฟล์ผู้ใช้ + รูปโปรไฟล์ในเมนูด้านบน ======
    if (profileForm) {
        profileForm.addEventListener('submit', handleProfileFormSubmit); // บันทึกข้อมูลโปรไฟล์
    }
    if (navProfileAvatarInput) {
        navProfileAvatarInput.addEventListener('change', handleNavProfileAvatarSelect); // เลือกรูปโปรไฟล์จากเมนูด้านบน
    }
    if (navProfileAvatarSubmit) {
        navProfileAvatarSubmit.addEventListener('click', handleNavProfileAvatarSubmit); // ยืนยันอัปโหลดรูปโปรไฟล์
    }
    if (navProfileLogoutButton) {
        navProfileLogoutButton.addEventListener('click', handleNavProfileLogout); // ปุ่มออกจากระบบในเมนูโปรไฟล์
    }
    if (profileLogoutButton) {
        profileLogoutButton.addEventListener('click', handleProfileSectionLogout); // ปุ่มออกจากระบบในหน้าโปรไฟล์
    }

    // ====== Modal จัดการทีม (Team Manage Panel) ======
    if (teamManagePanel) {
        teamManagePanel.addEventListener('click', event => {
            // คลิกที่พื้นหลังมืด (ไม่ใช่กล่องด้านใน) -> ปิดหน้าจัดการทีม
            if (event.target === teamManagePanel) {
                closeTeamManager();
            }
        });
    }
    if (teamManageLogoInput) {
        teamManageLogoInput.addEventListener('change', handleTeamManageLogoSelect); // เปลี่ยนโลโก้ทีมในหน้าแก้ไขทีม
    }
    if (teamManagePhotoInput) {
        teamManagePhotoInput.addEventListener('change', handleTeamManagePhotoSelect); // เปลี่ยนรูปทีมในหน้าแก้ไขทีม
    }
    if (teamManageStatusSelect) {
        teamManageStatusSelect.addEventListener('change', () => {
            // แสดง/ซ่อนช่องเหตุผลตามสถานะใหม่ของทีม
            updateTeamManageReasonVisibility(teamManageStatusSelect.value || '');
        });
    }
    if (teamManageStageSwitch) {
        teamManageStageSwitch.addEventListener('click', handleTeamManageStageSwitch); // ปุ่มสลับรอบ/สถานะขั้นของทีม
    }
    if (teamManagePhotoOpen) {
        teamManagePhotoOpen.addEventListener('click', () => {
            // เปิดดูรูปทีมใน modal แยก
            if (activeManagedTeam) {
                openTeamPhotoModal(activeManagedTeam.teamId);
            }
        });
    }

    // ====== Modal กรอกคะแนน ======
    if (scoreEntryModal) {
        scoreEntryModal.addEventListener('click', event => {
            // คลิกพื้นหลังมืด -> ปิด modal กรอกคะแนน
            if (event.target === scoreEntryModal) {
                closeScoreEntryModal();
            }
        });
    }

    // ====== Modal สรุปเหรียญรายโรงเรียน ======
    if (schoolAwardModal) {
        schoolAwardModal.addEventListener('click', event => {
            // คลิกพื้นหลังมืด -> ปิด modal สรุปเหรียญ
            if (event.target === schoolAwardModal) {
                closeSchoolAwardModal();
            }
        });
    }

    // ====== ปุ่ม Escape ปิด Modal ต่าง ๆ ======
    document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && scoreEntryModal && !scoreEntryModal.classList.contains('hidden')) {
            closeScoreEntryModal();
        }
    });
    document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && schoolAwardModal && !schoolAwardModal.classList.contains('hidden')) {
            closeSchoolAwardModal();
        }
    });

    // ====== Global Handlers (ครอบทั้งหน้า) ======
    document.addEventListener('click', handleGlobalProfileMenuClick); // จัดการเมนูโปรไฟล์ (เปิด/ปิด)
    document.addEventListener('click', handleJudgePanelClick);        // จัดการคลิกที่ panel สำหรับกรรมการ
    document.addEventListener('change', handleJudgeFileChange);      // จัดการไฟล์อัปโหลดจากกรรมการ
    document.addEventListener('keydown', handleProfileMenuKeydown);  // การกดคีย์บอร์ดในเมนูโปรไฟล์
    document.addEventListener('input', handleNumericInputEvent, true); // บังคับกรอกตัวเลขในบาง input (ใช้ capture)

    // ====== การเลือก/กำหนดระดับชั้นเรียนด้วย data-attribute ======
    document.addEventListener('change', event => {
        if (event.target?.matches('[data-class-level-select="true"]')) {
            // สลับการแสดง input ระดับชั้น custom
            toggleClassLevelCustomInput(event.target);

            // ถ้าเป็นโหมด manage (จัดการสมาชิกในทีม) ให้บันทึกค่ากลับไปยัง state
            if ((event.target.dataset.classScope || '') === 'manage') {
                handleManagedClassLevelValue(
                    event.target.dataset.memberType || 'student',
                    event.target.dataset.memberIndex || '0',
                    event.target.dataset.managedIndex
                );
            }
        }
    });

    document.addEventListener('input', event => {
        if (
            event.target?.matches('[data-class-level-custom="true"]') &&
            (event.target.dataset.classScope || '') === 'manage'
        ) {
            // กรณีพิมพ์ระดับชั้นแบบ custom ในหน้า manage ให้บันทึกค่าเช่นกัน
            handleManagedClassLevelValue(
                event.target.dataset.memberType || 'student',
                event.target.dataset.memberIndex || '0',
                event.target.dataset.managedIndex
            );
        }
    });

    // =====================================================================
    // ส่วนจัดการผู้ใช้ (User Management)
    // =====================================================================
    if (userManagementRefreshBtn) {
        // ปุ่มรีเฟรชรายการผู้ใช้
        userManagementRefreshBtn.addEventListener('click', () => loadUserManagementData(true));
    }
    if (userManagementSearchInput) {
        // ช่องค้นหาผู้ใช้
        userManagementSearchInput.addEventListener('input', handleUserManagementSearchInput);
    }
    if (scoreAssignmentRefreshBtn) {
        // ปุ่มรีเฟรชหน้ามอบหมายหน้าที่ให้คะแนน (ใช้ data จาก user management)
        scoreAssignmentRefreshBtn.addEventListener('click', () => loadUserManagementData(true));
    }
    if (userManagementAddButton) {
        // ปุ่มเปิดฟอร์มเพิ่มผู้ใช้ใหม่
        userManagementAddButton.addEventListener('click', () => openUserManagementForm());
    }
    if (userManagementForm) {
        // เมื่อบันทึกฟอร์มผู้ใช้
        userManagementForm.addEventListener('submit', handleUserManagementFormSubmit);
    }
    if (userManagementCancelLink) {
        // ปุ่ม/ลิงก์ยกเลิกในฟอร์มผู้ใช้
        userManagementCancelLink.addEventListener('click', event => {
            event.preventDefault();
            hideUserManagementForm();
        });
    }
    if (userFormCancelBtn) {
        // ปุ่มยกเลิกอีกตำแหน่ง (ในฟอร์มผู้ใช้)
        userFormCancelBtn.addEventListener('click', hideUserManagementForm);
    }
    if (userManagementContent) {
        // จัดการคลิกในรายการผู้ใช้ (เช่น แก้ไข/ลบ)
        userManagementContent.addEventListener('click', handleUserManagementContentClick);
    }

    // =====================================================================
    // ส่วนจัดการโรงเรียน (School Management)
    // =====================================================================
    if (schoolManagementRefreshBtn) {
        // ปุ่มรีเฟรชรายการโรงเรียน
        schoolManagementRefreshBtn.addEventListener('click', () => loadSchoolManagementData(true));
    }
    if (schoolManagementSearchInput) {
        // ช่องค้นหาโรงเรียน
        schoolManagementSearchInput.addEventListener('input', handleSchoolManagementSearchInput);
    }
    if (schoolManagementContent) {
        // คลิกจัดการโรงเรียน (แก้ไข/ลบ ฯลฯ)
        schoolManagementContent.addEventListener('click', handleSchoolManagementContentClick);
    }

    // =====================================================================
    // Modal มอบหมายโรงเรียนให้ผู้ใช้ (School Assignment)
    // =====================================================================
    if (schoolAssignmentClose) {
        schoolAssignmentClose.addEventListener('click', closeSchoolAssignmentModal); // ปิด modal
    }
    if (schoolAssignmentCancel) {
        schoolAssignmentCancel.addEventListener('click', closeSchoolAssignmentModal); // ปุ่มยกเลิก
    }
    if (schoolAssignmentSave) {
        schoolAssignmentSave.addEventListener('click', submitSchoolAssignments);      // ปุ่มบันทึกการมอบหมายโรงเรียน
    }
    if (schoolAssignmentSearch) {
        schoolAssignmentSearch.addEventListener('input', handleAssignmentSearchInput); // ค้นหาโรงเรียนใน modal มอบหมาย
    }
    if (schoolAssignmentList) {
        schoolAssignmentList.addEventListener('change', handleAssignmentListToggle);   // เลือก/ยกเลิกโรงเรียนที่มอบหมาย
    }

    // =====================================================================
    // ฟอร์มบันทึกกรรมการ (Judge Manual Modal)
    // =====================================================================
    if (judgeManualForm) {
        judgeManualForm.addEventListener('submit', handleJudgeManualSubmit); // บันทึกข้อมูลกรรมการแบบ manual
    }
    if (judgeManualCopySelect) {
        judgeManualCopySelect.addEventListener('change', handleJudgeManualCopySelect); // คัดลอกข้อมูลกรรมการรอบกลุ่ม
    }
    if (judgeManualCancel) {
        judgeManualCancel.addEventListener('click', closeJudgeManualModal);  // ปุ่มยกเลิกใน modal
    }
    if (judgeManualClose) {
        judgeManualClose.addEventListener('click', closeJudgeManualModal);   // ปุ่มกากบาทปิด modal
    }
    if (judgeManualModal) {
        judgeManualModal.addEventListener('click', event => {
            // คลิกพื้นหลังมืด -> ปิด modal
            if (event.target === judgeManualModal) {
                closeJudgeManualModal();
            }
        });
    }

    // =====================================================================
    // ฟิลเตอร์รายงานผลการแข่งขัน / เหรียญ / ตัวแทน
    // =====================================================================
    if (competitionFilterActivity) {
        competitionFilterActivity.addEventListener('change', handleCompetitionFilterChange); // เปลี่ยนฟิลเตอร์กิจกรรม
    }
    if (competitionFilterSchool) {
        competitionFilterSchool.addEventListener('change', handleCompetitionFilterChange);   // ฟิลเตอร์โรงเรียน
    }
    if (competitionFilterMedal) {
        competitionFilterMedal.addEventListener('change', handleCompetitionFilterChange);    // ฟิลเตอร์ตามเหรียญ
    }
    if (competitionFilterRepresentative) {
        competitionFilterRepresentative.addEventListener('change', handleCompetitionFilterChange); // ฟิลเตอร์ตัวแทน/ไม่ใช่ตัวแทน
    }
    if (competitionFilterResetBtn) {
        competitionFilterResetBtn.addEventListener('click', resetCompetitionFilters);        // ปุ่มรีเซ็ตฟิลเตอร์ทั้งหมด
    }

    // ปุ่มบันทึก Stage การแข่งขัน (เช่น เปลี่ยนรอบ, อัปเดตสถานะ)
    if (competitionStageSaveBtn) {
        competitionStageSaveBtn.addEventListener('click', handleCompetitionStageSave);
    }

    // =====================================================================
    // หน้ามอบหมายหน้าที่ให้คะแนน (Score Assignment)
    // =====================================================================
    if (scoreAssignmentContent) {
        // คลิกในรายการมอบหมาย (เช่น เปิด/แก้ไขหน้าที่ของกรรมการ)
        scoreAssignmentContent.addEventListener('click', handleScoreAssignmentAction);
        // เปลี่ยนหมวดหมู่การให้คะแนน
        scoreAssignmentContent.addEventListener('change', handleScoreAssignmentCategoryChange);
    }

    // รายการหน้าที่ของกรรมการ (Duty List)
    if (scoreDutyList) {
        scoreDutyList.addEventListener('click', handleScoreDutyAction); // เลือกหน้าที่/เปิดรายละเอียด
    }
    if (scoreDutySearchInput) {
        scoreDutySearchInput.addEventListener('input', handleScoreDutySearchInput); // ค้นหาหน้าที่ของกรรมการ
    }

    // ส่วนกรอกคะแนนใน Modal (Score Entry Body)
    if (scoreEntryBody) {
        scoreEntryBody.addEventListener('input', handleScoreEntryBodyInput);   // กรอกคะแนนแล้วอัปเดตแบบ real-time
        scoreEntryBody.addEventListener('change', handleScoreEntryBodyChange); // เมื่อเปลี่ยนค่าเสร็จ (blur / enter)
    }

    // =====================================================================
    // โหมดบันทึกคะแนนระดับเขต/พื้นที่ (Area Score)
    // =====================================================================
    if (areaScoreActivitySelect) {
        areaScoreActivitySelect.addEventListener('change', () => {
            if (!areaScoreHelper) return;

            // แสดงข้อความช่วยเหลือตามกิจกรรมที่เลือก
            const activityLabel =
                (competitionResultsCache?.activities || []).find(
                    act => act.id === areaScoreActivitySelect.value
                )?.name || '';

            areaScoreHelper.textContent = activityLabel
                ? `พร้อมบันทึกคะแนนให้ ${activityLabel}`
                : 'เลือกกิจกรรมเพื่อเริ่มบันทึก';
        });
    }

    if (areaScoreStartButton) {
        areaScoreStartButton.addEventListener('click', () => {
            const activityId = (areaScoreActivitySelect?.value || '').trim();

            if (!activityId) {
                // กรณีไม่ได้เลือกกิจกรรม
                setJudgeModalStatus('กรุณาระบุกิจกรรม', 'error');
                return;
            }

            // ต้องล็อกอินก่อนเริ่มบันทึกคะแนน
            if (!requireLoginForRegistration()) return;

            // เปิดหน้ากรอกคะแนนสำหรับกิจกรรมที่เลือก
            openScoreEntryModal(activityId);
        });
    }
});

</script>
</body>
</html>
